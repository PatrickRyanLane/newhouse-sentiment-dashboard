<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Brand Risk Dashboard</title>

<!-- Chart.js + PapaParse CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
:root{
  --bg:#044152; --card:#092e37; --muted:#a2ebf3; --text:#ebf2f2; --accent:#58dbed; --black:#1f2121;
  --pill-neg:#ff8261; --pill-neu:#cfdbdd; --pill-pos:#82c618;
  --stroke:#0e2230; --chip:#12343e; --chipBorder:#174550;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
.wrap{max-width:1200px;margin:0 auto;padding:20px}
h1{font-size:28px;margin:6px 0 18px}

/* Controls */
.controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:0 0 16px}
.card{background:var(--card);border:1px solid var(--stroke);border-radius:12px;padding:12px}
select,input[type="text"]{background:var(--black);border:1px solid #23314d;border-radius:10px;color:var(--text);padding:8px 10px}
button{background:var(--black);border:1px solid #2a3b5e;color:var(--text);border-radius:10px;padding:8px 12px;cursor:pointer}
button:hover{filter:brightness(1.08)}

/* Charts grid – equal heights, responsive */
.grid{
  display:grid;
  grid-template-rows:minmax(360px,42vh) minmax(360px,42vh);
  gap:16px;
  margin:16px 0;
}

/* Chart cards */
.chart-card{background:var(--card);border:1px solid var(--stroke);border-radius:12px;padding:12px 12px 48px;position:relative}
.chart-card canvas{width:100% !important;height:100% !important;display:block}

/* Chart pagination controls (top-right) */
.chart-actions{
  position:absolute;
  top:10px; right:12px;
  display:flex; align-items:center; gap:10px;
}
.chart-actions .dates-range{ font-size:12px; }
.chart-actions .dates-pager{ display:flex; gap:6px; }
.chart-actions .dates-pager button{
  background:#1f2121; border:1px solid #2a3b5e; color:var(--text);
  border-radius:8px; padding:4px 8px; cursor:pointer;
}
.chart-actions .dates-pager button[disabled]{ opacity:.45; cursor:not-allowed; }
  
/* Table */
.table-card{background:var(--card);border:1px solid var(--stroke);border-radius:12px;padding:10px}
.table-hint{margin:0 0 8px;color:var(--muted)}
.table-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch}
.table-scroll::-webkit-scrollbar{height:8px}
.table-scroll::-webkit-scrollbar-track{background:rgba(255,255,255,.05);border-radius:8px}
.table-scroll::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:8px}

table{width:100%;border-collapse:separate;border-spacing:0 6px;min-width:980px}
thead th{font-size:12px;color:var(--muted);text-align:left;padding:6px 8px}
tbody td{padding:10px 8px;background:var(--black);border-top:1px solid #0f1831;border-bottom:1px solid #0f1831}
tbody tr td:first-child{border-left:1px solid #0f1831;border-radius:10px 0 0 10px}
tbody tr td:last-child{border-right:1px solid #0f1831;border-radius:0 10px 10px 0}
.right{text-align:right}
.center{text-align:center}

.pill{font-size:12px;border-radius:999px;padding:3px 8px;border:1px solid var(--chipBorder);background:var(--chip);color:#cfe0ff}
.pill.low{background:rgba(130,198,24,.15);color:#82c618}
.pill.med{background:rgba(207,219,221,.25);color:#cfdbdd}
.pill.high{background:rgba(255,130,97,.15);color:#ff8261}
.link{color:var(--accent);text-decoration:underline}

@media (max-width:960px){
  .table-card{padding:8px}
  .table-hint{font-size:12px}
  thead th,tbody td{padding:8px 10px}
  .pill{font-size:11px}
}

/* Sticky first column (Company + checkbox) */
thead th:first-child, tbody td:first-child{
  position:sticky;left:0;z-index:2;box-shadow:2px 0 0 0 rgba(255,255,255,.06);
}

/* Pagination */
.pagination{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:8px}

/* Modal (z-index > sticky) */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:24px;z-index:10000}
.modal.open{display:flex}
.modal .box{max-width:900px;width:100%;max-height:85vh;overflow:auto;background:#0e152a;border:1px solid #1b2745;border-radius:16px;position:relative;z-index:10001}
.modal header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #12203d}
.modal header h3{margin:0;font-size:16px}
.modal .content{padding:16px}
.badges{display:flex;gap:8px;margin-top:8px}
.badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid transparent}
.badge.positive{background:rgba(130,198,24,.15);color:#82c618;border-color:rgba(130,198,24,.35)}
.badge.neutral{background:rgba(207,219,221,.25);color:#cfdbdd;border-color:rgba(207,219,221,.45)}
.badge.negative{background:rgba(255,130,97,.15);color:#ff8261;border-color:rgba(255,130,97,.35)}
.badge.controlled{background:rgba(88,219,237,.15);color:#58dbed;border-color:rgba(88,219,237,.35)}
.badge.uncontrolled{background:rgba(255,130,97,.15);color:#ff8261;border-color:rgba(255,130,97,.35)}
.muted{color:var(--muted)}

/* SERP cards */
.serp-cards{display:grid;gap:12px;margin-top:12px}
.serp-card{background:var(--card);border:1px solid var(--stroke);border-radius:12px;padding:14px 16px}
.serp-domain{font-size:12px;color:var(--muted);margin-bottom:4px}
.serp-title a{color:var(--text);text-decoration:underline}
.serp-snippet{color:var(--muted);margin-top:6px;line-height:1.35}
.serp-metrics{margin:4px 0 0;color:var(--muted)}
.serp-metrics b{color:var(--text)}
</style>
</head>

<body>
<div class="wrap">
  <h1>Brand Risk Dashboard</h1>

  <div class="controls card">
    <div>
      <div class="muted" style="font-size:12px;margin:0 0 4px">Date</div>
      <select id="dateSelect"></select>
    </div>
    <div style="flex:1 1 420px">
      <div class="muted" style="font-size:12px;margin:0 0 4px">Filter (Company)</div>
      <input id="filterInput" type="text" placeholder="Type to filter…" />
    </div>
    <button id="refreshBtn">Refresh Data</button>
    <button id="clearBtn">Clear Selection</button>
  </div>

  <div class="grid">
    <div class="chart-card">
      <h3>News sentiment (percent of articles)</h3>
      <!-- range + pager (synced) -->
      <div class="chart-actions">
        <span class="dates-range muted" aria-live="polite"></span>
        <div class="dates-pager">
          <button class="dates-prev" title="Older window">←</button>
          <button class="dates-next" title="Newer window">→</button>
        </div>
      </div>
      <canvas id="newsChart"></canvas>
    </div>

    <div class="chart-card">
      <h3>SERP (Negative % • Control %)</h3>
      <!-- range + pager (synced) -->
      <div class="chart-actions">
        <span class="dates-range muted" aria-live="polite"></span>
        <div class="dates-pager">
          <button class="dates-prev" title="Older window">←</button>
          <button class="dates-next" title="Newer window">→</button>
        </div>
      </div>
      <canvas id="serpChart"></canvas>
    </div>
  </div>

  <div class="table-card">
    <p class="table-hint">Select a company using the checkbox to view its trend lines.</p>
    <div class="table-scroll">
      <table>
        <thead>
          <tr>
            <th>Company</th>
            <th data-key="neg_news" class="right">Negative News % ▲▼</th>
            <th data-key="neg_serp" class="right">Negative SERP % ▲▼</th>
            <th data-key="ctrl_pct" class="right">SERP Control % ▲▼</th>
            <th data-key="risk" class="center">Risk ▲▼</th>
            <th class="center">Headlines</th>
            <th class="center">SERP</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="pagination">
      <button id="prevBtn">Prev</button>
      <div>Page <span id="pageNo">1</span> / <span id="pageTotal">1</span></div>
      <button id="nextBtn">Next</button>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="box">
    <header>
      <h3 id="modalTitle">Title</h3>
      <button id="modalClose">Close</button>
    </header>
    <div class="content" id="modalContent"></div>
  </div>
</div>

<script>
/********************** Config (brand) **********************/
const COUNTS_CANDIDATES   = ['data/processed_articles/daily_counts.csv'];
const SERPS_DAILY_CSV     = 'data/serps/brand_serps_daily.csv';
const ARTICLES_DAILY_PATH = d => `data/processed_articles/${d}.csv`;     // table
const HEADLINES_PATH      = d => `data/articles/${d}-articles.csv`;       // modal
const SERP_PROCESSED_PATH = d => `data/processed_serps/${d}-brand-serps-processed.csv`;
const SERP_ROWS_PATH      = d => `data/serp_rows/${d}-brand-serps-rows.csv`;

/********************** Runtime **********************/
let allCountsRows = [];   // news counts (for charts)  [{date,company,pos,neu,neg}]
let serpsDaily    = [];   // serp aggregates for charts [{date,company,total,neg_serp,ctrl}]
let filteredRows  = [];   // table rows for current date/filter
let selectedCompany = null;
let currentSort = { key:null, dir:1 };
let currentPage = 1;
const PAGE_SIZE = 25;

let newsChart, serpChart;

// per-date caches
const _articlesCache = new Map(); // date -> Map(company -> {neg_pct})
const _serpAggCache  = new Map(); // date -> Map(company -> {total, neg_serp, controlled})

/* ===== Synced chart pagination state (same as CEO) ===== */
const DATE_WINDOW_SIZE = 30;      // show 30 dates at a time
let dateWindowStart = null;       // index of first date in window (global/shared)

/********************** Utils **********************/
const isISODate = s => /^\d{4}-\d{2}-\d{2}$/.test(String(s||'').trim());
const esc = (s) => String(s ?? '').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const fmtPct = (v) => (v==null) ? 'N/A' : Math.round(v*100)+'%';

/*************** Style (SERP chart) ***************/
const NEG_COLOR   = '#ff8261';
const CTRL_COLOR  = '#58dbed';
const SOLID_WIDTH = 3;        // daily (solid)
const DASH_WIDTH  = 2;        // averages (dashed)
const DASH_PATTERN = [8, 6];

/*************** Index-average holders ***************/
let INDEX_AVG_NEG  = null; // Average Negative SERP % across index (all days, exclude 0/100)
let INDEX_AVG_CTRL = null; // Average Daily Control % across index (all days, exclude 0/100)

/*************** Helper ***************/
function avgPctExcludingExtremes(arr){
  const vals = (arr || []).filter(v => Number.isFinite(v) && v > 0 && v < 100);
  if (!vals.length) return null;
  return vals.reduce((a,b)=>a+b, 0) / vals.length;
}

/* ===== Pager helpers (same as CEO) ===== */
function clampDateStart(total){
  if (total <= DATE_WINDOW_SIZE) return 0;
  const maxStart = total - DATE_WINDOW_SIZE;
  const start = (dateWindowStart ?? maxStart);
  return Math.min(Math.max(0, start), maxStart);
}
function sliceWindow(arr, start, size){ return arr.slice(start, start + size); }
function updateDateRangeUI(allDates){
  const start = clampDateStart(allDates.length);
  const end = Math.min(allDates.length, start + DATE_WINDOW_SIZE);
  const label = allDates.length ? `${allDates[start]} — ${allDates[end - 1]}` : '';
  document.querySelectorAll('.dates-range').forEach(el => el.textContent = label);

  const atStart = start === 0;
  const atEnd   = (start + DATE_WINDOW_SIZE) >= allDates.length;
  document.querySelectorAll('.dates-prev').forEach(b => b.disabled = atStart);
  document.querySelectorAll('.dates-next').forEach(b => b.disabled = atEnd);
}
function hookDatePager(allDates){
  const goPrev = () => {
    const total = allDates.length;
    if (total <= DATE_WINDOW_SIZE) return;
    dateWindowStart = clampDateStart(total) - DATE_WINDOW_SIZE;
    if (dateWindowStart < 0) dateWindowStart = 0;
    renderCharts();
  };
  const goNext = () => {
    const total = allDates.length;
    if (total <= DATE_WINDOW_SIZE) return;
    const maxStart = total - DATE_WINDOW_SIZE;
    dateWindowStart = Math.min(maxStart, clampDateStart(total) + DATE_WINDOW_SIZE);
    renderCharts();
  };
  document.querySelectorAll('.dates-prev').forEach(b => b.onclick = goPrev);
  document.querySelectorAll('.dates-next').forEach(b => b.onclick = goNext);
}
  
/********************** CSV helpers **********************/
async function fetchCsv(url){
  const r = await fetch(url, {cache:'no-store'});
  if (!r.ok) throw new Error(`HTTP ${r.status} for ${url}`);
  const t = await r.text();
  return await new Promise((res,rej)=>Papa.parse(t,{header:true,skipEmptyLines:true,complete:o=>res(o.data||[]),error:e=>rej(e)}));
}
async function fetchCsvAny(cands){
  for (const u of cands){ try{ const rows = await fetchCsv(u); if (Array.isArray(rows)) return rows; } catch{} }
  return [];
}

/********************** Loaders **********************/
async function loadCounts(){
  const rows = await fetchCsvAny(COUNTS_CANDIDATES);
  allCountsRows = rows.map(r=>({
    date: String(r.date||'').trim(),
    company: String(r.company||'').trim(),
    pos: +r.positive||0,
    neu: +r.neutral||0,
    neg: +r.negative||0
  })).filter(r=>isISODate(r.date) && r.company);
}
async function loadSerpDaily(){
  try {
    const rows = await fetchCsv(SERPS_DAILY_CSV);
    serpsDaily = rows.map(r => ({
      date:    (r.date||'').trim(),
      company: (r.company||'').trim(),
      total:   +r.total || 0,
      neg_serp:+r.negative_serp || +r.neg_serp || 0,
      ctrl:    +r.controlled    || +r.control  || 0
    })).filter(r => isISODate(r.date) && r.company);

    // ---- compute constant index averages (index-wide; run after serpsDaily is loaded)
    {
      const byDate = new Map();
      for (const r of serpsDaily) {
        if (!byDate.has(r.date)) byDate.set(r.date, []);
        byDate.get(r.date).push(r);
      }

      const indexNegDailyPct  = [];
      const indexCtrlDailyPct = [];

      for (const rows of byDate.values()) {
        const negs  = rows.map(r => +r.neg_serp)
                          .filter(v => Number.isFinite(v) && v > 0 && v < 100);
        const ctrls = rows.map(r => +r.ctrl)
                          .filter(v => Number.isFinite(v) && v > 0 && v < 100);

        indexNegDailyPct.push(negs.length  ? (negs.reduce((a,b)=>a+b,0)  / negs.length)  : NaN);
        indexCtrlDailyPct.push(ctrls.length ? (ctrls.reduce((a,b)=>a+b,0) / ctrls.length) : NaN);
      }

      INDEX_AVG_NEG  = avgPctExcludingExtremes(indexNegDailyPct);
      INDEX_AVG_CTRL = avgPctExcludingExtremes(indexCtrlDailyPct);
    }

  } catch (e) {
    serpsDaily = [];
  }
}

/********************** Risk **********************/
// NEW risk logic:
// If neg% > 0  => "High"
// If neg% = 0 and control < 40% => "Medium"
// Else => "Low"
function computeRisk(negPct, ctrlPct){
  // Require negPct; if missing we can't score
  if (negPct == null || isNaN(negPct)) return 'N/A';

  // Any measurable negative SERP -> High
  if (negPct > 0) return 'High';

  // negPct is exactly zero; need control to decide
  if (ctrlPct == null || isNaN(ctrlPct)) return 'N/A';
  return ctrlPct < 0.40 ? 'Medium' : 'Low';
}

/********************** Per-date sources **********************/
function toPct01(x){
  if (x==null || x==='') return null;
  const n = +String(x).replace('%','').trim();
  if (!isFinite(n)) return null;
  return n>1 ? n/100 : n;
}

// data/processed_articles/<DATE>.csv -> Map(company -> {neg_pct})
async function getArticlesForDate(d){
  if (_articlesCache.has(d)) return _articlesCache.get(d);
  const map = new Map();
  try{
    const rows = await fetchCsv(ARTICLES_DAILY_PATH(d));
    rows.forEach(r=>{
      const company = String(r.company||'').trim();
      if (!company) return;
      let neg = toPct01(r.neg_pct);
      if (neg==null){
        const negCount = +r.negative||0;
        const tot = (+r.total) || ((+r.positive||0)+(+r.neutral||0)+negCount) || 0;
        neg = tot ? (negCount/tot) : 0;
      }
      map.set(company, { neg_pct: neg });
    });
  }catch{}
  _articlesCache.set(d,map);
  return map;
}

// data/processed_serps/<DATE>-brand-serps-processed.csv -> Map(company -> {total, neg_serp, controlled})
async function getSerpAggForDate(d){
  if (_serpAggCache.has(d)) return _serpAggCache.get(d);
  const map = new Map();
  try{
    const rows = await fetchCsv(SERP_PROCESSED_PATH(d));
    rows.forEach(r=>{
      const company = String(r.company||'').trim();
      if (!company) return;
      map.set(company,{ total:+r.total||0, neg_serp:+r.negative_serp||0, controlled:+r.controlled||0 });
    });
  }catch{}
  _serpAggCache.set(d,map);
  return map;
}

/********************** UI bootstrap **********************/
async function init(){
  await Promise.all([loadCounts(), loadSerpDaily()]);
  const dateSet = new Set([ ...allCountsRows.map(r=>r.date), ...serpsDaily.map(r=>r.date) ].filter(isISODate));
  const dates = [...dateSet].sort();
  const sel = document.getElementById('dateSelect');
  sel.innerHTML = dates.map(d=>`<option value="${d}">${d}</option>`).join('');
  sel.value = dates[dates.length-1] || '';
  sel.addEventListener('change', ()=>{ currentPage=1; selectedCompany=null; renderAll(); });

  document.getElementById('filterInput').addEventListener('input', ()=>{ currentPage=1; renderAll(); });
  document.getElementById('refreshBtn').onclick = async ()=>{ await init(); };
  document.getElementById('clearBtn').onclick = ()=>{ selectedCompany=null; document.getElementById('filterInput').value=''; renderAll(); };
  document.getElementById('prevBtn').onclick = ()=>{ if (currentPage>1){ currentPage--; renderTable(); } };
  document.getElementById('nextBtn').onclick = ()=>{ const totalPages = Math.max(1, Math.ceil(filteredRows.length/PAGE_SIZE)); if (currentPage<totalPages){ currentPage++; renderTable(); } };

  document.querySelectorAll('thead th[data-key]').forEach(th=>{
    th.style.cursor='pointer';
    th.addEventListener('click', ()=>{
      const k = th.getAttribute('data-key');
      if (currentSort.key===k) currentSort.dir*=-1; else { currentSort.key=k; currentSort.dir=1; }
      renderTable();
    });
  });

  renderAll();

  // Keep charts synced to card resizes
  const ro = new ResizeObserver(()=>{ if (newsChart) newsChart.resize(); if (serpChart) serpChart.resize(); });
  ro.observe(document.getElementById('newsChart').parentElement);
  ro.observe(document.getElementById('serpChart').parentElement);
}

/********************** Data → view rows **********************/
async function buildRowsForDate(d){
  const articles = await getArticlesForDate(d); // Map(company -> {neg_pct})
  const serpAgg  = await getSerpAggForDate(d);  // Map(company -> {total,neg_serp,controlled})

  const out = [];
  for (const [company, a] of articles.entries()){
    const s = serpAgg.get(company);
    let negSerpPct=null, ctrlPct=null;
    if (s && s.total>0){ negSerpPct = s.neg_serp/s.total; ctrlPct = s.controlled/s.total; }
    const risk = computeRisk(negSerpPct, ctrlPct);
    out.push({
      date:d,
      company,
      neg_news:a.neg_pct ?? 0,
      neg_serp:negSerpPct,
      ctrl_pct:ctrlPct,
      risk
    });
  }
  return out;
}

/********************** Rendering **********************/
async function renderAll(){
  const d = document.getElementById('dateSelect').value;
  const filter = document.getElementById('filterInput').value.trim().toLowerCase();
  const rows = (await buildRowsForDate(d)).filter(r => !filter || r.company.toLowerCase().includes(filter));
  filteredRows = rows;
  currentPage = 1;
  // Auto-select when the filtered table contains exactly one brand
  if (rows.length === 1) {
    selectedCompany = rows[0].company;
  } else if (selectedCompany && !rows.some(r => r.company === selectedCompany)) {
    // Optional: clear a stale selection when it drops out of the filter
    selectedCompany = null;
  }
  renderTable();
  renderCharts();
}

function renderTable(){
  const tbody = document.getElementById('tbody');
  let rows = [...filteredRows];

  if (currentSort.key){
    rows.sort((a,b)=>{
      const ka=a[currentSort.key], kb=b[currentSort.key];
      if (typeof ka==='string') return currentSort.dir*ka.localeCompare(kb);
      return currentSort.dir*((ka??-1)-(kb??-1));
    });
  }

  const start = (currentPage-1)*PAGE_SIZE;
  const pageRows = rows.slice(start, start+PAGE_SIZE);
  tbody.innerHTML = pageRows.map(r=>{
    const checked = (selectedCompany && selectedCompany===r.company) ? 'checked' : '';
    return `<tr>
      <td><input type="checkbox" data-company="${esc(r.company)}" class="brandCheck" ${checked} /> ${esc(r.company)}</td>
      <td class="right">${fmtPct(r.neg_news)}</td>
      <td class="right">${fmtPct(r.neg_serp)}</td>
      <td class="right">${fmtPct(r.ctrl_pct)}</td>
      <td class="center">${
        (r.risk==='High'||r.risk==='Medium'||r.risk==='Low')
          ? (r.risk==='High'
              ? '<span class="pill high">High</span>'
              : r.risk==='Medium'
                ? '<span class="pill med">Medium</span>'
                : '<span class="pill low">Low</span>')
          : '<span class="muted">N/A</span>'
      }</td>
      <td class="center"><button class="headBtn" data-company="${esc(r.company)}">View</button></td>
      <td class="center"><button class="serpBtn" data-company="${esc(r.company)}">View</button></td>
    </tr>`;
  }).join('');

  // events
  tbody.querySelectorAll('.brandCheck').forEach(cb=>{
    cb.addEventListener('change',(e)=>{
      const company = e.target.getAttribute('data-company');
      if (e.target.checked){
        selectedCompany = company;
        tbody.querySelectorAll('.brandCheck').forEach(x=>{ if (x!==e.target) x.checked=false; });
      } else selectedCompany=null;
      renderCharts();
    });
  });
  tbody.querySelectorAll('.serpBtn').forEach(btn=>{
    btn.onclick = ()=> showSerp({ company: btn.getAttribute('data-company') });
  });
  tbody.querySelectorAll('.headBtn').forEach(btn=>{
    btn.onclick = ()=> showHeadlines({ company: btn.getAttribute('data-company') });
  });

  document.getElementById('pageNo').textContent = String(currentPage);
  document.getElementById('pageTotal').textContent = String(Math.max(1, Math.ceil(filteredRows.length/PAGE_SIZE)));
}

/********************** Charts **********************/
function getDateSeries(){
  const byDate = new Map();
  allCountsRows.forEach(r=>{
    const key=r.date;
    if (!byDate.has(key)) byDate.set(key,{pos:0,neu:0,neg:0});
    const b=byDate.get(key);
    if (!selectedCompany || r.company===selectedCompany){
      b.pos += +r.pos||0; b.neu += +r.neu||0; b.neg += +r.neg||0;
    }
  });

  const serpByDate = new Map();
  serpsDaily.forEach(r=>{
    const key=r.date;
    if (!serpByDate.has(key)) serpByDate.set(key,{total:0,neg:0,ctrl:0});
    if (!selectedCompany || r.company===selectedCompany){
      const b=serpByDate.get(key);
      b.total += +r.total||0; b.neg += +r.neg_serp||0; b.ctrl += +r.ctrl||0;
    }
  });

  const dates=[...new Set([...byDate.keys(),...serpByDate.keys()])].filter(isISODate).sort();
  const newsPos=[],newsNeu=[],newsNeg=[],serpNegPct=[],serpCtrlPct=[];
  dates.forEach(d=>{
    const n=byDate.get(d)||{pos:0,neu:0,neg:0};
    const t=n.pos+n.neu+n.neg||0;
    newsPos.push(t? n.pos/t*100 : 0);
    newsNeu.push(t? n.neu/t*100 : 0);
    newsNeg.push(t? n.neg/t*100 : 0);

    const s=serpByDate.get(d)||{total:0,neg:0,ctrl:0};
    serpNegPct.push(s.total? s.neg/s.total*100 : 0);
    serpCtrlPct.push(s.total? s.ctrl/s.total*100 : 0);
  });
  return {dates,newsPos,newsNeu,newsNeg,serpNegPct,serpCtrlPct};
}

function renderCharts(){
  const {dates, newsPos, newsNeu, newsNeg, serpNegPct, serpCtrlPct} = getDateSeries();

  // Initialize default window to the last 30 points (once per load)
  if (dateWindowStart === null){
    dateWindowStart = Math.max(0, dates.length - DATE_WINDOW_SIZE);
  }
  const start = clampDateStart(dates.length);
  const d  = sliceWindow(dates,       start, DATE_WINDOW_SIZE);
  const nP = sliceWindow(newsPos,     start, DATE_WINDOW_SIZE);
  const nN = sliceWindow(newsNeu,     start, DATE_WINDOW_SIZE);
  const nG = sliceWindow(newsNeg,     start, DATE_WINDOW_SIZE);
  const sN = sliceWindow(serpNegPct,  start, DATE_WINDOW_SIZE);
  const sC = sliceWindow(serpCtrlPct, start, DATE_WINDOW_SIZE);

  // Update UI + hook pager (both charts share the same handlers/state)
  updateDateRangeUI(dates);
  hookDatePager(dates);

  const who = selectedCompany ? selectedCompany : 'Index Average';
  const pct = v => `${Math.round(v)}%`;

  const commonOpts = {
    responsive:true, maintainAspectRatio:false,
    layout:{ padding:{ bottom:24 } },
    scales:{
      x:{ ticks:{color:'#ebf2f2'}, grid:{color:'rgba(255,255,255,.05)'} },
      y:{ ticks:{color:'#ebf2f2', stepSize:20, callback:v=>pct(v)},
          grid:{color:'rgba(255,255,255,.06)'}, suggestedMin:0, suggestedMax:100 }
    },
    plugins:{
      legend:{labels:{color:'#ebf2f2'}},
      title:{display:true, text:who, color:'#ebf2f2', font:{weight:'bold', size:14},
             padding:{top:10,bottom:6}},
      tooltip:{callbacks:{label:(ctx)=>`${ctx.dataset?.label?ctx.dataset.label+': ':''}${pct(typeof ctx.parsed.y==='number'?ctx.parsed.y:ctx.parsed)}`}}
    }
  };

  // News stacked bar
  const nh = document.getElementById('newsChart').getContext('2d');
  if (newsChart) newsChart.destroy();
  newsChart = new Chart(nh, {
    type:'bar',
    data:{ labels:d, datasets:[
      {label:'Positive %',data:nP, backgroundColor:'#82c618', stack:'s'},
      {label:'Neutral %', data:nN, backgroundColor:'#cfdbdd', stack:'s'},
      {label:'Negative %',data:nG, backgroundColor:'#ff8261', stack:'s'}
    ]},
    options:{...commonOpts}
  });
  
  // Compute index-wide averages across ALL days, excluding 0% and 100%
  const avgNegAll = avgPctExcludingExtremes(serpNegPct);
  const avgCtrlAll = avgPctExcludingExtremes(serpCtrlPct);
  
  // Flat lines over the current window size
  const avgNegLine = avgNegAll == null ? [] : new Array(d.length).fill(Math.round(avgNegAll));
  const avgCtrlLine = avgCtrlAll == null ? [] : new Array(d.length).fill(Math.round(avgCtrlAll));

  // ---- SERP LINE ----
  
  const sh = document.getElementById('serpChart').getContext('2d');
  if (serpChart) serpChart.destroy();
  
  const avgNegLine = INDEX_AVG_NEG  == null ? [] : new Array(d.length).fill(INDEX_AVG_NEG);
  const avgCtrlLine = INDEX_AVG_CTRL == null ? [] : new Array(d.length).fill(INDEX_AVG_CTRL);
  
  serpChart = new Chart(sh, {
    type: 'line',
    data: {
      labels: d,

      datasets: [
  // Daily (solid)
  {
    label: 'Daily Negative SERP %',
    data: sN,
    tension: 0.2,
    borderWidth: SOLID_WIDTH,
    fill: false,
    borderColor: NEG_COLOR,
    pointBackgroundColor: NEG_COLOR,
    pointBorderColor: NEG_COLOR
  },
  {
    label: 'Daily Control %',
    data: sC,
    tension: 0.2,
    borderWidth: SOLID_WIDTH,
    fill: false,
    borderColor: CTRL_COLOR,
    pointBackgroundColor: CTRL_COLOR,
    pointBorderColor: CTRL_COLOR
  },

  // Index averages (horizontal, dashed, no points)
  ...(avgNegLine.length ? [{
    label: 'Average Negative SERP %',
    data: avgNegLine,
    tension: 0,
    fill: false,
    borderWidth: DASH_WIDTH,
    borderDash: DASH_PATTERN,
    borderColor: NEG_COLOR,
    pointRadius: 0
  }] : []),

  ...(avgCtrlLine.length ? [{
    label: 'Average Daily Control %',
    data: avgCtrlLine,
    tension: 0,
    fill: false,
    borderWidth: DASH_WIDTH,
    borderDash: DASH_PATTERN,
    borderColor: CTRL_COLOR,
    pointRadius: 0
  }] : [])
]
    },
    options: { ...commonOpts }
  });
}

/********************** Modals **********************/
const modal=document.getElementById('modal');
const modalTitle=document.getElementById('modalTitle');
const modalContent=document.getElementById('modalContent');
document.getElementById('modalClose').onclick=()=>modal.classList.remove('open');
modal.addEventListener('click',e=>{ if (e.target===modal) modal.classList.remove('open'); });
function openModal(title,html){ modalTitle.textContent=title; modalContent.innerHTML=html; modal.classList.add('open'); }

// Headlines (brand)
async function showHeadlines({company}){
  const d=document.getElementById('dateSelect').value;
  let rows=[];
  try{ rows=await fetchCsv(HEADLINES_PATH(d)); }catch(e){
    openModal(`Headlines — ${esc(company)}`, `<div class="muted">Could not load headlines for ${d}.</div>`); return;
  }
  const list=rows.filter(r=>String(r.company||'').trim()===company);
  if (!list.length){ openModal(`Headlines — ${esc(company)}`, `<div class="muted">No headlines for ${esc(company)} on ${d}.</div>`); return; }

  const cards=list.map(r=>{
    const url=String(r.url||'').trim();
    let domain=''; try{ domain=new URL(url).hostname.replace(/^www\./,''); }catch{}
    const title=esc(r.title||domain||'(no title)');
    const link=url?`<a class="link" href="${esc(url)}" target="_blank" rel="noopener">${title}</a>`:`<span class="muted">${title}</span>`;
    const sRaw=String(r.sentiment||'').toLowerCase();
    const s=sRaw==='positive'?'positive':(sRaw==='negative'?'negative':'neutral');
    return `<div class="serp-card">
      ${domain?`<div class="serp-domain">${esc(domain)}</div>`:''}
      <div class="serp-title">${link}</div>
      <div class="badges" style="margin-top:8px"><span class="badge ${s}">${s}</span></div>
    </div>`;
  }).join('');

  openModal(`Headlines — ${esc(company)}`, `<div class="serp-cards">${cards}</div>`);
}

// SERP modal (brand)
async function showSerp({company}){
  const d=document.getElementById('dateSelect').value;
  let rows=[]; try{ rows=await fetchCsv(SERP_ROWS_PATH(d)); }
  catch{ openModal(`SERP — ${esc(company)}`, `<div class="muted">Could not load SERP file for ${d}.</div>`); return; }
  if (!rows.length){ openModal(`SERP — ${esc(company)}`, `<div class="muted">No SERP data found for ${d}.</div>`); return; }

  const canon=s=>String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,' ').trim();
  const wantCo=canon(company);
  const matches=rows.filter(r=>canon(r.company)===wantCo);
  if (!matches.length){ openModal(`SERP — ${esc(company)}`, `<div class="muted">No SERPs for ${esc(company)} on ${d}.</div>`); return; }

  const total=matches.length;
  const negCount=matches.filter(r=>String(r.sentiment||'').toLowerCase()==='negative').length;
  const ctrlCount=matches.filter(r=>(/^controlled|true|1$/i).test(String(r.controlled||''))).length;
  const negPct= total ? (negCount/total) : 0;
  const ctrlPct= total ? (ctrlCount/total) : 0;
  const risk=computeRisk(negPct,ctrlPct);

  matches.sort((a,b)=>(+a.position||9999)-(+b.position||9999));
  const cards=matches.map(r=>{
    const url=String(r.url||'').trim();
    let domain=''; try{ domain=new URL(url).hostname.replace(/^www\./,''); }catch{}
    const title=esc(r.title||domain||'(no title)');
    const snippet=esc(r.snippet||'');
    const s=String(r.sentiment||'neutral').toLowerCase();
    const ctrl=(/^controlled|true|1$/i).test(String(r.controlled||''))?'controlled':'uncontrolled';
    const link=url?`<a class="link" href="${esc(url)}" target="_blank" rel="noopener">${title}</a>`:`<span class="muted">${title}</span>`;
    return `<div class="serp-card">
      ${domain?`<div class="serp-domain">${esc(domain)}</div>`:''}
      <div class="serp-title">${link}</div>
      ${snippet?`<div class="serp-snippet">${snippet}</div>`:''}
      <div class="badges"><span class="badge ${s}">${s}</span><span class="badge ${ctrl}">${ctrl}</span></div>
    </div>`;
  }).join('');

  const metrics = `<div class="serp-metrics">
    <b>Negative SERP:</b> ${(negPct*100).toFixed(1)}% &nbsp;|&nbsp;
    <b>Control:</b> ${(ctrlPct*100).toFixed(1)}% &nbsp;|&nbsp;
    <b>Risk:</b> ${esc(risk)}
  </div>`;

  openModal(`SERP — ${esc(company)}`, `${metrics}<div class="serp-cards">${cards}</div>`);
}

/********************** Init **********************/
init();
</script>
</body>
</html>
