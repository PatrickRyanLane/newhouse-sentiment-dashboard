<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Brand Risk Dashboard</title>

<!-- Chart.js + PapaParse CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
:root{
  --bg:#044152; --card:#092e37; --muted:#a2ebf3; --text:#ebf2f2; --accent:#58dbed; --black:#1f2121;
  --pill-neg:#ff8261; --pill-neu:#cfdbdd; --pill-pos:#82c618;
  --stroke:#0e2230; --chip:#12343e; --chipBorder:#174550;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
.wrap{max-width:1200px;margin:0 auto;padding:20px}
h1{font-size:28px;margin:6px 0 18px}

/* Controls */
.controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:0 0 16px}
.card{background:var(--card);border:1px solid var(--stroke);border-radius:12px;padding:12px}
select,input[type="text"]{background:var(--black);border:1px solid #23314d;border-radius:10px;color:var(--text);padding:8px 10px}
button{background:var(--black);border:1px solid #2a3b5e;color:var(--text);border-radius:10px;padding:8px 12px;cursor:pointer}
button:hover{filter:brightness(1.08)}

/* Charts grid – equal heights, responsive */
.grid{
  display:grid;
  grid-template-rows:minmax(360px,42vh) minmax(360px,42vh);
  gap:16px;
  margin:16px 0;
}

/* Chart cards */
.chart-card{background:var(--card);border:1px solid var(--stroke);border-radius:12px;padding:12px 12px 48px;position:relative}
.chart-card canvas{width:100% !important;height:100% !important;display:block}

/* NEW: chart pagination controls (top-right) */
.chart-actions{
  position:absolute; top:10px; right:12px;
  display:flex; align-items:center; gap:10px;
}
.chart-actions .dates-range{ font-size:12px; }
.chart-actions .dates-pager{ display:flex; gap:6px; }
.chart-actions .dates-pager button{
  background:var(--black); border:1px solid #2a3b5e; color:var(--text);
  border-radius:8px; padding:4px 8px; cursor:pointer;
}
.chart-actions .dates-pager button[disabled]{ opacity:.45; cursor:not-allowed; }

/* Table */
.table-card{background:var(--card);border:1px solid var(--stroke);border-radius:12px;padding:10px}
.table-hint{margin:0 0 8px;color:var(--muted)}
.table-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch}
.table-scroll::-webkit-scrollbar{height:8px}
.table-scroll::-webkit-scrollbar-track{background:rgba(255,255,255,.05);border-radius:8px}
.table-scroll::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:8px}

table{width:100%;border-collapse:separate;border-spacing:0 6px;min-width:980px}
thead th{font-size:12px;color:var(--muted);text-align:left;padding:6px 8px}
tbody td{padding:10px 8px;background:var(--black);border-top:1px solid #0f1831;border-bottom:1px solid #0f1831}
tbody tr td:first-child{border-left:1px solid #0f1831;border-radius:10px 0 0 10px}
tbody tr td:last-child{border-right:1px solid #0f1831;border-radius:0 10px 10px 0}
.right{text-align:right}
.center{text-align:center}

.pill{font-size:12px;border-radius:999px;padding:3px 8px;border:1px solid var(--chipBorder);background:var(--chip);color:#cfe0ff}
.pill.low{background:rgba(130,198,24,.15);color:#82c618}
.pill.med{background:rgba(207,219,221,.25);color:#cfdbdd}
.pill.high{background:rgba(255,130,97,.15);color:#ff8261}
.link{color:var(--accent);text-decoration:underline}

@media (max-width:960px){
  .table-card{padding:8px}
  .table-hint{font-size:12px}
  thead th,tbody td{padding:8px 10px}
  .pill{font-size:11px}
}

/* Sticky first column (Company + checkbox) */
thead th:first-child, tbody td:first-child{
  position:sticky;left:0;z-index:2;box-shadow:2px 0 0 0 rgba(255,255,255,.06);
}

/* Pagination */
.pagination{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:8px}

/* Modal (z-index > sticky) */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:24px;z-index:10000}
.modal.open{display:flex}
.modal .box{max-width:900px;width:100%;max-height:85vh;overflow:auto;background:#0e152a;border:1px solid #1b2745;border-radius:16px;position:relative;z-index:10001}
.modal header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #12203d}
.modal header h3{margin:0;font-size:16px}
.modal .content{padding:16px}
.badges{display:flex;gap:8px;margin-top:8px}
.badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid transparent}
.badge.positive{background:rgba(130,198,24,.15);color:#82c618;border-color:rgba(130,198,24,.35)}
.badge.neutral{background:rgba(207,219,221,.25);color:#cfdbdd;border-color:rgba(207,219,221,.45)}
.badge.negative{background:rgba(255,130,97,.15);color:#ff8261;border-color:rgba(255,130,97,.35)}
.badge.controlled{background:rgba(88,219,237,.15);color:#58dbed;border-color:rgba(88,219,237,.35)}
.badge.uncontrolled{background:rgba(255,130,97,.15);color:#ff8261;border-color:rgba(255,130,97,.35)}
.muted{color:var(--muted)}

/* SERP cards */
.serp-cards{display:grid;gap:12px;margin-top:12px}
.serp-card{background:var(--card);border:1px solid var(--stroke);border-radius:12px;padding:14px 16px}
.serp-domain{font-size:12px;color:var(--muted);margin-bottom:4px}
.serp-title a{color:var(--text);text-decoration:underline}
.serp-snippet{color:var(--muted);margin-top:6px;line-height:1.35}
.serp-metrics{margin:4px 0 0;color:var(--muted)}
.serp-metrics b{color:var(--text)}
</style>
</head>

<body>
<div class="wrap">
  <h1>Brand Risk Dashboard</h1>

  <div class="controls card">
    <div>
      <div class="muted" style="font-size:12px;margin:0 0 4px">Date</div>
      <select id="dateSelect"></select>
    </div>
    <div style="flex:1 1 420px">
      <div class="muted" style="font-size:12px;margin:0 0 4px">Filter (Company)</div>
      <input id="filterInput" type="text" placeholder="Type to filter…" />
    </div>
    <button id="refreshBtn">Refresh Data</button>
    <button id="clearBtn">Clear Selection</button>
  </div>

  <div class="grid">
    <div class="chart-card">
      <h3>News sentiment (percent of articles)</h3>
      <!-- NEW: range + pager (synced) -->
      <div class="chart-actions">
        <span class="dates-range muted" aria-live="polite"></span>
        <div class="dates-pager">
          <button class="dates-prev" title="Older window">←</button>
          <button class="dates-next" title="Newer window">→</button>
        </div>
      </div>
      <canvas id="newsChart"></canvas>
    </div>
    <div class="chart-card">
      <h3>SERP (Negative % • Control %)</h3>
      <!-- NEW: range + pager (synced) -->
      <div class="chart-actions">
        <span class="dates-range muted" aria-live="polite"></span>
        <div class="dates-pager">
          <button class="dates-prev" title="Older window">←</button>
          <button class="dates-next" title="Newer window">→</button>
        </div>
      </div>
      <canvas id="serpChart"></canvas>
    </div>
  </div>

  <div class="table-card">
    <p class="table-hint">Select a company using the checkbox to view its trend lines.</p>
    <div class="table-scroll">
      <table>
        <thead>
          <tr>
            <th>Company</th>
            <th data-key="neg_news" class="right">Negative News % ▲▼</th>
            <th data-key="neg_serp" class="right">Negative SERP % ▲▼</th>
            <th data-key="ctrl_pct" class="right">SERP Control % ▲▼</th>
            <th data-key="risk" class="center">Risk ▲▼</th>
            <th class="center">Headlines</th>
            <th class="center">SERP</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="pagination">
      <button id="prevBtn">Prev</button>
      <div>Page <span id="pageNo">1</span> / <span id="pageTotal">1</span></div>
      <button id="nextBtn">Next</button>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="box">
    <header>
      <h3 id="modalTitle">Title</h3>
      <button id="modalClose">Close</button>
    </header>
    <div class="content" id="modalContent"></div>
  </div>
</div>

<script>
/********************** Config (brand) **********************/
const COUNTS_CANDIDATES   = ['data/processed_articles/daily_counts.csv'];
const SERPS_DAILY_CSV     = 'data/serps/brand_serps_daily.csv';
const ARTICLES_DAILY_PATH = d => `data/processed_articles/${d}.csv`;     // table
const HEADLINES_PATH      = d => `data/articles/${d}-articles.csv`;       // modal
const SERP_PROCESSED_PATH = d => `data/processed_serps/${d}-brand-serps-processed.csv`;
const SERP_ROWS_PATH      = d => `data/serp_rows/${d}-brand-serps-rows.csv`;

/********************** Runtime **********************/
let allCountsRows = [];   // news counts (for charts)  [{date,company,pos,neu,neg}]
let serpsDaily    = [];   // serp aggregates for charts [{date,company,total,neg_serp,ctrl}]
let filteredRows  = [];   // table rows for current date/filter
let selectedCompany = null;
let currentSort = { key:null, dir:1 };
let currentPage = 1;
const PAGE_SIZE = 25;

let newsChart, serpChart;

// per-date caches
const _articlesCache = new Map(); // date -> Map(company -> {neg_pct})
const _serpAggCache  = new Map(); // date -> Map(company -> {total, neg_serp, controlled})

/* ===== NEW: synced chart pagination state ===== */
const DATE_WINDOW_SIZE = 30;  // show 30 dates at a time
let dateWindowStart = null;   // index of first date in window (shared)

/********************** Utils **********************/
const isISODate = s => /^\d{4}-\d{2}-\d{2}$/.test(String(s||'').trim());
const esc = (s) => String(s ?? '').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const fmtPct = (v) => (v==null) ? 'N/A' : Math.round(v*100)+'%';

/* ===== NEW: pager helpers ===== */
function clampDateStart(total){
  if (total <= DATE_WINDOW_SIZE) return 0;
  const maxStart = total - DATE_WINDOW_SIZE;
  const start = (dateWindowStart ?? maxStart);
  return Math.min(Math.max(0, start), maxStart);
}
function sliceWindow(arr, start, size){ return arr.slice(start, start + size); }
function updateDateRangeUI(allDates){
  const start = clampDateStart(allDates.length);
  const end = Math.min(allDates.length, start + DATE_WINDOW_SIZE);
  const label = allDates.length ? `${allDates[start]} — ${allDates[end-1]}` : '';
  document.querySelectorAll('.dates-range').forEach(el => el.textContent = label);

  const atStart = start === 0;
  const atEnd = (start + DATE_WINDOW_SIZE) >= allDates.length;
  document.querySelectorAll('.dates-prev').forEach(b => b.disabled = atStart);
  document.querySelectorAll('.dates-next').forEach(b => b.disabled = atEnd);
}
function hookDatePager(allDates){
  const goPrev = () => {
    const total = allDates.length;
    if (total <= DATE_WINDOW_SIZE) return;
    dateWindowStart = clampDateStart(total) - DATE_WINDOW_SIZE;
    if (dateWindowStart < 0) dateWindowStart = 0;
    renderCharts();
  };
  const goNext = () => {
    const total = allDates.length;
    if (total <= DATE_WINDOW_SIZE) return;
    const maxStart = total - DATE_WINDOW_SIZE;
    dateWindowStart = Math.min(maxStart, clampDateStart(total) + DATE_WINDOW_SIZE);
    renderCharts();
  };
  document.querySelectorAll('.dates-prev').forEach(b => b.onclick = goPrev);
  document.querySelectorAll('.dates-next').forEach(b => b.onclick = goNext);
}

/********************** CSV helpers **********************/
async function fetchCsv(url){
  const r = await fetch(url, {cache:'no-store'});
  if (!r.ok) throw new Error(`HTTP ${r.status} for ${url}`);
  const t = await r.text();
  return await new Promise((res,rej)=>Papa.parse(t,{header:true,skipEmptyLines:true,complete:o=>res(o.data||[]),error:e=>rej(e)}));
}
async function fetchCsvAny(cands){
  for (const u of cands){ try{ const rows = await fetchCsv(u); if (Array.isArray(rows)) return rows; } catch{} }
  return [];
}

/********************** Loaders **********************/
async function loadCounts(){
  const rows = await fetchCsvAny(COUNTS_CANDIDATES);
  allCountsRows = rows.map(r=>({
    date: String(r.date||'').trim(),
    company: String(r.company||'').trim(),
    pos: +r.positive||0,
    neu: +r.neutral||0,
    neg: +r.negative||0
  })).filter(r=>isISODate(r.date) && r.company);
}
async function loadSerpDaily(){
  try{
    const rows = await fetchCsv(SERPS_DAILY_CSV);
    serpsDaily = rows.map(r=>({
      date:(r.date||'').trim(),
      company:(r.company||'').trim(),
      total:+r.total||0,
      neg_serp:+r.negative_serp||+r.neg_serp||0,
      ctrl:+r.controlled||+r.control||0
    })).filter(r=>isISODate(r.date) && r.company);
  }catch(e){ serpsDaily = []; }
}

/********************** Risk **********************/
function computeRisk(negPct, ctrlPct){
  const n = (negPct ?? 0)*100, c = (ctrlPct ?? 0)*100;
  if (negPct==null || ctrlPct==null) return 'N/A';
  if (n >= 40 || c < 25) return 'High';
  if (n >= 25 || c < 50) return 'Medium';
  return 'Low';
}

/********************** Per-date sources **********************/
function toPct01(x){
  if (x==null || x==='') return null;
  const n = +String(x).replace('%','').trim();
  if (!isFinite(n)) return null;
  return n>1 ? n/100 : n;
}

// data/processed_articles/<DATE>.csv -> Map(company -> {neg_pct})
async function getArticlesForDate(d){
  if (_articlesCache.has(d)) return _articlesCache.get(d);
  const map = new Map();
  try{
    const rows = await fetchCsv(ARTICLES_DAILY_PATH(d));
    rows.forEach(r=>{
      const company = String(r.company||'').trim();
      if (!company) return;
      let neg = toPct01(r.neg_pct);
      if (neg==null){
        const negCount = +r.negative||0;
        const tot = (+r.total) || ((+r.positive||0)+(+r.neutral||0)+negCount) || 0;
        neg = tot ? (negCount/tot) : 0;
      }
      map.set(company, { neg_pct: neg });
    });
  }catch{}
  _articlesCache.set(d,map);
  return map;
}

// data/processed_serps/<DATE>-brand-serps-processed.csv -> Map(company -> {total, neg_serp, controlled})
async function getSerpAggForDate(d){
  if (_serpAggCache.has(d)) return _serpAggCache.get(d);
  const map = new Map();
  try{
    const rows = await fetchCsv(SERP_PROCESSED_PATH(d));
    rows.forEach(r=>{
      const company = String(r.company||'').trim();
      if (!company) return;
      map.set(company,{ total:+r.total||0, neg_serp:+r.negative_serp||0, controlled:+r.controlled||0 });
    });
  }catch{}
  _serpAggCache.set(d,map);
  return map;
}

/********************** UI bootstrap **********************/
async function init(){
  await Promise.all([loadCounts(), loadSerpDaily()]);
  const dateSet = new Set([ ...allCountsRows.map(r=>r.date), ...serpsDaily.map(r=>r.date) ].filter(isISODate));
  const dates = [...dateSet].sort();
  const sel = document.getElementById('dateSelect');
  sel.innerHTML = dates.map(d=>`<option value="${d}">${d}</option>`).join('');
  sel.value = dates[dates.length-1] || '';
  sel.addEventListener('change', ()=>{ currentPage=1; selectedCompany=null; renderAll(); });

  document.getElementById('filterInput').addEventListener('input', ()=>{ currentPage=1; renderAll(); });
  document.getElementById('refreshBtn').onclick = async ()=>{ await init(); };
  document.getElementById('clearBtn').onclick = ()=>{ selectedCompany=null; document.getElementById('filterInput').value=''; renderAll(); };
  document.getElementById('prevBtn').onclick = ()=>{ if (currentPage>1){ currentPage--; renderTable(); } };
  document.getElementById('nextBtn').onclick = ()=>{ const totalPages = Math.max(1, Math.ceil(filteredRows.length/PAGE_SIZE)); if (currentPage<totalPages){ currentPage++; renderTable(); } };

  document.querySelectorAll('thead th[data-key]').forEach(th=>{
    th.style.cursor='pointer';
    th.addEventListener('click', ()=>{
      const k = th.getAttribute('data-key');
      if (currentSort.key===k) currentSort.dir*=-1; else { currentSort.key=k; currentSort.dir=1; }
      renderTable();
    });
  });

  renderAll();

  // Keep charts synced to card resizes
  const ro = new ResizeObserver(()=>{ if (newsChart) newsChart.resize(); if (serpChart) serpChart.resize(); });
  ro.observe(document.getElementById('newsChart').parentElement);
  ro.observe(document.getElementById('serpChart').parentElement);
}

/********************** Data → view rows **********************/
async function buildRowsForDate(d){
  const articles = await getArticlesForDate(d); // Map(company -> {neg_pct})
  const serpAgg  = await getSerpAggForDate(d);  // Map(company -> {total,neg_serp,controlled})

  const out = [];
  for (const [company, a] of articles.entries()){
    const s = serpAgg.get(company);
    let negSerpPct=null, ctrlPct=null;
    if (s && s.total>0){ negSerpPct = s.neg_serp/s.total; ctrlPct = s.controlled/s.total; }
    const risk = computeRisk(negSerpPct, ctrlPct);
    out.push({
      date:d,
      company,
      neg_news:a.neg_pct ?? 0,
      neg_serp:negSerpPct,
      ctrl_pct:ctrlPct,
      risk
    });
  }
  return out;
}

/********************** Rendering **********************/
async function renderAll(){
  const d = document.getElementById('dateSelect').value;
  const filter = document.getElementById('filterInput').value.trim().toLowerCase();
  const rows = (await buildRowsForDate(d)).filter(r => !filter || r.company.toLowerCase().includes(filter));
  filteredRows = rows;
  currentPage = 1;
  renderTable();
  renderCharts();
}

function renderTable(){
  const tbody = document.getElementById('tbody');
  let rows = [...filteredRows];

  if (currentSort.key){
    rows.sort((a,b)=>{
      const ka=a[currentSort.key], kb=b[currentSort.key];
      if (typeof ka==='string') return currentSort.dir*ka.localeCompare(kb);
      return currentSort.dir*((ka??-1)-(kb??-1));
    });
  }

  const start = (currentPage-1)*PAGE_SIZE;
  const pageRows = rows.slice(start, start+PAGE_SIZE);
  tbody.innerHTML = pageRows.map(r=>{
    const checked = (selectedCompany && selectedCompany===r.company) ? 'checked' : '';
    return `<tr>
      <td><input type="checkbox" data-company="${esc(r.company)}" class="brandCheck" ${checked} /> ${esc(r.company)}</td>
      <td class="right">${fmtPct(r.neg_news)}</td>
      <td class="right">${fmtPct(r.neg_serp)}</td>
      <td class="right">${fmtPct(r.ctrl_pct)}</td>
      <td class="center">${
        (r.risk==='High'||r.risk==='Medium'||r.risk==='Low')
          ? (r.risk==='High'
              ? '<span class="pill high">High</span>'
              : r.risk==='Medium'
                ? '<span class="pill med">Medium</span>'
                : '<span class="pill low">Low</span>')
          : '<span class="muted">N/A</span>'
      }</td>
      <td class="center"><button class="headBtn" data-company="${esc(r.company)}">View</button></td>
      <td class="center"><button class="serpBtn" data-company="${esc(r.company)}">View</button></td>
    </tr>`;
  }).join('');

  // events
  tbody.querySelectorAll('.brandCheck').forEach(cb=>{
    cb.addEventListener('change',(e)=>{
      const company = e.target.getAttribute('data-company');
      if (e.target.checked){
        selectedCompany = company;
        tbody.querySelectorAll('.brandCheck').forEach(x=>{ if (x!==e.target) x.checked=false; });
      } else selectedCompany=null;
      renderCharts();
    });
  });
  tbody.querySelectorAll('.serpBtn').forEach(btn=>{
    btn.onclick = ()=> showSerp({ company: btn.getAttribute('data-company') });
  });
  tbody.querySelectorAll('.headBtn').forEach(btn=>{
    btn.onclick = ()=> showHeadlines({ company: btn.getAttribute('data-company') });
  });

  document.getElementById('pageNo').textContent = String(currentPage);
  document.getElementById('pageTotal').textContent = String(Math.max(1, Math.ceil(filteredRows.length/PAGE_SIZE)));
}

/********************** Charts (windowed + synced) **********************/
function getDateSeries(){
  const byDate = new Map();
  allCountsRows.forEach(r=>{
    const key=r.date;
    if (!byDate.has(key)) byDate.set(key,{pos:0,neu:0,neg:0});
    const b=byDate.get(key);
    if (!selectedCompany || r.company===selectedCompany){
      b.pos += +r.pos||0; b.neu += +r.neu||0; b.neg += +r.neg||0;
    }
  });

  const serpByDate = new Map();
  serpsDaily.forEach(r=>{
