<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Brand Risk Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#052f35;
      --panel:#073b44;
      --text:#ebf2f2;
      --muted:#a8bbbf;
      --pos:#82c618;
      --neu:#cfdbdd;
      --neg:#ff8261;     /* match CEO */
      --ctrl:#6ad3e6;    /* match CEO */
      --card-radius:16px;
    }
    html,body{margin:0;background:#04282d;color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1200px;margin:auto;padding:16px}
    .controls{display:flex;gap:12px;align-items:center;margin-bottom:12px}
    .controls input,.controls select,.controls button{
      background:#102e34;border:1px solid #234651;color:var(--text);
      border-radius:10px;padding:8px 10px
    }
    .card{background:var(--panel);border-radius:var(--card-radius);padding:14px;margin-bottom:16px;position:relative}
    .card h3{margin:0 0 10px 0}
    .chart-actions{
      position:absolute;top:10px;right:12px;display:flex;align-items:center;gap:10px
    }
    .dates-range{font-size:12px;color:var(--muted)}
    .dates-pager{display:flex;gap:6px}
    .dates-pager button{
      background:#1f2121;border:1px solid #2a3b5e;color:var(--text);
      border-radius:8px;padding:4px 8px;cursor:pointer
    }
    .dates-pager button[disabled]{opacity:.45;cursor:not-allowed}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    .legend{display:flex;gap:12px;align-items:center;color:var(--muted);font-size:12px}
    .legend .sw{display:inline-block;width:12px;height:12px;border-radius:2px;margin-right:6px}
    .table-wrap{overflow:auto}
    table{width:100%;border-collapse:collapse}
    thead th{position:sticky;top:0;background:#0a4650}
    th,td{padding:8px;border-bottom:1px solid #10464f;text-align:left;white-space:nowrap}
    #companyList{display:flex;flex-wrap:wrap;gap:10px;margin-top:6px}
    .badge{background:#0d3d46;border:1px solid #1b6673;border-radius:999px;padding:6px 10px}
    .muted{color:var(--muted)}
    canvas{width:100%;height:340px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="controls">
      <label>Date
        <select id="dateSelect"></select>
      </label>
      <label>Filter (Company)
        <input id="searchCompany" type="search" placeholder="type to filter…" />
      </label>
      <button id="refreshBtn">Refresh Data</button>
      <button id="clearBtn">Clear Selection</button>
      <span class="muted" id="lastRefresh" style="margin-left:auto"></span>
    </div>

    <div class="card">
      <h3>News sentiment (percent of articles)</h3>
      <div class="chart-actions">
        <span class="dates-range muted" id="rangeNews"></span>
        <div class="dates-pager">
          <button id="newsPrev">←</button>
          <button id="newsNext">→</button>
        </div>
      </div>
      <canvas id="newsChart"></canvas>
      <div class="legend" style="margin-top:8px">
        <span><span class="sw" style="background:var(--pos)"></span>Positive %</span>
        <span><span class="sw" style="background:var(--neu)"></span>Neutral %</span>
        <span><span class="sw" style="background:var(--neg)"></span>Negative %</span>
      </div>
    </div>

    <div class="card">
      <h3>SERP (Negative % • Control %)</h3>
      <div class="chart-actions">
        <span class="dates-range muted" id="rangeSerp"></span>
        <div class="dates-pager">
          <button id="serpPrev">←</button>
          <button id="serpNext">→</button>
        </div>
      </div>
      <canvas id="serpChart"></canvas>
      <div class="legend" style="margin-top:8px">
        <span><span class="sw" style="background:var(--neg)"></span>Negative SERP %</span>
        <span><span class="sw" style="background:var(--ctrl)"></span>Control %</span>
      </div>
    </div>

    <div class="card">
      <h3 style="margin-bottom:6px">Companies</h3>
      <div id="companyList"><!-- checkboxes injected here --></div>
      <div class="table-wrap" style="margin-top:12px">
        <table id="brandsTable">
          <thead>
            <tr>
              <th>Pick</th>
              <th>Company</th>
              <th>Negative News %</th>
              <th>Negative SERP %</th>
              <th>SERP Control %</th>
              <th>Risk</th>
            </tr>
          </thead>
          <tbody><!-- rows injected here --></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
  // -------------------------------
  // Minimal state
  // -------------------------------
  let newsChart = null, serpChart = null;
  let selectedCompany = null; // null = Index Average
  const DATE_WINDOW_SIZE = 30;
  let dateWindowStart = null;

  // -------------------------------
  // Utilities (placeholders where you already have them)
  // -------------------------------
  const pct = (v)=> (v==null? 'N/A' : `${Math.round(v*100)}%`);
  const toPct01 = (v)=> {
    if (v==null || v==='') return null;
    const n = +v;
    return Number.isFinite(n) ? (n>1? n/100 : n) : null;
  };

  // You likely already have real loaders; here we assume these exist:
  async function loadAllData(){ /* your existing loaders */ }
  function getDateSeries(){
    // return structure from your existing code:
    // { dates, newsPos, newsNeu, newsNeg, serpNegPct, serpCtrlPct }
    return window.__brandSeries || {dates:[],newsPos:[],newsNeu:[],newsNeg:[],serpNegPct:[],serpCtrlPct:[]};
  }

  // -------------------------------
  // Search → chart selection helpers
  // -------------------------------
  function selectCompany(name) {
    selectedCompany = name || null;
    // Sync checkboxes
    document.querySelectorAll('.company-checkbox').forEach(cb => {
      cb.checked = (name && cb.dataset.company === name);
    });
    renderCharts();
  }

  function clearCompanySelection() {
    selectedCompany = null;
    document.querySelectorAll('.company-checkbox').forEach(cb => (cb.checked = false));
    renderCharts();
  }

  function visibleCompaniesFromTable() {
    const rows = [...document.querySelectorAll('#brandsTable tbody tr')];
    return rows
      .filter(r => r.offsetParent !== null) // visible after filter
      .map(r => (r.dataset.company || r.querySelector('[data-col="company"]')?.textContent || '').trim())
      .filter(Boolean);
  }

  function syncChartsToSearch() {
    const q = document.getElementById('searchCompany').value.trim();
    if (!q) return; // user cleared search => keep current selection
    const matches = visibleCompaniesFromTable();
    if (matches.length === 0) {
      clearCompanySelection();  // back to Index Average
    } else if (matches.length === 1) {
      selectCompany(matches[0]); // auto-select the single match
    } else {
      // >1 match: leave selection unchanged
    }
  }

  // -------------------------------
  // Table filter wiring
  // -------------------------------
  function applyTableFilter() {
    const q = document.getElementById('searchCompany').value.trim().toLowerCase();
    const rows = document.querySelectorAll('#brandsTable tbody tr');
    rows.forEach(r => {
      const company = (r.dataset.company || r.querySelector('[data-col="company"]')?.textContent || '').toLowerCase();
      r.style.display = company.includes(q) ? '' : 'none';
    });
    syncChartsToSearch();
  }

  // -------------------------------
  // Pagination helpers (shared)
  // -------------------------------
  function clampDateStart(total){
    if (total <= DATE_WINDOW_SIZE) return 0;
    const maxStart = total - DATE_WINDOW_SIZE;
    const start = (dateWindowStart ?? maxStart);
    return Math.min(Math.max(0, start), maxStart);
  }
  function sliceWindow(arr, start, size){ return arr.slice(start, start + size); }
  function updateDateRangeUI(allDates){
    const start = clampDateStart(allDates.length);
    const end = Math.min(allDates.length, start + DATE_WINDOW_SIZE);
    const label = allDates.length ? `${allDates[start]} — ${allDates[end - 1]}` : '';
    document.getElementById('rangeNews').textContent = label;
    document.getElementById('rangeSerp').textContent = label;

    const atStart = start === 0;
    const atEnd   = (start + DATE_WINDOW_SIZE) >= allDates.length;
    document.getElementById('newsPrev').disabled = atStart;
    document.getElementById('serpPrev').disabled = atStart;
    document.getElementById('newsNext').disabled = atEnd;
    document.getElementById('serpNext').disabled = atEnd;
  }
  function attachPagers(dates){
    const goPrev = () => {
      const total = dates.length;
      if (total <= DATE_WINDOW_SIZE) return;
      dateWindowStart = clampDateStart(total) - DATE_WINDOW_SIZE;
      if (dateWindowStart < 0) dateWindowStart = 0;
      renderCharts();
    };
    const goNext = () => {
      const total = dates.length;
      if (total <= DATE_WINDOW_SIZE) return;
      const maxStart = total - DATE_WINDOW_SIZE;
      dateWindowStart = Math.min(maxStart, clampDateStart(total) + DATE_WINDOW_SIZE);
      renderCharts();
    };
    document.getElementById('newsPrev').onclick = goPrev;
    document.getElementById('serpPrev').onclick = goPrev;
    document.getElementById('newsNext').onclick = goNext;
    document.getElementById('serpNext').onclick = goNext;
  }

  // -------------------------------
  // Render charts (news + serp)
  // -------------------------------
  function renderCharts(){
    const {dates, newsPos, newsNeu, newsNeg, serpNegPct, serpCtrlPct} = getDateSeries();

    if (dateWindowStart === null){
      dateWindowStart = Math.max(0, dates.length - DATE_WINDOW_SIZE);
    }
    const start = clampDateStart(dates.length);
    const d  = sliceWindow(dates,       start, DATE_WINDOW_SIZE);
    const nP = sliceWindow(newsPos,     start, DATE_WINDOW_SIZE);
    const nN = sliceWindow(newsNeu,     start, DATE_WINDOW_SIZE);
    const nG = sliceWindow(newsNeg,     start, DATE_WINDOW_SIZE);
    const sN = sliceWindow(serpNegPct,  start, DATE_WINDOW_SIZE);
    const sC = sliceWindow(serpCtrlPct, start, DATE_WINDOW_SIZE);

    updateDateRangeUI(dates);
    attachPagers(dates);

    const who = selectedCompany ? selectedCompany : 'Index Average';

    const commonOpts = {
      responsive:true, maintainAspectRatio:false,
      layout:{ padding:{ bottom:24 } },
      scales:{
        x:{ ticks:{color:varText()}, grid:{color:'rgba(255,255,255,.05)'} },
        y:{ ticks:{color:varText(), stepSize:20, callback:v=>`${v}%`},
            grid:{color:'rgba(255,255,255,.06)'}, suggestedMin:0, suggestedMax:100 }
      },
      plugins:{
        legend:{labels:{color:varText()}},
        title:{display:true, text:who, color:varText(), font:{weight:'bold', size:16},
               padding:{top:6,bottom:6}},
        tooltip:{callbacks:{label:(ctx)=>{
          const y = typeof ctx.parsed.y==='number'? ctx.parsed.y : ctx.parsed;
          return `${ctx.dataset.label}: ${Math.round(y)}%`;
        }}}
      }
    };

    // News stacked bar
    const nh = document.getElementById('newsChart').getContext('2d');
    if (newsChart) newsChart.destroy();
    newsChart = new Chart(nh, {
      type:'bar',
      data:{ labels:d, datasets:[
        {label:'Positive %',data:nP, backgroundColor:getComputedStyle(document.documentElement).getPropertyValue('--pos').trim(), stack:'s'},
        {label:'Neutral %', data:nN, backgroundColor:getComputedStyle(document.documentElement).getPropertyValue('--neu').trim(), stack:'s'},
        {label:'Negative %',data:nG, backgroundColor:getComputedStyle(document.documentElement).getPropertyValue('--neg').trim(), stack:'s'}
      ]},
      options:{...commonOpts}
    });

    // SERP line (match CEO colors)
    const sh = document.getElementById('serpChart').getContext('2d');
    if (serpChart) serpChart.destroy();
    serpChart = new Chart(sh, {
      type:'line',
      data:{ labels:d, datasets:[
        {
          label:'Negative SERP %',
          data:sN, tension:.2, borderWidth:2, fill:false,
          borderColor:getComputedStyle(document.documentElement).getPropertyValue('--neg').trim(),
          pointBackgroundColor:getComputedStyle(document.documentElement).getPropertyValue('--neg').trim(),
          pointBorderColor:getComputedStyle(document.documentElement).getPropertyValue('--neg').trim()
        },
        {
          label:'Control %',
          data:sC, tension:.2, borderWidth:2, fill:false,
          borderColor:getComputedStyle(document.documentElement).getPropertyValue('--ctrl').trim(),
          pointBackgroundColor:getComputedStyle(document.documentElement).getPropertyValue('--ctrl').trim(),
          pointBorderColor:getComputedStyle(document.documentElement).getPropertyValue('--ctrl').trim()
        }
      ]},
      options:{...commonOpts}
    });
  }

  function varText(){ return getComputedStyle(document.documentElement).getPropertyValue('--text').trim(); }

  // -------------------------------
  // Init / wiring
  // -------------------------------
  async function init(){
    // Load data (replace with your existing init/load pipeline)
    await loadAllData();

    // Wire search filter
    const searchInput = document.getElementById('searchCompany');
    searchInput.addEventListener('input', applyTableFilter);

    // Wire refresh / clear
    document.getElementById('refreshBtn').addEventListener('click', async ()=>{
      dateWindowStart = null; // reset pager to show most-recent window
      await loadAllData();
      applyTableFilter();
      renderCharts();
      document.getElementById('lastRefresh').textContent = `Refreshed ${new Date().toLocaleString()}`;
    });
    document.getElementById('clearBtn').addEventListener('click', ()=>{
      document.getElementById('searchCompany').value = '';
      applyTableFilter();
      clearCompanySelection();
    });

    // Checkbox ↔ charts single-select (event delegation)
    const listEl = document.querySelector('#companyList');
    if (listEl){
      listEl.addEventListener('change', (e)=>{
        const cb = e.target.closest('.company-checkbox');
        if (!cb) return;
        if (cb.checked){
          listEl.querySelectorAll('.company-checkbox').forEach(x => { if (x !== cb) x.checked = false; });
          selectCompany(cb.dataset.company);
        }else{
          clearCompanySelection();
        }
      });
    }

    // First render
    applyTableFilter(); // also syncs charts if only one match
    renderCharts();
  }

  // Kickoff
  init();
  </script>
</body>
</html>
