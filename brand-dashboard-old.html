<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Brand Risk Dashboard</title>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
:root{
  --bg:#044152; --card:#092e37; --muted:#a2ebf3; --text:#ebf2f2; --accent:#58dbed; --black:#1f2121;
  --pill-neg:#ff8261; --pill-neu:#cfdbdd; --pill-pos:#82c618;
  --stroke:#0e2230; --chip:#12343e; --chipBorder:#174550;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
.wrap{max-width:1200px;margin:0 auto;padding:20px}
h1{font-size:28px;margin:6px 0 18px}

/* Controls */
.controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:0 0 16px}
.card{background:var(--card);border:1px solid var(--stroke);border-radius:12px;padding:12px}
select,input[type="text"]{background:var(--black);border:1px solid #23314d;border-radius:10px;color:var(--text);padding:8px 10px}
button{background:var(--black);border:1px solid #2a3b5e;color:var(--text);border-radius:10px;padding:8px 12px;cursor:pointer}
button:hover{filter:brightness(1.08)}

/* Charts grid */
.grid{display:grid;grid-template-rows:minmax(360px,42vh) minmax(360px,42vh);gap:16px;margin:16px 0}
.chart-card{background:var(--card);border:1px solid var(--stroke);border-radius:12px;padding:12px 12px 48px;position:relative}
.chart-card canvas{width:100% !important;height:100% !important;display:block}
.chart-actions{position:absolute;top:10px;right:12px;display:flex;align-items:center;gap:10px}
.chart-actions .dates-range{font-size:12px}
.chart-actions .dates-pager{display:flex;gap:6px}
.chart-actions .dates-pager button{background:#1f2121;border:1px solid #2a3b5e;color:var(--text);border-radius:8px;padding:4px 8px;cursor:pointer}
.chart-actions .dates-pager button[disabled]{opacity:.45;cursor:not-allowed}

/* Table */
.table-card{background:var(--card);border:1px solid var(--stroke);border-radius:12px;padding:10px}
.table-hint{margin:0 0 8px;color:var(--muted)}
.table-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch}
.table-scroll::-webkit-scrollbar{height:8px}
.table-scroll::-webkit-scrollbar-track{background:rgba(255,255,255,.05);border-radius:8px}
.table-scroll::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:8px}

table{width:100%;border-collapse:separate;border-spacing:0 6px;min-width:980px}
thead th{font-size:12px;color:var(--muted);text-align:left;padding:6px 8px}
tbody td{padding:10px 8px;background:var(--black);border-top:1px solid #0f1831;border-bottom:1px solid #0f1831}
tbody tr td:first-child{border-left:1px solid #0f1831;border-radius:10px 0 0 10px}
tbody tr td:last-child{border-right:1px solid #0f1831;border-radius:0 10px 10px 0}
.right{text-align:right}
.center{text-align:center}

.pill{font-size:12px;border-radius:999px;padding:3px 8px;border:1px solid var(--chipBorder);background:var(--chip);color:#cfe0ff}
.pill.low{background:rgba(130,198,24,.15);color:#82c618}
.pill.med{background:rgba(207,219,221,.25);color:#cfdbdd}
.pill.high{background:rgba(255,130,97,.15);color:#ff8261}
.link{color:var(--accent);text-decoration:underline}

@media (max-width:960px){
  .table-card{padding:8px}
  .table-hint{font-size:12px}
  thead th,tbody td{padding:8px 10px}
  .pill{font-size:11px}
}

/* Sticky first column */
thead th:first-child, tbody td:first-child{position:sticky;left:0;z-index:2;box-shadow:2px 0 0 0 rgba(255,255,255,.06)}

/* Pagination */
.pagination{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:8px}

/* Modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:24px;z-index:10000}
.modal.open{display:flex}
.modal .box{max-width:900px;width:100%;max-height:85vh;overflow:auto;background:#0e152a;border:1px solid #1b2745;border-radius:16px;position:relative;z-index:10001}
.modal header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #12203d}
.modal header h3{margin:0;font-size:16px}
.modal .content{padding:16px}
.badges{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
.badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid transparent;cursor:pointer;transition:all 0.2s;position:relative}
.badge.positive{background:rgba(130,198,24,.15);color:#82c618;border-color:rgba(130,198,24,.35)}
.badge.neutral{background:rgba(207,219,221,.25);color:#cfdbdd;border-color:rgba(207,219,221,.45)}
.badge.negative{background:rgba(255,130,97,.15);color:#ff8261;border-color:rgba(255,130,97,.35)}
.badge.controlled{background:rgba(88,219,237,.15);color:#58dbed;border-color:rgba(88,219,237,.35)}
.badge.uncontrolled{background:rgba(255,130,97,.15);color:#ff8261;border-color:rgba(255,130,97,.35)}
.badge.editable:hover{filter:brightness(1.2);transform:scale(1.05)}
.muted{color:var(--muted)}

/* Sentiment dropdown */
.sentiment-dropdown{position:absolute;top:100%;left:0;margin-top:4px;background:var(--card);border:1px solid var(--stroke);border-radius:8px;padding:4px;z-index:10002;box-shadow:0 4px 12px rgba(0,0,0,.3);min-width:120px}
.sentiment-dropdown button{display:block;width:100%;text-align:left;padding:6px 10px;margin:2px 0;background:var(--black);border:1px solid #2a3b5e;color:var(--text);border-radius:6px;cursor:pointer;font-size:12px}
.sentiment-dropdown button:hover{background:#1a2335;filter:brightness(1.15)}

/* SERP cards */
.serp-cards{display:grid;gap:12px;margin-top:12px}
.serp-card{background:var(--card);border:1px solid var(--stroke);border-radius:12px;padding:14px 16px}
.serp-domain{font-size:12px;color:var(--muted);margin-bottom:4px}
.serp-title a{color:var(--text);text-decoration:underline}
.serp-snippet{color:var(--muted);margin-top:6px;line-height:1.35}
.serp-metrics{margin:4px 0 8px;color:var(--muted)}
.serp-metrics b{color:var(--text)}

/* Loading indicator */
.loading{color:var(--muted);font-style:italic;padding:20px;text-align:center}
</style>
</head>

<body>
<div class="wrap">
  <h1>Brand Risk Dashboard</h1>

  <div class="controls card">
    <div>
      <div class="muted" style="font-size:12px;margin:0 0 4px">Date</div>
      <select id="dateSelect"></select>
    </div>
    <div style="flex:1 1 420px">
      <div class="muted" style="font-size:12px;margin:0 0 4px">Filter (Company)</div>
      <input id="filterInput" type="text" placeholder="Type to filter‚Ä¶" />
    </div>
    <button id="refreshBtn">Refresh Data</button>
    <button id="clearBtn">Clear Selection</button>
  </div>

  <div class="grid">
    <div class="chart-card">
      <h3>News sentiment (percent of articles)</h3>
      <div class="chart-actions">
        <span class="dates-range muted" aria-live="polite"></span>
        <div class="dates-pager">
          <button class="dates-prev" title="Older window">‚Üê</button>
          <button class="dates-next" title="Newer window">‚Üí</button>
        </div>
      </div>
      <canvas id="newsChart"></canvas>
    </div>

    <div class="chart-card">
      <h3>SERP (Negative % ‚Ä¢ Control %)</h3>
      <div class="chart-actions">
        <span class="dates-range muted" aria-live="polite"></span>
        <div class="dates-pager">
          <button class="dates-prev" title="Older window">‚Üê</button>
          <button class="dates-next" title="Newer window">‚Üí</button>
        </div>
      </div>
      <canvas id="serpChart"></canvas>
    </div>
  </div>

  <div class="table-card">
    <p class="table-hint">üí° Click on sentiment badges in article/SERP views to edit. Changes save to Google Sheets instantly.</p>
    <div class="table-scroll">
      <table>
        <thead>
          <tr>
            <th>Company</th>
            <th data-key="neg_news" class="right">Negative News % ‚ñ≤‚ñº</th>
            <th data-key="neg_serp" class="right">Negative SERP % ‚ñ≤‚ñº</th>
            <th data-key="ctrl_pct" class="right">SERP Control % ‚ñ≤‚ñº</th>
            <th data-key="risk" class="center">Risk ‚ñ≤‚ñº</th>
            <th class="center">Headlines</th>
            <th class="center">SERP</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="pagination">
      <button id="prevBtn">Prev</button>
      <div>Page <span id="pageNo">1</span> / <span id="pageTotal">1</span></div>
      <button id="nextBtn">Next</button>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="box">
    <header>
      <h3 id="modalTitle">Title</h3>
      <button id="modalClose">Close</button>
    </header>
    <div class="content" id="modalContent"></div>
  </div>
</div>

<script>
/********************** Config **********************/
// üëá YOUR BRAND PROXY URL HERE
const PROXY_URL = 'https://script.google.com/macros/s/AKfycbwMwSmXj-vE8r7hhbVaqVLFOYOWMW5cUwPQIXRTCyCF83VJ320NEcIukgbmZmUT-U4MOA/exec';

/********************** Runtime **********************/
let articlesDaily = [];
let serpsDaily = [];
let filteredRows = [];
let selectedCompany = null;
let currentSort = { key: null, dir: 1 };
let currentPage = 1;
const PAGE_SIZE = 25;

let newsChart, serpChart;
const DATE_WINDOW_SIZE = 30;
let dateWindowStart = null;

/********************** Utils **********************/
const isISODate = s => /^\d{4}-\d{2}-\d{2}$/.test(String(s || '').trim());
const esc = (s) => String(s ?? '').replace(/[&<>"']/g, m => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'}[m]));
const fmtPct = (v) => (v == null) ? 'N/A' : Math.round(v * 100) + '%';

const NEG_COLOR = '#ff8261';
const CTRL_COLOR = '#58dbed';
const SOLID_WIDTH = 3;
const DASH_WIDTH = 2;
const DASH_PATTERN = [8, 6];

/********************** Google Sheets via Proxy **********************/
async function fetchFromSheets(sheetName, date = null) {
  const fullName = date ? `${date}-${sheetName}` : sheetName;
  try {
    const response = await fetch(PROXY_URL, {
      method: 'POST',
      body: JSON.stringify({
        action: 'READ',
        sheetName: fullName
      })
    });
    const data = await response.json();
    return data.data || [];
  } catch (e) {
    console.warn(`Failed to read ${fullName}:`, e);
    return [];
  }
}

async function updateSentimentInSheets(sheetName, date, url, newSentiment) {
  const fullName = date ? `${date}-${sheetName}` : sheetName;
  try {
    const response = await fetch(PROXY_URL, {
      method: 'POST',
      body: JSON.stringify({
        action: 'UPDATE_SENTIMENT',
        sheetName: fullName,
        url: url,
        sentiment: newSentiment
      })
    });
    const data = await response.json();
    if (data.success) {
      console.log(`‚úì Updated ${url} to ${newSentiment}`);
      return true;
    } else {
      console.warn(`Failed to update sentiment: ${data.error}`);
      return false;
    }
  } catch (e) {
    console.error(`Failed to update sentiment:`, e);
    return false;
  }
}

/********************** Data Loaders **********************/
async function loadDates() {
  const candidates = [
    'brand-articles-daily-counts-chart',
    'brand-serps-daily-counts-chart'
  ];
  
  const dates = new Set();
  
  for (const sheet of candidates) {
    const rows = await fetchFromSheets(sheet);
    rows.forEach(r => {
      const d = String(r.date || '').trim();
      if (isISODate(d)) dates.add(d);
    });
  }
  
  return [...dates].sort();
}

async function loadArticlesForDate(date) {
  const rows = await fetchFromSheets('brand-articles-modal', date);
  return rows.map(r => ({
    date,
    company: String(r.company || '').trim(),
    title: String(r.title || '').trim(),
    url: String(r.url || '').trim(),
    source: String(r.source || '').trim(),
    sentiment: String(r.sentiment || 'neutral').toLowerCase()
  })).filter(r => r.company && r.url);
}

async function loadSERPsForDate(date) {
  const rows = await fetchFromSheets('brand-serps-modal', date);
  return rows.map(r => ({
    date,
    company: String(r.company || '').trim(),
    title: String(r.title || '').trim(),
    url: String(r.url || '').trim(),
    position: +r.position || 0,
    snippet: String(r.snippet || '').trim(),
    sentiment: String(r.sentiment || 'neutral').toLowerCase(),
    controlled: (/^true|1|controlled$/i).test(String(r.controlled || ''))
  })).filter(r => r.company && r.url);
}

async function loadCounts() {
  const rows = await fetchFromSheets('brand-articles-daily-counts-chart');
  articlesDaily = rows.map(r => ({
    date: String(r.date || '').trim(),
    company: String(r.company || '').trim(),
    pos: +r.positive_articles || 0,
    neu: +r.neutral_articles || 0,
    neg: +r.negative_articles || 0
  })).filter(r => isISODate(r.date) && r.company);
}

async function loadSerpDaily() {
  const rows = await fetchFromSheets('brand-serps-daily-counts-chart');
  serpsDaily = rows.map(r => ({
    date: (r.date || '').trim(),
    company: (r.company || '').trim(),
    total: +r.total || 0,
    neg_serp: +r.negative_serp || 0,
    ctrl: +r.controlled || 0
  })).filter(r => isISODate(r.date) && r.company);
}

/********************** Risk Calculation **********************/
function computeRisk(negPct, ctrlPct) {
  if (negPct == null || isNaN(negPct)) return 'N/A';
  if (negPct > 0) return 'High';
  if (ctrlPct == null || isNaN(ctrlPct)) return 'N/A';
  return ctrlPct < 0.40 ? 'Medium' : 'Low';
}

/********************** Pager Helpers **********************/
function clampDateStart(total) {
  if (total <= DATE_WINDOW_SIZE) return 0;
  const maxStart = total - DATE_WINDOW_SIZE;
  const start = (dateWindowStart ?? maxStart);
  return Math.min(Math.max(0, start), maxStart);
}

function sliceWindow(arr, start, size) {
  return arr.slice(start, start + size);
}

function updateDateRangeUI(allDates) {
  const start = clampDateStart(allDates.length);
  const end = Math.min(allDates.length, start + DATE_WINDOW_SIZE);
  const label = allDates.length ? `${allDates[start]} ‚Äî ${allDates[end - 1]}` : '';
  document.querySelectorAll('.dates-range').forEach(el => el.textContent = label);

  const atStart = start === 0;
  const atEnd = (start + DATE_WINDOW_SIZE) >= allDates.length;
  document.querySelectorAll('.dates-prev').forEach(b => b.disabled = atStart);
  document.querySelectorAll('.dates-next').forEach(b => b.disabled = atEnd);
}

function hookDatePager(allDates) {
  const goPrev = () => {
    const total = allDates.length;
    if (total <= DATE_WINDOW_SIZE) return;
    dateWindowStart = clampDateStart(total) - DATE_WINDOW_SIZE;
    if (dateWindowStart < 0) dateWindowStart = 0;
    renderCharts();
  };
  const goNext = () => {
    const total = allDates.length;
    if (total <= DATE_WINDOW_SIZE) return;
    const maxStart = total - DATE_WINDOW_SIZE;
    dateWindowStart = Math.min(maxStart, clampDateStart(total) + DATE_WINDOW_SIZE);
    renderCharts();
  };
  document.querySelectorAll('.dates-prev').forEach(b => b.onclick = goPrev);
  document.querySelectorAll('.dates-next').forEach(b => b.onclick = goNext);
}

/********************** UI Bootstrap **********************/
async function init() {
  const dates = await loadDates();
  
  await Promise.all([loadCounts(), loadSerpDaily()]);
  
  const sel = document.getElementById('dateSelect');
  sel.innerHTML = dates.map(d => `<option value="${d}">${d}</option>`).join('');
  sel.value = dates[dates.length - 1] || '';
  sel.addEventListener('change', () => { currentPage = 1; selectedCompany = null; renderAll(); });

  document.getElementById('filterInput').addEventListener('input', () => { currentPage = 1; renderAll(); });
  document.getElementById('refreshBtn').onclick = async () => { 
    console.log('üîÑ Refreshing data...');
    await init(); 
  };
  document.getElementById('clearBtn').onclick = () => { selectedCompany = null; document.getElementById('filterInput').value = ''; renderAll(); };
  document.getElementById('prevBtn').onclick = () => { if (currentPage > 1) { currentPage--; renderTable(); } };
  document.getElementById('nextBtn').onclick = () => { const totalPages = Math.max(1, Math.ceil(filteredRows.length / PAGE_SIZE)); if (currentPage < totalPages) { currentPage++; renderTable(); } };

  document.querySelectorAll('thead th[data-key]').forEach(th => {
    th.style.cursor = 'pointer';
    th.addEventListener('click', () => {
      const k = th.getAttribute('data-key');
      if (currentSort.key === k) currentSort.dir *= -1; else { currentSort.key = k; currentSort.dir = 1; }
      renderTable();
    });
  });

  renderAll();

  const ro = new ResizeObserver(() => { if (newsChart) newsChart.resize(); if (serpChart) serpChart.resize(); });
  ro.observe(document.getElementById('newsChart').parentElement);
  ro.observe(document.getElementById('serpChart').parentElement);
}

/********************** Build Rows **********************/
async function buildRowsForDate(d) {
  const articles = await loadArticlesForDate(d);
  const serps = await loadSERPsForDate(d);

  const articlesByCompany = new Map();
  articles.forEach(a => {
    if (!articlesByCompany.has(a.company)) {
      articlesByCompany.set(a.company, []);
    }
    articlesByCompany.get(a.company).push(a);
  });

  const serpsByCompany = new Map();
  serps.forEach(s => {
    if (!serpsByCompany.has(s.company)) {
      serpsByCompany.set(s.company, []);
    }
    serpsByCompany.get(s.company).push(s);
  });

  const companies = new Set([...articlesByCompany.keys(), ...serpsByCompany.keys()]);
  const out = [];

  for (const company of companies) {
    const articleList = articlesByCompany.get(company) || [];
    const serpList = serpsByCompany.get(company) || [];

    // Calculate article sentiment %
    let negArticles = 0;
    if (articleList.length > 0) {
      negArticles = articleList.filter(a => a.sentiment === 'negative').length / articleList.length;
    }

    // Calculate SERP metrics
    let negSerpPct = null, ctrlPct = null;
    if (serpList.length > 0) {
      negSerpPct = serpList.filter(s => s.sentiment === 'negative').length / serpList.length;
      ctrlPct = serpList.filter(s => s.controlled).length / serpList.length;
    }

    const risk = computeRisk(negSerpPct, ctrlPct);

    out.push({
      date: d,
      company,
      neg_news: negArticles,
      neg_serp: negSerpPct,
      ctrl_pct: ctrlPct,
      risk
    });
  }

  return out;
}

/********************** Rendering **********************/
async function renderAll() {
  const d = document.getElementById('dateSelect').value;
  const filter = document.getElementById('filterInput').value.trim().toLowerCase();
  const rows = (await buildRowsForDate(d)).filter(r => !filter || r.company.toLowerCase().includes(filter));
  filteredRows = rows;
  currentPage = 1;
  if (rows.length === 1) {
    selectedCompany = rows[0].company;
  } else if (selectedCompany && !rows.some(r => r.company === selectedCompany)) {
    selectedCompany = null;
  }
  renderTable();
  renderCharts();
}

function renderTable() {
  const tbody = document.getElementById('tbody');
  let rows = [...filteredRows];

  if (currentSort.key) {
    rows.sort((a, b) => {
      const ka = a[currentSort.key], kb = b[currentSort.key];
      if (typeof ka === 'string') return currentSort.dir * ka.localeCompare(kb);
      return currentSort.dir * ((ka ?? -1) - (kb ?? -1));
    });
  }

  const start = (currentPage - 1) * PAGE_SIZE;
  const pageRows = rows.slice(start, start + PAGE_SIZE);
  tbody.innerHTML = pageRows.map(r => {
    const checked = (selectedCompany && selectedCompany === r.company) ? 'checked' : '';
    return `<tr>
      <td><input type="checkbox" data-company="${esc(r.company)}" class="brandCheck" ${checked} /> ${esc(r.company)}</td>
      <td class="right">${fmtPct(r.neg_news)}</td>
      <td class="right">${fmtPct(r.neg_serp)}</td>
      <td class="right">${fmtPct(r.ctrl_pct)}</td>
      <td class="center">${
        (r.risk === 'High' || r.risk === 'Medium' || r.risk === 'Low')
          ? (r.risk === 'High'
            ? '<span class="pill high">High</span>'
            : r.risk === 'Medium'
              ? '<span class="pill med">Medium</span>'
              : '<span class="pill low">Low</span>')
          : '<span class="muted">N/A</span>'
      }</td>
      <td class="center"><button class="headBtn" data-company="${esc(r.company)}">View</button></td>
      <td class="center"><button class="serpBtn" data-company="${esc(r.company)}">View</button></td>
    </tr>`;
  }).join('');

  tbody.querySelectorAll('.brandCheck').forEach(cb => {
    cb.addEventListener('change', (e) => {
      const company = e.target.getAttribute('data-company');
      if (e.target.checked) {
        selectedCompany = company;
        tbody.querySelectorAll('.brandCheck').forEach(x => { if (x !== e.target) x.checked = false; });
      } else selectedCompany = null;
      renderCharts();
    });
  });

  tbody.querySelectorAll('.serpBtn').forEach(btn => {
    btn.onclick = () => showSerp({ company: btn.getAttribute('data-company') });
  });

  tbody.querySelectorAll('.headBtn').forEach(btn => {
    btn.onclick = () => showHeadlines({ company: btn.getAttribute('data-company') });
  });

  document.getElementById('pageNo').textContent = String(currentPage);
  document.getElementById('pageTotal').textContent = String(Math.max(1, Math.ceil(filteredRows.length / PAGE_SIZE)));
}

/********************** Charts **********************/
function getDateSeries() {
  const byDate = new Map();
  articlesDaily.forEach(r => {
    const key = r.date;
    if (!byDate.has(key)) byDate.set(key, { pos: 0, neu: 0, neg: 0 });
    const b = byDate.get(key);
    if (!selectedCompany || r.company === selectedCompany) {
      b.pos += +r.pos || 0; b.neu += +r.neu || 0; b.neg += +r.neg || 0;
    }
  });

  const serpByDate = new Map();
  serpsDaily.forEach(r => {
    const key = r.date;
    if (!serpByDate.has(key)) serpByDate.set(key, { total: 0, neg: 0, ctrl: 0 });
    if (!selectedCompany || r.company === selectedCompany) {
      const b = serpByDate.get(key);
      b.total += +r.total || 0; b.neg += +r.neg_serp || 0; b.ctrl += +r.ctrl || 0;
    }
  });

  const dates = [...new Set([...byDate.keys(), ...serpByDate.keys()])].filter(isISODate).sort();
  const newsPos = [], newsNeu = [], newsNeg = [], serpNegPct = [], serpCtrlPct = [];

  dates.forEach(d => {
    const n = byDate.get(d) || { pos: 0, neu: 0, neg: 0 };
    const t = n.pos + n.neu + n.neg || 0;
    newsPos.push(t ? n.pos / t * 100 : 0);
    newsNeu.push(t ? n.neu / t * 100 : 0);
    newsNeg.push(t ? n.neg / t * 100 : 0);

    const s = serpByDate.get(d) || { total: 0, neg: 0, ctrl: 0 };
    serpNegPct.push(s.total ? s.neg / s.total * 100 : 0);
    serpCtrlPct.push(s.total ? s.ctrl / s.total * 100 : 0);
  });

  return { dates, newsPos, newsNeu, newsNeg, serpNegPct, serpCtrlPct };
}

function renderCharts() {
  const { dates, newsPos, newsNeu, newsNeg, serpNegPct, serpCtrlPct } = getDateSeries();

  if (dateWindowStart === null) {
    dateWindowStart = Math.max(0, dates.length - DATE_WINDOW_SIZE);
  }

  const start = clampDateStart(dates.length);
  const d = sliceWindow(dates, start, DATE_WINDOW_SIZE);
  const nP = sliceWindow(newsPos, start, DATE_WINDOW_SIZE);
  const nN = sliceWindow(newsNeu, start, DATE_WINDOW_SIZE);
  const nG = sliceWindow(newsNeg, start, DATE_WINDOW_SIZE);
  const sN = sliceWindow(serpNegPct, start, DATE_WINDOW_SIZE);
  const sC = sliceWindow(serpCtrlPct, start, DATE_WINDOW_SIZE);

  updateDateRangeUI(dates);
  hookDatePager(dates);

  const who = selectedCompany ? selectedCompany : 'Index Average';
  const pct = v => `${Math.round(v)}%`;

  const commonOpts = {
    responsive: true, maintainAspectRatio: false,
    layout: { padding: { bottom: 24 } },
    scales: {
      x: { ticks: { color: '#ebf2f2' }, grid: { color: 'rgba(255,255,255,.05)' } },
      y: { ticks: { color: '#ebf2f2', stepSize: 20, callback: v => pct(v) }, grid: { color: 'rgba(255,255,255,.06)' }, suggestedMin: 0, suggestedMax: 100 }
    },
    plugins: {
      legend: { labels: { color: '#ebf2f2' } },
      title: { display: true, text: who, color: '#ebf2f2', font: { weight: 'bold', size: 14 }, padding: { top: 10, bottom: 6 } },
      tooltip: { callbacks: { label: (ctx) => `${ctx.dataset?.label ? ctx.dataset.label + ': ' : ''}${pct(typeof ctx.parsed.y === 'number' ? ctx.parsed.y : ctx.parsed)}` } }
    }
  };

  const nh = document.getElementById('newsChart').getContext('2d');
  if (newsChart) newsChart.destroy();
  newsChart = new Chart(nh, {
    type: 'bar',
    data: { labels: d, datasets: [{ label: 'Positive %', data: nP, backgroundColor: '#82c618', stack: 's' }, { label: 'Neutral %', data: nN, backgroundColor: '#cfdbdd', stack: 's' }, { label: 'Negative %', data: nG, backgroundColor: '#ff8261', stack: 's' }] },
    options: { ...commonOpts }
  });

  const sh = document.getElementById('serpChart').getContext('2d');
  if (serpChart) serpChart.destroy();
  serpChart = new Chart(sh, {
    type: 'line',
    data: {
      labels: d,
      datasets: [{ label: 'Daily Negative SERP %', data: sN, tension: 0.2, borderWidth: SOLID_WIDTH, fill: false, borderColor: NEG_COLOR, pointBackgroundColor: NEG_COLOR, pointBorderColor: NEG_COLOR }, { label: 'Daily Control %', data: sC, tension: 0.2, borderWidth: SOLID_WIDTH, fill: false, borderColor: CTRL_COLOR, pointBackgroundColor: CTRL_COLOR, pointBorderColor: CTRL_COLOR }]
    },
    options: { ...commonOpts }
  });
}

/********************** Modals with Editable Sentiment **********************/
const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modalTitle');
const modalContent = document.getElementById('modalContent');
document.getElementById('modalClose').onclick = () => modal.classList.remove('open');
modal.addEventListener('click', e => { if (e.target === modal) modal.classList.remove('open'); });
function openModal(title, html) { modalTitle.textContent = title; modalContent.innerHTML = html; modal.classList.add('open'); }

// Close dropdown when clicking outside
document.addEventListener('click', (e) => {
  if (!e.target.closest('.badge') && !e.target.closest('.sentiment-dropdown')) {
    document.querySelectorAll('.sentiment-dropdown').forEach(d => d.remove());
  }
});

function createSentimentDropdown(sheetName, date, url, currentSentiment) {
  const container = document.createElement('div');
  container.className = 'sentiment-dropdown';
  
  const options = ['positive', 'neutral', 'negative'];
  
  options.forEach(opt => {
    const btn = document.createElement('button');
    btn.textContent = opt.charAt(0).toUpperCase() + opt.slice(1);
    if (opt === currentSentiment) {
      btn.style.fontWeight = 'bold';
      btn.textContent = '‚úì ' + btn.textContent;
    }
    btn.onclick = async (e) => {
      e.stopPropagation();
      const success = await updateSentimentInSheets(sheetName, date, url, opt);
      if (success) {
        // Find and update the badge
        const badge = container.parentElement.querySelector('.badge.editable');
        if (badge) {
          badge.className = `badge editable ${opt}`;
          badge.textContent = opt;
        }
        container.remove();
        // Refresh data to update charts and table
        renderAll();
      } else {
        alert('Failed to update sentiment. Check console for details.');
      }
    };
    container.appendChild(btn);
  });
  
  return container;
}

async function showHeadlines({ company }) {
  const d = document.getElementById('dateSelect').value;
  const articles = await loadArticlesForDate(d);
  const list = articles.filter(a => a.company === company);
  
  if (!list.length) {
    openModal(`Headlines ‚Äî ${esc(company)}`, `<div class="muted">No headlines for ${esc(company)} on ${d}.</div>`);
    return;
  }

  const cards = list.map(r => {
    const url = r.url;
    let domain = '';
    try { domain = new URL(url).hostname.replace(/^www\./, ''); } catch { }
    const title = esc(r.title || domain || '(no title)');
    const link = url ? `<a class="link" href="${esc(url)}" target="_blank" rel="noopener">${title}</a>` : `<span class="muted">${title}</span>`;
    const s = r.sentiment;
    return `<div class="serp-card" data-url="${esc(url)}">
      ${domain ? `<div class="serp-domain">${esc(domain)}</div>` : ''}
      <div class="serp-title">${link}</div>
      <div class="badges" style="position:relative;margin-top:8px">
        <span class="badge editable ${s}" data-url="${esc(url)}" title="Click to edit">${s}</span>
      </div>
    </div>`;
  }).join('');

  openModal(`Headlines ‚Äî ${esc(company)}`, `<div class="serp-cards">${cards}</div>`);

  // Attach click handlers to sentiment badges
  document.querySelectorAll('.modal .badge.editable').forEach(badge => {
    badge.addEventListener('click', (e) => {
      e.stopPropagation();
      
      // Remove any existing dropdowns
      document.querySelectorAll('.sentiment-dropdown').forEach(d => d.remove());
      
      const url = badge.getAttribute('data-url');
      const currentSentiment = badge.textContent.trim();
      const dropdown = createSentimentDropdown('brand-articles-modal', d, url, currentSentiment);
      badge.parentElement.appendChild(dropdown);
    });
  });
}

async function showSerp({ company }) {
  const d = document.getElementById('dateSelect').value;
  const serps = await loadSERPsForDate(d);
  const matches = serps.filter(s => s.company === company);

  if (!matches.length) {
    openModal(`SERP ‚Äî ${esc(company)}`, `<div class="muted">No SERPs for ${esc(company)} on ${d}.</div>`);
    return;
  }

  const total = matches.length;
  const negCount = matches.filter(r => r.sentiment === 'negative').length;
  const ctrlCount = matches.filter(r => r.controlled).length;
  const negPct = total ? (negCount / total) : 0;
  const ctrlPct = total ? (ctrlCount / total) : 0;
  const risk = computeRisk(negPct, ctrlPct);

  matches.sort((a, b) => (a.position) - (b.position));

  const cards = matches.map(r => {
    const url = r.url;
    let domain = '';
    try { domain = new URL(url).hostname.replace(/^www\./, ''); } catch { }
    const title = esc(r.title || domain || '(no title)');
    const snippet = esc(r.snippet || '');
    const s = r.sentiment;
    const ctrl = r.controlled ? 'controlled' : 'uncontrolled';
    const link = url ? `<a class="link" href="${esc(url)}" target="_blank" rel="noopener">${title}</a>` : `<span class="muted">${title}</span>`;
    return `<div class="serp-card" data-url="${esc(url)}">
      ${domain ? `<div class="serp-domain">${esc(domain)}</div>` : ''}
      <div class="serp-title">${link}</div>
      ${snippet ? `<div class="serp-snippet">${snippet}</div>` : ''}
      <div class="badges" style="position:relative">
        <span class="badge editable ${s}" data-url="${esc(url)}" title="Click to edit">${s}</span>
        <span class="badge ${ctrl}">${ctrl}</span>
      </div>
    </div>`;
  }).join('');

  const metrics = `<div class="serp-metrics">
    <b>Negative SERP:</b> ${(negPct * 100).toFixed(1)}% &nbsp;|&nbsp;
    <b>Control:</b> ${(ctrlPct * 100).toFixed(1)}% &nbsp;|&nbsp;
    <b>Risk:</b> ${esc(risk)}
  </div>`;

  openModal(`SERP ‚Äî ${esc(company)}`, `${metrics}<div class="serp-cards">${cards}</div>`);

  // Attach click handlers to sentiment badges
  document.querySelectorAll('.modal .badge.editable').forEach(badge => {
    badge.addEventListener('click', (e) => {
      e.stopPropagation();
      
      // Remove any existing dropdowns
      document.querySelectorAll('.sentiment-dropdown').forEach(d => d.remove());
      
      const url = badge.getAttribute('data-url');
      const currentSentiment = badge.textContent.trim();
      const dropdown = createSentimentDropdown('brand-serps-modal', d, url, currentSentiment);
      badge.parentElement.appendChild(dropdown);
    });
  });
}

/********************** Init **********************/
init();
</script>
</body>
</html>
