<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CEO News Sentiment Dashboard</title>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Papa Parse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-7xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-3xl font-bold">CEO News Sentiment Dashboard</h1>
      <p class="text-sm text-slate-600">
        News: <code>data_ceos/daily_counts.csv</code> &middot;
        Articles: <code>data_ceos/articles/YYYY-MM-DD.csv</code> &middot;
        SERPs: <code>data/serps/ceo_serps.csv</code> &middot;
        Boards: <code>data/ceo_boards.csv</code>
      </p>
    </header>

    <!-- Controls -->
    <section class="mb-4 grid gap-3 md:grid-cols-3">
      <div>
        <label class="block text-sm font-medium mb-1">Pick date</label>
        <select id="dateSelect" class="w-full border rounded-lg p-2 bg-white"></select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Filter CEOs</label>
        <input id="filterInput" type="text" placeholder="Type to filter…" class="w-full border rounded-lg p-2" />
      </div>
      <div class="flex items-end gap-2 w-full">
        <button id="refreshBtn" class="px-3 py-2 rounded-lg bg-slate-900 text-white">Refresh</button>
      </div>
    </section>

    <!-- Trend -->
    <section class="mb-6 p-4 border rounded-xl bg-white">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-lg font-semibold">Sentiment trend</h2>
        <div class="flex items-center gap-2">
          <span id="trendInfo" class="text-xs text-slate-500"></span>
          <span id="trendRange" class="text-xs text-slate-500"></span>
          <button id="trendPrev" class="px-2 py-1 border rounded disabled:opacity-40" title="Older 30 days">←</button>
          <button id="trendNext" class="px-2 py-1 border rounded disabled:opacity-40" title="Newer 30 days">→</button>
        </div>
      </div>
      <p id="trendHint" class="text-sm text-slate-500 mb-2 hidden">
        Select exactly <span class="font-semibold">1</span> CEO to display a trend. When none is selected, the most negative CEO is shown by default.
      </p>
      <div class="h-64">
        <canvas id="trendChart"></canvas>
      </div>
    </section>

    <!-- Table -->
    <section class="overflow-x-auto">
      <table class="min-w-full text-sm bg-white rounded-xl overflow-hidden border">
        <thead class="bg-slate-100">
          <tr>
            <th class="p-3 text-left w-10"><input type="checkbox" id="selectAll"></th>

            <!-- ORDER: CEO, Company, Theme, Negative News (%), Negative SERP (%), SERP Control (%), Risk, Headlines, SERP, Boards -->
            <th class="p-3 text-left">CEO</th>
            <th class="p-3 text-left">Company</th>
            <th class="p-3 text-left">Theme</th>

            <th class="p-3 text-left cursor-pointer select-none" data-sort="negNews">
              Negative News (%) <span class="inline-block text-slate-400" id="sortIcon-negNews">▼</span>
            </th>
            <th class="p-3 text-left cursor-pointer select-none" data-sort="serpNeg">
              Negative SERP (%) <span class="inline-block text-slate-400" id="sortIcon-serpNeg"></span>
            </th>
            <th class="p-3 text-left cursor-pointer select-none" data-sort="serpCtrl">
              SERP Control (%) <span class="inline-block text-slate-400" id="sortIcon-serpCtrl"></span>
            </th>
            <th class="p-3 text-left cursor-pointer select-none" data-sort="risk">
              Risk <span class="inline-block text-slate-400" id="sortIcon-risk"></span>
            </th>

            <th class="p-3 text-left">Headlines</th>
            <th class="p-3 text-left">SERP</th>
            <th class="p-3 text-left">Boards</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>

      <!-- Pagination -->
      <div class="flex items-center justify-between mt-3">
        <div id="status" class="text-xs text-slate-500"></div>
        <div class="flex items-center gap-2">
          <button id="pagePrev" class="px-2 py-1 border rounded disabled:opacity-40">Prev</button>
          <span id="pageInfo" class="text-sm text-slate-600">Page 1 of 1</span>
          <button id="pageNext" class="px-2 py-1 border rounded disabled:opacity-40">Next</button>
        </div>
      </div>
    </section>
  </div>

  <!-- Modal -->
  <div id="modalBackdrop" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-3xl bg-white rounded-2xl shadow-xl overflow-hidden">
        <div class="flex items-center justify-between p-4 border-b">
          <div>
            <h3 id="modalTitle" class="text-xl font-bold">Details</h3>
            <p id="modalSubtitle" class="text-sm text-slate-600"></p>
          </div>
        </div>
        <div id="modalBody" class="max-h-[70vh] overflow-y-auto p-4">
          <p class="text-sm text-slate-500">Loading…</p>
        </div>
        <div class="p-4 border-t flex justify-end">
          <button id="modalClose" class="px-3 py-1.5 rounded-lg border">Close</button>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  // ---- Paths
  const CSV_COUNTS   = 'data_ceos/daily_counts.csv';
  const CSV_ARTICLES = (date) => `data_ceos/articles/${date}.csv`;
  const SERP_CSV     = 'data/serps/ceo_serps.csv';
  const BOARDS_CSV   = 'data/ceo_boards.csv';

  // ---- Paging / sorting
  const PAGE_SIZE = 25;
  let currentPage = 1;
  let sortKey = 'negNews'; // 'negNews'|'serpNeg'|'serpCtrl'|'risk'
  let sortDir = 'desc';    // 'asc'|'desc'

  // ---- State
  let allRows = [];        // daily_counts rows
  let currentDate = null;
  let filterText = '';
  let selected = new Set();

  let datasetForDate = []; // full filtered+sorted set for date
  let pageSlice = [];      // current page

  // caches
  const articlesCache = {};
  const serpIndex = Object.create(null);    // serpIndex[ceoLower] = rows[]
  const boardsIndex = Object.create(null);  // boardsIndex[ceoLower] = rows[]
  let serpReady = false, boardsReady = false;
  const serpAggCache = Object.create(null); // serpAggCache[date][ceo] = {negPct, ctrlPct, risk}

  // ---- DOM
  const dateSelect = document.getElementById('dateSelect');
  const filterInput = document.getElementById('filterInput');
  const refreshBtn  = document.getElementById('refreshBtn');
  const tableBody   = document.getElementById('tableBody');
  const statusEl    = document.getElementById('status');
  const selectAll   = document.getElementById('selectAll');
  const pagePrev    = document.getElementById('pagePrev');
  const pageNext    = document.getElementById('pageNext');
  const pageInfo    = document.getElementById('pageInfo');
  const sortHeaders = Array.from(document.querySelectorAll('th[data-sort]'));

  // trend
  const trendCanvas = document.getElementById('trendChart');
  const trendInfo   = document.getElementById('trendInfo');
  const trendRange  = document.getElementById('trendRange');
  const trendHint   = document.getElementById('trendHint');
  const trendPrev   = document.getElementById('trendPrev');
  const trendNext   = document.getElementById('trendNext');
  const TREND_WINDOW = 30;
  let trendPage = 0, trendBrand = null, trendChart = null;

  // modal
  const modalBackdrop = document.getElementById('modalBackdrop');
  const modalTitle = document.getElementById('modalTitle');
  const modalSubtitle = document.getElementById('modalSubtitle');
  const modalBody = document.getElementById('modalBody');
  const modalClose = document.getElementById('modalClose');

  // ---- Utils
  function normalizeRowKeys(row){
    const out = {};
    for(const k in row){
      const nk = String(k||'').replace(/^\ufeff/,'').trim().toLowerCase();
      out[nk] = row[k];
    }
    return out;
  }
  function escapeHtml(s){
    return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;');
  }
  function fmtPct(part, total){
    const t = Number(total||0), p = Number(part||0);
    if(!t || isNaN(t)) return 0;
    return Math.round((p/t)*100);
  }
  function toPct(val){ return (val==null || isNaN(val)) ? '—' : `${Math.round(val)}%`; }
  function riskOrder(r){ return r==='High'?3 : r==='Medium'?2 : r==='Low'?1 : 0; }
  function setSortIndicators(){
    ['negNews','serpNeg','serpCtrl','risk'].forEach(k=>{
      const el = document.getElementById(`sortIcon-${k}`); if(!el) return;
      el.textContent = (sortKey===k ? (sortDir==='asc'?'▲':'▼') : '');
    });
  }

  // ---- Loaders
  async function loadCountsCsv(){
    const url = CSV_COUNTS + '?_=' + Date.now();
    let text = '';
    try{ const r = await fetch(url,{cache:'no-store'}); if(r.ok) text = await r.text(); }catch{}
    if(!text){ statusEl.textContent = 'Error loading daily counts.'; return false; }
    const parsed = Papa.parse(text, {header:true, dynamicTyping:true});
    const raw = (parsed.data||[]).map(normalizeRowKeys);
    const good = raw.filter(r=> r && r.date && r.brand);
    allRows = good.map(r=>({
      date: String(r.date),
      ceo: String(r.brand),               // counts CSV uses 'brand' for the name
      company: String(r.company||''),
      total: Number(r.total||0),
      positive: Number(r.positive||0),
      neutral: Number(r.neutral||0),
      negative: Number(r.negative||0),
      theme: r.theme ? String(r.theme) : 'none'
    }));
    const dates = Array.from(new Set(allRows.map(r=>r.date))).sort();
    dateSelect.innerHTML = dates.map(d=>`<option value="${d}">${d}</option>`).join('');
    currentDate = dates[dates.length-1] || null;
    if(currentDate) dateSelect.value = currentDate;
    return true;
  }

  async function loadSerpsCsvOnce(){
    if(serpReady) return;
    const url = SERP_CSV + '?_=' + Date.now();
    let text=''; try{ const r=await fetch(url,{cache:'no-store'}); if(r.ok) text=await r.text(); }catch{}
    serpReady = true;
    if(!text) return;

    const parsed = Papa.parse(text,{header:true});
    const rows = (parsed.data||[]).map(normalizeRowKeys);

    function parseControl(v){
      // Robust: accept booleans, numbers, TRUE/FALSE, Yes/No, Controlled/Uncontrolled
      if(typeof v === 'boolean') return v;
      if(typeof v === 'number') return v !== 0;
      const s = String(v ?? '').trim().toLowerCase();
      if(!s) return false;
      if(['true','1','y','yes','controlled','control','owner','official'].includes(s)) return true;
      if(['false','0','n','no','uncontrolled','not controlled'].includes(s)) return false;
      // fallback: treat anything not explicitly negative as false
      return false;
    }

    for(const raw of rows){
      const ceo   = String(raw.ceo||'').trim();
      if(!ceo) continue;
      const company  = String(raw.company||'').trim();
      const title    = String(raw.title||'').trim();
      const link     = String(raw.link||'').trim();
      const snippet  = String(raw.snippet||'').trim();
      const control  = parseControl(raw.control);
      const sentiment= String(raw.sentiment||'').trim().toLowerCase();
      let domain = '';
      if(link){ try{ domain = new URL(link).hostname; }catch{} }
      const row = { ceo, company, title, link, snippet, control, sentiment, domain };
      const key = ceo.toLowerCase();
      if(!serpIndex[key]) serpIndex[key] = [];
      serpIndex[key].push(row);
    }
  }

  async function loadBoardsCsvOnce(){
    if(boardsReady) return;
    const url = BOARDS_CSV + '?_=' + Date.now();
    let text=''; try{ const r=await fetch(url,{cache:'no-store'}); if(r.ok) text=await r.text(); }catch{}
    boardsReady = true;
    if(!text) return;

    const parsed = Papa.parse(text,{header:true});
    const rows = (parsed.data||[]).map(normalizeRowKeys);

    for(const raw of rows){
      const ceo = String(raw.ceo||'').trim();
      if(!ceo) continue;
      const link = String(raw.url || raw.link || '').trim();
      const domain = String(raw.domain || '').trim() || (()=>{ try{ return (new URL(link)).hostname; }catch{ return ''; }})();
      const row = { ceo, link, domain };
      const key = ceo.toLowerCase();
      if(!boardsIndex[key]) boardsIndex[key] = [];
      boardsIndex[key].push(row);
    }
  }

  // ---- SERP helpers / aggregation
  function getSerpRowsFor(ceo){
    const key = (ceo||'').toLowerCase().trim();
    return serpIndex[key] || [];
  }
  function getSerpAgg(ceo, date){
    if(!serpAggCache[date]) serpAggCache[date] = Object.create(null);
    if(serpAggCache[date][ceo]) return serpAggCache[date][ceo];

    const rows = getSerpRowsFor(ceo);
    if(!rows.length){
      const v = {negPct:null, ctrlPct:null, risk:'—'};
      serpAggCache[date][ceo] = v; return v;
    }
    const n = rows.length;
    const neg = rows.filter(r=> (r.sentiment||'').toLowerCase()==='negative').length;
    const ctrl = rows.filter(r=> !!r.control).length;
    const negPct = (neg/n)*100;
    const ctrlPct = (ctrl/n)*100;

    let risk = 'Medium';
    if(negPct > 0.0001) risk = 'High';
    else if(ctrlPct > 70) risk = 'Low';

    const out = {negPct, ctrlPct, risk};
    serpAggCache[date][ceo] = out;
    return out;
  }

  // ---- Articles (headlines)
  async function loadArticlesForDate(date){
    if(articlesCache[date]) return articlesCache[date];
    const url = CSV_ARTICLES(date) + '?_=' + Date.now();
    let text=''; try{ const r=await fetch(url,{cache:'no-store'}); if(r.ok) text=await r.text(); }catch{}
    if(!text){ articlesCache[date]=[]; return []; }

    const parsed = Papa.parse(text,{header:true});
    const norm = (parsed.data||[]).map(normalizeRowKeys);
    const rows = norm
      .filter(r => (r.brand || r.canonical || r.company) && (r.title || r.headline))
      .map(r=>{
        const ceo = String(r.brand || r.canonical || r.company || '').trim();
        const rawUrl = String(r.url || r.link || r.href || '');
        let domain = String(r.domain || '');
        if(!domain && rawUrl){ try{ domain = new URL(rawUrl).hostname; }catch{} }
        // Strip " - Publication"
        function cleanTitle(t){ const i = t.lastIndexOf(' - '); return i>0 ? t.slice(0,i) : t; }
        return {
          ceo,
          title: cleanTitle(String(r.title || r.headline || '').trim()),
          url: rawUrl,
          domain,
          sentiment: String(r.sentiment || r.label || 'neutral'),
          published: String(r.published || r.date || r.datetime || '')
        };
      });
    articlesCache[date] = rows;
    return rows;
  }
  function parseDateMaybe(s){ const t = Date.parse(s); return isNaN(t)?0:t; }

  function badge(text, tone){
    const m = {
      pos:'bg-emerald-100 text-emerald-700',
      neu:'bg-slate-100 text-slate-700',
      neg:'bg-rose-100 text-rose-700',
      ctrl:'bg-sky-100 text-sky-700',
      un:'bg-amber-100 text-amber-700',
    };
    return `<span class="inline-block px-2 py-0.5 text-xs rounded-full ${m[tone]||m.neu}">${text}</span>`;
  }

  async function showHeadlines(ceo){
    modalTitle.textContent = ceo + ' — Headlines';
    modalSubtitle.textContent = `Date: ${currentDate}`;
    modalBody.innerHTML = '<p class="text-sm text-slate-500">Loading…</p>';
    openModal();

    const all = await loadArticlesForDate(currentDate);
    const key = ceo.trim().toLowerCase();
    const rows = all.filter(r => (r.ceo||'').trim().toLowerCase()===key);
    rows.sort((a,b)=>{
      const order = (x)=> x.sentiment==='negative' ? 2 : (x.sentiment==='neutral'?1:0);
      const d = order(b) - order(a); if(d!==0) return d;
      return parseDateMaybe(b.published) - parseDateMaybe(a.published);
    });

    if(!rows.length){
      modalBody.innerHTML = `<p class="text-sm text-slate-600">No headlines found for ${escapeHtml(ceo)}.</p>`;
      return;
    }
    modalBody.innerHTML = `
      <div class="space-y-3">
        ${rows.map(r=>`
          <div class="p-3 border rounded-xl hover:bg-slate-50">
            <div class="flex items-center justify-between gap-3">
              <div class="text-xs text-slate-500">${r.domain || ''}</div>
              <div>${r.sentiment==='negative'?badge('negative','neg'):r.sentiment==='positive'?badge('positive','pos'):badge('neutral','neu')}</div>
            </div>
            <a href="${r.url}" target="_blank" rel="noopener" class="block mt-1 font-medium underline">${escapeHtml(r.title)}</a>
            ${r.published?`<div class="text-xs text-slate-500 mt-1">${r.published}</div>`:''}
          </div>
        `).join('')}
      </div>`;
  }

  async function showSerpPopup(ceo){
    await loadSerpsCsvOnce();
    const rows = getSerpRowsFor(ceo);
    modalTitle.textContent = `${ceo} — SERP`;
    modalSubtitle.textContent = rows.length ? '' : '';
    if(!rows.length){
      modalBody.innerHTML = `<p class="text-sm text-slate-600">No SERP rows found for ${escapeHtml(ceo)}.</p>`;
      openModal(); return;
    }
    modalBody.innerHTML = `
      <div class="space-y-3">
        ${rows.map(r=>{
          const s = r.sentiment==='negative' ? badge('negative','neg')
                  : r.sentiment==='positive' ? badge('positive','pos') : badge('neutral','neu');
          const c = r.control ? badge('controlled','ctrl') : badge('uncontrolled','un');
          const dom = r.domain ? `<div class="text-xs text-slate-500">${escapeHtml(r.domain)}</div>` : '';
          const sn  = r.snippet ? `<div class="text-sm text-slate-700 mt-1">${escapeHtml(r.snippet)}</div>` : '';
          return `
            <div class="p-3 border rounded-xl hover:bg-slate-50">
              <div class="flex items-center gap-2 justify-between">
                <div class="flex items-center gap-2">${s}${c}</div>
                ${dom}
              </div>
              <a class="block mt-1 font-medium underline" href="${r.link}" target="_blank" rel="noopener">
                ${escapeHtml(r.title || r.link)}
              </a>
              ${sn}
            </div>`;
        }).join('')}
      </div>`;
    openModal();
  }

  async function showBoardsPopup(ceo){
    await loadBoardsCsvOnce();
    const key = (ceo||'').toLowerCase().trim();
    const rows = boardsIndex[key] || [];
    modalTitle.textContent = `${ceo} — Active Boards`;
    modalSubtitle.textContent = '';
    if(!rows.length){
      modalBody.innerHTML = `<p class="text-sm text-slate-600">No board memberships found for ${escapeHtml(ceo)}.</p>`;
      openModal(); return;
    }
    modalBody.innerHTML = `
      <div class="space-y-4">
        ${rows.map(r=>`
          <div class="p-3 border rounded-xl">
            <div class="text-base font-semibold">${escapeHtml(r.domain || '(domain unknown)')}</div>
            <a class="block mt-1 underline" href="${r.link}" target="_blank" rel="noopener">${escapeHtml(r.link)}</a>
          </div>
        `).join('')}
      </div>`;
    openModal();
  }

  // ---- Dataset (filter + sort + page)
  function computeDatasetForDate(){
    const f = (filterText||'').toLowerCase();
    const rows = allRows.filter(r => r.date===currentDate && r.ceo);
    const filtered = f ? rows.filter(r =>
      r.ceo.toLowerCase().includes(f) || String(r.company||'').toLowerCase().includes(f)
    ) : rows.slice();

    const mapped = filtered.map(r=>{
      const negNewsPct = fmtPct(r.negative, r.total);
      const agg = getSerpAgg(r.ceo, currentDate);
      return {
        ...r,
        _negNewsPct: negNewsPct,
        _serpNeg: agg.negPct,
        _serpCtrl: agg.ctrlPct,
        _risk: agg.risk
      };
    });

    mapped.sort((a,b)=>{
      let A,B;
      if(sortKey==='negNews'){ A=a._negNewsPct; B=b._negNewsPct; }
      else if(sortKey==='serpNeg'){ A=(a._serpNeg==null?-1:a._serpNeg); B=(b._serpNeg==null?-1:b._serpNeg); }
      else if(sortKey==='serpCtrl'){ A=(a._serpCtrl==null?-1:a._serpCtrl); B=(b._serpCtrl==null?-1:b._serpCtrl); }
      else if(sortKey==='risk'){ A=riskOrder(a._risk); B=riskOrder(b._risk); }
      else { A=a._negNewsPct; B=b._negNewsPct; }
      const d = (A===B) ? a.ceo.localeCompare(b.ceo) : (A-B);
      return (sortDir==='asc') ? d : -d;
    });

    datasetForDate = mapped;
    const totalPages = Math.max(1, Math.ceil(datasetForDate.length / PAGE_SIZE));
    if(currentPage>totalPages) currentPage = totalPages;
    if(currentPage<1) currentPage = 1;

    const start = (currentPage-1)*PAGE_SIZE;
    const end = start + PAGE_SIZE;
    pageSlice = datasetForDate.slice(start,end);
    updatePager();
  }

  function updatePager(){
    const totalPages = Math.max(1, Math.ceil(datasetForDate.length / PAGE_SIZE));
    pagePrev.disabled = currentPage<=1;
    pageNext.disabled = currentPage>=totalPages;
    pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
  }

  function renderTable(){
    tableBody.innerHTML = pageSlice.map(r=>{
      const isSel = selected.has(r.ceo);
      const negNews = `${r._negNewsPct}%`;
      const negSerp = toPct(r._serpNeg);
      const ctrlSerp = toPct(r._serpCtrl);
      const risk = r._risk || '—';
      return `<tr class="border-t hover:bg-slate-50">
        <td class="p-3"><input type="checkbox" data-ceo="${r.ceo.replace(/\"/g,'&quot;')}" ${isSel?'checked':''}></td>
        <td class="p-3 font-medium">${escapeHtml(r.ceo)}</td>
        <td class="p-3">${escapeHtml(r.company||'')}</td>
        <td class="p-3 text-slate-700">${escapeHtml((r.theme && String(r.theme).trim()) ? r.theme : 'none')}</td>

        <td class="p-3" title="${r.negative} of ${r.total}">${negNews}</td>
        <td class="p-3">${negSerp}</td>
        <td class="p-3">${ctrlSerp}</td>
        <td class="p-3">${risk}</td>

        <td class="p-3"><button class="px-2 py-1 border rounded-lg" data-headlines="${r.ceo.replace(/\"/g,'&quot;')}">View</button></td>
        <td class="p-3"><button class="px-2 py-1 border rounded-lg" data-serp="${r.ceo.replace(/\"/g,'&quot;')}">View</button></td>
        <td class="p-3"><button class="px-2 py-1 border rounded-lg" data-boards="${r.ceo.replace(/\"/g,'&quot;')}">View</button></td>
      </tr>`;
    }).join('\n');

    statusEl.textContent = `${datasetForDate.length} CEOs found for ${currentDate}. Showing ${pageSlice.length} on this page. ${selected.size} selected.`;

    // handlers
    tableBody.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
      cb.addEventListener('change', ()=>{
        const ceo = cb.getAttribute('data-ceo');
        if(cb.checked) selected.add(ceo); else selected.delete(ceo);
        updateTrend();
      });
    });
    tableBody.querySelectorAll('button[data-headlines]').forEach(btn=>{
      btn.addEventListener('click', ()=> showHeadlines(btn.getAttribute('data-headlines')));
    });
    tableBody.querySelectorAll('button[data-serp]').forEach(btn=>{
      btn.addEventListener('click', ()=> showSerpPopup(btn.getAttribute('data-serp')));
    });
    tableBody.querySelectorAll('button[data-boards]').forEach(btn=>{
      btn.addEventListener('click', ()=> showBoardsPopup(btn.getAttribute('data-boards')));
    });

    updateTrend();
  }

  // ---- Trend (percent-only)
  if(trendPrev){ trendPrev.addEventListener('click', ()=>{ trendPage += 1; updateTrend(); }); }
  if(trendNext){ trendNext.addEventListener('click', ()=>{ trendPage = Math.max(0, trendPage - 1); updateTrend(); }); }
  function allDatesSorted(){ return Array.from(new Set(allRows.map(r=>r.date))).sort(); }

  function seriesForCeo(ceo){
    const dates = allDatesSorted();
    const byDate = new Map();
    for(const r of allRows){ if(r.ceo === ceo) byDate.set(r.date, r); }
    const pos = [], neu = [], neg = [];
    for(const d of dates){
      const r = byDate.get(d) || {total:0,positive:0,neutral:0,negative:0};
      const t = r.total || 0; const f = (x)=> t? (x/t*100) : 0;
      pos.push(+f(r.positive).toFixed(1));
      neu.push(+f(r.neutral).toFixed(1));
      neg.push(+f(r.negative).toFixed(1));
    }
    return { dates, pos, neu, neg };
  }

  function updateTrend(){
    const selCount = selected.size;
    let ceo = null;
    if(selCount === 1){ ceo = Array.from(selected)[0]; }
    else if(selCount === 0 && datasetForDate.length){ ceo = datasetForDate[0].ceo; }
    else {
      trendHint.classList.remove('hidden');
      trendInfo.textContent = '';
      trendRange.textContent = '';
      if(trendChart){ trendChart.destroy(); trendChart=null; }
      return;
    }

    if(ceo !== trendBrand){ trendPage = 0; }
    trendHint.classList.add('hidden');
    const full = seriesForCeo(ceo);

    const total = full.dates.length;
    const W = TREND_WINDOW;
    const maxPage = Math.max(0, Math.ceil(total / W) - 1);
    if(trendPage > maxPage) trendPage = maxPage;
    const end = Math.max(0, total - W * trendPage);
    const start = Math.max(0, end - W);

    const labels = full.dates.slice(start, end);
    const pos = full.pos.slice(start, end);
    const neu = full.neu.slice(start, end);
    const neg = full.neg.slice(start, end);

    trendBrand = ceo;
    trendInfo.textContent = `CEO: ${ceo}`;
    trendRange.textContent = labels.length ? `  |  DATE: ${labels[0]} → ${labels[labels.length-1]}` : '';

    const showLabels = labels.length <= 7;
    const data = {
      labels,
      datasets: [
        { label: 'Positive', data: pos, backgroundColor: '#98c15b', stack: 'sent' },
        { label: 'Neutral',  data: neu, backgroundColor: '#dae5e6', stack: 'sent' },
        { label: 'Negative', data: neg, backgroundColor: '#ffb199', stack: 'sent' },
      ]
    };
    const options = {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'top' },
        tooltip: { callbacks: { label: (ctx)=> `${ctx.dataset.label}: ${ctx.parsed.y}%` } }
      },
      scales: {
        x: { stacked: true, ticks: { display: showLabels } },
        y: { stacked: true, beginAtZero: true, ticks: { callback: (v)=> v+"%" } }
      }
    };
    if(trendChart){ trendChart.destroy(); }
    trendChart = new Chart(trendCanvas.getContext('2d'), { type: 'bar', data, options });
  }

  // ---- Events
  dateSelect.addEventListener('change', ()=>{ currentDate = dateSelect.value; currentPage=1; computeDatasetForDate(); renderTable(); });
  filterInput.addEventListener('input', ()=>{ filterText = filterInput.value||''; currentPage=1; computeDatasetForDate(); renderTable(); });
  refreshBtn.addEventListener('click', async ()=>{
    await loadCountsCsv();
    await loadSerpsCsvOnce();
    await loadBoardsCsvOnce();
    serpAggCache[currentDate] = Object.create(null); // recalc with any updated SERPs
    currentPage=1; computeDatasetForDate(); renderTable();
  });
  selectAll.addEventListener('change', ()=>{
    if(selectAll.checked){ pageSlice.forEach(r=>selected.add(r.ceo)); }
    else { selected.clear(); }
    renderTable();
  });
  pagePrev.addEventListener('click', ()=>{ if(currentPage>1){ currentPage--; computeDatasetForDate(); renderTable(); } });
  pageNext.addEventListener('click', ()=>{
    const totalPages = Math.max(1, Math.ceil(datasetForDate.length / PAGE_SIZE));
    if(currentPage<totalPages){ currentPage++; computeDatasetForDate(); renderTable(); }
  });
  sortHeaders.forEach(th=>{
    th.addEventListener('click', ()=>{
      const key = th.getAttribute('data-sort');
      if(sortKey===key) sortDir = (sortDir==='asc'?'desc':'asc');
      else { sortKey=key; sortDir='desc'; }
      setSortIndicators();
      currentPage=1; computeDatasetForDate(); renderTable();
    });
  });

  // modal
  function openModal(){ modalBackdrop.classList.remove('hidden'); }
  function closeModal(){ modalBackdrop.classList.add('hidden'); }
  modalClose.addEventListener('click', closeModal);
  modalBackdrop.addEventListener('click', (e)=>{ if(e.target===modalBackdrop) closeModal(); });
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });

  // ---- Init
  (async function init(){
    statusEl.textContent = 'Loading…';
    await loadCountsCsv();
    await Promise.all([loadSerpsCsvOnce(), loadBoardsCsvOnce()]);
    setSortIndicators();
    computeDatasetForDate();
    renderTable();
  })();
})();
</script>
</body>
</html>
