<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CEO Risk Dashboard</title>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>

<style>
:root{
  --bg:#1f2121;
  --card:#111f24;
  --muted:#98c0cb;
  --text:#e7f5f6;
  --accent:#58dbed;
  --brand:#00809e;
  --chipHigh:#ff8261;
  --chipMed:#ffc32e;
  --chipLow:#82c616;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
.wrap{max-width:1200px;margin:0 auto;padding:24px}
h1{font-size:24px;margin:0 0 12px}
.controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:12px 0}
.card{background:var(--card);border:1px solid #0e3240;border-radius:12px;padding:16px;box-shadow:0 4px 20px rgba(0,0,0,.25)}

/* charts stacked vertically, full width */
#chartsStack{display:flex;flex-direction:column;gap:12px;margin-bottom:16px;}
.chartCard{background:var(--card);border:1px solid #0e3240;border-radius:12px;padding:12px 16px}
/* make svg texts white for readability */
.chartCard svg text{fill:var(--text)}
/* optional (thin axis lines on dark) */
.chartCard svg .domain, .chartCard svg .tick line{stroke:#37576a}

/* form */
select,input[type="text"]{background:#0c1220;border:1px solid #23314d;color:var(--text);border-radius:10px;padding:8px 10px}
button{background:#18243b;border:1px solid #2a3b5e;color:var(--text);border-radius:10px;padding:8px 10px;cursor:pointer}
button:hover{border-color:#35d8ea}

/* table */
.table{width:100%;border-collapse:separate;border-spacing:0 8px}
thead th{font-size:12px;color:var(--muted);text-align:left;padding:0 8px}
tbody tr{background:#0e1524}
tbody td{padding:10px 8px;border-top:1px solid #17223a;border-bottom:1px solid #17223a}
tbody tr td:first-child{border-left:1px solid #17223a;border-radius:10px 0 0 10px}
tbody tr td:last-child{border-right:1px solid #17223a;border-radius:0 10px 10px 0}

.pill{padding:4px 8px;border-radius:999px;font-size:12px}
.pill.low{background:rgba(34,197,94,.15);color:#5fe08b}
.pill.med{background:rgba(234,179,8,.15);color:#f5e37a}
.pill.high{background:rgba(244,63,94,.15);color:#ff7b7b}

.muted{color:var(--muted)}
.right{text-align:right}
.center{text-align:center}

.pagination{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:8px}
.checkbox{accent-color:var(--accent)}

.modal{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;padding:24px}
.modal.show{display:flex}
.modal > .box{background:#0e1524;border:1px solid #23314d;border-radius:12px;max-width:900px;width:100%;max-height:80vh;overflow:auto}
.modal header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #0d2a46}
.modal .content{padding:16px}
.link{color:#92e8ef}
</style>
</head>
<body>
<div class="wrap">
  <h1>CEO Risk Dashboard</h1>

  <div class="controls card">
    <div>
      <div class="muted" style="font-size:12px;margin-bottom:4px">Date</div>
      <select id="dateSelect"></select>
    </div>
    <div style="flex:1;min-width:260px">
      <div class="muted" style="font-size:12px;margin-bottom:4px">Filter (CEO or Company)</div>
      <input id="filterInput" type="text" placeholder="Type to filter…" style="width:100%" />
    </div>
    <div style="margin-left:auto;display:flex;gap:8px">
      <button id="refreshBtn">Refresh Data</button>
      <button id="clearBtn">Clear Selection</button>
    </div>
  </div>

  <!-- STACKED CHARTS (bar on top, line beneath) -->
  <div id="chartsStack">
    <div class="chartCard" id="newsChart"></div>
    <div class="chartCard" id="serpChart"></div>
  </div>

  <div class="card">
    <div class="muted" style="margin-bottom:10px">
      Select exactly one CEO using the checkbox to see brand-level charts. Selecting another will automatically unselect the previous one.
    </div>

    <table class="table" id="dataTable">
      <thead>
        <tr>
          <th>CEO</th>
          <th>Company</th>
          <th>Theme</th>
          <th class="right">Negative News % ▲▼</th>
          <th class="right">Negative SERP % ▲▼</th>
          <th class="right">SERP Control % ▲▼</th>
          <th>Risk ▲▼</th>
          <th class="center">Headlines</th>
          <th class="center">SERP</th>
          <th class="center">Boards</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="pagination">
      <button id="prevBtn">Prev</button>
      <div class="muted" id="pageInfo">Page</div>
      <button id="nextBtn">Next</button>
    </div>
  </div>
</div>

<!-- Headlines/SERP/Boards modal -->
<div class="modal" id="modal">
  <div class="box">
    <header>
      <div id="modalTitle" class="muted">Modal</div>
      <button id="modalClose">Close</button>
    </header>
    <div class="content" id="modalBody">Loading…</div>
  </div>
</div>

<script>
/* ===================== Config & globals ===================== */
const COUNTS_CANDIDATES = [
  'data_ceos/daily_counts.csv',
  'data/serps/daily_counts.csv',
  'data/daily_counts.csv'
];
const SERPS_DAILY_CSV = 'data/serps/ceo_serps_daily.csv';
const ROSTER_CANDIDATES = [
  'data/serps/roster.csv',
  'data/roster.csv',
  'data/ceo_companies.csv'
];
const BOARDS_CSV = 'data/ceo_boards.csv';

const LAST_N_DATES = 5; // show last N aligned dates

let rosterMap = new Map();      // CEO -> Company
let companyToCeo = new Map();   // Company -> CEO
let allCountsRows = [];         // from daily_counts
let serpDaily = [];             // from ceo_serps_daily
let boardsByCeo = new Map();    // CEO -> [{domain,url},...]

let filteredRows = [];          // table rows for current date after filter
let currentSort = { key: null, dir: 1 };
let currentPage = 1;
const PAGE_SIZE = 25;

let selectedCeo = '';

const isISODate = s => /^\d{4}-\d{2}-\d{2}$/.test(String(s||'').trim());

/* ===================== CSV helpers ===================== */
async function fetchCsv(url){
  const r = await fetch(url, {cache:'no-store'});
  if (!r.ok) throw new Error(`HTTP ${r.status} for ${url}`);
  const t = await r.text();
  return await new Promise((res, rej)=>(
    Papa.parse(t, {header:true, skipEmptyLines:true,
      complete: out => res(out.data || []),
      error: e => rej(e)
    })
  ));
}
async function fetchCsvAny(candidates){
  for (const u of candidates){
    try{
      const rows = await fetchCsv(u);
      if (Array.isArray(rows)) return rows;
    }catch(e){}
  }
  return [];
}

/* ===================== Loaders ===================== */
async function loadBoards(){
  try{
    const rows = await fetchCsv(BOARDS_CSV);
    const norm = r => {
      const ceo = String(r.ceo || r.CEO || '').trim();
      const url = String(r.url || r.URL || '').trim();
      let domain = String(r.domain || r.Domain || '').trim();
      if (!domain && url){
        try{ domain = new URL(url).hostname.replace(/^www\./,''); }catch(_){}
      }
      return {ceo, url, domain};
    };
    const arr = rows.map(norm).filter(r => r.ceo && (r.url || r.domain));
    boardsByCeo = new Map();
    for (const row of arr){
      const list = boardsByCeo.get(row.ceo) || [];
      list.push({domain: row.domain || 'Board', url: row.url || '#'});
      boardsByCeo.set(row.ceo, list);
    }
  }catch(e){
    boardsByCeo = new Map();
  }
}

async function loadRoster(){
  try{
    const rows = await fetchCsvAny(ROSTER_CANDIDATES);
    const norm = r => ({
      ceo: String(r.ceo || r.CEO || '').trim(),
      company: String(r.company || r.Company || '').trim()
    });
    const arr = rows.map(norm).filter(r => r.ceo && r.company);
    rosterMap = new Map(arr.map(r => [r.ceo, r.company]));
    companyToCeo = new Map(arr.map(r => [r.company, r.ceo]));
  }catch(e){
    rosterMap = new Map(); companyToCeo = new Map();
  }
}

async function loadCounts(){
  try{
    const rows = await fetchCsvAny(COUNTS_CANDIDATES);
    const norm = r => ({
      date: String(r.date || r.Date || '').trim(),
      ceo: String(r.ceo || r.CEO || '').trim(),
      company: String(r.company || r.Company || '').trim(),
      theme: String(r.theme || r.Theme || 'None').trim(),
      negative: +(r.negative || r.Negative || 0),
      neutral: +(r.neutral || r.Neutral || 0),
      positive: +(r.positive || r.Positive || 0),
      total: +(r.total || r.Total || 0),
      neg_pct: +((r.neg_pct || r['neg pct'] || r.negative_pct || 0))
    });
    allCountsRows = rows.map(norm).filter(x => isISODate(x.date));
  }catch(e){
    allCountsRows = [];
  }
}

function computeRisk(negPct, controlPct){
  if (negPct >= 40 || controlPct <= 30) return "High";
  if (negPct >= 20 || controlPct <= 50) return "Medium";
  return "Low";
}

async function loadSerpDaily(){
  try{
    const rows = await fetchCsv(SERPS_DAILY_CSV);
    const norm = r => {
      const date   = String(r.date || r.Date || '').trim();
      const ceo    = String(r.ceo || r.CEO || '').trim();
      const company= String(r.company || r.Company || '').trim();
      const total       = +((r.total ?? r.Total) || 0);
      const controlled  = +((r.controlled ?? r.Controlled) || 0);
      const negCount    = +((r.negative_serp ?? r.Negative_Serp ?? r.neg_serp ?? r.Negative) || 0);
      const serpControlPct  = total ? (controlled / total) * 100 : 0;
      const negativeSerpPct = total ? (negCount  / total) * 100 : 0;
      return {
        date, ceo, company, total, controlled,
        negative_serp: negCount,
        serp_control_pct: +serpControlPct.toFixed(1),
        negative_serp_pct: +negativeSerpPct.toFixed(1),
        risk: computeRisk(negativeSerpPct, serpControlPct)
      };
    };
    serpDaily = rows.map(norm).filter(x => isISODate(x.date));
  }catch(e){
    console.error('Could not load SERPS_DAILY_CSV', e);
    serpDaily = [];
  }
}

/* ===================== UI bootstrap ===================== */
async function initDatesAndRender(){
  const sel = document.getElementById('dateSelect');
  if (sel) sel.innerHTML = '<option>Loading…</option>';

  await Promise.all([loadRoster(), loadCounts(), loadSerpDaily(), loadBoards()]);

  const dates = [...new Set([
    ...serpDaily.map(r => r.date),
    ...allCountsRows.map(r => r.date)
  ])].filter(isISODate).sort();

  if (!dates.length){
    if (sel) sel.innerHTML = '<option value="">No dates/options</option>';
    console.warn('No valid dates found across inputs.');
    return;
  }
  if (sel) sel.innerHTML = dates.map(d => `<option value="${d}">${d}</option>`).join('');

  const requested = (window.currentDate || '').trim();
  const chosen = dates.includes(requested) ? requested : dates[dates.length - 1];
  window.currentDate = chosen;
  if (sel) sel.value = chosen;

  if (sel && !sel._wired){
    sel.addEventListener('change', e => {
      window.currentDate = e.target.value;
      currentPage = 1;
      renderAll();
    });
    sel._wired = true;
  }

  document.getElementById('refreshBtn').onclick = () => initDatesAndRender();
  document.getElementById('clearBtn').onclick = () => { selectedCeo = ''; renderAll(); };
  document.getElementById('filterInput').addEventListener('input', () => { currentPage = 1; renderAll(); });

  renderAll();
  setupResize(); // <— responsive re-render
}

/* ===================== Charts helpers ===================== */
function getLastNDates(allDates, n){
  const ds = Array.from(new Set(allDates)).filter(isISODate).sort();
  return ds.slice(Math.max(0, ds.length - n));
}

function drawNewsStackedBar(sel, rows, dates){
  const perDate = new Map();
  for (const r of rows){
    if (!dates.includes(r.date)) continue;
    const a = perDate.get(r.date) || {pos:0, neu:0, neg:0};
    a.pos += (+r.positive||0);
    a.neu += (+r.neutral||0);
    a.neg += (+r.negative||0);
    perDate.set(r.date, a);
  }
  const data = dates.map(d => {
    const a = perDate.get(d) || {pos:0, neu:0, neg:0};
    const tot = a.pos + a.neu + a.neg;
    return {date:d,
      posPct: tot ? (a.pos/tot)*100 : 0,
      neuPct: tot ? (a.neu/tot)*100 : 0,
      negPct: tot ? (a.neg/tot)*100 : 0
    };
  });

  sel.html('');
  const W = Math.max(360, sel.node().clientWidth || 360);
  const H = 240, M = {t:16,r:16,b:36,l:42};
  const svg = sel.append('svg').attr('width', W).attr('height', H);
  const g = svg.append('g').attr('transform', `translate(${M.l},${M.t})`);
  const w = W - M.l - M.r, h = H - M.t - M.b;

  const x = d3.scaleBand().domain(dates).range([0, w]).padding(0.2);
  const y = d3.scaleLinear().domain([0,100]).range([h, 0]);

  const colors = {pos:'#82c616', neu:'#cedcdd', neg:'#ff8261'};
  data.forEach(d => {
    let y0 = 0;
    const parts = [
      {k:'posPct', c:colors.pos},
      {k:'neuPct', c:colors.neu},
      {k:'negPct', c:colors.neg},
    ];
    const gx = g.append('g').attr('transform', `translate(${x(d.date)},0)`);
    parts.forEach(p => {
      const v = d[p.k];
      const y1 = y(y0 + v), yStart = y(y0);
      gx.append('rect')
        .attr('x', 0).attr('y', y1)
        .attr('width', x.bandwidth())
        .attr('height', Math.max(0, yStart - y1))
        .attr('fill', p.c);
      y0 += v;
    });
  });

  g.append('g').attr('transform', `translate(0,${h})`)
    .call(d3.axisBottom(x).tickSizeOuter(0));
  g.append('g').call(d3.axisLeft(y).ticks(5).tickFormat(d => d + '%'));

  const legend = svg.append('g').attr('transform', `translate(${W-220},8)`);
  [{label:'Positive %', c:colors.pos},{label:'Neutral %', c:colors.neu},{label:'Negative %', c:colors.neg}]
  .forEach((it,i)=>{
    const gg = legend.append('g').attr('transform', `translate(${i*75},0)`);
    gg.append('rect').attr('width',10).attr('height',10).attr('fill',it.c);
    gg.append('text').attr('x',14).attr('y',10).attr('font-size',12).text(it.label);
  });
}

function drawSerpLines(sel, serpRows, dates){
  const per = new Map();
  dates.forEach(d => per.set(d, {neg:[], ctrl:[]}));
  for (const r of serpRows){
    if (!dates.includes(r.date)) continue;
    per.get(r.date).neg.push(+r.negative_serp_pct || 0);
    per.get(r.date).ctrl.push(+r.serp_control_pct || 0);
  }
  const data = dates.map(d => {
    const a = per.get(d);
    const avg = arr => arr.length ? arr.reduce((x,y)=>x+y,0)/arr.length : 0;
    return {date:d, neg:avg(a.neg), ctrl:avg(a.ctrl)};
  });

  sel.html('');
  const W = Math.max(360, sel.node().clientWidth || 360);
  const H = 240, M = {t:16,r:16,b:36,l:42};
  const svg = sel.append('svg').attr('width', W).attr('height', H);
  const g = svg.append('g').attr('transform', `translate(${M.l},${M.t})`);
  const w = W - M.l - M.r, h = H - M.t - M.b;

  const x = d3.scalePoint().domain(dates).range([0, w]).padding(0.5);
  const y = d3.scaleLinear().domain([0,100]).nice().range([h, 0]);

  const line = d3.line().x(d => x(d.date)).y(d => y(d.value));

  const series = [
    {name:'Negative SERP %', key:'neg', color:'#ff8261'},
    {name:'SERP Control %', key:'ctrl', color:'#58dbed'}
  ];

  series.forEach(s=>{
    const pathData = data.map(d => ({date:d.date, value:d[s.key]}));
    g.append('path')
      .attr('fill','none')
      .attr('stroke-width',2)
      .attr('stroke', s.color)
      .attr('d', line(pathData));
  });

  g.append('g').attr('transform', `translate(0,${h})`)
    .call(d3.axisBottom(x).tickSizeOuter(0));
  g.append('g').call(d3.axisLeft(y).ticks(5).tickFormat(d => d + '%'));

  const legend = svg.append('g').attr('transform', `translate(${W-230},8)`);
  [{label:'Negative SERP %', c:'#ff8261'},{label:'SERP Control %',  c:'#58dbed'}]
  .forEach((it,i)=>{
    const gg = legend.append('g').attr('transform', `translate(${i*110},0)`);
    gg.append('rect').attr('width',10).attr('height',10).attr('fill',it.c);
    gg.append('text').attr('x',14).attr('y',10).attr('font-size',12).text(it.label);
  });
}

/* ===================== Rendering ===================== */
function sortByKey(rows){
  const k = currentSort.key, dir = currentSort.dir;
  if (!k) return rows;
  const val = r => (k === 'risk') ? ({'High':3,'Medium':2,'Low':1}[r.risk]||0) : r[k];
  return rows.slice().sort((a,b)=> (val(a) > val(b) ? 1 : -1) * dir);
}
function applyFilter(rows){
  const q = document.getElementById('filterInput').value || '';
  const v = q.trim().toLowerCase();
  if (!v) return rows;
  return rows.filter(r => r.ceo.toLowerCase().includes(v) || r.company.toLowerCase().includes(v));
}
function fmtPct(n){ return (isFinite(n) ? n.toFixed(1) : '0.0') + '%'; }

function buildRowsForDate(date){
  const serpMap = new Map(serpDaily.filter(r => r.date === date).map(r => [r.ceo.toLowerCase(), r]));
  const base = allCountsRows.filter(r => r.date === date);
  const fromRoster = [...rosterMap.entries()].map(([ceo,company]) => ({date, ceo, company, theme:'None', neg_pct:0, total:0, positive:0, neutral:0, negative:0}));
  const merged = (base.length ? base : fromRoster).map(r => {
    const k = r.ceo.toLowerCase();
    const s = serpMap.get(k) || {negative_serp_pct:0, serp_control_pct:0, risk:'Medium'};
    return {
      date: r.date || date,
      ceo: r.ceo,
      company: r.company,
      theme: r.theme || 'None',
      neg_pct: +r.neg_pct || 0,
      negative_serp_pct: +s.negative_serp_pct || 0,
      serp_control_pct: +s.serp_control_pct || 0,
      risk: s.risk || computeRisk(0,100)
    };
  });
  return merged;
}

function renderTable(rows){
  const tbody = document.querySelector('#dataTable tbody');
  tbody.innerHTML = '';

  const start = (currentPage - 1) * PAGE_SIZE;
  const pageRows = rows.slice(start, start + PAGE_SIZE);

  for (const r of pageRows){
    const tr = document.createElement('tr');

    const tdCeo = document.createElement('td');
    tdCeo.innerHTML = `<label><input class="checkbox" type="checkbox" ${selectedCeo===r.ceo?'checked':''} /> <strong>${r.ceo}</strong></label>`;
    tdCeo.querySelector('input').addEventListener('change', (e)=>{
      selectedCeo = e.target.checked ? r.ceo : '';
      document.querySelectorAll('#dataTable tbody input[type="checkbox"]').forEach(box=>{
        if (box!==e.target) box.checked = false;
      });
      renderChartsForSelection();
    });
    tr.appendChild(tdCeo);

    const tdCo = document.createElement('td'); tdCo.textContent = r.company; tr.appendChild(tdCo);
    const tdTheme = document.createElement('td'); tdTheme.textContent = r.theme || 'None'; tr.appendChild(tdTheme);

    const tdNegNews = document.createElement('td'); tdNegNews.className='right'; tdNegNews.textContent = fmtPct(+r.neg_pct); tr.appendChild(tdNegNews);

    const tdNegSerp = document.createElement('td'); tdNegSerp.className='right'; tdNegSerp.textContent = fmtPct(+r.negative_serp_pct); tr.appendChild(tdNegSerp);

    const tdCtrl = document.createElement('td'); tdCtrl.className='right'; tdCtrl.textContent = fmtPct(+r.serp_control_pct); tr.appendChild(tdCtrl);

    const tdRisk = document.createElement('td');
    const riskClass = r.risk === 'High' ? 'high' : (r.risk === 'Medium' ? 'med' : 'low');
    tdRisk.innerHTML = `<span class="pill ${riskClass}">${r.risk}</span>`;
    tr.appendChild(tdRisk);

    const mkBtn = (label, fn) => {
      const td = document.createElement('td'); td.className='center';
      const b = document.createElement('button'); b.textContent = label;
      b.onclick = () => fn(r);
      td.appendChild(b);
      return td;
    };
    tr.appendChild(mkBtn('View', showHeadlines));
    tr.appendChild(mkBtn('View', showSerp));
    tr.appendChild(mkBtn('View', showBoards));

    tbody.appendChild(tr);
  }

  const totalPages = Math.max(1, Math.ceil(rows.length / PAGE_SIZE));
  document.getElementById('pageInfo').textContent = `Page ${currentPage} / ${totalPages}`;
  document.getElementById('prevBtn').onclick = () => { if (currentPage>1){ currentPage--; renderTable(rows);} };
  document.getElementById('nextBtn').onclick = () => { if (currentPage<totalPages){ currentPage++; renderTable(rows);} };
}

function renderChartsForSelection(){
  const target = selectedCeo;
  const newsDiv = d3.select('#newsChart'); newsDiv.html('');
  const serpDiv = d3.select('#serpChart'); serpDiv.html('');

  const unionDates = [...new Set([...allCountsRows.map(r=>r.date), ...serpDaily.map(r=>r.date)])];
  const dates = getLastNDates(unionDates, LAST_N_DATES);

  // NEWS stacked 100% bar
  let newsRows = allCountsRows.filter(r => dates.includes(r.date));
  if (target) newsRows = newsRows.filter(r => r.ceo === target);
  drawNewsStackedBar(newsDiv, newsRows, dates);

  // add small caption
  const totals = newsRows.reduce((a,r)=>({pos:a.pos+(+r.positive||0), neu:a.neu+(+r.neutral||0), neg:a.neg+(+r.negative||0)}), {pos:0, neu:0, neg:0});
  newsDiv.insert('div',':first-child')
    .html(`<strong>News sentiment (percent)</strong><br/><span class="muted">Positive: ${totals.pos} | Neutral: ${totals.neu} | Negative: ${totals.neg}</span>`)
    .style('margin-bottom','6px');

  // SERP dual lines
  let sRows = serpDaily.filter(r => dates.includes(r.date));
  if (target) sRows = sRows.filter(r => r.ceo === target);
  drawSerpLines(serpDiv, sRows, dates);

  const sAgg = sRows.reduce((a,r)=>({neg:a.neg + (+r.negative_serp_pct||0), ctrl:a.ctrl + (+r.serp_control_pct||0)}), {neg:0, ctrl:0});
  const cnt = Math.max(1, sRows.length);
  serpDiv.insert('div',':first-child')
    .html(`<strong>SERP (average %)</strong><br/><span class="muted">Negative: ${(sAgg.neg/cnt).toFixed(1)}% | Control: ${(sAgg.ctrl/cnt).toFixed(1)}%</span>`)
    .style('margin-bottom','6px');
}

/* ===================== Responsive charts ===================== */
function setupResize(){
  if (window.__chartsResizeSetup) return;
  window.__chartsResizeSetup = true;

  let t;
  const debounced = () => { clearTimeout(t); t = setTimeout(()=>renderChartsForSelection(), 150); };

  // Observe the charts container
  const el = document.getElementById('chartsStack');
  if (el && 'ResizeObserver' in window){
    const ro = new ResizeObserver(debounced);
    ro.observe(el);
  }
  // Fallback: window resize
  window.addEventListener('resize', debounced);
}

/* ===================== Popups ===================== */
const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modalTitle');
const modalBody = document.getElementById('modalBody');
document.getElementById('modalClose').onclick = ()=> modal.classList.remove('show');

function openModal(title, html){
  modalTitle.textContent = title;
  modalBody.innerHTML = html;
  modal.classList.add('show');
}

async function showHeadlines(row){
  const d = document.getElementById('dateSelect').value;
  const path = `data_ceos/articles/${d}-articles.csv`;
  let items = [];
  try{
    const rows = await fetchCsv(path);
    items = rows.filter(r => String(r.ceo||'').trim() === row.ceo);
  }catch(e){}
  if (!items.length){
    openModal(`Headlines — ${row.ceo}`, `<div class="muted">No headlines for ${row.ceo} on ${d}.</div>`);
    return;
  }
  const list = items.map(r => {
    const sent = String(r.sentiment||'').toLowerCase();
    const chip = sent==='negative' ? 'high' : (sent==='neutral' ? 'med' : 'low');
    const src = r.source ? ` — <span class="muted">${r.source}</span>` : '';
    return `<li><a class="link" href="${r.url}" target="_blank" rel="noopener">${r.title||'(no title)'}</a> <span class="pill ${chip}">${sent||'neutral'}</span>${src}</li>`;
  }).join('');
  openModal(`Headlines — ${row.ceo}`, `<div class="muted">Showing ${d}</div><ul>${list}</ul>`);
}

function normalizeKey(s){
  return String(s||'')
    .toLowerCase()
    .replace(/[^a-z0-9]+/g,' ')
    .trim()
    .replace(/\s+/g,' ');
}

async function showSerp(row){
  const d = document.getElementById('dateSelect').value;
  const path = `data_ceos/processed_serps/${d}-ceo-serps-processed.csv`;
  let items = [];
  try{
    const rows = await fetchCsv(path);
    // robust alias match: "CEO Company"
    const alias = normalizeKey(`${row.ceo} ${row.company}`);
    items = rows.filter(r => {
      const comp = normalizeKey(r.company || r.alias || '');
      return comp === alias || (comp.includes(normalizeKey(row.ceo)) && comp.includes(normalizeKey(row.company)));
    });
  }catch(e){}
  if (!items.length){
    openModal(`Serp — ${row.ceo}`, `<div class="muted">Could not load SERP file for ${d}.</div>`);
    return;
  }
  const top = items.slice(0, 50).map((r,i)=>{
    const s = String(r.sentiment||'neutral').toLowerCase();
    const c = String(r.control_status||'uncontrolled').toLowerCase();
    const sChip = s==='negative' ? 'high' : (s==='neutral' ? 'med' : 'low');
    const cLabel = c==='controlled' ? 'Controlled' : 'Uncontrolled';
    return `<tr>
      <td class="right">${r.position||i+1}</td>
      <td><a class="link" href="${r.link}" target="_blank" rel="noopener">${r.title||'(no title)'}</a></td>
      <td><span class="pill ${sChip}">${s}</span></td>
      <td>${cLabel}</td>
    </tr>`;
  }).join('');
  openModal(`Serp — ${row.ceo}`,
    `<div class="muted">${items.length} results — showing ${Math.min(50, items.length)} (date ${d})</div>
     <table class="table"><thead><tr>
       <th class="right">#</th><th>Result</th><th>Sentiment</th><th>Control</th>
     </tr></thead><tbody>${top}</tbody></table>`
  );
}

function showBoards(row){
  const boards = boardsByCeo.get(row.ceo) || [];
  if (!boards.length){
    openModal(`Boards — ${row.ceo}`, `<div class="muted">No boards found.</div>`);
    return;
  }
  const list = boards.map(b=>{
    const text = (b.domain || new URL(b.url).hostname.replace(/^www\./,''));
    return `<li><a class="link" href="${b.url}" target="_blank" rel="noopener">${text}</a></li>`;
  }).join('');
  openModal(`Boards — ${row.ceo}`, `<ul>${list}</ul>`);
}

/* ===================== Sort hooks ===================== */
document.querySelectorAll('#dataTable thead th').forEach((th, idx)=>{
  const keys = ['ceo','company','theme','neg_pct','negative_serp_pct','serp_control_pct','risk'];
  const key = keys[idx];
  if (!key) return;
  th.style.cursor = 'pointer';
  th.addEventListener('click', ()=>{
    if (currentSort.key === key) currentSort.dir *= -1;
    else currentSort = {key, dir: 1};
    renderAll();
  });
});

/* ===================== Boot ===================== */
initDatesAndRender();
</script>
</body>
</html>
