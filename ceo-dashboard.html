<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CEO Risk Dashboard</title>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>

<style>
:root{
  --bg:#1f2121;
  --card:#111f24;
  --muted:#98c0cb;
  --text:#e7f5f6;
  --accent:#58dbed;
  --brand:#00809e;
  --chipHigh:#ff8261;
  --chipMed:#ffc32e;
  --chipLow:#82c616;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
.wrap{max-width:1200px;margin:0 auto;padding:24px}
h1{font-size:24px;margin:0 0 12px}
.controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:12px 0}
.card{background:var(--card);border:1px solid #0e3240;border-radius:12px;padding:16px;box-shadow:0 4px 20px rgba(0,0,0,.25)}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media(min-width:980px){.grid{grid-template-columns:2fr 1fr}}
select,input[type="text"]{background:#0c1220;border:1px solid #23314d;color:var(--text);border-radius:10px;padding:8px 10px}
button{background:#18243b;border:1px solid #2a3b5e;color:var(--text);border-radius:10px;padding:8px 10px;cursor:pointer}
button:hover{border-color:#35d8ea}

.table{width:100%;border-collapse:separate;border-spacing:0 8px}
thead th{font-size:12px;color:var(--muted);text-align:left;padding:0 8px}
tbody tr{background:#0e1524}
tbody td{padding:10px 8px;border-top:1px solid #17223a;border-bottom:1px solid #17223a}
tbody tr td:first-child{border-left:1px solid #17223a;border-radius:10px 0 0 10px}
tbody tr td:last-child{border-right:1px solid #17223a;border-radius:0 10px 10px 0}

.pill{padding:4px 8px;border-radius:999px;font-size:12px}
.pill.low{background:rgba(34,197,94,.15);color:#5fe08b}
.pill.med{background:rgba(234,179,8,.15);color:#f5e37a}
.pill.high{background:rgba(244,63,94,.15);color:#ff7b7b}
.muted{color:var(--muted)}
.right{text-align:right}
.center{text-align:center}

.pagination{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:8px}
.checkbox{accent-color:var(--accent)}

.modal{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;padding:24px}
.modal.show{display:flex}
.modal > .box{background:#0e1524;border:1px solid #23314d;border-radius:12px;max-width:900px;width:100%;max-height:80vh;overflow:auto}
.modal header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #0d2a46}
.modal .content{padding:16px}
.link{color:#92e8ef}
</style>
</head>
<body>
<div class="wrap">
  <h1>CEO Risk Dashboard</h1>

  <div class="controls card">
    <div>
      <div class="muted" style="font-size:12px;margin-bottom:4px">Date</div>
      <select id="dateSelect"></select>
    </div>
    <div style="flex:1;min-width:260px">
      <div class="muted" style="font-size:12px;margin-bottom:4px">Filter (CEO or Company)</div>
      <input id="filterInput" type="text" placeholder="Type to filter…" style="width:100%" />
    </div>
    <div style="margin-left:auto;display:flex;gap:8px">
      <button id="refreshBtn">Refresh Data</button>
      <button id="clearBtn">Clear Selection</button>
    </div>
  </div>

  <div class="grid">
    <div class="card" id="newsChart"> </div>
    <div class="card" id="serpChart"> </div>
  </div>

  <div class="card" style="margin-top:16px">
    <div class="muted" style="margin-bottom:10px">
      Select exactly one CEO using the checkbox to see brand-level charts. Selecting another will automatically unselect the previous one.
    </div>

    <table class="table" id="dataTable">
      <thead>
        <tr>
          <th>CEO</th>
          <th>Company</th>
          <th>Theme</th>
          <th class="right">Negative News % ▲▼</th>
          <th class="right">Negative SERP % ▲▼</th>
          <th class="right">SERP Control % ▲▼</th>
          <th>Risk ▲▼</th>
          <th class="center">Headlines</th>
          <th class="center">SERP</th>
          <th class="center">Boards</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="pagination">
      <button id="prevBtn">Prev</button>
      <div class="muted" id="pageInfo">Page</div>
      <button id="nextBtn">Next</button>
    </div>
  </div>
</div>

<!-- Headlines modal -->
<div class="modal" id="modal">
  <div class="box">
    <header>
      <div id="modalTitle" class="muted">Modal</div>
      <button id="modalClose">Close</button>
    </header>
    <div class="content" id="modalBody">Loading…</div>
  </div>
</div>

<script>
/* ===================== Config & globals ===================== */
const COUNTS_CANDIDATES = [
  'data_ceos/daily_counts.csv',     // preferred
  'data/serps/daily_counts.csv',    // legacy fallback (if you had this)
  'data/daily_counts.csv'           // last-ditch
];

const SERPS_DAILY_CSV = 'data/serps/ceo_serps_daily.csv';

const ROSTER_CANDIDATES = [
  'data/serps/roster.csv',
  'data/roster.csv',
  'data/ceo_companies.csv'
];

const BOARDS_CSV = 'data/ceo_boards.csv';   // correct path

let rosterMap = new Map();      // CEO -> Company
let companyToCeo = new Map();   // Company -> CEO
let allCountsRows = [];         // normalized rows from daily_counts (all dates)
let serpDaily = [];             // per-date SERP aggregates (index)
let boardsByCeo = new Map();    // CEO -> [{domain,url},...]

let filteredRows = [];          // table rows for current date after filter
let currentSort = { key: null, dir: 1 };
let currentPage = 1;
const PAGE_SIZE = 25;

let newSchart, serpChart;

const isISODate = s => /^\d{4}-\d{2}-\d{2}$/.test(String(s||'').trim());

/* ===================== CSV helpers ===================== */
async function fetchCsv(url){
  const r = await fetch(url, {cache:'no-store'});
  if (!r.ok) throw new Error(`HTTP ${r.status} for ${url}`);
  const t = await r.text();
  return await new Promise((res, rej)=>(
    Papa.parse(t, {header:true, skipEmptyLines:true,
      complete: out => res(out.data || []),
      error: e => rej(e)
    })
  ));
}
async function fetchCsvAny(candidates){
  for (const u of candidates){
    try{
      const rows = await fetchCsv(u);
      if (Array.isArray(rows)) return rows;
    }catch(e){}
  }
  return [];
}

/* ===================== Loaders ===================== */

// Boards (CEO, URL, Domain)
async function loadBoards(){
  try{
    const rows = await fetchCsv(BOARDS_CSV);
    const norm = r => {
      const ceo = String(r.ceo || r.CEO || '').trim();
      const url = String(r.url || r.URL || '').trim();
      let domain = String(r.domain || r.Domain || '').trim();
      if (!domain && url){
        try{ domain = new URL(url).hostname.replace(/^www\./,''); }catch(_){}
      }
      return {ceo, url, domain};
    };
    const arr = rows.map(norm).filter(r => r.ceo && (r.url || r.domain));
    boardsByCeo = new Map();
    for (const row of arr){
      const list = boardsByCeo.get(row.ceo) || [];
      list.push({domain: row.domain || 'Board', url: row.url || '#'});
      boardsByCeo.set(row.ceo, list);
    }
  }catch(e){
    boardsByCeo = new Map();
  }
}

// Roster -> CEO <-> Company
async function loadRoster(){
  try{
    const rows = await fetchCsvAny(ROSTER_CANDIDATES);
    const norm = r => {
      const ceo = String(r.ceo || r.CEO || '').trim();
      const company = String(r.company || r.Company || '').trim();
      return {ceo, company};
    };
    const arr = rows.map(norm).filter(r => r.ceo && r.company);
    rosterMap = new Map(arr.map(r => [r.ceo, r.company]));
    companyToCeo = new Map(arr.map(r => [r.company, r.ceo]));
  }catch(e){
    rosterMap = new Map(); companyToCeo = new Map();
  }
}

// News counts (daily_counts.csv)
async function loadCounts(){
  try{
    const rows = await fetchCsvAny(COUNTS_CANDIDATES);
    const norm = r => ({
      date: String(r.date || r.Date || '').trim(),
      ceo: String(r.ceo || r.CEO || '').trim(),
      company: String(r.company || r.Company || '').trim(),
      theme: String(r.theme || r.Theme || 'None').trim(),
      negative: +(r.negative || r.Negative || 0),
      neutral: +(r.neutral || r.Neutral || 0),
      positive: +(r.positive || r.Positive || 0),
      total: +(r.total || r.Total || 0),
      neg_pct: +((r.neg_pct || r['neg pct'] || r.negative_pct || 0))
    });
    allCountsRows = rows.map(norm).filter(x => isISODate(x.date));
  }catch(e){
    allCountsRows = [];
  }
}

// SERP daily → compute % and risk
function computeRisk(negPct, controlPct){
  if (negPct >= 40 || controlPct <= 30) return "High";
  if (negPct >= 20 || controlPct <= 50) return "Medium";
  return "Low";
}
async function loadSerpDaily(){
  try{
    const rows = await fetchCsv(SERPS_DAILY_CSV);
    const norm = r => {
      const date   = String(r.date || r.Date || '').trim();
      const ceo    = String(r.ceo || r.CEO || '').trim();
      const company= String(r.company || r.Company || '').trim();
      const total       = +((r.total ?? r.Total) || 0);
      const controlled  = +((r.controlled ?? r.Controlled) || 0);
      const negCount    = +((r.negative_serp ?? r.Negative_Serp ?? r.neg_serp ?? r.Negative) || 0);
      const serpControlPct  = total ? (controlled / total) * 100 : 0;
      const negativeSerpPct = total ? (negCount  / total) * 100 : 0;
      return {
        date, ceo, company, total, controlled,
        negative_serp: negCount,
        serp_control_pct: +serpControlPct.toFixed(1),
        negative_serp_pct: +negativeSerpPct.toFixed(1),
        risk: computeRisk(negativeSerpPct, serpControlPct)
      };
    };
    serpDaily = rows.map(norm).filter(x => isISODate(x.date));
  }catch(e){
    console.error('Could not load SERPS_DAILY_CSV', e);
    serpDaily = [];
  }
}

/* ===================== UI bootstrap ===================== */
async function initDatesAndRender(){
  const sel = document.getElementById('dateSelect');
  if (sel) sel.innerHTML = '<option>Loading…</option>';

  await Promise.all([loadRoster(), loadCounts(), loadSerpDaily(), loadBoards()]);

  const dates = [...new Set([
    ...serpDaily.map(r => r.date),
    ...allCountsRows.map(r => r.date)
  ])].filter(isISODate).sort();

  if (!dates.length){
    if (sel) sel.innerHTML = '<option value="">No dates/options</option>';
    console.warn('No valid dates found across inputs.');
    return;
  }
  if (sel) sel.innerHTML = dates.map(d => `<option value="${d}">${d}</option>`).join('');

  const requested = (window.currentDate || '').trim();
  const chosen = dates.includes(requested) ? requested : dates[dates.length - 1];
  window.currentDate = chosen;
  if (sel) sel.value = chosen;

  if (sel && !sel._wired){
    sel.addEventListener('change', e => {
      window.currentDate = e.target.value;
      currentPage = 1;
      renderAll();
    });
    sel._wired = true;
  }

  document.getElementById('refreshBtn').onclick = () => initDatesAndRender();
  document.getElementById('clearBtn').onclick = () => { selectedCeo = ''; renderAll(); };
  document.getElementById('filterInput').addEventListener('input', () => { currentPage = 1; renderAll(); });

  renderAll();
}

/* ===================== Rendering ===================== */
let selectedCeo = '';

function sortByKey(rows){
  const k = currentSort.key, dir = currentSort.dir;
  if (!k) return rows;
  const val = r => (k === 'risk') ? ({'High':3,'Medium':2,'Low':1}[r.risk]||0) : r[k];
  return rows.slice().sort((a,b)=> (val(a) > val(b) ? 1 : -1) * dir);
}

function applyFilter(rows){
  const q = document.getElementById('filterInput').value || '';
  const v = q.trim().toLowerCase();
  if (!v) return rows;
  return rows.filter(r =>
    r.ceo.toLowerCase().includes(v) ||
    r.company.toLowerCase().includes(v)
  );
}

function fmtPct(n){ return (isFinite(n) ? n.toFixed(1) : '0.0') + '%'; }

function buildRowsForDate(date){
  // build a map from SERP daily for the date
  const serpMap = new Map(serpDaily.filter(r => r.date === date).map(r => [r.ceo.toLowerCase(), r]));
  // base rows from news counts (fall back to roster if missing)
  const base = allCountsRows.filter(r => r.date === date);
  const fromRoster = [...rosterMap.entries()].map(([ceo,company]) => ({date, ceo, company, theme:'None', neg_pct:0, total:0, positive:0, neutral:0, negative:0}));
  const merged = (base.length ? base : fromRoster).map(r => {
    const k = r.ceo.toLowerCase();
    const s = serpMap.get(k) || {negative_serp_pct:0, serp_control_pct:0, risk:'Medium'};
    return {
      date: r.date || date,
      ceo: r.ceo,
      company: r.company,
      theme: r.theme || 'None',
      neg_pct: +r.neg_pct || 0,
      negative_serp_pct: +s.negative_serp_pct || 0,
      serp_control_pct: +s.serp_control_pct || 0,
      risk: s.risk || computeRisk(0,100)
    };
  });
  return merged;
}

function renderTable(rows){
  const tbody = document.querySelector('#dataTable tbody');
  tbody.innerHTML = '';

  const start = (currentPage - 1) * PAGE_SIZE;
  const pageRows = rows.slice(start, start + PAGE_SIZE);

  for (const r of pageRows){
    const tr = document.createElement('tr');

    const tdCeo = document.createElement('td');
    tdCeo.innerHTML = `<label><input class="checkbox" type="checkbox" ${selectedCeo===r.ceo?'checked':''} /> <strong>${r.ceo}</strong></label>`;
    tdCeo.querySelector('input').addEventListener('change', (e)=>{
      selectedCeo = e.target.checked ? r.ceo : '';
      // uncheck other checkboxes
      document.querySelectorAll('#dataTable tbody input[type="checkbox"]').forEach(box=>{
        if (box!==e.target) box.checked = false;
      });
      renderChartsForSelection();
    });
    tr.appendChild(tdCeo);

    const tdCo = document.createElement('td'); tdCo.textContent = r.company; tr.appendChild(tdCo);
    const tdTheme = document.createElement('td'); tdTheme.textContent = r.theme || 'None'; tr.appendChild(tdTheme);

    const tdNegNews = document.createElement('td'); tdNegNews.className='right'; tdNegNews.textContent = fmtPct(+r.neg_pct); tr.appendChild(tdNegNews);

    const tdNegSerp = document.createElement('td'); tdNegSerp.className='right'; tdNegSerp.textContent = fmtPct(+r.negative_serp_pct); tr.appendChild(tdNegSerp);

    const tdCtrl = document.createElement('td'); tdCtrl.className='right'; tdCtrl.textContent = fmtPct(+r.serp_control_pct); tr.appendChild(tdCtrl);

    const tdRisk = document.createElement('td');
    const riskClass = r.risk === 'High' ? 'high' : (r.risk === 'Medium' ? 'med' : 'low');
    tdRisk.innerHTML = `<span class="pill ${riskClass}">${r.risk}</span>`;
    tr.appendChild(tdRisk);

    // actions
    const mkBtn = (label, fn) => {
      const td = document.createElement('td'); td.className='center';
      const b = document.createElement('button'); b.textContent = label;
      b.onclick = () => fn(r);
      td.appendChild(b);
      return td;
    };
    tr.appendChild(mkBtn('View', showHeadlines));
    tr.appendChild(mkBtn('View', showSerp));
    tr.appendChild(mkBtn('View', showBoards));

    tbody.appendChild(tr);
  }

  const totalPages = Math.max(1, Math.ceil(rows.length / PAGE_SIZE));
  document.getElementById('pageInfo').textContent = `Page ${currentPage} / ${totalPages}`;
  document.getElementById('prevBtn').onclick = () => { if (currentPage>1){ currentPage--; renderTable(rows);} };
  document.getElementById('nextBtn').onclick = () => { if (currentPage<totalPages){ currentPage++; renderTable(rows);} };
}

function renderAll(){
  const date = document.getElementById('dateSelect').value;
  let rows = buildRowsForDate(date);
  rows = applyFilter(rows);
  rows = sortByKey(rows);
  filteredRows = rows;
  currentPage = Math.min(currentPage, Math.max(1, Math.ceil(rows.length / PAGE_SIZE)));
  renderTable(rows);
  renderChartsForSelection();
}

/* ===================== Charts (simple summary) ===================== */
function renderChartsForSelection(){
  const date = document.getElementById('dateSelect').value;
  const target = selectedCeo;
  const newsDiv = d3.select('#newsChart'); newsDiv.html('');
  const serpDiv = d3.select('#serpChart'); serpDiv.html('');

  const base = allCountsRows.filter(r => r.date===date);
  if (!base.length){ newsDiv.append('div').text('No news data.'); return; }

  let rows = base;
  if (target){
    rows = base.filter(r => r.ceo === target);
    if (!rows.length){ newsDiv.append('div').text('No news for selected CEO.'); }
  }

  // Build stacked bar for Positive/Neutral/Negative counts across the set
  const data = rows.map(r => ({ label: r.ceo || 'All', pos:+r.positive||0, neu:+r.neutral||0, neg:+r.negative||0 }));
  // simple total summary
  const total = data.reduce((a,r)=>({pos:a.pos+r.pos, neu:a.neu+r.neu, neg:a.neg+r.neg}), {pos:0,neu:0,neg:0});
  newsDiv.append('div').html(`<strong>News sentiment (counts)</strong><br/>Positive: ${total.pos} | Neutral: ${total.neu} | Negative: ${total.neg}`);

  // SERP summary
  const serpRows = serpDaily.filter(r => r.date===date && (!target || r.ceo===target));
  if (!serpRows.length){ serpDiv.append('div').text('No SERP data.'); return; }
  const sTot = serpRows.reduce((a,r)=>({
    neg: a.neg + (+r.negative_serp_pct||0),
    ctrl: a.ctrl + (+r.serp_control_pct||0)
  }), {neg:0, ctrl:0});
  const avgNeg = sTot.neg / serpRows.length;
  const avgCtrl = sTot.ctrl / serpRows.length;
  serpDiv.append('div').html(`<strong>SERP (average %)</strong><br/>Negative: ${fmtPct(avgNeg)} | Control: ${fmtPct(avgCtrl)}`);
}

/* ===================== Popups ===================== */
const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modalTitle');
const modalBody = document.getElementById('modalBody');
document.getElementById('modalClose').onclick = ()=> modal.classList.remove('show');

function openModal(title, html){
  modalTitle.textContent = title;
  modalBody.innerHTML = html;
  modal.classList.add('show');
}

async function showHeadlines(row){
  const d = document.getElementById('dateSelect').value;
  const path = `data_ceos/articles/${d}-articles.csv`;
  let items = [];
  try{
    const rows = await fetchCsv(path);
    items = rows.filter(r => String(r.ceo||'').trim() === row.ceo);
  }catch(e){}
  if (!items.length){
    openModal(`Headlines — ${row.ceo}`, `<div class="muted">No headlines for ${row.ceo} on ${d}.</div>`);
    return;
  }
  const list = items.map(r => {
    const sent = String(r.sentiment||'').toLowerCase();
    const chip = sent==='negative' ? 'high' : (sent==='neutral' ? 'med' : 'low');
    const src = r.source ? ` — <span class="muted">${r.source}</span>` : '';
    return `<li><a class="link" href="${r.url}" target="_blank" rel="noopener">${r.title||'(no title)'}</a> <span class="pill ${chip}">${sent||'neutral'}</span>${src}</li>`;
  }).join('');
  openModal(`Headlines — ${row.ceo}`, `<div class="muted">Showing ${d}</div><ul>${list}</ul>`);
}

async function showSerp(row){
  const d = document.getElementById('dateSelect').value;
  const path = `data_ceos/processed_serps/${d}-ceo-serps-processed.csv`;
  let items = [];
  try{
    const rows = await fetchCsv(path);
    const alias = `${row.ceo} ${row.company}`.toLowerCase();
    items = rows.filter(r => String(r.company||'').toLowerCase() === alias);
  }catch(e){}
  if (!items.length){
    openModal(`Serp — ${row.ceo}`, `<div class="muted">Could not load SERP file for ${d}.</div>`);
    return;
  }
  // Expect columns: position, title, link, sentiment, control_status, ...
  const top = items.slice(0, 50).map((r,i)=>{
    const s = String(r.sentiment||'neutral').toLowerCase();
    const c = String(r.control_status||'uncontrolled').toLowerCase();
    const sChip = s==='negative' ? 'high' : (s==='neutral' ? 'med' : 'low');
    const cLabel = c==='controlled' ? 'Controlled' : 'Uncontrolled';
    return `<tr>
      <td class="right">${r.position||i+1}</td>
      <td><a class="link" href="${r.link}" target="_blank" rel="noopener">${r.title||'(no title)'}</a></td>
      <td><span class="pill ${sChip}">${s}</span></td>
      <td>${cLabel}</td>
    </tr>`;
  }).join('');
  openModal(`Serp — ${row.ceo}`,
    `<div class="muted">${items.length} results — showing ${Math.min(50, items.length)} (date ${d})</div>
     <table class="table"><thead><tr>
       <th class="right">#</th><th>Result</th><th>Sentiment</th><th>Control</th>
     </tr></thead><tbody>${top}</tbody></table>`
  );
}

function showBoards(row){
  const boards = boardsByCeo.get(row.ceo) || [];
  if (!boards.length){
    openModal(`Boards — ${row.ceo}`, `<div class="muted">No boards found.</div>`);
    return;
  }
  const list = boards.map(b=>{
    const text = (b.domain || new URL(b.url).hostname.replace(/^www\./,''));
    return `<li><a class="link" href="${b.url}" target="_blank" rel="noopener">${text}</a></li>`;
  }).join('');
  openModal(`Boards — ${row.ceo}`, `<ul>${list}</ul>`);
}

/* ===================== Sort hooks ===================== */
document.querySelectorAll('#dataTable thead th').forEach((th, idx)=>{
  const keys = ['ceo','company','theme','neg_pct','negative_serp_pct','serp_control_pct','risk'];
  const key = keys[idx];
  if (!key) return;
  th.style.cursor = 'pointer';
  th.addEventListener('click', ()=>{
    if (currentSort.key === key) currentSort.dir *= -1;
    else currentSort = {key, dir: 1};
    renderAll();
  });
});

/* ===================== Boot ===================== */
initDatesAndRender();
</script>
</body>
</html>
