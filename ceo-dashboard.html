<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CEO News Sentiment Dashboard</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Papa Parse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    /* Keep CEO + Company left-aligned even when they wrap */
    td[data-col="ceo-name"], td[data-col="company-name"]{
      text-align:left !important; vertical-align:top;
    }
    td[data-col="ceo-name"] > *, td[data-col="company-name"] > *{
      text-align:left !important; white-space:normal; word-break:break-word;
      line-height:1.15; display:inline-block;
    }
    .th-sort{ cursor:pointer; user-select:none; }
    .th-sort .arrow{ opacity:.35; margin-left:.25rem }
    .th-sort.active .arrow{ opacity:1 }
    #trendWrap{ height:20rem; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-7xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-3xl font-bold">CEO News Sentiment Dashboard</h1>
      <p class="text-sm text-slate-600">
        Shows the top 25 Fortune 500 CEOs by <em>negative</em> article count for a selected day.
        Data sources: <code>data_ceos/daily_counts.csv</code>, <code>data/serps/ceo_serps.csv</code>, <code>data/ceo_boards.csv</code>.
      </p>
    </header>

    <!-- Controls -->
    <section class="mb-4 grid gap-3 md:grid-cols-3">
      <div>
        <label class="block text-sm font-medium mb-1">Pick date</label>
        <select id="dateSelect" class="w-full border rounded-lg p-2 bg-white"></select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Filter CEOs</label>
        <input id="ceoFilter" type="text" placeholder="Type to filter…" class="w-full border rounded-lg p-2"/>
      </div>
      <div class="flex items-end gap-2">
        <button id="refreshBtn" class="px-3 py-2 rounded-lg bg-slate-900 text-white">Refresh</button>
      </div>
    </section>

    <!-- Trend -->
    <section class="mb-6 p-4 border rounded-xl bg-white">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-lg font-semibold">Sentiment trend</h2>
        <div class="flex items-center gap-2">
          <span id="trendInfo" class="text-xs text-slate-500"></span>
          <span id="trendRange" class="text-xs text-slate-500"></span>
          <button id="trendPrev" class="px-2 py-1 border rounded disabled:opacity-40" title="Older 30 days">←</button>
          <button id="trendNext" class="px-2 py-1 border rounded disabled:opacity-40" title="Newer 30 days">→</button>
        </div>
      </div>
      <p id="trendHint" class="text-sm text-slate-500 mb-2 hidden">
        Tip: select exactly <span class="font-semibold">1</span> CEO to display a trend. When none is selected, the INDEX average is shown.
      </p>
      <div id="trendWrap"><canvas id="trendChart"></canvas></div>
    </section>

    <!-- Table -->
    <section class="overflow-x-auto">
      <table class="min-w-full text-sm bg-white rounded-xl overflow-hidden border">
        <thead class="bg-slate-100">
          <tr>
            <th class="p-3 text-left"><input type="checkbox" id="selectAll"></th>
            <th class="p-3 text-left">CEO</th>
            <th class="p-3 text-left">Company</th>
            <th class="p-3 text-left">Theme</th>
            <th class="p-3 text-left th-sort" data-sort="negnews">Negative News (%) <span class="arrow">▲▼</span></th>
            <th class="p-3 text-left th-sort" data-sort="negserp">Negative SERP (%) <span class="arrow">▲▼</span></th>
            <th class="p-3 text-left th-sort" data-sort="control">SERP Control (%) <span class="arrow">▲▼</span></th>
            <th class="p-3 text-left th-sort" data-sort="risk">Risk <span class="arrow">▲▼</span></th>
            <th class="p-3 text-left">Headlines</th>
            <th class="p-3 text-left">SERP</th>
            <th class="p-3 text-left">Boards</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>

      <!-- Pagination -->
      <div class="flex items-center justify-between mt-3">
        <div class="text-xs text-slate-500" id="status"></div>
        <div class="flex gap-2">
          <button id="prevPage" class="px-3 py-1.5 border rounded-lg">Prev</button>
          <button id="nextPage" class="px-3 py-1.5 border rounded-lg">Next</button>
        </div>
      </div>
    </section>
  </div>

  <!-- Modal -->
  <div id="modalBackdrop" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-3xl bg-white rounded-2xl shadow-xl overflow-hidden">
        <div class="flex items-center justify-between p-4 border-b">
          <div>
            <h3 id="modalTitle" class="text-xl font-bold">Details</h3>
            <p id="modalSubtitle" class="text-sm text-slate-600"></p>
          </div>
          <button id="modalClose" class="px-3 py-1.5 rounded-lg border">Close</button>
        </div>
        <div id="modalBody" class="max-h-[70vh] overflow-y-auto p-4">
          <p class="text-sm text-slate-500">Loading…</p>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  // ---- Config / paths ----
  const GH_USER = 'jonas-sickler';
  const GH_REPO = 'news-sentiment-dashboard';
  const GH_BASE = `https://${GH_USER}.github.io/${GH_REPO}/`;

  const CSV_COUNTS = 'data_ceos/daily_counts.csv';            // CEO news
  const CSV_SERPS  = 'data/serps/ceo_serps.csv';              // SERPs
  const CSV_BOARDS = 'data/ceo_boards.csv';                   // Boards

  const ROWS_PER_PAGE = 25;
  const TREND_WINDOW = 30;

  // ---- DOM ----
  const tableBody = document.getElementById('tableBody');
  const dateSelect = document.getElementById('dateSelect');
  const ceoFilter = document.getElementById('ceoFilter');
  const refreshBtn = document.getElementById('refreshBtn');
  const selectAll = document.getElementById('selectAll');
  const statusEl = document.getElementById('status');
  const prevPageBtn = document.getElementById('prevPage');
  const nextPageBtn = document.getElementById('nextPage');

  // Trend
  const trendCanvas = document.getElementById('trendChart');
  const trendInfo = document.getElementById('trendInfo');
  const trendRange = document.getElementById('trendRange');
  const trendPrev = document.getElementById('trendPrev');
  const trendNext = document.getElementById('trendNext');
  const trendHint = document.getElementById('trendHint');

  // Modal
  const modalBackdrop = document.getElementById('modalBackdrop');
  const modalTitle = document.getElementById('modalTitle');
  const modalSubtitle = document.getElementById('modalSubtitle');
  const modalBody = document.getElementById('modalBody');
  const modalClose = document.getElementById('modalClose');

  function openModal(){ modalBackdrop.classList.remove('hidden'); }
  function closeModal(){ modalBackdrop.classList.add('hidden'); }
  modalClose.addEventListener('click', closeModal);
  modalBackdrop.addEventListener('click', e => { if(e.target === modalBackdrop) closeModal(); });

  // ---- State ----
  let allRows = [];  // news counts (per CEO)
  let serps = [];    // SERPs
  let boards = [];   // Boards
  let currentDate = null;

  let page = 0;
  let sortKey = 'negnews';
  let sortDir = 'desc';
  let filteredRows = [];
  let trendChart=null, trendPage=0, trendTarget=null;

  // ---- Helpers ----
  function asInt(x){ const n = Number(x||0); return Number.isFinite(n)?n:0; }
  function fmtPct(v, d=0){
    const x = Number(v||0);
    return (Math.round(x * Math.pow(10,d)) / Math.pow(10,d)).toFixed(d).replace(/\.0+$/,'') + '%';
  }
  function sentimentBadge(s){
    const base = 'inline-block px-2 py-0.5 rounded-full text-xs';
    if((s||'').toLowerCase()==='negative') return `<span class="${base} bg-rose-100 text-rose-700">negative</span>`;
    if((s||'').toLowerCase()==='positive') return `<span class="${base} bg-emerald-100 text-emerald-700">positive</span>`;
    return `<span class="${base} bg-slate-100 text-slate-700">neutral</span>`;
  }
  function riskLabel(negSerp, control){
    const ns = Number(negSerp||0), ctrl = Number(control||0);
    if(ns > 0) return 'high';
    if(ns === 0 && ctrl < 70) return 'medium';
    return 'low';
  }
  function esc(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#39;'); }

  // ---- Fetch ----
  async function fetchTextCandidates(path){
    const rel = new URL(path, location.href).href + (path.includes('?')?'&':'?') + '_=' + Date.now();
    const abs = GH_BASE + path + (path.includes('?')?'&':'?') + '_=' + Date.now();
    const candidates = [rel];
    if(!rel.startsWith(GH_BASE)) candidates.push(abs);
    for(const url of candidates){
      try{
        const r = await fetch(url, {cache:'no-store', mode:'cors'});
        if(r.ok){ const t = await r.text(); if(t) return t; }
      }catch(_){}
    }
    return '';
  }

  async function loadCounts(){
    const t = await fetchTextCandidates(CSV_COUNTS);
    if(!t) return [];
    const parsed = Papa.parse(t, {header:true, dynamicTyping:true});
    return (parsed.data||[]).map(row=>{
      const r={};
      for(const k in row){
        const nk = String(k||'').replace(/^\ufeff/,'').trim().toLowerCase();
        r[nk]=row[k];
      }
      return {
        date:String(r.date||''), brand:String(r.brand||''), // brand is CEO in this CSV
        company:String(r.company||r.co||''), // some builds include company column
        total:asInt(r.total), positive:asInt(r.positive), neutral:asInt(r.neutral), negative:asInt(r.negative),
        theme:String(r.theme||'None')
      };
    }).filter(r=> r.date && r.brand);
  }

  function parseControl(val){
    if(typeof val === 'boolean') return val;
    const s = String(val||'').trim().toLowerCase();
    if(['true']()
