<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CEO Risk Dashboard</title>

<!-- Charts + CSV parser -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  :root{
    /* Terakeet palette (dark UI) */
    --bg:#0b0d12;
    --card:#111a25;
    --muted:#9ae8ef;
    --text:#e7ecf4;
    --accent:#58dbed;   /* cyan */
    --accent-2:#82c616; /* green */
    --warn:#ffc32e;     /* yellow */
    --bad:#ff8261;      /* coral */
    --chip:#23314d;
    --chip-text:#e7ecf4;
    --chip-bad:#442327;
    --chip-good:#213d2a;
    --chip-warn:#3c361b;
    --ring: rgba(88,219,237,.25);
  }

  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{
    margin:0;
    font-family: Inter, ui-sans-serif, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    color:var(--text);
    background:var(--bg);
  }

  h1{ font-size:28px; margin:24px 0 8px 0 }
  .wrap{ max-width:1200px; margin:0 auto; padding:20px }
  .controls{
    display:grid;
    grid-template-columns: 180px 1fr auto auto;
    gap:12px;
    align-items:center;
    margin-bottom:14px;
  }
  .card{
    background:var(--card);
    border-radius:14px;
    box-shadow: 0 4px 22px rgba(0,0,0,.25);
    padding:14px;
  }
  select, input[type="text"]{
    width:100%;
    padding:10px 12px;
    border-radius:10px;
    border:1px solid #23314d;
    background:#0f1621;
    color:var(--text);
    outline:none;
  }
  button{
    padding:10px 14px;
    border-radius:10px;
    border:1px solid #23314d;
    color:var(--text);
    background:#0f1621;
    cursor:pointer;
  }
  button:hover{ box-shadow:0 0 0 3px var(--ring) inset }

  .grid-2{ display:grid; gap:14px; grid-template-columns:1fr }
  @media (min-width:980px){
    .grid-2{ grid-template-columns:1fr }
  }

  .legend-inline{ margin-top:6px; font-size:12px; color:#d9e2ee }

  /* Table */
  table{ width:100%; border-collapse:collapse; margin-top:10px }
  thead th{
    text-align:left; font-size:12px; color:#a6b4c6; letter-spacing:.02em; padding:8px 10px;
    border-bottom:1px solid #172733;
    user-select:none; cursor:default;
  }
  tbody td{ padding:10px; border-bottom:1px solid #13212d; vertical-align:middle }
  tbody tr:hover{ background:#0f1621 }
  .right{ text-align:right }
  .center{ text-align:center }
  .muted{ color:#a6b4c6 }

  .pill{
    display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; margin:0 4px 0 0;
    background:var(--chip); color:var(--chip-text);
  }
  .pill.bad{ background:var(--chip-bad); color:#ffd2c7 }
  .pill.good{ background:var(--chip-good); color:#c6f0d1 }
  .pill.warn{ background:var(--chip-warn); color:#ffe9b4 }

  .btn-mini{
    padding:6px 10px; font-size:12px; border-radius:10px; background:#0f1621; color:var(--text);
    border:1px solid #23314d;
  }

  /* Modal */
  .modal{ position:fixed; inset:0; display:none; place-items:center; background:rgba(4,8,12,.65); z-index:40 }
  .modal.open{ display:grid }
  .modal .box{
    width:min(900px, 92vw); max-height:82vh; overflow:auto;
    background:var(--card); border:1px solid #23314d; border-radius:14px; padding:16px;
  }
  .modal header{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px }
  .modal header h3{ margin:0; font-size:18px }
  .modal .close{ padding:8px 12px; border-radius:999px; background:#0f1621; border:1px solid #23314d; color:#d7e4f0 }

  .serp-card{
    background:#0f1621; border:1px solid #1f2d3b; border-radius:12px; padding:12px; margin:10px 0;
  }
  .serp-card h4{ margin:0 0 4px 0; font-size:15px }
  .serp-meta{ display:flex; gap:8px; flex-wrap:wrap; font-size:12px; color:#a6b4c6 }

  .flex{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
  .grow{ flex:1 }
  .small{ font-size:12px; color:#a6b4c6 }

  .charts{ display:grid; gap:14px; grid-template-columns:1fr }
  @media (min-width:980px){
    .charts{ grid-template-columns:1fr } /* stacked (bar over line) */
  }

  .kpis{ display:flex; gap:12px; flex-wrap:wrap; margin:6px 0 2px 0 }
  .kpi{ background:#0f1621; border:1px solid #23314d; border-radius:10px; padding:6px 10px; font-size:12px }
</style>
</head>
<body>
  <div class="wrap">
    <h1>CEO Risk Dashboard</h1>

    <div class="controls">
      <div>
        <div class="small">Date</div>
        <select id="dateSelect"></select>
      </div>
      <div>
        <div class="small">Filter (CEO or Company)</div>
        <input id="filterInput" type="text" placeholder="Type to filter…" />
      </div>
      <button id="refreshBtn">Refresh Data</button>
      <button id="clearBtn">Clear Selection</button>
    </div>

    <div class="charts">
      <div class="card">
        <div class="flex">
          <div class="grow"><strong>News sentiment (percent of articles)</strong></div>
          <div class="legend-inline">Legend is light for readability</div>
        </div>
        <canvas id="newsChart" height="140"></canvas>
      </div>

      <div class="card">
        <div class="flex">
          <div class="grow"><strong>SERP (Negative % • Control %)</strong></div>
          <div id="serpKpis" class="kpis"></div>
        </div>
        <canvas id="serpChart" height="140"></canvas>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <div class="small" style="margin-bottom:6px">
        Select exactly one CEO using the checkbox to see brand-level charts. Selecting another will automatically unselect the previous one.
      </div>

      <table id="results">
        <thead>
          <tr>
            <th class="center" style="width:46px">CEO</th>
            <th>CEO</th>
            <th>Company</th>
            <th class="right" data-sort="news">Negative News % ▲▼</th>
            <th class="right" data-sort="negserp">Negative SERP % ▲▼</th>
            <th class="right" data-sort="ctrl">SERP Control % ▲▼</th>
            <th data-sort="risk">Risk ▲▼</th>
            <th class="center">Headlines</th>
            <th class="center">SERP</th>
            <th class="center">Boards</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="flex" style="justify-content:flex-end; margin-top:10px">
        <div id="pageInfo" class="small"></div>
        <button class="btn-mini" id="prevBtn">Prev</button>
        <button class="btn-mini" id="nextBtn">Next</button>
      </div>
    </div>
  </div>

  <!-- Headlines Modal -->
  <div class="modal" id="headlinesModal">
    <div class="box">
      <header>
        <h3 id="headlinesTitle">Headlines</h3>
        <button class="close" data-close="#headlinesModal">Close</button>
      </header>
      <div id="headlinesBody" class="small muted">Loading…</div>
    </div>
  </div>

  <!-- SERP Modal -->
  <div class="modal" id="serpModal">
    <div class="box">
      <header>
        <h3 id="serpTitle">SERP</h3>
        <button class="close" data-close="#serpModal">Close</button>
      </header>
      <div id="serpMeta" class="small muted">Loading…</div>
      <div id="serpList"></div>
    </div>
  </div>

  <!-- Boards Modal -->
  <div class="modal" id="boardsModal">
    <div class="box">
      <header>
        <h3 id="boardsTitle">Boards</h3>
        <button class="close" data-close="#boardsModal">Close</button>
      </header>
      <div id="boardsBody" class="small muted">Loading…</div>
    </div>
  </div>

<script>
/* ======================= Config & globals ======================= */
const COUNTS_MASTER = 'data_ceos/daily_counts.csv'; // for dates + fallback
const SERPS_DAILY_CSV = 'data/serps/ceo_serps_daily.csv';
const SERP_ROWS_FMT = d => `data_ceos/serp_rows/${d}-ceo-serps-rows.csv`;
const BOARDS_CSV = 'data/serps/ceo_boards.csv';

let countsAll = [];               // master counts for all dates
let boardsByCeo = new Map();      // CEO -> [{domain,url}]
let serpDaily = [];               // SERP daily aggregates (optional)
let selectedCeo = '';             // single-select for brand charts
let currentDate = '';             // UI date
let currentPage = 1;              // paging
const PAGE_SIZE = 25;

// sorting
let currentSort = { key: null, dir: 1 };

/* ======================= Small utils ======================= */
const isISODate = s => /^\d{4}-\d{2}-\d{2}$/.test(String(s||'').trim());
function pctStr(v){
  if (v == null || Number.isNaN(v)) return 'N/A';
  return `${(v*100).toFixed(1)}%`;
}
function computeRisk(negPct, ctrlPct){
  if (negPct == null || ctrlPct == null) return '—';
  if (negPct >= 0.30 || ctrlPct < 0.35) return 'High';
  if (negPct >= 0.15 || ctrlPct < 0.55) return 'Medium';
  return 'Low';
}
function domainOf(u){
  try { return new URL(u).hostname.replace(/^www\./,''); } catch(e){ return ''; }
}

/* ======================= CSV fetchers ======================= */
async function fetchCsv(url){
  const res = await fetch(url, { cache:'no-store' });
  if (!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
  const text = await res.text();
  return new Promise((resolve,reject)=>{
    Papa.parse(text, {
      header: true,
      skipEmptyLines: true,
      complete: (out)=> resolve(out.data || []),
      error: (err)=> reject(err)
    });
  });
}

/* ======================= Loaders ======================= */
async function loadCountsMaster(){
  try{
    const rows = await fetchCsv(COUNTS_MASTER);
    countsAll = rows
      .map(r=>({
        date: String(r.date||'').trim(),
        ceo: String(r.ceo||'').trim(),
        company: String(r.company||'').trim(),
        positive: +r.positive || 0,
        neutral: +r.neutral || 0,
        negative: +r.negative || 0,
        total: +r.total || (+r.positive + +r.neutral + +r.negative) || 0,
        neg_pct: (typeof r.neg_pct !== 'undefined')
                  ? (+r.neg_pct>1 ? +r.neg_pct/100 : +r.neg_pct)
                  : ( (+r.negative||0) / Math.max(1, (+r.positive||0)+(+r.neutral||0)+(+r.negative||0)) )
      }))
      .filter(r=>isISODate(r.date));
  }catch(e){
    console.error('Could not load article counts master:', e);
    countsAll = [];
  }
}
async function getCountsForDate(date){
  // Preferred: per-day file
  try{
    const rows = await fetchCsv(`data_ceos/${date}.csv`);
    return rows.map(r=>({
      date: date,
      ceo: String(r.ceo||'').trim(),
      company: String(r.company||'').trim(),
      positive: +r.positive||0,
      neutral: +r.neutral||0,
      negative: +r.negative||0,
      total: +r.total || (+r.positive + +r.neutral + +r.negative) || 0,
      neg_pct: (typeof r.neg_pct !== 'undefined')
                 ? (+r.neg_pct>1 ? +r.neg_pct/100 : +r.neg_pct)
                 : ( (+r.negative||0) / Math.max(1,(+r.positive||0)+(+r.neutral||0)+(+r.negative||0)) )
    }));
  }catch(e){
    // Fallback: filter master
    return countsAll.filter(r=>r.date===date);
  }
}
async function loadBoards(){
  try{
    const rows = await fetchCsv(BOARDS_CSV);
    boardsByCeo = new Map();
    for(const r of rows){
      const ceo = String(r.ceo||r.CEO||'').trim();
      const url = String(r.url||r.URL||'').trim();
      const domain = String(r.domain||domainOf(url)||'').trim();
      if(!ceo) continue;
      if(!boardsByCeo.has(ceo)) boardsByCeo.set(ceo, []);
      boardsByCeo.get(ceo).push({ domain, url });
    }
  }catch(e){
    console.warn('Boards CSV not available:', e);
    boardsByCeo = new Map();
  }
}
async function loadSerpDaily(){
  try{
    const rows = await fetchCsv(SERPS_DAILY_CSV);
    serpDaily = rows.map(r=>{
      const total = +r.total || 0;
      const neg = (+r.neg_serp_pct ?? NaN);
      const ctrl = (+r.ctrl_pct ?? NaN);
      // if pct fields absent, compute from counts
      const negPct = Number.isFinite(neg) ? (neg>1? neg/100: neg)
                    : ( (+r.negative_serp||0) / Math.max(1,total) );
      const ctrlPct = Number.isFinite(ctrl) ? (ctrl>1? ctrl/100: ctrl)
                     : ( (+r.controlled||0) / Math.max(1,total) );
      return {
        date: String(r.date||'').trim(),
        ceo: String(r.ceo||'').trim(),
        company: String(r.company||'').trim(),
        neg_serp_pct: negPct,
        ctrl_pct: ctrlPct
      };
    }).filter(r=>isISODate(r.date));
  }catch(e){
    console.warn('SERP daily file optional – not found:', e);
    serpDaily = [];
  }
}

/* ======================= Date bootstrap ======================= */
async function initDatesAndRender(){
  const sel = document.getElementById('dateSelect');
  sel.innerHTML = '<option>Loading…</option>';

  await Promise.all([ loadCountsMaster(), loadBoards(), loadSerpDaily() ]);

  // Build date list from counts (primary) + SERP (optional)
  const dateSet = new Set([
    ...countsAll.map(r=>r.date),
    ...serpDaily.map(r=>r.date),
  ].filter(isISODate));
  const dates = Array.from(dateSet).sort();
  if (!dates.length){
    sel.innerHTML = '<option value="">No dates found</option>';
    return;
  }

  const requested = (currentDate||'').trim();
  const chosen = dates.includes(requested) ? requested : dates[dates.length-1];
  currentDate = chosen;
  sel.innerHTML = dates.map(d=>`<option value="${d}">${d}</option>`).join('');
  sel.value = chosen;

  if(!sel._wired){
    sel.addEventListener('change', e=>{
      currentDate = e.target.value;
      currentPage = 1;
      renderAll();
    });
    sel._wired = true;
  }

  document.getElementById('filterInput').addEventListener('input', ()=>{
    currentPage = 1; renderAll();
  });
  document.getElementById('refreshBtn').onclick = ()=> initDatesAndRender();
  document.getElementById('clearBtn').onclick = ()=>{
    selectedCeo = '';
    document.getElementById('filterInput').value = '';
    currentPage = 1;
    renderAll();
  };

  // table header sorting
  document.querySelectorAll('thead th[data-sort]').forEach(th=>{
    if(th._wired) return;
    th.addEventListener('click', ()=>{
      const key = th.getAttribute('data-sort');
      currentSort.dir = (currentSort.key===key) ? -currentSort.dir : 1;
      currentSort.key = key;
      renderAll();
    });
    th._wired = true;
  });

  document.getElementById('prevBtn').onclick = ()=>{ currentPage=Math.max(1,currentPage-1); renderTableOnly(); };
  document.getElementById('nextBtn').onclick = ()=>{ currentPage=currentPage+1; renderTableOnly(); };

  renderAll();
}

/* ======================= SERP overlay helpers ======================= */
function serpAggFor(ceo, date){
  const r = serpDaily.find(x=> x.ceo===ceo && x.date===date );
  if(!r) return { neg_serp_pct: null, ctrl_pct: null };
  return { neg_serp_pct: r.neg_serp_pct, ctrl_pct: r.ctrl_pct };
}

/* ======================= Rendering ======================= */
let newsChart, serpChart;

async function renderAll(){
  const date = currentDate;
  const filter = (document.getElementById('filterInput').value||'').trim().toLowerCase();

  const rows = (await getCountsForDate(date))
    .filter(r=>{
      if(!filter) return true;
      return r.ceo.toLowerCase().includes(filter) || r.company.toLowerCase().includes(filter);
    })
    .map(r=>{
      const {neg_serp_pct, ctrl_pct} = serpAggFor(r.ceo, date);
      return {
        ceo:r.ceo, company:r.company,
        newsNeg:r.neg_pct, negSerp:neg_serp_pct, ctrl:ctrl_pct,
        risk: computeRisk(neg_serp_pct, ctrl_pct)
      };
    });

  // Sort
  applySort(rows);

  // Charts
  drawNewsChart(date, rows);
  drawSerpChart(date);

  // Table
  renderTableRows(rows);
  updatePagerUI(rows.length);
}

function applySort(rows){
  const k = currentSort.key;
  if(!k) return;
  const dir = currentSort.dir;
  rows.sort((a,b)=>{
    const get = (obj)=>{
      if(k==='news') return obj.newsNeg ?? -1;
      if(k==='negserp') return (obj.negSerp==null?-1:obj.negSerp);
      if(k==='ctrl') return (obj.ctrl==null?-1:obj.ctrl);
      if(k==='risk'){
        const order={ 'High':3,'Medium':2,'Low':1,'—':0 };
        return order[obj.risk] ?? 0;
      }
      return 0;
    };
    return (get(a)-get(b))*dir || a.ceo.localeCompare(b.ceo);
  });
}

function paginateRows(rows){
  const total = rows.length;
  const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
  currentPage = Math.min(currentPage, totalPages);
  const start = (currentPage-1)*PAGE_SIZE;
  const pageRows = rows.slice(start, start+PAGE_SIZE);
  return { pageRows, totalPages };
}

function renderTableRows(allRows){
  const { pageRows, totalPages } = paginateRows(allRows);
  const tb = document.querySelector('#results tbody');
  tb.innerHTML = '';
  const date = currentDate;

  for(const r of pageRows){
    const tr = document.createElement('tr');

    // checkbox
    const tdSel = document.createElement('td');
    tdSel.className='center';
    const cb = document.createElement('input');
    cb.type='checkbox';
    cb.checked = (selectedCeo===r.ceo);
    cb.onclick = ()=>{
      selectedCeo = cb.checked ? r.ceo : '';
      // uncheck others
      document.querySelectorAll('#results tbody input[type=checkbox]').forEach(n=>{ if(n!==cb) n.checked=false; });
      drawNewsChart(date); drawSerpChart(date);
    };
    tdSel.appendChild(cb);

    const tdCeo = document.createElement('td'); tdCeo.textContent = r.ceo;
    const tdCo = document.createElement('td'); tdCo.textContent = r.company;

    const tdNews = document.createElement('td'); tdNews.className='right';
    tdNews.textContent = pctStr(r.newsNeg);

    const tdNeg = document.createElement('td'); tdNeg.className='right';
    tdNeg.textContent = (r.negSerp==null ? 'N/A' : pctStr(r.negSerp));

    const tdCtrl = document.createElement('td'); tdCtrl.className='right';
    tdCtrl.textContent = (r.ctrl==null ? 'N/A' : pctStr(r.ctrl));

    const tdRisk = document.createElement('td');
    const pill = document.createElement('span');
    pill.className = 'pill ' + (r.risk==='High'?'bad': r.risk==='Medium'?'warn':'good');
    pill.textContent = r.risk;
    tdRisk.appendChild(pill);

    const tdHead = document.createElement('td'); tdHead.className='center';
    tdHead.appendChild(actionBtn('View', ()=> openHeadlines(r.ceo, date)));

    const tdSerp = document.createElement('td'); tdSerp.className='center';
    tdSerp.appendChild(actionBtn('View', ()=> openSerpModal(r.ceo, date)));

    const tdBoards = document.createElement('td'); tdBoards.className='center';
    tdBoards.appendChild(actionBtn('View', ()=> openBoards(r.ceo)));

    tr.append(tdSel, tdCeo, tdCo, tdNews, tdNeg, tdCtrl, tdRisk, tdHead, tdSerp, tdBoards);
    tb.appendChild(tr);
  }

  updatePagerUI(totalPages);
}

function renderTableOnly(){ renderAll(); } // simple for now

function updatePagerUI(totalPages){
  const info = document.getElementById('pageInfo');
  info.textContent = `Page ${currentPage} / ${totalPages}`;
}

/* ======================= Buttons ======================= */
function actionBtn(label, onClick){
  const b = document.createElement('button');
  b.className='btn-mini';
  b.textContent = label;
  b.onclick = onClick;
  return b;
}

/* ======================= Charts ======================= */
function destroyChart(chart){ if(chart){ chart.destroy(); } }

async function drawNewsChart(date){
  destroyChart(newsChart);
  // Use selected CEO if any; otherwise index totals for the day
  const rows = await getCountsForDate(date);
  let pos=0,neu=0,neg=0,tot=0;

  if(selectedCeo){
    const r = rows.find(x=>x.ceo===selectedCeo);
    if(r){ pos=r.positive; neu=r.neutral; neg=r.negative; tot=r.total; }
  }else{
    for(const r of rows){ pos+=r.positive; neu+=r.neutral; neg+=r.negative; tot+=r.total; }
  }
  const P = tot? pos/tot:0, N = tot? neg/tot:0, Z = tot? neu/tot:0;

  const ctx = document.getElementById('newsChart').getContext('2d');
  newsChart = new Chart(ctx,{
    type:'bar',
    data:{
      labels:[date],
      datasets:[
        { label:'Positive %', data:[(P*100).toFixed(1)], backgroundColor:'#82c616' },
        { label:'Neutral %',  data:[(Z*100).toFixed(1)], backgroundColor:'#ffc32e' },
        { label:'Negative %',data:[(N*100).toFixed(1)], backgroundColor:'#ff8261' },
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{ labels:{ color:'#e7ecf4' } },
        tooltip:{ callbacks:{ label:(ctx)=> ctx.dataset.label+': '+Number(ctx.raw).toFixed(1)+'%' } }
      },
      scales:{
        x:{ ticks:{ color:'#cfd7e3' }, grid:{ color:'#1b2835' } },
        y:{ ticks:{ color:'#cfd7e3', callback:(v)=> v+'%' }, beginAtZero:true, max:100, grid:{ color:'#1b2835' } }
      }
    }
  });
}

function drawSerpChart(date){
  destroyChart(serpChart);
  const ctx = document.getElementById('serpChart').getContext('2d');

  // Build a small series across dates (7 recent if possible)
  const allDates = Array.from(new Set(serpDaily.map(r=>r.date))).sort();
  if(!allDates.length){
    // No SERP data at all
    ctx.canvas.getContext('2d').clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
    document.getElementById('serpKpis').innerHTML =
      `<div class="kpi">No SERP data for this date.</div>`;
    return;
  }
  // window around the selected date
  const idx = Math.max(0, allDates.indexOf(date));
  const start = Math.max(0, idx-6);
  const seriesDates = allDates.slice(start, idx+1);

  const byDate = d=>{
    const rows = serpDaily.filter(r=> r.date===d && (!selectedCeo || r.ceo===selectedCeo));
    if(!rows.length) return { neg: null, ctrl: null };
    const avg = (k)=> rows.reduce((s,x)=> s+(x[k]??0),0)/rows.length;
    return { neg: avg('neg_serp_pct'), ctrl: avg('ctrl_pct') };
  };

  const neg = seriesDates.map(d=> (byDate(d).neg==null? null : (byDate(d).neg*100).toFixed(1)) );
  const ctrl = seriesDates.map(d=> (byDate(d).ctrl==null? null : (byDate(d).ctrl*100).toFixed(1)) );

  // KPIs for the selected date
  const today = byDate(date);
  document.getElementById('serpKpis').innerHTML =
    `<div class="kpi">Negative: ${today.neg==null?'N/A':(today.neg*100).toFixed(1)+'%'}</div>
     <div class="kpi">Control: ${today.ctrl==null?'N/A':(today.ctrl*100).toFixed(1)+'%'}</div>
     <div class="kpi">Risk: ${computeRisk(today.neg, today.ctrl)}</div>`;

  serpChart = new Chart(ctx,{
    type:'line',
    data:{
      labels: seriesDates,
      datasets:[
        { label:'Negative %', data:neg, borderColor:'#ff8261', backgroundColor:'rgba(255,130,97,.25)', tension:.2, spanGaps:true },
        { label:'Control %',  data:ctrl, borderColor:'#58dbed', backgroundColor:'rgba(88,219,237,.25)', tension:.2, spanGaps:true }
      ]
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{ labels:{ color:'#e7ecf4' } } },
      scales:{
        x:{ ticks:{ color:'#cfd7e3' }, grid:{ color:'#1b2835' } },
        y:{ ticks:{ color:'#cfd7e3', callback:(v)=> v+'%' }, beginAtZero:true, max:100, grid:{ color:'#1b2835' } }
      }
    }
  });
}

/* ======================= Modals ======================= */
function openModal(id){ document.querySelector(id).classList.add('open'); }
function closeModal(id){ document.querySelector(id).classList.remove('open'); }
document.querySelectorAll('.close[data-close]').forEach(btn=>{
  btn.addEventListener('click', ()=> closeModal(btn.getAttribute('data-close')) );
});
document.querySelectorAll('.modal').forEach(m=>{
  m.addEventListener('click', (e)=>{ if(e.target===m) m.classList.remove('open') });
});

/* Headlines (placeholder – wire when your articles file is ready) */
async function openHeadlines(ceo, date){
  document.getElementById('headlinesTitle').textContent = `Headlines — ${ceo}`;
  document.getElementById('headlinesBody').textContent = `No headlines wired yet for ${date}.`;
  openModal('#headlinesModal');
}

/* SERP Modal (card layout) */
async function openSerpModal(ceo, date){
  document.getElementById('serpTitle').textContent = `SERP — ${ceo}`;
  document.getElementById('serpMeta').textContent = 'Loading…';
  document.getElementById('serpList').innerHTML = '';

  let rows=[];
  try{
    rows = await fetchCsv(SERP_ROWS_FMT(date));
  }catch(e){
    document.getElementById('serpMeta').textContent = `No SERP file for ${date}.`;
    openModal('#serpModal'); return;
  }
  const mine = rows.filter(r=> String(r.ceo||'').trim()===ceo);
  if(!mine.length){
    document.getElementById('serpMeta').textContent = `No SERPs found for ${ceo} on ${date}.`;
    openModal('#serpModal'); return;
  }

  // Compute KPIs from rows
  let total = mine.length;
  let neg = mine.filter(r=> String(r.sentiment||'').toLowerCase()==='negative').length;
  let ctrl = mine.filter(r=> String(r.controlled||'').toLowerCase()==='controlled').length;
  const negPct = total? neg/total: null;
  const ctrlPct = total? ctrl/total: null;

  document.getElementById('serpMeta').innerHTML =
    `<div class="kpis">
       <div class="kpi">Date: ${date}</div>
       <div class="kpi">Negative SERP: ${negPct==null?'N/A':(negPct*100).toFixed(1)+'%'}</div>
       <div class="kpi">Control: ${ctrlPct==null?'N/A':(ctrlPct*100).toFixed(1)+'%'}</div>
       <div class="kpi">Risk: ${computeRisk(negPct, ctrlPct)}</div>
     </div>`;

  const list = document.getElementById('serpList');
  mine.sort((a,b)=> (+a.position||999) - (+b.position||999) );
  for(const r of mine){
    const card = document.createElement('div');
    card.className='serp-card';

    const url = String(r.url||'').trim();
    const title = String(r.title||'(no title)').trim() || '(no title)';
    const snippet = String(r.snippet||'').trim();
    const sentiment = String(r.sentiment||'').toLowerCase();
    const controlled = String(r.controlled||'').toLowerCase();
    const dom = domainOf(url);

    card.innerHTML =
      `<div class="serp-meta"><span>${dom||'—'}</span></div>
       <h4><a href="${url||'#'}" target="_blank" rel="noopener">${title}</a></h4>
       <div class="small" style="margin:4px 0 8px 0">${snippet||''}</div>
       <div class="serp-meta">
         <span class="pill ${sentiment==='negative'?'bad': sentiment==='positive'?'good':'warn'}">${sentiment||'neutral'}</span>
         <span class="pill ${controlled==='controlled'?'good':'bad'}">${controlled==='controlled'?'controlled':'uncontrolled'}</span>
       </div>`;
    list.appendChild(card);
  }

  openModal('#serpModal');
}

/* Boards modal */
function openBoards(ceo){
  document.getElementById('boardsTitle').textContent = `Boards — ${ceo}`;
  const body = document.getElementById('boardsBody');
  body.innerHTML = '';
  const arr = boardsByCeo.get(ceo)||[];
  if(!arr.length){ body.textContent = 'No boards found.'; openModal('#boardsModal'); return; }
  const ul = document.createElement('ul');
  ul.style.paddingLeft='18px';
  for(const b of arr){
    const li = document.createElement('li');
    const a = document.createElement('a');
    a.href = b.url||'#'; a.textContent = b.domain||b.url||'link';
    a.target='_blank'; a.rel='noopener';
    li.appendChild(a); ul.appendChild(li);
  }
  body.appendChild(ul);
  openModal('#boardsModal');
}

/* ======================= Kickoff ======================= */
initDatesAndRender();
</script>
</body>
</html>
