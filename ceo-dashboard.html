<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CEO News Sentiment Dashboard</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Papa Parse -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
  .th-sort { cursor:pointer; user-select:none }
  .th-sort .arrow { opacity:.35; margin-left:.25rem }
  .th-sort.active .arrow { opacity:1 }
  .nowrap { white-space:nowrap }
  .clamp-1 { display:-webkit-box; -webkit-line-clamp:1; -webkit-box-orient:vertical; overflow:hidden }
  .clamp-2 { display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden }
</style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-7xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-3xl font-bold">CEO News Sentiment Dashboard</h1>
      <p class="text-sm text-slate-600">Sources:
        <code>data_ceos/daily_counts.csv</code>,
        <code>data/serps/ceo_serps.csv</code>,
        <code>data/ceo_boards.csv</code>.
      </p>
    </header>

    <!-- Controls -->
    <section class="mb-4 grid gap-3 md:grid-cols-3">
      <div>
        <label class="block text-sm font-medium mb-1">Pick date</label>
        <select id="dateSelect" class="w-full border rounded-lg p-2 bg-white"></select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Filter CEOs</label>
        <input id="filterInput" type="text" placeholder="Type to filter…" class="w-full border rounded-lg p-2" />
      </div>
      <div class="flex items-end gap-2">
        <button id="refreshBtn" class="px-3 py-2 rounded-lg bg-slate-900 text-white">Refresh</button>
      </div>
    </section>

    <!-- Trend -->
    <section class="mb-6 p-4 border rounded-xl bg-white">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-lg font-semibold">Sentiment trend</h2>
        <div class="flex items-center gap-2 text-xs text-slate-600">
          <span id="trendInfo"></span>
          <span id="trendRange"></span>
          <button id="trendPrev" class="px-2 py-1 border rounded disabled:opacity-40" title="Older">←</button>
          <button id="trendNext" class="px-2 py-1 border rounded disabled:opacity-40" title="Newer">→</button>
        </div>
      </div>
      <p id="trendHint" class="text-sm text-slate-500 mb-2">Tip: select exactly <span class="font-semibold">1</span> CEO to display that CEO’s trend. When none is selected, the <span class="font-semibold">index average</span> is shown.</p>
      <div class="h-64"><canvas id="trendChart"></canvas></div>
    </section>

    <!-- Table -->
    <section class="overflow-x-auto">
      <table class="min-w-full text-sm bg-white rounded-xl overflow-hidden border">
        <thead class="bg-slate-100">
          <tr>
            <th class="p-3 text-left"><input type="checkbox" id="selectAll"></th>
            <th class="p-3 text-left">CEO</th>
            <th class="p-3 text-left">Company</th>
            <th class="p-3 text-left">Theme</th>

            <th class="p-3 text-left th-sort" data-sort="negNews">
              Negative News (%) <span class="arrow">▲▼</span>
            </th>
            <th class="p-3 text-left th-sort" data-sort="negSerp">
              Negative SERP (%) <span class="arrow">▲▼</span>
            </th>
            <th class="p-3 text-left th-sort" data-sort="ctrlPct">
              SERP Control (%) <span class="arrow">▲▼</span>
            </th>
            <th class="p-3 text-left th-sort" data-sort="risk">
              Risk <span class="arrow">▲▼</span>
            </th>

            <th class="p-3 text-left">Headlines</th>
            <th class="p-3 text-left">SERP</th>
            <th class="p-3 text-left">Boards</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>

      <div class="flex items-center justify-end gap-2 mt-3">
        <button id="pagePrev" class="px-3 py-1.5 border rounded disabled:opacity-40">Prev</button>
        <button id="pageNext" class="px-3 py-1.5 border rounded disabled:opacity-40">Next</button>
      </div>

      <p id="status" class="text-xs text-slate-500 mt-2"></p>
    </section>
  </div>

  <!-- Modals -->
  <div id="modalBackdrop" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-3xl bg-white rounded-2xl shadow-xl overflow-hidden">
        <div class="flex items-center justify-between p-4 border-b">
          <div>
            <h3 id="modalTitle" class="text-xl font-bold">Modal</h3>
            <p id="modalSubtitle" class="text-sm text-slate-600"></p>
          </div>
          <button id="modalClose" class="px-3 py-1.5 rounded-lg border">Close</button>
        </div>
        <div id="modalBody" class="max-h-[70vh] overflow-y-auto p-4">
          <p class="text-sm text-slate-500">Loading…</p>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ---------- CONSTANTS / CONFIG ----------
  const COUNTS_CSV   = 'data_ceos/daily_counts.csv';
  const SERPS_CSV    = 'data/serps/ceo_serps.csv';
  const BOARDS_CSV   = 'data/ceo_boards.csv';
  const ARTICLES_URL = (date) => `data_ceos/articles/${date}.csv`;

  const GH_USER='jonas-sickler', GH_REPO='news-sentiment-dashboard';
  const GH_BASE = `https://${GH_USER}.github.io/${GH_REPO}/`;

  const PAGE_SIZE = 25;
  const TREND_WINDOW = 30;
  const viewMode = 'percent'; // always percent

  // ---------- DOM ----------
  const dateSelect = document.getElementById('dateSelect');
  const filterInput = document.getElementById('filterInput');
  const refreshBtn = document.getElementById('refreshBtn');
  const trendCanvas = document.getElementById('trendChart');
  const trendInfo   = document.getElementById('trendInfo');
  const trendRange  = document.getElementById('trendRange');
  const trendPrev   = document.getElementById('trendPrev');
  const trendNext   = document.getElementById('trendNext');
  const trendHint   = document.getElementById('trendHint');
  const tableBody   = document.getElementById('tableBody');
  const selectAll   = document.getElementById('selectAll');
  const statusEl    = document.getElementById('status');
  const pagePrev    = document.getElementById('pagePrev');
  const pageNext    = document.getElementById('pageNext');
  const modalBackdrop = document.getElementById('modalBackdrop');
  const modalTitle  = document.getElementById('modalTitle');
  const modalSubtitle = document.getElementById('modalSubtitle');
  const modalBody   = document.getElementById('modalBody');
  const modalClose  = document.getElementById('modalClose');

  // ---------- STATE ----------
  let allCounts = [];        // raw counts rows
  let dates = [];            // all available dates
  let currentDate = null;
  let filteredRows = [];     // rows for current date after filter
  let selected = new Set();  // selected CEOS
  let trendChart = null;

  // pagination & sort
  let page = 0;
  let sortKey = 'negNews'; // 'negNews' | 'negSerp' | 'ctrlPct' | 'risk'
  let sortDir = 'desc';    // 'asc' | 'desc'

  // caches
  let serpsAll = null;     // parsed SERP rows
  let boardsAll = null;    // parsed boards

  // ---------- UTIL ----------
  const cacheBust = (url) => url + (url.includes('?') ? '&' : '?') + `_=${Date.now()}`;
  const pct = (n) => `${Math.round(n)}%`;
  const toNum = (x, d=0) => isFinite(+x) ? +x : d;

  function normalizeRowKeys(row){
    const out = {};
    for(const k in row){
      const nk = String(k||'').replace(/^\ufeff/, '').trim().toLowerCase();
      out[nk] = row[k];
    }
    return out;
  }

  async function fetchCsv(urlRel){
    const rel = cacheBust(urlRel);
    const abs = cacheBust(GH_BASE + urlRel);
    const tryUrls = [rel];
    if(!rel.startsWith(GH_BASE)) tryUrls.push(abs);

    for(const u of tryUrls){
      try{
        const r = await fetch(u, {cache:'no-store', mode:'cors'});
        if(!r.ok) continue;
        const txt = await r.text();
        const parsed = Papa.parse(txt, {header:true});
        return (parsed.data||[]).map(normalizeRowKeys);
      }catch(e){}
    }
    return [];
  }

  function riskFrom(negSerpPct, ctrlPct){
    if(negSerpPct > 0) return 'High';
    if(negSerpPct === 0 && ctrlPct < 35) return 'Medium';
    return 'Low';
  }

  // ---------- LOADERS ----------
  async function loadCounts(){
    const rows = await fetchCsv(COUNTS_CSV);
    // expect headers: date, brand(=ceo), company?, total, positive, neutral, negative, theme?
    // Normalize key names we rely on
    allCounts = rows
      .filter(r => r.date && (r.ceo || r.brand))
      .map(r => ({
        date: String(r.date),
        ceo: String(r.ceo || r.brand),
        company: String(r.company || ''),
        total: toNum(r.total),
        positive: toNum(r.positive),
        neutral: toNum(r.neutral),
        negative: toNum(r.negative),
        theme: String(r.theme || 'None')
      }));
    dates = Array.from(new Set(allCounts.map(r=>r.date))).sort();
  }

  async function ensureSerps(){
    if(serpsAll) return;
    const rows = await fetchCsv(SERPS_CSV);
    // expect: ceo, company, position, title, link, snippet, control, sentiment
    serpsAll = rows.map(r => ({
      ceo: String(r.ceo || '').trim(),
      company: String(r.company || '').trim(),
      title: String(r.title || '').trim(),
      link: String(r.link || '').trim(),
      snippet: String(r.snippet || '').trim(),
      control: String(r.control || '').trim().toLowerCase(), // true/false or controlled/uncontrolled
      sentiment: String(r.sentiment || '').trim().toLowerCase()
    }));
  }

  async function ensureBoards(){
    if(boardsAll) return;
    const rows = await fetchCsv(BOARDS_CSV);
    // expect: CEO, Company, URL, Domain  (case-insensitive)
    boardsAll = rows.map(r => ({
      ceo: String(r.ceo || r.name || '').trim(),
      company: String(r.company || '').trim(),
      url: String(r.url || r.link || '').trim(),
      domain: String(r.domain || '').trim()
    }));
  }

  // ---------- TABLE / VIEW ----------
  function indexForDate(date){
    const rs = allCounts.filter(r => r.date === date);
    // theme is per CEO; trend uses totals only
    return rs.map(r => ({
      ceo: r.ceo,
      company: r.company,
      theme: r.theme,
      negNews: r.total ? (r.negative / r.total * 100) : 0,
      posNews: r.total ? (r.positive / r.total * 100) : 0,
      neuNews: r.total ? (r.neutral  / r.total * 100) : 0,
      total: r.total,
      raw: r
    }));
  }

  function applyFilterSort(){
    const q = (filterInput.value || '').toLowerCase();
    let rows = indexForDate(currentDate).filter(r =>
      r.ceo.toLowerCase().includes(q) || r.company.toLowerCase().includes(q)
    );

    // Join in SERP aggregates (computed once per CEO)
    rows = rows.map(r => {
      const agg = aggregateSerpFor(r.ceo);
      const ctrlPct = agg.total ? (agg.controlled/agg.total*100) : 0;
      const negSerpPct = agg.total ? (agg.neg/agg.total*100) : 0;
      const risk = riskFrom(Math.round(negSerpPct), Math.round(ctrlPct));
      return {...r,
        negSerp: negSerpPct,
        ctrlPct,
        risk
      };
    });

    // sort
    const dir = sortDir==='asc' ? 1 : -1;
    rows.sort((a,b)=>{
      if(sortKey==='risk'){
        const order = {High:3, Medium:2, Low:1};
        return (order[a.risk]-order[b.risk]) * dir;
      }
      return (a[sortKey]-b[sortKey]) * dir;
    });

    filteredRows = rows;
    page = 0;
  }

  function renderTable(){
    const start = page*PAGE_SIZE;
    const slice = filteredRows.slice(start, start+PAGE_SIZE);

    tableBody.innerHTML = slice.map((r, idx)=>{
      const checked = selected.has(r.ceo) ? 'checked' : '';
      return `<tr class="border-t hover:bg-slate-50 align-top">
        <td class="p-3"><input type="checkbox" data-ceo="${escapeAttr(r.ceo)}" ${checked}></td>
        <td class="p-3">
          <div class="clamp-2 text-slate-900">${escapeHtml(r.ceo)}</div>
        </td>
        <td class="p-3"><div class="clamp-2">${escapeHtml(r.company || '')}</div></td>
        <td class="p-3"><div class="clamp-2">${escapeHtml(r.theme || 'None')}</div></td>

        <td class="p-3 nowrap" title="${Math.round(r.negNews)}%">${Math.round(r.negNews)}%</td>
        <td class="p-3 nowrap" title="${Math.round(r.negSerp)}%">${Math.round(r.negSerp)}%</td>
        <td class="p-3 nowrap" title="${Math.round(r.ctrlPct)}%">${Math.round(r.ctrlPct)}%</td>
        <td class="p-3">${r.risk}</td>

        <td class="p-3"><button class="px-2 py-1 border rounded" data-headlines="${escapeAttr(r.ceo)}">View</button></td>
        <td class="p-3"><button class="px-2 py-1 border rounded" data-serp="${escapeAttr(r.ceo)}">View</button></td>
        <td class="p-3"><button class="px-2 py-1 border rounded" data-boards="${escapeAttr(r.ceo)}">View</button></td>
      </tr>`;
    }).join('');

    // handlers
    tableBody.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
      cb.addEventListener('change', ()=>{
        const key = cb.getAttribute('data-ceo');
        if(cb.checked) selected.add(key); else selected.delete(key);
        updateTrend();
      });
    });
    tableBody.querySelectorAll('[data-headlines]').forEach(btn=>{
      btn.addEventListener('click', ()=> showHeadlines(btn.getAttribute('data-headlines')));
    });
    tableBody.querySelectorAll('[data-serp]').forEach(btn=>{
      btn.addEventListener('click', ()=> showSerp(btn.getAttribute('data-serp')));
    });
    tableBody.querySelectorAll('[data-boards]').forEach(btn=>{
      btn.addEventListener('click', ()=> showBoards(btn.getAttribute('data-boards')));
    });

    // footer
    const total = filteredRows.length;
    const end = Math.min(start+PAGE_SIZE, total);
    statusEl.textContent = `${total} CEOs (${start+1}-${end}) for ${currentDate}. Selected: ${selected.size}.`;
    pagePrev.disabled = (page===0);
    pageNext.disabled = (end>=total);
  }

  function attachSorting(){
    document.querySelectorAll('.th-sort').forEach(th=>{
      th.addEventListener('click', ()=>{
        const key = th.getAttribute('data-sort');
        if(sortKey===key){ sortDir = (sortDir==='asc'?'desc':'asc'); }
        else { sortKey=key; sortDir='desc'; }
        document.querySelectorAll('.th-sort').forEach(x=>x.classList.remove('active'));
        th.classList.add('active');
        applyFilterSort(); renderTable(); updateTrend();
      });
    });
  }

  // ---------- TREND ----------
  function seriesForCeo(ceo){
    const all = allCounts.filter(r=>r.ceo===ceo).sort((a,b)=>a.date.localeCompare(b.date));
    const labels=[], pos=[], neu=[], neg=[];
    for(const r of all){
      const t = r.total||0;
      labels.push(r.date);
      pos.push(t? (r.positive/t*100):0);
      neu.push(t? (r.neutral /t*100):0);
      neg.push(t? (r.negative/t*100):0);
    }
    return {labels,pos,neu,neg};
  }

  function seriesForIndexAverage(){
    // average across all CEOs per date
    const byDate = new Map();
    for(const r of allCounts){
      if(!byDate.has(r.date)) byDate.set(r.date, []);
      byDate.get(r.date).push(r);
    }
    const labels = Array.from(byDate.keys()).sort();
    const pos=[], neu=[], neg=[];
    for(const d of labels){
      const arr = byDate.get(d);
      let tp=0, tn=0, tneg=0, ttot=0;
      for(const r of arr){ tp+=r.positive||0; tn+=r.neutral||0; tneg+=r.negative||0; ttot+=r.total||0; }
      pos.push(ttot? (tp/ttot*100):0);
      neu.push(ttot? (tn/ttot*100):0);
      neg.push(ttot? (tneg/ttot*100):0);
    }
    return {labels,pos,neu,neg};
  }

  function updateTrend(){
    let titleText='', ser=null;

    if(selected.size===1){
      const ceo = Array.from(selected)[0];
      ser = seriesForCeo(ceo);
      titleText = `CEO: ${ceo}`;
      trendHint.classList.add('hidden');
    }else{
      ser = seriesForIndexAverage();
      titleText = 'INDEX: average across all CEOs';
      trendHint.classList.remove('hidden');
    }

    // page windowing
    const total = ser.labels.length;
    const maxPage = Math.max(0, Math.ceil(total/TREND_WINDOW)-1);
    if(!updateTrend._page && updateTrend._page!==0) updateTrend._page=0;
    if(updateTrend._page>maxPage) updateTrend._page=maxPage;

    const end = Math.max(0, total - TREND_WINDOW*updateTrend._page);
    const start = Math.max(0, end - TREND_WINDOW);

    const labels = ser.labels.slice(start,end);
    const pos = ser.pos.slice(start,end);
    const neu = ser.neu.slice(start,end);
    const neg = ser.neg.slice(start,end);

    trendInfo.textContent = titleText;
    trendRange.textContent = labels.length ? ` | DATE: ${labels[0]} → ${labels[labels.length-1]}` : '';

    const data = {
      labels,
      datasets: [
        {label:'Positive', data: pos, backgroundColor:'#98c15b', stack:'s'},
        {label:'Neutral',  data: neu, backgroundColor:'#dae5e6', stack:'s'},
        {label:'Negative', data: neg, backgroundColor:'#ffb199', stack:'s'}
      ]
    };
    const options = {
      responsive:true, maintainAspectRatio:false,
      scales:{ x:{stacked:true}, y:{stacked:true, beginAtZero:true, ticks:{callback:(v)=>v+'%'}}},
      plugins:{ legend:{position:'top'} }
    };
    if(trendChart) trendChart.destroy();
    trendChart = new Chart(trendCanvas.getContext('2d'), {type:'bar', data, options});

    trendPrev.disabled = (updateTrend._page>=maxPage);
    trendNext.disabled = (updateTrend._page<=0);
  }

  trendPrev.addEventListener('click', ()=>{ updateTrend._page=(updateTrend._page||0)+1; updateTrend(); });
  trendNext.addEventListener('click', ()=>{ updateTrend._page=Math.max(0,(updateTrend._page||0)-1); updateTrend(); });

  // ---------- SERP AGG ----------
  function aggregateSerpFor(ceo){
    if(!serpsAll) return {total:0, controlled:0, neg:0, rows:[]};
    const rows = serpsAll.filter(r => r.ceo.toLowerCase() === String(ceo).toLowerCase());
    let total=0, controlled=0, neg=0;
    for(const r of rows){
      total++;
      const isCtl = (r.control==='true' || r.control==='controlled');
      if(isCtl) controlled++;
      if(r.sentiment==='negative') neg++;
    }
    return {total, controlled, neg, rows};
  }

  // ---------- MODALS ----------
  function openModal(){ modalBackdrop.classList.remove('hidden'); }
  function closeModal(){ modalBackdrop.classList.add('hidden'); }
  modalClose.addEventListener('click', closeModal);
  modalBackdrop.addEventListener('click', (e)=>{ if(e.target===modalBackdrop) closeModal(); });

  async function showHeadlines(ceo){
    modalTitle.textContent = `${ceo} — Headlines`;
    modalSubtitle.textContent = `Date: ${currentDate}`;
    modalBody.innerHTML = '<p class="text-sm text-slate-500">Loading…</p>';
    openModal();

    // load daily articles file
    const rows = await fetchCsv(ARTICLES_URL(currentDate));
    const norm = rows.map(r=>{
      const t = String(r.title || r.headline || '').trim();
      const link = String(r.url || r.link || '').trim();
      let domain = String(r.domain || '').trim();
      if(!domain && link){ try{ domain = new URL(link).hostname }catch{} }
      const s = String(r.sentiment || r.label || '').toLowerCase();
      return {title:t, link, domain, sentiment:s||'neutral'};
    });
    // filter to those that mention CEO name (best effort)
    const key = ceo.toLowerCase();
    const list = norm.filter(r => r.title.toLowerCase().includes(key));

    if(!list.length){
      modalBody.innerHTML = '<p class="text-sm text-slate-600">No articles found for this CEO on this date.</p>';
      return;
    }
    modalBody.innerHTML = `
      <div class="space-y-3">
        ${list.map(r=>`
          <div class="p-3 border rounded-xl hover:bg-slate-50">
            <div class="flex items-center justify-between gap-3">
              <div class="text-xs text-slate-500">${escapeHtml(r.domain||'')}</div>
              <div class="text-xs">${badge(r.sentiment)}</div>
            </div>
            <a href="${escapeAttr(r.link)}" target="_blank" rel="noopener" class="block mt-1 underline">${escapeHtml(r.title)}</a>
          </div>`).join('')}
      </div>`;
  }

  async function showSerp(ceo){
    await ensureSerps();
    const agg = aggregateSerpFor(ceo);
    modalTitle.textContent = `${ceo} — SERP`;
    modalSubtitle.textContent = `${agg.total} results`;
    if(!agg.rows.length){
      modalBody.innerHTML = '<p class="text-sm text-slate-600">No SERP rows found.</p>';
      openModal(); return;
    }
    modalBody.innerHTML = `
      <div class="space-y-3">
        ${agg.rows.map(r=>`
          <div class="p-3 border rounded-xl hover:bg-slate-50">
            <div class="flex items-center justify-between gap-3 text-xs">
              <div class="text-slate-500">${escapeHtml(rootDomain(r.link))}</div>
              <div class="flex gap-2">
                <span class="px-2 py-0.5 rounded-full border ${isCtl(r)?'bg-emerald-50 border-emerald-300 text-emerald-800':'bg-slate-50'}">
                  ${isCtl(r) ? 'controlled' : 'uncontrolled'}
                </span>
                ${badge(r.sentiment)}
              </div>
            </div>
            <a href="${escapeAttr(r.link)}" target="_blank" rel="noopener" class="block mt-1 underline">${escapeHtml(r.title||'(no title)')}</a>
            ${r.snippet ? `<div class="text-xs text-slate-600 mt-1">${escapeHtml(r.snippet)}</div>`: ''}
          </div>
        `).join('')}
      </div>`;
    openModal();

    function isCtl(r){ return r.control==='true' || r.control==='controlled'; }
  }

  async function showBoards(ceo){
    await ensureBoards();
    const rows = boardsAll.filter(r => r.ceo.toLowerCase() === ceo.toLowerCase());
    modalTitle.textContent = `${ceo} — Active Boards`;
    modalSubtitle.textContent = '';
    if(!rows.length){
      modalBody.innerHTML = '<p class="text-sm text-slate-600">No board memberships found.</p>';
      openModal(); return;
    }
    modalBody.innerHTML = `
      <div class="space-y-4">
        ${rows.map(r=>`
          <div class="p-3 border rounded-xl">
            <div class="text-base font-semibold">${escapeHtml(r.domain || rootDomain(r.url) || '—')}</div>
            <a class="block text-sm mt-1 underline" href="${escapeAttr(r.url)}" target="_blank" rel="noopener">
              ${escapeHtml(r.url)}
            </a>
          </div>
        `).join('')}
      </div>`;
    openModal();
  }

  // ---------- HELPERS ----------
  function badge(sent){
    const s = (sent||'neutral').toLowerCase();
    if(s==='negative') return `<span class="px-2 py-0.5 rounded-full bg-rose-100 text-rose-700">negative</span>`;
    if(s==='positive') return `<span class="px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-700">positive</span>`;
    return `<span class="px-2 py-0.5 rounded-full bg-slate-100 text-slate-700">neutral</span>`;
  }
  function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;'); }
  function escapeAttr(s){ return escapeHtml(s).replaceAll('"','&quot;'); }
  function rootDomain(u){ try{ return new URL(u).hostname }catch{return ''} }

  // ---------- WIRE-UP ----------
  selectAll.addEventListener('change', ()=>{
    if(selectAll.checked){
      indexForDate(currentDate).forEach(r=>selected.add(r.ceo));
    } else {
      selected.clear();
    }
    renderTable(); updateTrend();
  });
  filterInput.addEventListener('input', ()=>{ applyFilterSort(); renderTable(); updateTrend(); });
  pagePrev.addEventListener('click', ()=>{ if(page>0){ page--; renderTable(); } });
  pageNext.addEventListener('click', ()=>{ page++; renderTable(); });

  refreshBtn.addEventListener('click', async ()=>{
    await Promise.all([loadCounts(), ensureSerps(), ensureBoards()]);
    populateDates(); applyFilterSort(); renderTable(); updateTrend();
  });

  function populateDates(){
    dateSelect.innerHTML = dates.map(d=>`<option value="${d}">${d}</option>`).join('');
    currentDate = dates[dates.length-1] || null;
    if(currentDate) dateSelect.value = currentDate;
  }
  dateSelect.addEventListener('change', ()=>{
    currentDate = dateSelect.value;
    // deselect on date change
    selected.clear();
    applyFilterSort(); renderTable(); updateTrend();
  });

  // ---------- INIT ----------
  (async function init(){
    await Promise.all([loadCounts(), ensureSerps(), ensureBoards()]);
    populateDates(); attachSorting();
    applyFilterSort(); renderTable(); updateTrend();
  })();

})();
</script>
</body>
</html>
