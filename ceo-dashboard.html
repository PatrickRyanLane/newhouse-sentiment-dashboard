<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CEO Risk Dashboard</title>

<!-- Chart.js + PapaParse CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
:root{
  /* Terakeet-ish palette */
  --bg:#0b0d12; --card:#11172a; --muted:#9c96bb; --text:#e7ecf4; --accent:#58dbed;
  --pill-neg:#ff7861; --pill-neu:#ffd54f; --pill-pos:#8be276;
  --stroke:#17223a; --chip:#23314d; --chipBorder:#2c3b5a;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
.wrap{max-width:1200px;margin:0 auto;padding:20px}
h1{font-size:28px;margin:6px 0 18px}

/* Controls */
.controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:0 0 12px}
.card{background:var(--card);border:1px solid var(--stroke);border-radius:12px;padding:12px 12px}
select,input[type="text"]{background:#0c1226;border:1px solid #23314d;border-radius:10px;color:var(--text);padding:8px 10px}
button{background:#18243b;border:1px solid #2a3b5e;color:var(--text);border-radius:10px;padding:8px 12px;cursor:pointer}
button:hover{filter:brightness(1.08)}

/* Grid for charts */
/* Spacing */
.controls{ margin:0 0 16px }             /* a touch more space under controls */
.grid{                                    /* taller rows + bigger gaps */
  display:grid;
  grid-template-rows:minmax(300px,36vh) minmax(240px,32vh);
  gap:16px;
  margin:16px 0;
}
@media (min-width:980px){
  .grid{
    grid-template-rows:minmax(320px,38vh) minmax(260px,34vh);
    gap:18px;
  }
}

/* Chart cards: add padding-bottom so long tick labels never clip */
.chart-card{ background:var(--card); border:1px solid var(--stroke);
  border-radius:12px; padding:12px 12px 26px; position:relative }

/* The magic: let Chart.js fill the card and respond to resizes */
.chart-card canvas{
  width:100% !important;
  height:100% !important;
  display:block;              /* removes baseline gap */
}

/* Table */
.table-card{background:var(--card);border:1px solid var(--stroke);border-radius:12px;padding:10px}
.table-hint{margin:0 0 8px;color:var(--muted)}
table{width:100%;border-collapse:separate;border-spacing:0 6px}
thead th{font-size:12px;color:var(--muted);text-align:left;padding:6px 8px}
tbody td{padding:10px 8px;background:#0c1226;border-top:1px solid #0f1831;border-bottom:1px solid #0f1831}
tbody tr td:first-child{border-left:1px solid #0f1831;border-radius:10px 0 0 10px}
tbody tr td:last-child{border-right:1px solid #0f1831;border-radius:0 10px 10px 0}
.right{text-align:right}
.center{text-align:center}
.pill{font-size:12px;border-radius:999px;padding:3px 8px;border:1px solid var(--chipBorder);background:var(--chip);color:#cfe0ff}
.pill.low{background:rgba(34,187,102,.1);color:#8be276}
.pill.med{background:rgba(255,215,79,.08);color:#ffd54f}
.pill.high{background:rgba(255,120,97,.12);color:#ff7861}
.link{color:var(--accent);text-decoration:underline}

/* Pagination */
.pagination{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:8px}

/* Modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:24px}
.modal.open{display:flex}
.modal .box{max-width:900px;width:100%;max-height:85vh;overflow:auto;background:#0e152a;border:1px solid #1b2745;border-radius:16px}
.modal header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #12203d}
.modal header h3{margin:0;font-size:16px}
.modal .content{padding:16px}
.badges{display:flex;gap:8px;margin-top:8px}
.badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid transparent}
.badge.positive{background:rgba(34,187,102,.1);color:#8be276;border-color:rgba(139,226,118,.25)}
.badge.neutral{background:rgba(255,215,0,.1);color:#ffd54f;border-color:rgba(255,213,79,.25)}
.badge.negative{background:rgba(255,120,97,.12);color:#ff7861;border-color:rgba(255,120,97,.25)}
.badge.controlled{background:rgba(34,187,102,.1);color:#8be276;border-color:rgba(139,226,118,.25)}
.badge.uncontrolled{background:rgba(255,120,97,.1);color:#ff7861;border-color:rgba(255,120,97,.25)}
.muted{color:var(--muted)}

/* SERP card layout */
.serp-cards{display:grid;gap:12px;margin-top:12px}
.serp-card{background:var(--card);border:1px solid var(--stroke);border-radius:12px;padding:14px 16px}
.serp-domain{font-size:12px;color:var(--muted);margin-bottom:4px}
.serp-title a{color:var(--text);text-decoration:underline}
.serp-snippet{color:var(--muted);margin-top:6px;line-height:1.35}
.serp-metrics{margin:4px 0 0;color:var(--muted)}
.serp-metrics b{color:var(--text)}
</style>
</head>

<body>
<div class="wrap">
  <h1>CEO Risk Dashboard</h1>

  <div class="controls card">
    <div>
      <div class="muted" style="font-size:12px;margin:0 0 4px">Date</div>
      <select id="dateSelect"></select>
    </div>
    <div style="flex:1 1 420px">
      <div class="muted" style="font-size:12px;margin:0 0 4px">Filter (CEO or Company)</div>
      <input id="filterInput" type="text" placeholder="Type to filter…" />
    </div>
    <button id="refreshBtn">Refresh Data</button>
    <button id="clearBtn">Clear Selection</button>
  </div>

  <div class="grid">
    <div class="chart-card">
      <h3>News sentiment (percent of articles)</h3>
      <canvas id="newsChart"></canvas>
    </div>
    <div class="chart-card">
      <h3>SERP (Negative % • Control %)</h3>
      <canvas id="serpChart"></canvas>
    </div>
  </div>

  <div class="table-card">
    <p class="table-hint">Select exactly one CEO using the checkbox to see brand-level charts. Selecting another will automatically unselect the previous one.</p>
    <table>
      <thead>
        <tr>
          <th>CEO</th>
          <th>Company</th>
          <th>Theme</th>
          <th data-key="neg_news" class="right">Negative News % ▲▼</th>
          <th data-key="neg_serp" class="right">Negative SERP % ▲▼</th>
          <th data-key="ctrl_pct" class="right">SERP Control % ▲▼</th>
          <th data-key="risk" class="center">Risk ▲▼</th>
          <th class="center">Headlines</th>
          <th class="center">SERP</th>
          <th class="center">Boards</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="pagination">
      <button id="prevBtn">Prev</button>
      <div>Page <span id="pageNo">1</span> / <span id="pageTotal">1</span></div>
      <button id="nextBtn">Next</button>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="box">
    <header>
      <h3 id="modalTitle">Title</h3>
      <button id="modalClose">Close</button>
    </header>
    <div class="content" id="modalContent"></div>
  </div>
</div>

<script>
/********************** Config **********************/
const COUNTS_CANDIDATES = ['data_ceos/daily_counts.csv'];
const ROSTER_CANDIDATES = [
  'data/serps/roster.csv',
  'data/roster.csv',
  'data/ceo_companies.csv'
];
const SERPS_DAILY_CSV = 'data/serps/ceo_serps_daily.csv';
const BOARDS_CSV = 'data_ceos/ceo_boards.csv';
const SERP_ROWS_PATH = d => `data_ceos/serp_rows/${d}-ceo-serps-rows.csv`;

// NEW: authoritative per-date sources for the table
const ARTICLES_DAILY_PATH = d => `data_ceos/${d}.csv`;
const SERP_PROCESSED_PATH = d => `data_ceos/processed_serps/${d}-ceo-serps-processed.csv`;

/********************** Runtime **********************/
let rosterMap = new Map();        // CEO -> Company
let companyToCeo = new Map();     // Company -> CEO
let allCountsRows = [];           // news counts (for charts)
let serpsDaily = [];              // serp aggregates (for charts)
let boardsByCeo = new Map();      // CEO -> [domain,url]
let filteredRows = [];            // table rows for current date/filter
let selectedCeo = null;           // to drive brand-level charts
let currentSort = { key:null, dir:1 };
let currentPage = 1;
const PAGE_SIZE = 25;

let newsChart, serpChart;

// NEW caches for per-date table sources
const _articlesCache = new Map();   // date -> Map(ceo -> {company, theme, neg_pct})
const _serpAggCache  = new Map();   // date -> Map(ceo -> {total, neg_serp, controlled})

/********************** Utils **********************/
const isISODate = s => /^\d{4}-\d{2}-\d{2}$/.test(String(s||'').trim());
const esc = (s) => String(s ?? '').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
function fmtPct(v){ return (v==null) ? 'N/A' : (v*100).toFixed(1) + '%'; }

// Normalizes names so lookups are reliable
const canonName = s => String(s || '')
  .toLowerCase()
  .replace(/\s+/g, ' ')
  .trim();


/********************** CSV helpers **********************/
async function fetchCsv(url){
  const r = await fetch(url, {cache:'no-store'});
  if (!r.ok) throw new Error(`HTTP ${r.status} for ${url}`);
  const t = await r.text();
  return await new Promise((res, rej) => {
    Papa.parse(t, {header:true, skipEmptyLines:true,
      complete: out => res(out.data || []), error: e => rej(e)
    });
  });
}
async function fetchCsvAny(candidates){
  for (const u of candidates){
    try { const rows = await fetchCsv(u); if (Array.isArray(rows)) return rows; }
    catch(e){ /* next */ }
  }
  return [];
}

/********************** Loaders for charts/boards/roster **********************/
async function loadRoster(){
  const rows = await fetchCsvAny(ROSTER_CANDIDATES);
  rosterMap = new Map();
  companyToCeo = new Map();
  rows.forEach(r => {
    const ceo = (r.ceo || r.CEO || '').trim();
    const company = (r.company || r.Company || '').trim();
    if (ceo && company){
      rosterMap.set(ceo, company);
      companyToCeo.set(company, ceo);
    }
  });
}
async function loadBoards(){
  boardsByCeo = new Map();
  try{
    const rows = await fetchCsv(BOARDS_CSV); // 'data_ceos/ceo_boards.csv'
    rows.forEach(r => {
      const ceoRaw = (r.ceo || '').trim();
      const url = (r.url || '').trim();
      let domain = (r.domain || '').trim();

      if (!ceoRaw || !url) return; // need both
      if (!domain && url){
        try { domain = new URL(url).hostname.replace(/^www\./,''); } catch {}
      }

      const key = canonName(ceoRaw);
      const arr = boardsByCeo.get(key) || [];
      arr.push({ domain, url });
      boardsByCeo.set(key, arr);
    });
  }catch(e){
    console.error('Could not load boards CSV:', e);
    boardsByCeo = new Map();
  }
}
async function loadCounts(){
  const rows = await fetchCsvAny(COUNTS_CANDIDATES);
  allCountsRows = rows
    .map(r => ({
      date: String(r.date || '').trim(),
      ceo: String(r.ceo || '').trim(),
      company: String(r.company || '').trim(),
      theme: String(r.theme || '').trim(),
      pos: +r.positive || 0,
      neu: +r.neutral || 0,
      neg: +r.negative || 0
    }))
    .filter(r => isISODate(r.date) && r.ceo);   // require a CEO name
}
async function loadSerpDaily(){
  try{
    const rows = await fetchCsv(SERPS_DAILY_CSV);
    serpsDaily = rows.map(r => ({
      date: (r.date||'').trim(),
      ceo: (r.ceo||'').trim(),
      company: (r.company||'').trim(),
      total: +r.total || 0,
      neg_serp: +r.negative_serp || +r.neg_serp || 0,
      ctrl: +r.controlled || +r.control || 0,
    })).filter(r => isISODate(r.date));
  }catch(e){ serpsDaily = []; }
}

/********************** Risk **********************/
function computeRisk(negPct, ctrlPct){
  const n = (negPct ?? 0)*100, c = (ctrlPct ?? 0)*100;
  if (negPct==null || ctrlPct==null) return 'N/A';
  if (n >= 40 || c < 25) return 'High';
  if (n >= 25 || c < 50) return 'Medium';
  return 'Low';
}

/********************** NEW: per-date table sources **********************/
function toPct01(x){
  if (x == null || x === '') return null;
  const n = +String(x).replace('%','').trim();
  if (!isFinite(n)) return null;
  return n > 1 ? n/100 : n;
}

// data_ceos/<DATE>.csv  ->  Map(ceo -> {company, theme, neg_pct})
async function getArticlesForDate(d){
  if (_articlesCache.has(d)) return _articlesCache.get(d);
  let map = new Map();
  try{
    const rows = await fetchCsv(ARTICLES_DAILY_PATH(d));
    rows.forEach(r=>{
      const ceo = String(r.ceo||'').trim();
      if (!ceo) return;
      const company = String(r.company||'').trim();
      const theme   = String(r.theme||'').trim();

      let neg = toPct01(r.neg_pct);
      if (neg == null){
        const negCount = +r.negative || 0;
        const tot = (+r.total) || ((+r.positive||0)+(+r.neutral||0)+negCount) || 0;
        neg = tot ? (negCount / tot) : 0;
      }
      map.set(ceo, { company, theme, neg_pct: neg });
    });
  }catch(e){ /* missing is allowed */ }
  _articlesCache.set(d, map);
  return map;
}

// data_ceos/processed_serps/<DATE>-ceo-serps-processed.csv -> Map(ceo -> {total, neg_serp, controlled})
async function getSerpAggForDate(d){
  if (_serpAggCache.has(d)) return _serpAggCache.get(d);
  let map = new Map();
  try{
    const rows = await fetchCsv(SERP_PROCESSED_PATH(d));
    rows.forEach(r=>{
      const ceo = String(r.ceo||'').trim();
      if (!ceo) return;
      map.set(ceo, {
        total:      +r.total || 0,
        neg_serp:   +r.negative_serp || 0,
        controlled: +r.controlled || 0
      });
    });
  }catch(e){ /* allowed */ }
  _serpAggCache.set(d, map);
  return map;
}

/********************** UI bootstrap **********************/
async function init(){
  await Promise.all([loadRoster(), loadCounts(), loadSerpDaily(), loadBoards()]);
  // date options from the chart sources (existing behavior)
  const dateSet = new Set([
    ...allCountsRows.map(r => r.date),
    ...serpsDaily.map(r => r.date)
  ].filter(isISODate));
  const dates = [...dateSet].sort();
  const sel = document.getElementById('dateSelect');
  sel.innerHTML = dates.map(d => `<option value="${d}">${d}</option>`).join('');
  sel.value = dates[dates.length-1] || '';
  sel.addEventListener('change', ()=>{ currentPage=1; selectedCeo=null; renderAll(); });

  document.getElementById('filterInput').addEventListener('input', ()=>{ currentPage=1; renderAll(); });
  document.getElementById('refreshBtn').onclick = async ()=>{ await init(); };
  document.getElementById('clearBtn').onclick = ()=>{ selectedCeo=null; document.getElementById('filterInput').value=''; renderAll(); };
  document.getElementById('prevBtn').onclick = ()=>{ if (currentPage>1){ currentPage--; renderTable(); } };
  document.getElementById('nextBtn').onclick = ()=>{ const totalPages = Math.max(1, Math.ceil(filteredRows.length / PAGE_SIZE)); if (currentPage<totalPages){ currentPage++; renderTable(); } };

  // header sort
  document.querySelectorAll('thead th[data-key]').forEach(th=>{
    th.style.cursor='pointer';
    th.addEventListener('click', ()=>{
      const k = th.getAttribute('data-key');
      if (currentSort.key === k) currentSort.dir *= -1; else { currentSort.key = k; currentSort.dir = 1; }
      renderTable();
    });
  });

  renderAll();

// Keep charts perfectly in sync with their cards
const newsCanvas = document.getElementById('newsChart');
const serpCanvas = document.getElementById('serpChart');
const ro = new ResizeObserver(() => {
  if (newsChart) newsChart.resize();
  if (serpChart) serpChart.resize();
});
[newsCanvas.parentElement, serpCanvas.parentElement].forEach(el => ro.observe(el));  
}

/********************** Data → view rows **********************/
async function buildRowsForDate(d){
  const articles = await getArticlesForDate(d);  // Map(ceo -> {company, theme, neg_pct})
  const serpAgg  = await getSerpAggForDate(d);   // Map(ceo -> {total, neg_serp, controlled})

  const out = [];
  for (const [ceo, a] of articles.entries()){
    const s = serpAgg.get(ceo);  // may be undefined

    let negSerpPct = null, ctrlPct = null;
    if (s && s.total > 0){
      negSerpPct = s.neg_serp   / s.total;   // 0..1
      ctrlPct    = s.controlled / s.total;   // 0..1
    }
    const risk = computeRisk(negSerpPct, ctrlPct);

    out.push({
      date: d,
      ceo,
      company: a.company || '',
      theme: a.theme || 'None',
      neg_news: a.neg_pct ?? 0,   // 0..1
      neg_serp: negSerpPct,       // 0..1 or null
      ctrl_pct: ctrlPct,          // 0..1 or null
      risk
    });
  }
  return out;
}

/********************** Rendering **********************/
async function renderAll(){
  const d = document.getElementById('dateSelect').value;
  const filter = document.getElementById('filterInput').value.trim().toLowerCase();

  const rows = (await buildRowsForDate(d)).filter(r=>{
    if (!filter) return true;
    return r.ceo.toLowerCase().includes(filter) || r.company.toLowerCase().includes(filter);
  });

  filteredRows = rows;
  currentPage = 1;

  renderTable();
  renderCharts(); // charts keep using existing aggregated sources
}

function renderTable(){
  const tbody = document.getElementById('tbody');
  let rows = [...filteredRows];

  // sorting
  if (currentSort.key){
    rows.sort((a,b)=>{
      const ka = a[currentSort.key], kb = b[currentSort.key];
      if (typeof ka === 'string') return currentSort.dir * ka.localeCompare(kb);
      return currentSort.dir * ((ka ?? -1) - (kb ?? -1));
    });
  }

  const start = (currentPage-1)*PAGE_SIZE;
  const pageRows = rows.slice(start, start+PAGE_SIZE);
  tbody.innerHTML = pageRows.map(r=>{
    const checked = (selectedCeo && selectedCeo===r.ceo) ? 'checked' : '';
    return `<tr>
      <td><input type="checkbox" data-ceo="${esc(r.ceo)}" class="brandCheck" ${checked} /> ${esc(r.ceo)}</td>
      <td>${esc(r.company)}</td>
      <td>${esc(r.theme||'None')}</td>
      <td class="right">${fmtPct(r.neg_news)}</td>
      <td class="right">${fmtPct(r.neg_serp)}</td>
      <td class="right">${fmtPct(r.ctrl_pct)}</td>
      <td class="center">${
        (r.risk==='High'||r.risk==='Medium'||r.risk==='Low')
          ? (r.risk==='High'
              ? '<span class="pill high">High</span>'
              : r.risk==='Medium'
                ? '<span class="pill med">Medium</span>'
                : '<span class="pill low">Low</span>')
          : '<span class="muted">N/A</span>'
      }</td>
      <td class="center"><button class="headBtn" data-ceo="${esc(r.ceo)}">View</button></td>
      <td class="center"><button class="serpBtn" data-ceo="${esc(r.ceo)}" data-company="${esc(r.company)}">View</button></td>
      <td class="center"><button class="boardsBtn" data-ceo="${esc(r.ceo)}">View</button></td>
    </tr>`;
  }).join('');

  // events
  tbody.querySelectorAll('.brandCheck').forEach(cb=>{
    cb.addEventListener('change', (e)=>{
      const ceo = e.target.getAttribute('data-ceo');
      if (e.target.checked){ selectedCeo = ceo; tbody.querySelectorAll('.brandCheck').forEach(x=>{ if (x!==e.target) x.checked=false; }); }
      else selectedCeo = null;
      renderCharts();
    });
  });
  tbody.querySelectorAll('.serpBtn').forEach(btn=>{
    btn.onclick = ()=>{
      const ceo = btn.getAttribute('data-ceo');
      const company = btn.getAttribute('data-company');
      showSerp({ceo, company});
    };
  });
  tbody.querySelectorAll('.headBtn').forEach(btn=>{
    btn.onclick = ()=>{
      const ceo = btn.getAttribute('data-ceo');
      showHeadlines({ceo});
    };
  });
  tbody.querySelectorAll('.boardsBtn').forEach(btn=>{
    btn.onclick = ()=>{
      const ceo = btn.getAttribute('data-ceo');
      showBoards(ceo);
    };
  });

  document.getElementById('pageNo').textContent = String(currentPage);
  document.getElementById('pageTotal').textContent = String(Math.max(1, Math.ceil(filteredRows.length / PAGE_SIZE)));
}

/********************** Charts (unchanged behavior) **********************/
function getDateSeries(){
  // Build series for all dates, optionally for a single CEO
  const byDate = new Map();
  allCountsRows.forEach(r=>{
    const key = r.date;
    if (!byDate.has(key)) byDate.set(key,{pos:0,neu:0,neg:0});
    const bucket = byDate.get(key);
    if (!selectedCeo || r.ceo===selectedCeo){
      bucket.pos += +r.pos||0; bucket.neu += +r.neu||0; bucket.neg += +r.neg||0;
    }
  });

  const serpByDate = new Map();
  serpsDaily.forEach(r=>{
    const key = r.date;
    if (!serpByDate.has(key)) serpByDate.set(key,{total:0,neg:0,ctrl:0});
    if (!selectedCeo || r.ceo===selectedCeo){
      const b = serpByDate.get(key);
      b.total += +r.total||0; b.neg += +r.neg_serp||0; b.ctrl += +r.ctrl||0;
    }
  });

  const dates = [...new Set([...byDate.keys(), ...serpByDate.keys()])].filter(isISODate).sort();
  const newsPos=[], newsNeu=[], newsNeg=[], serpNegPct=[], serpCtrlPct=[];
  dates.forEach(d=>{
    const n = byDate.get(d)||{pos:0,neu:0,neg:0};
    const t = n.pos+n.neu+n.neg || 0;
    newsPos.push(t? n.pos/t*100 : 0);
    newsNeu.push(t? n.neu/t*100 : 0);
    newsNeg.push(t? n.neg/t*100 : 0);

    const s = serpByDate.get(d)||{total:0,neg:0,ctrl:0};
    serpNegPct.push(s.total? s.neg/s.total*100 : 0);
    serpCtrlPct.push(s.total? s.ctrl/s.total*100 : 0);
  });
  return {dates, newsPos, newsNeu, newsNeg, serpNegPct, serpCtrlPct};
}

function renderCharts(){
  const {dates, newsPos, newsNeu, newsNeg, serpNegPct, serpCtrlPct} = getDateSeries();

  const who = selectedCeo ? selectedCeo : "Index Average";

  const commonOpts = {
    responsive: true,
    maintainAspectRatio: false,
    scales: {
      x: {
        ticks: { color: '#ebf2f2' },
        grid: { color: 'rgba(255,255,255,.05)' }
      },
      y: {
        ticks: { color: '#ebf2f2' },
        grid: { color: 'rgba(255,255,255,.06)' },
        suggestedMin: 0,
        suggestedMax: 100
      }
    },
    plugins: {
      legend: { labels: { color: '#ebf2f2' } },
      title: {
        display: true,
        text: who,
        color: '#ebf2f2',
        font: { weight: 'bold', size: 14 },
        padding: { top: 8, bottom: 8 }
      }
    }
  };

  // --- News stacked bar chart ---
  const nh = document.getElementById('newsChart').getContext('2d');
  if (newsChart) newsChart.destroy();
  newsChart = new Chart(nh, {
    type: 'bar',
    data: {
      labels: dates,
      datasets: [
        { label: 'Positive %', data: newsPos, backgroundColor: 'rgba(139,226,118,.8)', stack: 's' },
        { label: 'Neutral %',  data: newsNeu, backgroundColor: 'rgba(255,213,79,.85)', stack: 's' },
        { label: 'Negative %', data: newsNeg, backgroundColor: 'rgba(255,120,97,.9)', stack: 's' }
      ]
    },
    options: { ...commonOpts }
  });

  // --- SERP line chart ---
  const sh = document.getElementById('serpChart').getContext('2d');
  if (serpChart) serpChart.destroy();
  serpChart = new Chart(sh, {
    type: 'line',
    data: {
      labels: dates,
      datasets: [
        { label: 'Negative SERP %', data: serpNegPct, tension: .25, borderColor: 'rgba(255,120,97,1)', backgroundColor: 'rgba(255,120,97,.2)', fill: false },
        { label: 'Control %', data: serpCtrlPct, tension: .25, borderColor: 'rgba(139,226,118,1)', backgroundColor: 'rgba(139,226,118,.15)', fill: false }
      ]
    },
    options: { ...commonOpts }
  });
}

/********************** Modals **********************/
const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modalTitle');
const modalContent = document.getElementById('modalContent');
document.getElementById('modalClose').onclick = ()=> modal.classList.remove('open');
modal.addEventListener('click', e=>{ if (e.target===modal) modal.classList.remove('open'); });
function openModal(title, html){
  modalTitle.textContent = title;
  modalContent.innerHTML = html;
  modal.classList.add('open');
}

/********************** Boards modal **********************/
function showBoards(ceo){
  // exact, then canonical (case/space-insensitive), then fuzzy fallback
  const key = canonName(ceo);
  let boards = boardsByCeo.get(ceo) || boardsByCeo.get(key);

  if (!boards){
    // last-chance: find any key that equals ignoring case/space
    const k = [...boardsByCeo.keys()].find(k => k === key);
    boards = k ? boardsByCeo.get(k) : null;
  }

  if (!boards || !boards.length){
    openModal(`Boards — ${ceo}`, `<div class="muted">No boards found.</div>`);
    return;
  }

  const html = `<ul style="padding-left:20px;margin:0">
    ${boards.map(b=>{
      const text = esc(b.domain || (b.url ? new URL(b.url).hostname.replace(/^www\./,'') : 'Board'));
      const href = esc(b.url || '#');
      return `<li style="margin:6px 0"><a class="link" href="${href}" target="_blank" rel="noopener">${text}</a></li>`;
    }).join('')}
  </ul>`;
  openModal(`Boards — ${ceo}`, html);
}

/********************** Headlines modal (styled like SERP cards) **********************/
async function showHeadlines({ ceo }) {
  const d = document.getElementById('dateSelect').value;
  const file = `data_ceos/articles/${d}-articles.csv`;

  let rows = [];
  try {
    rows = await fetchCsv(file);
  } catch (e) {
    openModal(`Headlines — ${esc(ceo)}`,
      `<div class="muted">Could not load headlines for ${d}.</div>`);
    return;
  }

  // Match on CEO (trim to be safe)
  const list = rows.filter(r => String(r.ceo || '').trim() === ceo);

  if (!list.length) {
    openModal(`Headlines — ${esc(ceo)}`,
      `<div class="muted">No headlines for ${esc(ceo)} on ${d}.</div>`);
    return;
  }

  // Build cards using the same layout classes as the SERP modal
  const cards = list.map(r => {
    const url = String(r.url || '').trim();
    let domain = '';
    try { domain = new URL(url).hostname.replace(/^www\./, ''); } catch {}
    const title = esc(r.title || domain || '(no title)');
    const link = url
      ? `<a class="link" href="${esc(url)}" target="_blank" rel="noopener">${title}</a>`
      : `<span class="muted">${title}</span>`;

    const sRaw = String(r.sentiment || '').toLowerCase();
    const s = sRaw === 'positive' ? 'positive' : (sRaw === 'negative' ? 'negative' : 'neutral');

    return `
      <div class="serp-card">
        ${domain ? `<div class="serp-domain">${esc(domain)}</div>` : ''}
        <div class="serp-title">${link}</div>
        <div class="badges" style="margin-top:8px">
          <span class="badge ${s}">${s}</span>
        </div>
      </div>
    `;
  }).join('');

  openModal(`Headlines — ${esc(ceo)}`, `<div class="serp-cards">${cards}</div>`);
}


/********************** SERP modal (reads data_ceos/serp_rows) **********************/
async function showSerp(row){
  const d = document.getElementById('dateSelect').value;
  const path = SERP_ROWS_PATH(d);

  let rows = [];
  try { rows = await fetchCsv(path); }
  catch { openModal(`SERP — ${esc(row.ceo)}`, `<div class="muted">Could not load SERP file for ${d}.</div>`); return; }
  if (!rows.length){ openModal(`SERP — ${esc(row.ceo)}`, `<div class="muted">No SERP data found for ${d}.</div>`); return; }

  const canon = s => String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,' ').trim();

  const wantCEO = canon(row.ceo), wantCo = canon(row.company);
  const matches = rows.filter(r => {
    const rCEO = canon(r.ceo), rCo = canon(r.company);
    return (r.ceo===row.ceo && r.company===row.company) || (rCEO===wantCEO && rCo===wantCo);
  });

  if (!matches.length){
    openModal(`SERP — ${esc(row.ceo)}`, `<div class="muted">No SERPs for ${esc(row.ceo)} on ${d}.</div>`); return;
  }

  // metrics
  const total = matches.length;
  const negCount = matches.filter(r => String(r.sentiment||'').toLowerCase()==='negative').length;
  const ctrlCount = matches.filter(r => (/^controlled|true|1$/i).test(String(r.controlled||''))).length;
  const negPct = total? (negCount/total) : 0;
  const ctrlPct = total? (ctrlCount/total) : 0;
  const risk = computeRisk(negPct, ctrlPct);

  // sort by position if present
  matches.sort((a,b)=>(+a.position||9999) - (+b.position||9999));

  const cards = matches.map(r=>{
    const url = String(r.url||'').trim();
    let domain = '';
    try { domain = new URL(url).hostname.replace(/^www\./,''); } catch {}
    const title = esc(r.title || domain || '(no title)');
    const snippet = esc(r.snippet || '');
    const s = String(r.sentiment||'neutral').toLowerCase();
    const ctrl = (/^controlled|true|1$/i).test(String(r.controlled||'')) ? 'controlled' : 'uncontrolled';
    const link = url ? `<a class="link" href="${esc(url)}" target="_blank" rel="noopener">${title}</a>` : `<span class="muted">${title}</span>`;
    return `<div class="serp-card">
      ${domain? `<div class="serp-domain">${esc(domain)}</div>` : ''}
      <div class="serp-title">${link}</div>
      ${snippet? `<div class="serp-snippet">${snippet}</div>` : ''}
      <div class="badges">
        <span class="badge ${s}">${s}</span>
        <span class="badge ${ctrl}">${ctrl}</span>
      </div>
    </div>`;
  }).join('');

  const metrics = `<div class="serp-metrics">
    <b>Negative SERP:</b> ${(negPct*100).toFixed(1)}% &nbsp;|&nbsp;
    <b>Control:</b> ${(ctrlPct*100).toFixed(1)}% &nbsp;|&nbsp;
    <b>Risk:</b> ${esc(risk)}
  </div>`;

  openModal(`SERP — ${esc(row.ceo)}`, `${metrics}<div class="serp-cards">${cards}</div>`);
}

/********************** Init **********************/
init();
</script>
</body>
</html>
