<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CEO News Sentiment Dashboard</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Papa Parse (CSV parser) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Chart.js for stacked bar trend -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    #trendWrap { height: 20rem; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-7xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-3xl font-bold">CEO News Sentiment Dashboard</h1>
      <p class="text-sm text-slate-600">
        Shows the top 25 Fortune 500 CEOs by <em>negative</em> article count for a selected day.
        Data source: <code>data_ceos/daily_counts.csv</code>.
      </p>
    </header>

    <!-- Controls -->
    <section class="mb-4 grid gap-3 md:grid-cols-3">
      <div>
        <label class="block text-sm font-medium mb-1">Pick date</label>
        <select id="dateSelect" class="w-full border rounded-lg p-2 bg-white"></select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Filter CEOs</label>
        <input id="brandFilter" type="text" placeholder="Type to filter…" class="w-full border rounded-lg p-2" />
      </div>
      <div class="flex items-end gap-2 w-full">
        <button id="refreshBtn" class="px-3 py-2 rounded-lg bg-slate-900 text-white">Refresh</button>
      </div>
    </section>

    <!-- Save options -->
    <section class="mb-6 p-4 border rounded-xl bg-white">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <h2 class="text-lg font-semibold">Save highlighted CEOs</h2>
        <div class="flex items-center gap-3">
          <span class="text-sm text-slate-600">Display</span>
          <div class="flex gap-1" role="group" aria-label="Display mode">
            <button id="modeCountsBtn" class="px-2 py-1 rounded-lg border bg-white" title="Show raw counts">Counts</button>
            <button id="modePercentBtn" class="px-2 py-1 rounded-lg border bg-white" title="Show percentages">%</button>
          </div>
        </div>
      </div>
      <div class="mt-3 flex items-center gap-3 flex-wrap">
        <button id="saveLocalBtn" class="px-3 py-2 rounded-lg bg-black hover:bg-black/90 text-white">Save selection (local)</button>
        <button id="exportCsvBtn" class="px-3 py-2 rounded-lg bg-black hover:bg-black/90 text-white">Download all data (CSV)</button>
      </div>
    </section>

    <!-- CEO trend (stacked bar) -->
    <section class="mb-6 p-4 border rounded-xl bg-white">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-lg font-semibold">Sentiment trend</h2>
        <div class="flex items-center gap-2">
          <span id="trendInfo" class="text-xs text-slate-500"></span>
          <span id="trendRange" class="text-xs text-slate-500"></span>
          <button id="trendPrev" class="px-2 py-1 border rounded disabled:opacity-40" title="Older 30 days">←</button>
          <button id="trendNext" class="px-2 py-1 border rounded disabled:opacity-40" title="Newer 30 days">→</button>
        </div>
      </div>
      <p id="trendHint" class="text-sm text-slate-500 mb-2">
        Select <b>1 CEO</b> to display their trend. When none is selected, the <b>INDEX (average)</b> is shown.
      </p>
      <div id="trendWrap">
        <canvas id="trendChart"></canvas>
      </div>
    </section>

    <!-- Table -->
    <section class="overflow-x-auto">
      <table class="min-w-full text-sm bg-white rounded-xl overflow-hidden border">
        <thead class="bg-slate-100">
          <tr>
            <th class="p-3 text-left"><input type="checkbox" id="selectAll"></th>
            <th class="p-3 text-left">Rank</th>
            <th class="p-3 text-left">CEO</th>
            <th class="p-3 text-left">Company</th>
            <th id="thNeg" class="p-3 text-left">Negative (%)</th>
            <th id="thNeu" class="p-3 text-left">Neutral (%)</th>
            <th id="thPos" class="p-3 text-left">Positive (%)</th>
            <th class="p-3 text-left">Theme</th>
            <th class="p-3 text-left">Headlines</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
      <p id="status" class="text-xs text-slate-500 mt-2"></p>
    </section>

    <!-- Saved (local) -->
    <section class="mt-8">
      <h2 class="text-lg font-semibold mb-2">Saved (local) watchlist</h2>
      <div id="savedContainer" class="border rounded-xl bg-white p-4 text-sm">
        <p class="text-slate-600">No saved items yet.</p>
      </div>
    </section>
  </div>

  <!-- Drill-down Modal -->
  <div id="modalBackdrop" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-3xl bg-white rounded-2xl shadow-xl overflow-hidden">
        <div class="flex items-center justify-between p-4 border-b">
          <div>
            <h3 id="modalTitle" class="text-xl font-bold">Headlines</h3>
            <p id="modalSubtitle" class="text-sm text-slate-600"></p>
          </div>
          <button id="modalClose" class="px-3 py-1.5 rounded-lg border">Close</button>
        </div>
        <div id="modalBody" class="max-h-[70vh] overflow-y-auto p-4">
          <p class="text-sm text-slate-500">Loading…</p>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  // === Paths / constants
  const CSV_COUNTS   = 'data_ceos/daily_counts.csv';
  const CSV_ARTICLES = (date) => `data_ceos/articles/${date}.csv`; // per-day headlines

  // Absolute fallback for GH Pages
  const GH_USER = 'jonas-sickler';
  const GH_REPO = 'news-sentiment-dashboard';
  const GH_PAGES_BASE = `https://${GH_USER}.github.io/${GH_REPO}/`;

  const ROWS_TO_SHOW = 25;        // top by negative
  const TREND_WINDOW = 30;        // days per page

  // Colors
  const C_NEG = '#ffb199';
  const C_POS = '#b8e276';
  const C_NEU = '#cedcdd';

  // DOM
  const tableBody      = document.getElementById('tableBody');
  const modeCountsBtn  = document.getElementById('modeCountsBtn');
  const modePercentBtn = document.getElementById('modePercentBtn');
  const dateSelect     = document.getElementById('dateSelect');
  const brandFilter    = document.getElementById('brandFilter');
  const statusEl       = document.getElementById('status');
  const selectAll      = document.getElementById('selectAll');
  const saveLocalBtn   = document.getElementById('saveLocalBtn');
  const exportCsvBtn   = document.getElementById('exportCsvBtn');
  const savedContainer = document.getElementById('savedContainer');

  const trendCanvas = document.getElementById('trendChart');
  const trendInfo   = document.getElementById('trendInfo');
  const trendHint   = document.getElementById('trendHint');
  const trendPrev   = document.getElementById('trendPrev');
  const trendNext   = document.getElementById('trendNext');
  const trendRange  = document.getElementById('trendRange');

  // Modal
  const modalBackdrop = document.getElementById('modalBackdrop');
  const modalTitle    = document.getElementById('modalTitle');
  const modalSubtitle = document.getElementById('modalSubtitle');
  const modalBody     = document.getElementById('modalBody');
  const modalClose    = document.getElementById('modalClose');

  // State
  let allRows = [];             // parsed from daily_counts.csv
  let currentDate = null;
  let currentRows = [];
  let selected = new Set();     // CEO names selected
  let viewMode = localStorage.getItem('view_mode_ceo') || 'percent'; // 'counts'|'percent'
  let trendChart = null, trendBrand = null, trendPage = 0;

  const articlesCache = {};     // date -> parsed article rows
  const themesByDate = {};      // { [date]: { [ceo]: 'theme phrase' } }

  // Utilities
  function normalizeRowKeys(row){
    const out = {};
    for(const k in row){
      const nk = String(k||'').replace(/^\ufeff/, '').trim().toLowerCase();
      out[nk] = row[k];
    }
    return out;
  }
  function formatInt(x){ return Number(x || 0); }
  function fmtPct(part, total, decimals = 0){
    const t = Number(total || 0), p = Number(part || 0);
    if(!t || isNaN(t)) return '0%';
    const v = (p / t) * 100;
    const s = v.toFixed(decimals);
    return s.replace(/\.0+$/, '') + '%';
  }
  function headerLabel(base){ return viewMode === 'percent' ? `${base} (%)` : base; }
  function updateHeaderLabels(){
    const thNeg = document.getElementById('thNeg');
    const thNeu = document.getElementById('thNeu');
    const thPos = document.getElementById('thPos');
    if(thNeg) thNeg.textContent = headerLabel('Negative');
    if(thNeu) thNeu.textContent = headerLabel('Neutral');
    if(thPos) thPos.textContent = headerLabel('Positive');
  }
  function updateModeButtons(){
    const base = 'px-2 py-1 rounded-lg border';
    modeCountsBtn.className  = base + (viewMode==='counts'  ? ' bg-slate-900 text-white' : ' bg-white');
    modePercentBtn.className = base + (viewMode==='percent' ? ' bg-slate-900 text-white' : ' bg-white');
  }
  function cellVal(part,total){
    if(viewMode === 'percent') return {val: fmtPct(part,total), title: `${part} of ${total}`};
    const pct = fmtPct(part,total);
    return {val: String(part), title: `${pct} of ${total}`};
  }
  function parseDateMaybe(s){ const t = Date.parse(s); return isNaN(t) ? 0 : t; }

  // -------- Strip trailing " -/–/—/| Publisher" for theme purposes --------
  function stripPublisherSuffix(s){
    return String(s || '')
      .replace(/\s(?:-|–|—|\|)\s+[^\s].*?$/u, '')
      .trim();
  }

  // ================== Improved CEO THEME ENGINE ==================
  const THEME_MAX_WORDS = 5;
  const THEME_MIN_COUNT = 2;
  const THEME_NGRAMS    = [2,3,4,5];

  const THEME_STOP = new Set([
    'the','a','an','and','or','but','of','for','to','in','on','at','by','with','from','as','about','after','before',
    'over','under','into','across','amid','amidst','per','this','that','these','those','it','its','their','his','her',
    'they','we','you','our','your','i','is','are','was','were','be','been','being','has','have','had','do','does','did',
    'will','would','should','can','could','may','might','must','new','update','updates','report','reports','reported',
    'says','say','said','see','sees','seen','watch','market','stock','shares','share','price','prices','wins','loss',
    'losses','gain','gains','up','down','news','today','latest','analyst','analysts','rating','cut','cuts','downgrade',
    'downgrades','quarter','q1','q2','q3','q4','year','yrs','2023','2024','2025','usd','billion','million','percent',
    'pct','vs','inc','corp','co','ltd','plc','group','sa','se','llc','lp','nv','ag',
    'mon','tue','wed','thu','fri','sat','sun','monday','tuesday','wednesday','thursday','friday','saturday','sunday',
    'jan','feb','mar','apr','may','jun','jul','aug','sep','sept','oct','nov','dec','january','february','march','april',
    'june','july','august','september','october','november','december',
    'opinion','editorial','video','podcast','blog','live','breaking'
  ]);
  function stemLite(t){
    let s = t.replace(/’s$|'s$/,'');
    if (s.endsWith('ies') && s.length > 4) return s.slice(0,-3)+'y';
    if (/(ing|ers|er|ed|es|s)$/.test(s) && s.length > 4) s = s.replace(/(ing|ers|er|ed|es|s)$/,'');
    return s;
  }
  function tokenizeTheme(text){
    const raw = String(text||'').toLowerCase()
      .normalize('NFKD')
      .replace(/[^\p{L}\p{N}\s]+/gu, ' ')
      .replace(/\s+/g,' ')
      .trim();
    if(!raw) return [];
    return raw.split(' ').map(stemLite);
  }
  function nameCompanyTokens(ceo, company){
    const out = new Set();
    for (const part of [ceo, company]) {
      String(part||'').split(/\s+/).forEach(w=>{
        const t = stemLite(w.toLowerCase());
        if (t) out.add(t);
      });
    }
    out.add('ceo'); out.add('chief'); out.add('executive'); out.add('officer');
    return out;
  }
  function buildCandidates(headlines, ceoName, company){
    const ban = nameCompanyTokens(ceoName, company);
    const keepToken = (t)=> t && !THEME_STOP.has(t) && !ban.has(t) && t.length > 1;
    const counts = new Map(); // key -> {cnt, domains:Set}

    for (const h of headlines){
      const toks = tokenizeTheme(h.title);
      const dom  = h.domain || '';
      for (const n of THEME_NGRAMS){
        for (let i=0;i<=toks.length-n;i++){
          const window = toks.slice(i,i+n);
          if (window.some(t=>!keepToken(t))) continue;
          const key = window.join(' ');
          const rec = counts.get(key) || {cnt:0, domains:new Set()};
          rec.cnt += 1;
          if (dom) rec.domains.add(dom);
          counts.set(key, rec);
        }
      }
    }
    // collapse shorter subphrases into longer ones
    const keys = Array.from(counts.keys()).sort((a,b)=> b.split(' ').length - a.split(' ').length);
    const killed = new Set();
    for (let i=0;i<keys.length;i++){
      if (killed.has(keys[i])) continue;
      for (let j=i+1;j<keys.length;j++){
        if (killed.has(keys[j])) continue;
        if (keys[i].includes(keys[j])) {
          const A = counts.get(keys[i]), B = counts.get(keys[j]);
          A.cnt += B.cnt; B.domains.forEach(d=>A.domains.add(d));
          killed.add(keys[j]);
        }
      }
    }
    const scored = [];
    counts.forEach((v,k)=>{
      if (killed.has(k)) return;
      const words = k.split(' ');
      if (words.length < 2 || words.length > THEME_MAX_WORDS) return;
      if (v.cnt < THEME_MIN_COUNT) return;
      const lenBonus = 1 + 0.2 * (words.length - 2);
      const domBonus = 1 + 0.1 * Math.min(6, v.domains.size);
      const score = v.cnt * lenBonus * domBonus;
      scored.push({phrase:k, score});
    });
    scored.sort((a,b)=> b.score - a.score || b.phrase.length - a.phrase.length || a.phrase.localeCompare(b.phrase));
    return scored.length ? scored[0].phrase : '';
  }
  async function ensureThemesForDate(date){
    if (themesByDate[date]) return;

    const rows = await loadArticlesForDate(date);
    const mapCompany = {};
    for (const r of allRows){ if (r.date === date) mapCompany[r.brand] = r.company || r.alias || ''; }

    const byCeo = new Map();
    for (const r of rows){
      const ceo = (r.brand || '').trim();
      if (!ceo) continue;
      let arr = byCeo.get(ceo);
      if (!arr){ arr = []; byCeo.set(ceo, arr); }
      arr.push({ title: r.title || '', sentiment: (r.sentiment||'').toLowerCase(), domain: r.domain || '' });
    }

    const out = {};
    byCeo.forEach((items, ceo)=>{
      const neg = items.filter(x=> x.sentiment==='negative');
      const pool = neg.length ? neg : items;

      // simple de-dup by normalized title
      const seen = new Set(), uniq = [];
      for (const it of pool){
        const sig = String(it.title||'').toLowerCase().replace(/[^\p{L}\p{N}\s]+/gu,' ').replace(/\s+/g,' ').trim();
        if (sig && !seen.has(sig)){ seen.add(sig); uniq.push(it); }
      }

      const company = mapCompany[ceo] || '';
      const phrase = buildCandidates(uniq, ceo, company);
      out[ceo] = phrase || 'None';
    });

    themesByDate[date] = out;
  }
  // ================= /Improved CEO THEME ENGINE =================

  function getThemeFor(row){
    const map = themesByDate[currentDate] || {};
    const val = map[row.brand] || row.theme || 'None';
    return (val && String(val).trim().length) ? val : 'None';
  }

  // Articles loader (per date) — uses cleaned title for themes, keeps original for modal
  async function loadArticlesForDate(date){
    if(articlesCache[date]) return articlesCache[date];
    const rel = CSV_ARTICLES(date) + '?_=' + Date.now();
    const abs = GH_PAGES_BASE + CSV_ARTICLES(date) + (CSV_ARTICLES(date).includes('?') ? '&' : '?') + '_=' + Date.now();
    const candidates = [rel, abs];

    for(const url of candidates){
      try{
        const resp = await fetch(url, {cache:'no-store'});
        if(!resp.ok) continue;
        const text = await resp.text();
        const parsed = Papa.parse(text, { header: true });
        const norm = (Array.isArray(parsed.data) ? parsed.data : []).map(normalizeRowKeys);
        const rows = norm
          .filter(r=> r && (r.brand || r.company || r.alias_matched) && (r.title || r.headline))
          .map(r=>{
            const brand = String(r.brand || r.company || '').trim();
            const alias = String(r.alias_matched || r.alias || '').trim();
            const rawUrl = String(r.url || r.link || r.href || '');
            let domain = String(r.domain || '');
            if(!domain && rawUrl){ try{ domain = new URL(rawUrl).hostname; }catch{} }

            const rawTitle   = String(r.title || r.headline || '').trim();
            const cleanTitle = stripPublisherSuffix(rawTitle);

            return {
              brand,
              alias,
              title: cleanTitle,                 // cleaned for theme/search
              displayTitle: rawTitle,            // original for modal display
              url: rawUrl,
              domain,
              sentiment: String(r.sentiment || r.label || 'neutral'),
              published: String(r.published || r.date || r.datetime || '')
            };
          });
        articlesCache[date] = rows;
        return rows;
      }catch{}
    }
    articlesCache[date] = [];
    return [];
  }

  // UI helpers
  function sentimentBadge(s){
    const base = 'inline-block px-2 py-0.5 rounded-full text-xs';
    if(s === 'negative') return `<span class="${base} bg-rose-100 text-rose-700">negative</span>`;
    if(s === 'positive') return `<span class="${base} bg-emerald-100 text-emerald-700">positive</span>`;
    return `<span class="${base} bg-slate-100 text-slate-700">neutral</span>`;
  }

  function renderDateOptions(){
    const dates = Array.from(new Set(allRows.map(r => r.date))).sort();
    dateSelect.innerHTML = dates.map(d => `<option value="${d}">${d}</option>`).join('\n');
    currentDate = dates[dates.length - 1] || null;
    if(currentDate) dateSelect.value = currentDate;
    updateHeaderLabels();
    updateModeButtons();
  }

  function computeRows(){
    const filter = (brandFilter.value || '').toLowerCase();
    const rows = allRows.filter(r => r.date === currentDate && r.brand);
    rows.sort((a,b)=> formatInt(b.negative) - formatInt(a.negative));
    const top = rows.filter(r => r.brand.toLowerCase().includes(filter)).slice(0, ROWS_TO_SHOW);
    selected = new Set(Array.from(selected).filter(b => top.find(r => r.brand === b)));
    currentRows = top;
  }

  function renderTable(){
    tableBody.innerHTML = currentRows.map((r, idx)=>{
      const isSel = selected.has(r.brand);
      const n = cellVal(r.negative, r.total);
      const u = cellVal(r.neutral, r.total);
      const p = cellVal(r.positive, r.total);
      const brandAttr = r.brand.replace(/"/g,'&quot;');
      return `<tr class="border-t hover:bg-slate-50">
        <td class="p-3"><input type="checkbox" data-brand="${brandAttr}" ${isSel?'checked':''}></td>
        <td class="p-3">${idx+1}</td>
        <td class="p-3 font-medium"><button class="underline" data-view-brand="${brandAttr}">${r.brand}</button></td>
        <td class="p-3">${r.company || ''}</td>
        <td class="p-3" title="${n.title}">${n.val}</td>
        <td class="p-3" title="${u.title}">${u.val}</td>
        <td class="p-3" title="${p.title}">${p.val}</td>
        <td class="p-3 text-slate-700">${getThemeFor(r)}</td>
        <td class="p-3"><button class="px-2 py-1 border rounded-lg" data-view-brand="${brandAttr}">View</button></td>
      </tr>`;
    }).join('\n');
    statusEl.textContent = `${currentRows.length} CEOs shown for ${currentDate}. ${selected.size} selected.`;
    updateTrend();
    attachTableHandlers();
  }

  function renderSaved(){
    const saved = JSON.parse(localStorage.getItem('saved_ceos') || '[]');
    if(!saved.length){
      savedContainer.innerHTML = '<p class="text-slate-600">No saved items yet.</p>';
      return;
    }
    const hNeg = headerLabel('Negative');
    const hNeu = headerLabel('Neutral');
    const hPos = headerLabel('Positive');
    savedContainer.innerHTML = `
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-100">
            <tr>
              <th class="p-2 text-left">Date</th>
              <th class="p-2 text-left">CEO</th>
              <th class="p-2 text-left">Company</th>
              <th class="p-2 text-left">${hNeg}</th>
              <th class="p-2 text-left">${hNeu}</th>
              <th class="p-2 text-left">${hPos}</th>
              <th class="p-2 text-left">Theme</th>
              <th class="p-2 text-left">Actions</th>
            </tr>
          </thead>
          <tbody>
            ${saved.map((s,i)=>{
              const n = cellVal(s.negative, s.total);
              const u = cellVal(s.neutral, s.total);
              const p = cellVal(s.positive, s.total);
              return `
              <tr class="border-t">
                <td class="p-2">${s.date}</td>
                <td class="p-2 font-medium">${s.brand}</td>
                <td class="p-2">${s.company || ''}</td>
                <td class="p-2" title="${n.title}">${n.val}</td>
                <td class="p-2" title="${u.title}">${u.val}</td>
                <td class="p-2" title="${p.title}">${p.val}</td>
                <td class="p-2">${s.theme || 'none'}</td>
                <td class="p-2"><button data-i="${i}" class="text-rose-600 underline">Remove</button></td>
              </tr>`;
            }).join('\n')}
          </tbody>
        </table>
      </div>`;
    savedContainer.querySelectorAll('button[data-i]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const idx = parseInt(btn.getAttribute('data-i'),10);
        const arr = JSON.parse(localStorage.getItem('saved_ceos') || '[]');
        arr.splice(idx,1);
        localStorage.setItem('saved_ceos', JSON.stringify(arr));
        renderSaved();
      });
    });
  }

  function saveSelectionLocal(){
    const current = currentRows.filter(r => selected.has(r.brand));
    if(!current.length){ alert('No rows selected.'); return; }
    const saved = JSON.parse(localStorage.getItem('saved_ceos') || '[]');
    const key = (x)=> `${x.date}__${x.brand}`;
    const existingKeys = new Set(saved.map(key));
    for(const row of current){ if(!existingKeys.has(key(row))) saved.push(row); }
    localStorage.setItem('saved_ceos', JSON.stringify(saved));
    renderSaved();
    alert('Saved locally.');
  }

  function exportSelectionCsv(){
    // Export ALL CEOs for the currently selected date (ignores checkbox/filter/top-25)
    const rows = allRows.filter(r => r.date === currentDate);
    if(!rows.length){ alert('No data for this date.'); return; }
    rows.sort((a,b)=>{
      const d = formatInt(b.negative) - formatInt(a.negative);
      return d !== 0 ? d : String(a.brand).localeCompare(String(b.brand));
    });
    const header = ['date','ceo','company','total','positive','neutral','negative','theme'];
    const body = rows.map(r=>[
      r.date,
      '"' + String(r.brand||'').replace(/"/g,'""') + '"',
      '"' + String(r.company||'').replace(/"/g,'""') + '"',
      r.total,
      r.positive,
      r.neutral,
      r.negative,
      '"' + String(getThemeFor(r) || '').replace(/"/g,'""') + '"'
    ].join(','));
    const bom = '\ufeff';
    const csv = bom + [header.join(','), ...body].join('\r\n');

    const filename = `ceo_alldata_${currentDate}.csv`;
    try{
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.rel = 'noopener'; a.target = '_blank';
      a.style.display = 'none'; document.body.appendChild(a); a.click();
      setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); }, 800);
    }catch(err){
      console.error('CSV export failed', err);
      alert('Download was blocked by the environment.');
    }
  }

  function attachTableHandlers(){
    tableBody.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
      cb.addEventListener('change', ()=>{
        const brand = cb.getAttribute('data-brand');
        if(cb.checked) selected.add(brand); else selected.delete(brand);
        statusEl.textContent = `${currentRows.length} CEOs shown for ${currentDate}. ${selected.size} selected.`;
        updateTrend();
      });
    });
    tableBody.querySelectorAll('[data-view-brand]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const brand = btn.getAttribute('data-view-brand');
        showDrilldown(brand);
      });
    });
  }

  function openModal(){ modalBackdrop.classList.remove('hidden'); }
  function closeModal(){ modalBackdrop.classList.add('hidden'); }
  modalClose.addEventListener('click', closeModal);
  modalBackdrop.addEventListener('click', (e)=>{ if(e.target === modalBackdrop) closeModal(); });
  window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeModal(); });

  async function showDrilldown(brand){
    modalTitle.textContent = brand + ' — Headlines';
    modalSubtitle.textContent = `Date: ${currentDate}`;
    modalBody.innerHTML = '<p class="text-sm text-slate-500">Loading…</p>';
    openModal();

    const all = await loadArticlesForDate(currentDate);
    const key = brand.trim().toLowerCase();
    const rows = all.filter(r => (r.brand || '').trim().toLowerCase() === key || (r.alias || '').trim().toLowerCase() === key);
    rows.sort((a,b)=>{
      const order = (x)=> x.sentiment === 'negative' ? 2 : (x.sentiment === 'neutral' ? 1 : 0);
      const d = order(b) - order(a);
      if(d !== 0) return d;
      return parseDateMaybe(b.published) - parseDateMaybe(a.published);
    });

    if(!rows.length){
      modalBody.innerHTML = '<p class="text-sm text-slate-600">No articles found for this CEO on this date.</p>';
      return;
    }

    modalBody.innerHTML = `
      <div class="space-y-3">
        ${rows.map(r=>`
          <div class="p-3 border rounded-xl hover:bg-slate-50">
            <div class="flex items-center justify-between gap-3">
              <div class="text-xs text-slate-500">${r.domain || ''}</div>
              <div>${sentimentBadge(r.sentiment)}</div>
            </div>
            <a href="${r.url}" target="_blank" rel="noopener" class="block mt-1 font-medium underline">
              ${escapeHtml(r.displayTitle || r.title)}
            </a>
            ${r.published ? `<div class="text-xs text-slate-500 mt-1">${r.published}</div>` : ''}
          </div>`).join('\n')}
      </div>`;
  }
  function escapeHtml(s){
    return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;');
  }

  // ==== Trend helpers & navigation ====
  if(trendPrev){ trendPrev.addEventListener('click', ()=>{ trendPage += 1; updateTrend(); }); }
  if(trendNext){ trendNext.addEventListener('click', ()=>{ trendPage = Math.max(0, trendPage - 1); updateTrend(); }); }

  function allDatesSorted(){ return Array.from(new Set(allRows.map(r=>r.date))).sort(); }

  // Build per-date series for a single CEO
  function seriesForBrand(brand){
    const dates = allDatesSorted();
    const byDate = new Map();
    for(const r of allRows){ if(r.brand === brand) byDate.set(r.date, r); }
    const pos = [], neu = [], neg = [];
    for(const d of dates){
      const r = byDate.get(d) || {total:0,positive:0,neutral:0,negative:0};
      if(viewMode === 'percent'){
        const t = r.total || 0; const f = (x)=> t? (x/t*100) : 0;
        pos.push(+f(r.positive).toFixed(1));
        neu.push(+f(r.neutral).toFixed(1));
        neg.push(+f(r.negative).toFixed(1));
      }else{
        pos.push(r.positive||0); neu.push(r.neutral||0); neg.push(r.negative||0);
      }
    }
    return { dates, pos, neu, neg };
  }

  // NEW: Build INDEX (average across all CEOs) series
  function seriesForIndex(){
    const dates = allDatesSorted();
    const pos = [], neu = [], neg = [];
    for(const d of dates){
      const rows = allRows.filter(r => r.date === d);
      const tot = rows.reduce((s,r)=> s + (r.total||0), 0);
      const sp  = rows.reduce((s,r)=> s + (r.positive||0), 0);
      const sn  = rows.reduce((s,r)=> s + (r.neutral||0), 0);
      const sg  = rows.reduce((s,r)=> s + (r.negative||0), 0);
      if(viewMode === 'percent'){
        const f = (x)=> tot ? (x/tot*100) : 0;
        pos.push(+f(sp).toFixed(1));
        neu.push(+f(sn).toFixed(1));
        neg.push(+f(sg).toFixed(1));
      }else{
        // counts mode: show totals across the cohort
        pos.push(sp); neu.push(sn); neg.push(sg);
      }
    }
    return { dates, pos, neu, neg };
  }

  function updateTrend(){
    const selCount = selected.size;
    let mode = 'index'; // default to INDEX when nothing selected
    let brand = null;

    if(selCount === 1){
      mode = 'brand';
      brand = Array.from(selected)[0];
    }

    // Reset paging if target changed
    const targetKey = mode === 'brand' ? `brand:${brand}` : 'index';
    if(targetKey !== trendBrand){ trendPage = 0; }
    trendBrand = targetKey;

    const full = (mode === 'brand') ? seriesForBrand(brand) : seriesForIndex();

    const total = full.dates.length;
    const W = TREND_WINDOW;
    const maxPage = Math.max(0, Math.ceil(total / W) - 1);
    if(trendPage > maxPage) trendPage = maxPage;
    const end = Math.max(0, total - W * trendPage);
    const start = Math.max(0, end - W);

    const labels = full.dates.slice(start, end);
    const pos = full.pos.slice(start, end);
    const neu = full.neu.slice(start, end);
    const neg = full.neg.slice(start, end);

    trendHint.classList.add('hidden');
    trendInfo.textContent = (mode === 'brand') ? `CEO: ${brand}` : 'INDEX: Average across CEOs';
    if(trendRange){
      const rangeText = labels.length ? `  |  DATE: ${labels[0]} → ${labels[labels.length-1]}` : '';
      trendRange.textContent = rangeText;
    }
    const showLabels = labels.length <= 7;

    const data = {
      labels,
      datasets: [
        { label: 'Positive', data: pos, backgroundColor: C_POS, stack: 'sent' },
        { label: 'Neutral',  data: neu, backgroundColor: C_NEU, stack: 'sent' },
        { label: 'Negative', data: neg, backgroundColor: C_NEG, stack: 'sent' },
      ]
    };
    const options = {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'top' },
        tooltip: {
          callbacks: {
            label: (ctx) => {
              const v = ctx.parsed.y;
              return (viewMode==='percent') ? `${ctx.dataset.label}: ${v}%` : `${ctx.dataset.label}: ${v}`;
            }
          }
        }
      },
      scales: {
        x: { stacked: true, ticks: { display: showLabels } },
        y: { stacked: true, beginAtZero: true, ticks: { callback: (v)=> viewMode==='percent' ? v + '%' : v } }
      }
    };

    if(trendChart){ trendChart.destroy(); }
    if(trendCanvas){ trendChart = new Chart(trendCanvas.getContext('2d'), { type: 'bar', data, options }); }
  }

  // Load counts CSV and bootstrap
  function loadCountsCsv(){
    const rel = new URL(CSV_COUNTS, location.href).href + (CSV_COUNTS.includes('?') ? '&' : '?') + '_=' + Date.now();
    const abs = GH_PAGES_BASE + CSV_COUNTS + (CSV_COUNTS.includes('?') ? '&' : '?') + '_=' + Date.now();
    const candidates = [rel, abs];

    statusEl.textContent = 'Loading…';

    (async () => {
      let okText = null;
      for(const url of candidates){
        try{
          const r = await fetch(url, {cache:'no-store', mode: 'cors'});
          if(!r.ok) continue;
          const t = await r.text();
          if(t && t.length) { okText = t; break; }
        }catch{}
      }
      if(!okText){
        statusEl.textContent = 'Error loading data.';
        return;
      }
      const parsed = Papa.parse(okText, { header: true, dynamicTyping: true });
      const raw = (Array.isArray(parsed.data) ? parsed.data : []).map(normalizeRowKeys);
      const good = raw.filter(r => r && r.date && r.brand);
      allRows = good.map(r => ({
        date: String(r.date),
        brand: String(r.brand),          // CEO name
        company: String(r.company || ''),// company column from your script
        total: formatInt(r.total),
        positive: formatInt(r.positive),
        neutral: formatInt(r.neutral),
        negative: formatInt(r.negative),
        theme: r.theme ? String(r.theme) : 'none'
      }));
      if(!allRows.length){
        statusEl.textContent = 'No rows parsed from data_ceos/daily_counts.csv.';
        dateSelect.innerHTML = ''; tableBody.innerHTML = '';
        return;
      }

      renderDateOptions();
      computeRows();
      // compute themes first so the table shows improved phrases
      ensureThemesForDate(currentDate).then(()=>{
        renderTable();
        renderSaved();
        statusEl.textContent = `${currentRows.length} CEOs shown for ${currentDate}. ${selected.size} selected.`;
      });
    })();
  }

  // Events
  document.getElementById('refreshBtn').addEventListener('click', loadCountsCsv);
  dateSelect.addEventListener('change', async ()=>{
    currentDate = dateSelect.value;
    computeRows();
    await ensureThemesForDate(currentDate);
    renderTable();
    renderSaved();
  });
  brandFilter.addEventListener('input', ()=>{ computeRows(); renderTable(); });
  selectAll.addEventListener('change', ()=>{
    if(selectAll.checked){ currentRows.forEach(r=>selected.add(r.brand)); }
    else { selected.clear(); }
    renderTable();
  });
  saveLocalBtn.addEventListener('click', saveSelectionLocal);
  exportCsvBtn.addEventListener('click', exportSelectionCsv);
  modeCountsBtn.addEventListener('click', ()=>{ viewMode='counts';  localStorage.setItem('view_mode_ceo','counts');  updateHeaderLabels(); updateModeButtons(); renderTable(); renderSaved(); updateTrend(); });
  modePercentBtn.addEventListener('click', ()=>{ viewMode='percent'; localStorage.setItem('view_mode_ceo','percent'); updateHeaderLabels(); updateModeButtons(); renderTable(); renderSaved(); updateTrend(); });

  // Go!
  loadCountsCsv();
})();
</script>
</body>
</html>
