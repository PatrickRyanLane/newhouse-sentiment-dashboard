<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CEO Risk Dashboard</title>
  <!-- Fonts & libs -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{--bg:#0b0d12;--card:#111724;--muted:#8c9bb0;--text:#e7ecf4;--accent:#5ea0ff}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    h1{font-size:24px;margin:0 0 12px}
    .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:12px 0}
    .card{background:var(--card);border-radius:16px;padding:16px;box-shadow:0 4px 20px rgb(0 0 0 / .25)}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:980px){.grid{grid-template-columns:2fr 1fr}}
    select,input[type="text"]{background:#0c1220;border:1px solid #23314d;color:var(--text);border-radius:10px;padding:8px 10px}
    button{background:#18243b;border:1px solid #2a3b5e;color:var(--text);border-radius:10px;padding:8px 10px;cursor:pointer}
    button:hover{border-color:#3d568a}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    thead th{font-size:12px;color:var(--muted);text-align:left;padding:0 8px}
    tbody tr{background:#0e1524}
    tbody td{padding:10px 8px;border-top:1px solid #17223a;border-bottom:1px solid #17223a}
    tbody tr td:first-child{border-left:1px solid #17223a;border-radius:10px 0 0 10px}
    tbody tr td:last-child{border-right:1px solid #17223a;border-radius:0 10px 10px 0}
    .pill{padding:4px 8px;border-radius:999px;font-size:12px}
    .pill.low{background:rgba(34,197,94,.15);color:#22c55e}
    .pill.med{background:rgba(245,158,11,.15);color:#f59e0b}
    .pill.high{background:rgba(255,107,107,.15);color:#ff7b7b}
    .muted{color:var(--muted)}
    .right{text-align:right}
    .center{text-align:center}
    .pagination{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:8px}
    .checkbox{accent-color:var(--accent)}
    .notice{display:none;font-size:12px;margin:4px 0;color:#f59e0b}
    .modal{position:fixed;inset:0;background:rgb(0 0 0 / .65);display:none;align-items:center;justify-content:center;padding:24px;z-index:50}
    .modal>.box{background:#0e1524;border:1px solid #23314d;border-radius:16px;max-width:900px;width:100%;max-height:80vh;overflow:auto}
    .modal header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #1f2b46}
    .modal .content{padding:16px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>CEO Risk Dashboard</h1>

    <div id="date-notice" class="notice"></div>

    <div class="controls card" id="controls">
      <label>
        <span class="muted" style="font-size:12px;display:block;margin-bottom:4px">Date</span>
        <select id="datePicker"></select>
      </label>
      <label style="min-width:260px;flex:1">
        <span class="muted" style="font-size:12px;display:block;margin-bottom:4px">Filter (CEO or Company)</span>
        <input id="filterInput" type="text" placeholder="Type to filter…" style="width:100%"/>
      </label>
      <div style="margin-left:auto;display:flex;gap:8px">
        <button id="refreshBtn">Refresh Data</button>
        <button id="clearBtn">Clear Selection</button>
      </div>
    </div>

    <div class="grid">
      <div class="card"><canvas id="newsTrend" height="150"></canvas></div>
      <div class="card"><canvas id="serpTrend" height="150"></canvas></div>
    </div>

    <div class="card" style="margin-top:16px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div class="muted">Select exactly one CEO using the checkbox to see brand-level charts. Selecting another will automatically unselect the previous one.</div>
        <div class="muted" id="rowCount"></div>
      </div>
      <table>
        <thead>
          <tr>
            <th></th>
            <th>CEO</th>
            <th>Company</th>
            <th>Theme</th>
            <th class="right sortable" data-sort="negNews">Negative News % ▲▼</th>
            <th class="right sortable" data-sort="negSerp">Negative SERP % ▲▼</th>
            <th class="right sortable" data-sort="ctrl">SERP Control % ▲▼</th>
            <th class="center sortable" data-sort="risk">Risk ▲▼</th>
            <th class="center">Headlines</th>
            <th class="center">SERP</th>
            <th class="center">Boards</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
      <div class="pagination">
        <button id="prevPage">Prev</button>
        <div class="muted" id="pageInfo">Page 1 / 1</div>
        <button id="nextPage">Next</button>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="box">
      <header>
        <strong id="modalTitle">Details</strong>
        <button id="modalClose">Close</button>
      </header>
      <div class="content" id="modalContent">Loading…</div>
    </div>
  </div>

<script>
/* =================== Config & globals =================== */
const COUNTS_CANDIDATES = [
  'data_ceos/daily_counts.csv',   // legacy
  'data/serps/daily_counts.csv',
  'data/daily_counts.csv'
];
const SERPS_DAILY_CSV = 'data/serps/ceo_serps_daily.csv';
const ROSTER_CANDIDATES = [
  'data/serps/roster.csv',
  'data/roster.csv',
  'data/ceo_companies.csv'
];
const BOARDS_CSV = 'data/ceo_boards.csv'; // ceo,domain,url

// Try a list of candidates; return [] if none worked (not null)
async function fetchCsvAny(candidates){
  for(const url of candidates){
    try{
      const rows = await fetchCsv(url);
      if (Array.isArray(rows) && rows.length >= 0) return rows;
    }catch{/* try next */}
  }
  return []; // important: always return an array
}

// Small helpers
function $(s){ return document.querySelector(s); }
function isISODate(s){ return /^\d{4}-\d{2}-\d{2}$/.test(String(s||'').trim()); }
function pct(n,d){ const den = Math.max(1, +d||0); return (+n||0) / den * 100; }
function formatPct(x){ return isFinite(x) ? (Math.round(x*10)/10).toFixed(1) : '0.0'; }
function badge(txt, kind){ const cls = kind==='neg'?'pill high':kind==='pos'?'pill low':'pill med'; return `<span class="${cls}" style="margin-left:6px">${txt}</span>`; }

function pickAvailableDate(requested, available){
  const ds = available.filter(isISODate).sort();
  if(!ds.length) return null;
  if(!requested || !isISODate(requested) || !ds.includes(requested)){
    const t = (requested && isISODate(requested)) ? requested : ds[ds.length-1];
    return ds.filter(d=>d<=t).pop() || ds[ds.length-1];
  }
  return requested;
}
function showDateNotice(actual, requested){
  const el = $('#date-notice');
  if(!el) return;
  if(actual && requested && actual !== requested){
    el.textContent = `Showing ${actual} (no data for ${requested})`;
    el.style.display = 'block';
  } else { el.textContent = ''; el.style.display='none'; }
}

// State
let rosterMap = new Map();        // CEO -> Company
let companyToCeo = new Map();     // company(lower) -> CEO
let boardsByCeo = new Map();      // CEO -> [{domain,url}]
let allCountsRows = [];           // news daily counts
let serpDaily = [];               // aggregated SERP daily
let dates = [];                   // available dates (from counts)
let currentDate = null;

let filteredRows = [];
let sortKey = 'negSerp';
let sortDir = 'desc';
let currentPage = 1;
const pageSize = 25;

let selected = new Set();         // single-select
let newsChart = null;
let serpTrendChart = null;

/* =================== Loaders =================== */
async function fetchCsv(url){
  try{
    const r = await fetch(url, {cache:'no-store'});
    if(!r.ok) throw new Error(`HTTP ${r.status} for ${url}`);
    const t = await r.text();
    return await new Promise((res, rej)=>{
      Papa.parse(t, {header:true, skipEmptyLines:true,
        complete: r => res(r.data || []),
        error: e => rej(e)
      });
    });
  }catch(err){
    console.error('fetchCsv error:', url, err);
    throw err;
  }
}

async function loadRoster(){
  for(const url of ROSTER_CANDIDATES){
    try{
      const rows = await fetchCsv(url);
      for(const r of rows){
        const ceo = String(r.ceo||r.CEO||r.name||'').trim();
        const comp = String(r.company||r.Company||r.brand||r.org||'').trim();
        if(ceo){ rosterMap.set(ceo, comp); if(comp && !companyToCeo.has(comp.toLowerCase())) companyToCeo.set(comp.toLowerCase(), ceo); }
      }
      if(rosterMap.size) return;
    }catch{}
  }
}
async function loadBoards(){
  boardsByCeo = new Map();

  try{
    const rows = await fetchCsv(BOARDS_CSV);
    for (const r of rows){
      const ceo = String(r.ceo || r.CEO || '').trim();
      const domain = String(r.Domain || r.domain || '').trim();
      const url = String(r.URL || r.url || '').trim();
      if (!ceo) continue;

      const list = boardsByCeo.get(ceo) || [];
      // Avoid duplicates
      if (!list.some(x => x.url === url && x.domain === domain)){
        list.push({ domain, url });
      }
      boardsByCeo.set(ceo, list);
    }
  } catch (e) {
    console.warn('Boards CSV not found or unreadable:', e);
  }
}
async function loadSerpsDaily(){
  try{
    const rows = await fetchCsv(SERPS_DAILY_CSV);
    serpDaily = rows.filter(r=>isISODate(r.date||r.Date)).map(r=>({
      date: String(r.date||r.Date).trim(),
      ceo: String(r.ceo||'').trim(),
      company: String(r.company||'').trim(),
      total: +(r.total||0),
      controlled: +(r.controlled||0),
      negative_serp: +(r.negative_serp||0),
      neutral_serp: +(r.neutral_serp||0),
      positive_serp: +(r.positive_serp||0),
    }));
  }catch{ serpDaily = []; }
}
async function loadCounts(){
  let rows = [];
  for(const url of COUNTS_CANDIDATES){
    try{ rows = await fetchCsv(url); if(rows && rows.length) break; }catch{}
  }
  const out = [];
  for(const r of rows){
    let date = String(r.date||'').trim();
    if(!isISODate(date)) continue;
    let ceo = String(r.ceo||'').trim();
    let company = String(r.company||'').trim();
    const brand = String(r.brand||'').trim();
    if(!ceo && brand) ceo = brand;
    if(!company && rosterMap.has(ceo)) company = rosterMap.get(ceo);
    if(!ceo && company && companyToCeo.has(company.toLowerCase())) ceo = companyToCeo.get(company.toLowerCase());
    out.push({
      date, ceo, company,
      theme: String(r.theme||'None'),
      total: +(r.total||0),
      positive: +(r.positive||0),
      neutral: +(r.neutral||0),
      negative: +(r.negative||0),
    });
  }
  allCountsRows = out;
  dates = Array.from(new Set(out.map(x=>x.date))).filter(isISODate).sort();
}

/* ========= Merge table rows using nearest SERP date ≤ selected ========= */
function mergeForDate(date){
  const perCeoNews = allCountsRows.filter(r=>r.date===date);

  // Index SERP by date/ceo/company
  const serpDates = Array.from(new Set(serpDaily.map(r=>r.date))).filter(isISODate).sort();
  const serpByDateKey = new Map();
  for(const r of serpDaily){
    const k = `${r.date}\u0001${r.ceo||''}\u0001${r.company||''}`;
    serpByDateKey.set(k, { total:r.total, controlled:r.controlled, negative_serp:r.negative_serp });
  }
  function nearestSerpDate(d){
    const n = serpDates.filter(x=>x<=d).pop();
    return n || serpDates[serpDates.length-1] || null;
  }
  const useDate = nearestSerpDate(date);

  const rows = [];
  for(const r of perCeoNews){
    let s = { total:0, controlled:0, negative_serp:0 };
    if(useDate){
      const kExact = `${useDate}\u0001${r.ceo||''}\u0001${r.company||''}`;
      const kCeoOnly = `${useDate}\u0001${r.ceo||''}\u0001`;
      s = serpByDateKey.get(kExact) || serpByDateKey.get(kCeoOnly) || s;
    }
    const negNewsPct = pct(r.negative, r.total);
    const negSerpPct = pct(s.negative_serp, s.total);
    const ctrlPct    = pct(s.controlled, s.total);
    const risk = computeRisk(negNewsPct, negSerpPct, ctrlPct);
    rows.push({ ceo:r.ceo, company:r.company, theme:r.theme, date:r.date,
                negNewsPct, negSerpPct, ctrlPct, risk, totals:{news:r.total, serp:s.total} });
  }
  return rows;
}
function computeRisk(negNewsPct, negSerpPct, controlPct){
  if(negSerpPct >= 50 || negNewsPct >= 50) return 'High';
  if(negSerpPct >= 30 || negNewsPct >= 30 || controlPct < 50) return 'Medium';
  return 'Low';
}

/* =================== Rendering =================== */
function applyFilterSortPaginate(){
  const q = ($('#filterInput').value||'').trim().toLowerCase();
  let rows = mergeForDate(currentDate);
  if(q){ rows = rows.filter(r => (r.ceo||'').toLowerCase().includes(q) || (r.company||'').toLowerCase().includes(q)); }
  rows.sort((a,b)=>{
    const dir = (sortDir==='asc')?1:-1;
    if(sortKey==='risk'){
      const order = {High:3, Medium:2, Low:1};
      return dir * ((order[a.risk]||0) - (order[b.risk]||0));
    }
    const av = sortKey==='negNews'?a.negNewsPct : (sortKey==='negSerp'?a.negSerpPct : a.ctrlPct);
    const bv = sortKey==='negNews'?b.negNewsPct : (sortKey==='negSerp'?b.negSerpPct : b.ctrlPct);
    return dir * (av - bv);
  });
  filteredRows = rows;
  $('#rowCount').textContent = `${rows.length.toLocaleString()} rows`;
  renderPage(1);
}
function renderPage(page){
  currentPage = page;
  const start = (page-1)*pageSize;
  const slice = filteredRows.slice(start, start+pageSize);
  const tbody = $('#tableBody'); tbody.innerHTML = '';
  for(const r of slice){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="center"><input type="checkbox" class="checkbox" data-ceo="${r.ceo.replace(/"/g,'&quot;')}" /></td>
      <td>${r.ceo||''}</td>
      <td>${r.company||''}</td>
      <td class="muted">${r.theme||''}</td>
      <td class="right">${formatPct(r.negNewsPct)}%</td>
      <td class="right">${formatPct(r.negSerpPct)}%</td>
      <td class="right">${formatPct(r.ctrlPct)}%</td>
      <td class="center">${
        r.risk==='High'?'<span class="pill high">High</span>':
        r.risk==='Medium'?'<span class="pill med">Medium</span>':'<span class="pill low">Low</span>'}</td>
      <td class="center"><button data-action="headlines" data-ceo="${r.ceo}" data-date="${r.date}">View</button></td>
      <td class="center"><button data-action="serp" data-ceo="${r.ceo}" data-date="${r.date}">View</button></td>
      <td class="center"><button data-action="boards" data-ceo="${r.ceo}">View</button></td>`;
    tbody.appendChild(tr);
  }
  // Single-select checkboxes
  tbody.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
    cb.checked = selected.has(cb.dataset.ceo);
    cb.addEventListener('change',()=>{
      if(cb.checked){
        selected.clear();
        tbody.querySelectorAll('input[type="checkbox"]').forEach(x=>{ if(x!==cb) x.checked=false; });
        selected.add(cb.dataset.ceo);
      } else { selected.delete(cb.dataset.ceo); }
      drawNewsTrend();
      drawSerpTrend();
    });
  });
  // Buttons
  tbody.querySelectorAll('button[data-action]').forEach(btn=>{
    btn.addEventListener('click',()=>openModal(btn.dataset.action, btn.dataset.ceo, btn.dataset.date));
  });

  const pages = Math.max(1, Math.ceil(filteredRows.length/pageSize));
  $('#pageInfo').textContent = `Page ${currentPage} / ${pages}`;
  $('#prevPage').disabled = currentPage<=1;
  $('#nextPage').disabled = currentPage>=pages;
}

/* =================== Charts =================== */
function drawNewsTrend(){
  const ctx = $('#newsTrend').getContext('2d');
  if(newsChart){ newsChart.destroy(); newsChart=null; }
  const selectedCeo = selected.size ? Array.from(selected)[0] : null;
  const byDate = new Map();
  for(const r of allCountsRows){
    if(selectedCeo && r.ceo!==selectedCeo) continue;
    const v = byDate.get(r.date)||{pos:0,neu:0,neg:0,total:0};
    v.pos+=+r.positive; v.neu+=+r.neutral; v.neg+=+r.negative; v.total+=+r.total;
    byDate.set(r.date,v);
  }
  const labels = Array.from(byDate.keys()).filter(isISODate).sort();
  const L = labels.length, s = Math.max(0, L-30), labs = labels.slice(s);
  if(!labs.length) return;
  const pos = labs.map(d=>{const v=byDate.get(d);return +(pct(v.pos,v.total)).toFixed(1)});
  const neu = labs.map(d=>{const v=byDate.get(d);return +(pct(v.neu,v.total)).toFixed(1)});
  const neg = labs.map(d=>{const v=byDate.get(d);return +(pct(v.neg,v.total)).toFixed(1)});
  newsChart = new Chart(ctx,{
    type:'bar',
    data:{labels:labs,datasets:[
      {label:'Positive %',data:pos,stack:'s'},
      {label:'Neutral %', data:neu,stack:'s'},
      {label:'Negative %',data:neg,stack:'s'}]},
    options:{responsive:true,animation:false,scales:{y:{suggestedMax:100,ticks:{callback:v=>v+'%'}}},plugins:{legend:{position:'bottom'}}}
  });
}
function computeSerpSeries(selectedCeo){
  const byDate = new Map();
  for(const r of serpDaily){
    if(selectedCeo && r.ceo!==selectedCeo) continue;
    const total = Math.max(1, r.total|0);
    const neg = r.negative_serp/total*100;
    const ctrl= r.controlled/total*100;
    const cur = byDate.get(r.date)||{neg:0,ctrl:0,n:0};
    byDate.set(r.date,{neg:cur.neg+neg,ctrl:cur.ctrl+ctrl,n:cur.n+1});
  }
  const labels = Array.from(byDate.keys()).filter(isISODate).sort();
  const L = labels.length, s = Math.max(0,L-30);
  return {
    labels: labels.slice(s),
    neg: labels.slice(s).map(d=>{const v=byDate.get(d);return v.n?+(v.neg/v.n).toFixed(1):0;}),
    ctrl:labels.slice(s).map(d=>{const v=byDate.get(d);return v.n?+(v.ctrl/v.n).toFixed(1):0;})
  };
}
function drawSerpTrend(){
  const canvas = $('#serpTrend'); if(!canvas) return;
  if(serpTrendChart){ serpTrendChart.destroy(); serpTrendChart=null; }
  const selectedCeo = selected.size ? Array.from(selected)[0] : null;
  const {labels,neg,ctrl} = computeSerpSeries(selectedCeo);
  if(!labels.length) return;
  const ctx = canvas.getContext('2d');
  serpTrendChart = new Chart(ctx,{
    type:'line',
    data:{labels,datasets:[
      {label:'Negative SERP %',data:neg,tension:.25,pointRadius:0},
      {label:'SERP Control %',data:ctrl,tension:.25,pointRadius:0}]},
    options:{responsive:true,animation:false,
      scales:{y:{suggestedMin:0,suggestedMax:100,ticks:{callback:v=>v+'%'}}},
      plugins:{legend:{position:'bottom'},tooltip:{callbacks:{label:c=>`${c.dataset.label}: ${c.parsed.y}%`}}}}
  });
}

/* =================== Modals =================== */
async function showHeadlines(ceo, date){
  const c = document.getElementById('modalContent');
  try{
    const files = [
      `data_ceos/articles/${date}-articles.csv`,
      `data/articles/${date}-articles.csv`,
      `data/articles/${date}.csv`,
    ];
    const rows = await fetchCsvAny(files);
    if (!rows.length){
      c.innerHTML = `<div class="muted">No article file found for ${date}.</div>`;
      return;
    }
    const norm = r => ({
      ceo: String(r.ceo||r.CEO||'').trim(),
      title: String(r.title||r.headline||'').trim(),
      url: String(r.url||r.link||'').trim(),
      pub: String(r.source||r.publisher||r.site||'').trim(),
      sent: String(r.sentiment||r.sentiment_label||'').toLowerCase().trim()
    });
    const filtered = rows.map(norm).filter(r => r.ceo === ceo);
    if (!filtered.length){
      c.innerHTML = `<div class="muted">No headlines for ${ceo} on ${date}.</div>`;
      return;
    }
    const items = filtered.map(r=>{
      const kind = r.sent.startsWith('neg') ? 'neg' : r.sent.startsWith('pos') ? 'pos' : 'neu';
      const pub = r.pub ? `<span class="muted"> — ${r.pub}</span>` : '';
      const link = r.url ? `<a href="${r.url}" target="_blank" rel="noopener">${r.title || '(untitled)'}</a>` : (r.title || '(untitled)');
      return `<li style="margin:8px 0">${link}${badge(r.sent || 'neutral', kind)}${pub}</li>`;
    });
    c.innerHTML = `<ul style="padding-left:18px;margin:0">${items.join('')}</ul>`;
  }catch(err){
    console.error('showHeadlines error:', err);
    c.innerHTML = `<div class="muted">Could not load headlines (${date}).</div>`;
  }
}
async function showSerps(ceo, company, date){
  const c = document.getElementById('modalContent');
  try{
    // Find nearest available processed date <= requested
    const available = Array.from(new Set(serpDaily.map(r => r.date))).filter(isISODate).sort();
    const chosen = available.filter(d => d <= date).pop() || available[available.length - 1];
    if (!chosen){
      c.innerHTML = '<div class="muted">No processed SERP data available yet.</div>';
      return;
    }
    const url = `data_ceos/serp_rows/${chosen}-ceo-serps-rows.csv`;
    const rows = await fetchCsv(url);

    const norm = r => ({
      ceo: String(r.ceo||'').trim(),
      company: String(r.company||'').trim(),
      title: String(r.title||'').trim(),
      url: String(r.url||'').trim(),
      pos: Number(r.position||'') || '',
      sent: String(r.sentiment||'').toLowerCase().trim(),
      ctrl: String(r.controlled||'').toString().toLowerCase().trim()
    });

    let filtered = rows.map(norm).filter(r => r.ceo === ceo);
    if (company){
      const exact = filtered.filter(r => r.company === company);
      if (exact.length) filtered = exact;
    }
    if (!filtered.length){
      c.innerHTML = `<div class="muted">No SERP rows for “${ceo}${company?` ${company}`:''}” on ${chosen}.</div>`;
      return;
    }

    const total = filtered.length;
    const neg = filtered.filter(r=>r.sent.startsWith('neg')).length;
    const ctrl = filtered.filter(r=>['1','true','yes','y','controlled'].includes(r.ctrl)).length;

    const head = `
      <thead><tr>
        <th style="text-align:right;padding:6px 8px;width:60px">Pos</th>
        <th style="text-align:left;padding:6px 8px">Title</th>
        <th style="text-align:left;padding:6px 8px">URL</th>
        <th style="text-align:center;padding:6px 8px">Sentiment</th>
        <th style="text-align:center;padding:6px 8px">Control</th>
      </tr></thead>`;
    const rowsHtml = filtered
      .sort((a,b)=>(a.pos||999)-(b.pos||999))
      .slice(0,50)
      .map(r=>{
        const kind = r.sent.startsWith('neg')?'neg':r.sent.startsWith('pos')?'pos':'neu';
        const ctrlTxt = ['1','true','yes','y','controlled'].includes(r.ctrl) ? 'Controlled' : 'Uncontrolled';
        const t = r.title || '(no title)';
        const link = r.url ? `<a href="${r.url}" target="_blank" rel="noopener">${t}</a>` : t;
        return `<tr>
          <td style="text-align:right;padding:6px 8px">${r.pos}</td>
          <td style="padding:6px 8px">${link}</td>
          <td style="padding:6px 8px"><span class="muted">${r.url||''}</span></td>
          <td style="text-align:center;padding:6px 8px">${badge(r.sent || 'neutral', kind)}</td>
          <td style="text-align:center;padding:6px 8px">${ctrlTxt}</td>
        </tr>`;
      }).join('');
    const summary = `<div class="muted" style="margin:0 0 8px 0">${total} results — ${neg} negative — ${ctrl} controlled (showing ${chosen})</div>`;
    c.innerHTML = summary + `<div style="overflow:auto;max-height:60vh;border:1px solid #23314d;border-radius:12px">
      <table style="width:100%;border-collapse:collapse">${head}<tbody>${rowsHtml}</tbody></table>
    </div>`;
  }catch(err){
    console.error('showSerps error:', err);
    c.innerHTML = `<div class="muted">Could not load processed SERPs.</div>`;
  }
}
async function openModal(kind, ceo, date){
  const box = document.getElementById('modalContent');
  const title = (kind.charAt(0).toUpperCase()+kind.slice(1)) + (ceo ? ` — ${ceo}` : '');
  document.getElementById('modalTitle').textContent = title;
  box.innerHTML = 'Loading…';
  document.getElementById('modal').style.display = 'flex';

  try{
    if (kind === 'boards'){
      let boards = boardsByCeo.get(ceo) || [];
      if (!boards.length) {
        const key = Array.from(boardsByCeo.keys()).find(k => k.toLowerCase() === ceo.toLowerCase());
        if (key) boards = boardsByCeo.get(key) || [];
      }
      if (!boards.length){ box.innerHTML = '<div class="muted">No boards found.</div>'; return; }
      box.innerHTML = '<ul style="padding-left:18px;margin:0">' +
        boards.map(b => {
          const text = b.domain || (b.url ? new URL(b.url).hostname.replace(/^www\./,'') : 'Board');
          const href = b.url || '#';
          return `<li style="margin:6px 0"><a href="${href}" target="_blank" rel="noopener">${text}</a></li>`;
        }).join('') +
      '</ul>';
      return;
    }

    if (kind === 'headlines'){
      const d = date || currentDate;
      await showHeadlines(ceo, d);
      return;
    }

    if (kind === 'serp'){
      let company = '';
      const match = filteredRows.find(r => r.ceo === ceo);
      if (match) company = match.company || '';
      const d = date || currentDate;
      await showSerps(ceo, company, d);
      return;
    }
  }catch(err){
    console.error('openModal error:', err);
    box.innerHTML = `<div class="muted">Something went wrong loading this view.</div>`;
  }
}

/* =================== Events / init =================== */
document.getElementById('modalClose').addEventListener('click', ()=>{ document.getElementById('modal').style.display='none'; });
document.getElementById('modal').addEventListener('click', (e)=>{ if(e.target && e.target.id==='modal'){ document.getElementById('modal').style.display='none'; } });

async function init(){
  await Promise.all([loadRoster(), loadBoards(), loadSerpsDaily()]);
  await loadCounts();
  // date picker
  const dp = $('#datePicker');
  dp.innerHTML = dates.map(d=>`<option value="${d}">${d}</option>`).join('');
  const requested = currentDate || dates[dates.length-1];
  currentDate = pickAvailableDate(requested, dates);
  dp.value = currentDate; showDateNotice(currentDate, requested);

  applyFilterSortPaginate();
  drawNewsTrend();
  drawSerpTrend();
}

$('#datePicker').addEventListener('change', e=>{
  const requested = e.target.value;
  currentDate = pickAvailableDate(requested, dates);
  showDateNotice(currentDate, requested);
  applyFilterSortPaginate(); drawNewsTrend(); drawSerpTrend();
});
$('#filterInput').addEventListener('input', ()=>{ applyFilterSortPaginate(); });
$('#prevPage').addEventListener('click', ()=>{ if(currentPage>1) renderPage(currentPage-1); });
$('#nextPage').addEventListener('click', ()=>{ const pages=Math.max(1,Math.ceil(filteredRows.length/pageSize)); if(currentPage<pages) renderPage(currentPage+1); });
$('#clearBtn').addEventListener('click', ()=>{ selected.clear(); document.querySelectorAll('input[type="checkbox"]').forEach(x=> x.checked=false); drawNewsTrend(); drawSerpTrend(); });
$('#refreshBtn').addEventListener('click', async ()=>{
  await Promise.all([loadRoster(), loadBoards(), loadSerpsDaily()]);
  await loadCounts();
  dates = Array.from(new Set(allCountsRows.map(x=>x.date))).filter(isISODate).sort();
  const dp = $('#datePicker'); dp.innerHTML = dates.map(d=>`<option value="${d}">${d}</option>`).join('');
  currentDate = pickAvailableDate(currentDate, dates); dp.value = currentDate;
  applyFilterSortPaginate(); drawNewsTrend(); drawSerpTrend();
});

// Column sorting
Array.from(document.querySelectorAll('th.sortable')).forEach(th=>{
  th.style.cursor='pointer';
  th.addEventListener('click', ()=>{
    const keyMap={negNews:'negNews',negSerp:'negSerp',ctrl:'ctrl',risk:'risk'};
    const key = keyMap[th.dataset.sort]||'negSerp';
    if(sortKey===key){ sortDir = (sortDir==='asc'?'desc':'asc'); } else { sortKey=key; sortDir='desc'; }
    applyFilterSortPaginate();
  });
});

init();
</script>
</body>
</html>
