<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CEO Risk Dashboard</title>

<!-- Chart.js & PapaParse -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>

<style>
  :root{
    --bg:#0f141a;          /* page */
    --card:#0f1a24;        /* panels */
    --muted:#9bb3c4;       /* secondary text */
    --text:#e8f1f7;        /* primary text */
    --accent:#58dbed;      /* ui accents */
    --pill-neg:#ff8261;
    --pill-pos:#82c616;
    --pill-neu:#ffc32e;
    --pill-ctrl:#58dbed;
    --pill-unctrl:#ffd08f;
    --border:#17223a;
  }
  *{ box-sizing:border-box }
  body{
    margin:0; padding:24px;
    background:var(--bg); color:var(--text);
    font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  }
  h1{ margin:0 0 18px; font-size:28px; font-weight:700 }

  .controls{
    display:grid;
    grid-template-columns: 220px 1fr;
    gap:12px;
    margin-bottom:14px;
  }
  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:12px;
    box-shadow:0 8px 24px rgba(0,0,0,.25);
  }
  .field{
    position:relative;
    background:var(--card);
    border:1px solid var(--border);
    border-radius:10px;
    padding:8px 12px;
    color:var(--text);
  }
  select, input[type="text"]{
    appearance:none; -webkit-appearance:none;
    width:100%; background:transparent; border:0; outline:0; color:var(--text);
    font:14px/1.5 inherit;
  }

  /* Chart sizing guards (fixes “ever-growing” canvas) */
  .chartbox{
    position:relative; width:100%; height:280px;
    border-radius:12px; overflow:hidden;
  }
  @media (max-width: 980px){ .chartbox{ height:240px } }
  .chartbox > canvas{
    display:block; width:100% !important; height:100% !important;
  }

  .pad{ padding:16px 16px 10px 16px }
  .pad-tight{ padding:10px 16px 14px 16px }

  /* Table */
  table{ width:100%; border-collapse:collapse }
  thead th{
    font-weight:600; font-size:12px; color:var(--muted); text-align:left;
    padding:10px 12px; border-bottom:1px solid var(--border);
    white-space:nowrap;
  }
  tbody td{
    padding:10px 12px; border-bottom:1px solid var(--border); vertical-align:middle;
  }
  .checkbox-cell{ width:36px }
  .btn{
    background:transparent; border:1px solid var(--accent); color:var(--text);
    border-radius:10px; padding:6px 10px; font-weight:600; cursor:pointer;
  }
  .btn:hover{ box-shadow:0 0 0 3px rgba(88,219,237,.2) inset }
  .pill{
    display:inline-block; padding:3px 8px; border-radius:999px; font-size:12px; font-weight:700;
  }
  .pill.neg  { background:rgba(255,130,97,.15);  color:var(--pill-neg) }
  .pill.pos  { background:rgba(130,198,22,.18);  color:var(--pill-pos) }
  .pill.neu  { background:rgba(255,195,46,.16);  color:var(--pill-neu) }
  .pill.ctrl { background:rgba(88,219,237,.18);  color:var(--pill-ctrl) }
  .pill.un   { background:rgba(255,208,143,.16); color:var(--pill-unctrl) }

  .footer-row{
    display:flex; justify-content:flex-end; gap:10px; padding:10px 16px;
  }

  /* Modal (SERP) */
  .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; }
  .modal.show{ display:flex }
  .modal .backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.5) }
  .modal .panel{
    position:relative; z-index:1; width:min(980px, 94vw); max-height:86vh; overflow:auto;
    border-radius:14px; background:var(--card); border:1px solid var(--border);
    box-shadow:0 24px 80px rgba(0,0,0,.45);
  }
  .modal header{ display:flex; justify-content:space-between; align-items:center;
    padding:14px 16px; border-bottom:1px solid var(--border) }
  .modal .content{ padding:14px 16px }
  .close{ background:#122030; color:var(--text); border:1px solid var(--border);
    border-radius:10px; padding:6px 10px; cursor:pointer; font-weight:600 }

  .serp-item{ padding:12px 0; border-bottom:1px solid var(--border) }
  .serp-domain{ font-size:12px; color:var(--muted); margin-bottom:4px }
  .serp-title{ font-weight:700; color:var(--accent); text-decoration:none }
  .serp-snippet{ color:var(--muted); margin-top:6px }
  .row-top{ display:flex; flex-wrap:wrap; gap:12px; align-items:center; margin-bottom:8px }
</style>
</head>
<body>
  <h1>CEO Risk Dashboard</h1>

  <!-- Controls (buttons removed) -->
  <div class="controls">
    <div class="field">
      <select id="dateSelect" aria-label="Date"></select>
    </div>
    <div class="field">
      <input id="filterInput" type="text" placeholder="Type to filter…" aria-label="Filter (CEO or Company)" />
    </div>
  </div>

  <!-- News sentiment (percent stacked) -->
  <div class="card pad">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <strong>News sentiment (percent of articles)</strong>
      <div id="legendNews" style="font-size:12px;"></div>
    </div>
    <div class="chartbox"><canvas id="newsChart"></canvas></div>
  </div>

  <!-- SERP lines -->
  <div class="card pad" style="margin-top:12px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <strong>SERP (Negative % • Control %)</strong>
      <div id="legendSerp" style="font-size:12px;"></div>
    </div>
    <div class="chartbox"><canvas id="serpChart"></canvas></div>
  </div>

  <!-- Table -->
  <div class="card" style="margin-top:14px;">
    <div class="pad-tight" style="padding-bottom:6px;color:var(--muted);font-weight:600;">
      Select exactly one CEO using the checkbox to see brand-level charts. Selecting another will automatically unselect the previous one.
    </div>
    <div class="pad-tight" style="padding-top:0;">
      <table id="ceoTable">
        <thead>
          <tr>
            <th class="checkbox-cell"></th>
            <th>CEO</th>
            <th>Company</th>
            <th>Negative News % ▲▼</th>
            <th>Negative SERP % ▲▼</th>
            <th>SERP Control % ▲▼</th>
            <th>Risk ▲▼</th>
            <th>Headlines</th>
            <th>SERP</th>
            <th>Boards</th>
          </tr>
        </thead>
        <tbody id="ceoTbody"></tbody>
      </table>
    </div>
    <div class="footer-row">
      <div id="pageInfo" style="color:var(--muted)"></div>
      <div style="flex:1"></div>
      <button class="btn" id="prevPage">Prev</button>
      <button class="btn" id="nextPage">Next</button>
    </div>
  </div>

  <!-- SERP Modal (unchanged behavior) -->
  <div class="modal" id="serpModal" aria-hidden="true">
    <div class="backdrop" data-close></div>
    <div class="panel">
      <header>
        <div id="serpTitle" style="font-weight:800">SERP</div>
        <button class="close" data-close>Close</button>
      </header>
      <div class="content">
        <div class="row-top" id="serpStats"></div>
        <div id="serpList"></div>
      </div>
    </div>
  </div>

<script>
/* ==============================
   Config / paths
============================== */
const COUNTS_CANDIDATES = [
  'data_ceos/daily_counts.csv',     // preferred
  'data/serps/daily_counts.csv',
  'data/daily_counts.csv'
];
const SERPS_DAILY_CSV = 'data/serps/ceo_serps_daily.csv';
const BOARDS_CSV      = 'data/serps/ceo_boards.csv';
const ARTICLES_DIR    = 'data_ceos/articles';
const DAILY_DIR       = 'data_ceos';
const PROCESSED_DIR   = 'data_ceos/processed_serps';    // processed SERP (counts)

/* Runtime */
let rosterMap = new Map();      // CEO -> Company (built from the day file)
let allCountsRows = [];         // rows from daily_counts (for all dates)
let serpDaily = [];             // per-date SERP aggregates (for date select)
let boardsByCeo = new Map();    // CEO -> [{domain,url}]
let filteredRows = [];          // table rows for current date after filter
let selectedCeo = '';           // single-select for brand charts
let currentDate = '';           // string YYYY-MM-DD
let currentPage = 1;
const PAGE_SIZE = 25;

const $ = sel => document.querySelector(sel);

const isISODate = s => /^\d{4}-\d{2}-\d{2}$/.test(String(s||'').trim());

/* ==============================
   CSV helpers
============================== */
async function fetchCsv(url){
  const r = await fetch(url, {cache:'no-store'});
  if (!r.ok) throw new Error(`HTTP ${r.status} for ${url}`);
  const t = await r.text();
  return await new Promise((res, rej)=>{
    Papa.parse(t, { header:true, skipEmptyLines:true,
      complete: out => res(out.data || []),
      error: err => rej(err)
    });
  });
}
async function fetchCsvAny(candidates){
  for (const u of candidates){
    try{
      const rows = await fetchCsv(u);
      if (Array.isArray(rows)) return rows;
    }catch(e){}
  }
  return [];
}

/* ==============================
   Data loads
============================== */
async function loadBoards(){
  try{
    const rows = await fetchCsv(BOARDS_CSV);
    boardsByCeo = new Map();
    rows.forEach(r=>{
      const ceo = String(r.CEO || r.ceo || '').trim();
      if (!ceo) return;
      const url = String(r.URL || r.url || '').trim();
      const domain = (new URL(url)).hostname.replace(/^www\./,'');
      const arr = boardsByCeo.get(ceo) || [];
      arr.push({domain, url});
      boardsByCeo.set(ceo, arr);
    });
  }catch(e){ boardsByCeo = new Map(); }
}

async function loadCounts(){
  // fallback chain for daily_counts
  const rows = await fetchCsvAny(COUNTS_CANDIDATES);
  // Normalize + keep only rows with date
  const norm = rows.map(r=>({
    date:String(r.date || r.Date || '').trim(),
    ceo:String(r.ceo || r.CEO || '').trim(),
    company:String(r.company || r.Company || '').trim(),
    neg_pct: Number(String(r.neg_pct || r['neg pct'] || r['neg_pct']||0).toString().replace('%','')) || 0
  })).filter(r=>isISODate(r.date) && r.ceo);

  allCountsRows = norm;

  // Build roster for the currently visible date later
  return norm;
}

async function loadSerpDaily(){
  try{
    const rows = await fetchCsv(SERPS_DAILY_CSV);
    serpDaily = rows.map(r=>({
      date:String(r.date || r.Date || '').trim()
    })).filter(r=>isISODate(r.date));
  }catch(e){ serpDaily = []; }
}

/* ==============================
   Date bootstrap
============================== */
async function initDatesAndRender(){
  const dateSel = $('#dateSelect');
  if (dateSel) dateSel.innerHTML = '<option>Loading…</option>';

  await Promise.all([loadCounts(), loadSerpDaily(), loadBoards()]);

  // build unique list from: available SERP daily + available counts
  const dates = [...new Set([
    ...serpDaily.map(r=>r.date),
    ...allCountsRows.map(r=>r.date)
  ])].filter(isISODate).sort();

  if (!dates.length){
    if (dateSel) dateSel.innerHTML = '<option value="">No dates</option>';
    console.warn('No valid dates found.');
    return;
  }

  if (dateSel){
    dateSel.innerHTML = dates.map(d=>`<option value="${d}">${d}</option>`).join('');
  }

  // default to the latest date (right-most)
  currentDate = dates[dates.length-1];
  dateSel.value = currentDate;

  // wire events
  dateSel.addEventListener('change', e=>{
    currentDate = e.target.value;
    currentPage = 1;
    renderAll();
  });
  $('#filterInput').addEventListener('input', ()=>{
    currentPage = 1;
    renderAll();
  });

  // first render
  renderAll();
}

/* ==============================
   Render (table + charts)
============================== */
function computeRisk(negSerp, ctrlPct){
  // Simple rule
  if (negSerp >= 40 || ctrlPct < 25) return 'High';
  if (negSerp >= 25 || ctrlPct < 50) return 'Medium';
  return 'Low';
}
function fmtPct(v){
  if (v===null || v===undefined || Number.isNaN(v)) return 'N/A';
  return `${(Math.round((v + Number.EPSILON)*10)/10).toFixed(1)}%`.replace('.0%','%');
}

function computeTableRowsForDate(dateStr){
  const filterText = $('#filterInput').value.trim().toLowerCase();

  // Build roster (CEO->Company) for this date from counts file
  const countsForDate = allCountsRows.filter(r=>r.date===dateStr);
  rosterMap = new Map();
  countsForDate.forEach(r=>{
    if (r.ceo) rosterMap.set(r.ceo, r.company);
  });

  // Daily counts (news) -> neg_pct
  const newsPctByCeo = new Map();
  countsForDate.forEach(r=>{
    newsPctByCeo.set(r.ceo, Number(r.neg_pct)||0);
  });

  // Processed SERP counts -> % (fallback N/A)
  // Try to load processed file if exists in memory? We fetch on demand per date.
  const rows = [];
  const makeRow = (ceo, company, negNews, negSerp, ctrlPct) => {
    const risk = computeRisk(negSerp ?? 0, ctrlPct ?? 0);
    return { ceo, company, negNews, negSerp, ctrlPct, risk };
  };

  const uniqueCeo = [...rosterMap.keys()];
  uniqueCeo.forEach(ceo=>{
    if (filterText && !(ceo.toLowerCase().includes(filterText) || (rosterMap.get(ceo)||'').toLowerCase().includes(filterText))) return;
    rows.push(makeRow(ceo, rosterMap.get(ceo)||'', newsPctByCeo.get(ceo) ?? 0, null, null));
  });

  return rows;
}

async function hydrateSerpPercentsIntoRows(rows, dateStr){
  // Try: data_ceos/processed_serps/YYYY-MM-DD-ceo-serps-processed.csv
  const url = `${PROCESSED_DIR}/${dateStr}-ceo-serps-processed.csv`;
  let map = new Map(); // ceo -> {negPct, ctrlPct}
  try{
    const srows = await fetchCsv(url);
    srows.forEach(r=>{
      const ceo = String(r.ceo || r.CEO || '').trim();
      if (!ceo) return;
      const total = Number(r.total||0) || 0;
      const negative_serp = Number(r.negative_serp||0) || 0;
      const controlled = Number(r.controlled||0) || 0;
      const negPct = total ? (negative_serp / total) * 100 : null;
      const ctrlPct = total ? (controlled / total) * 100 : null;
      map.set(ceo, {negPct, ctrlPct});
    });
  }catch(e){
    // leave map empty -> rows retain N/A
  }

  rows.forEach(row=>{
    const hit = map.get(row.ceo);
    if (hit){
      row.negSerp = hit.negPct;
      row.ctrlPct = hit.ctrlPct;
    }
  });
}

function applySort(rows){
  // Default sort: none (keep natural)
  // You can wire header clicks if desired; for now keep as-is.
  return rows;
}

function renderTable(rows){
  const tbody = $('#ceoTbody');
  tbody.innerHTML = '';

  const start = (currentPage-1)*PAGE_SIZE;
  const slice = rows.slice(start, start+PAGE_SIZE);

  slice.forEach((r, idx)=>{
    const tr = document.createElement('tr');

    // checkbox
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.name = 'rowselect';
    cb.addEventListener('change', e=>{
      // single-select: uncheck the others
      document.querySelectorAll('input[name="rowselect"]').forEach(x=>{ if (x!==cb) x.checked=false; });
      selectedCeo = e.target.checked ? r.ceo : '';
      renderCharts(); // refresh brand-level lines when selection changes
    });
    const td0 = document.createElement('td'); td0.className='checkbox-cell'; td0.append(cb);

    const td1 = document.createElement('td'); td1.textContent = r.ceo;
    const td2 = document.createElement('td'); td2.textContent = r.company;

    const td3 = document.createElement('td'); td3.textContent = fmtPct(r.negNews);
    const td4 = document.createElement('td'); td4.textContent = fmtPct(r.negSerp);
    const td5 = document.createElement('td'); td5.textContent = fmtPct(r.ctrlPct);

    const td6 = document.createElement('td');
    const riskPill = document.createElement('span');
    riskPill.className = 'pill ' + (r.risk==='High'?'neg':(r.risk==='Medium'?'neu':'pos'));
    riskPill.textContent = r.risk;
    td6.append(riskPill);

    const td7 = document.createElement('td');
    const bHead = document.createElement('button'); bHead.className='btn'; bHead.textContent='View';
    bHead.addEventListener('click', ()=> openHeadlines(r.ceo));
    td7.append(bHead);

    const td8 = document.createElement('td');
    const bSerp = document.createElement('button'); bSerp.className='btn'; bSerp.textContent='View';
    bSerp.addEventListener('click', ()=> openSerp(r.ceo));
    td8.append(bSerp);

    const td9 = document.createElement('td');
    const bBoard = document.createElement('button'); bBoard.className='btn'; bBoard.textContent='View';
    bBoard.addEventListener('click', ()=> openBoards(r.ceo));
    td9.append(bBoard);

    [td0,td1,td2,td3,td4,td5,td6,td7,td8,td9].forEach(td=>tr.append(td));
    tbody.append(tr);
  });

  // page info
  const pageInfo = $('#pageInfo');
  pageInfo.textContent = `Page ${currentPage} / ${Math.max(1, Math.ceil(rows.length/PAGE_SIZE))}`;
  $('#prevPage').onclick = ()=>{
    if (currentPage>1){ currentPage--; renderTable(rows); }
  };
  $('#nextPage').onclick = ()=>{
    const last = Math.max(1, Math.ceil(rows.length/PAGE_SIZE));
    if (currentPage<last){ currentPage++; renderTable(rows); }
  };
}

let newsChart, serpChart;

function renderCharts(){
  // Build dataset for news stacked % using today (or selected brand if any)
  // Simple percent‐stacked with one bar (or 3 days if you want trend).
  // Here we show only the current date percentages computed from articles file.
  // If a CEO is selected, show their article mix; else, total mix for day.
  drawNewsChart();   // uses currentDate + selectedCeo
  drawSerpChart();   // uses currentDate + selectedCeo
}

async function drawNewsChart(){
  // Load today's articles file to compute % mix
  // ARTICLES_DIR/YYYY-MM-DD-articles.csv (or your existing naming). If not present, fallback to counts file.
  let pos=0, neu=0, neg=0, total=0;

  try{
    const url = `${ARTICLES_DIR}/${currentDate}-articles.csv`;
    const rows = await fetchCsv(url);
    const rowsFiltered = selectedCeo
      ? rows.filter(r => (String(r.ceo||r.CEO||'').trim()===selectedCeo))
      : rows;

    rowsFiltered.forEach(r=>{
      const s = String(r.sentiment || r.Sentiment || '').toLowerCase();
      if (s==='positive') pos++;
      else if (s==='negative') neg++;
      else neu++;
    });
    total = pos+neu+neg;
  }catch(e){
    // Fallback: estimate from counts (neg_pct only)
    const dayRows = allCountsRows.filter(r=>r.date===currentDate && (!selectedCeo || r.ceo===selectedCeo));
    total = dayRows.length || 1;
    let negPctAvg = dayRows.length ? (dayRows.reduce((a,b)=>a+(Number(b.neg_pct)||0),0)/dayRows.length) : 0;
    neg = negPctAvg; // treat as % directly
    // split remainder between pos/neu (50/50 rough)
    const rem = 100 - neg;
    pos = rem*0.5; neu = rem*0.5;
  }

  const toPct = (n, d) => d ? (n/d*100) : n; // when already % keep value
  const data = total>1 ? [toPct(pos,total), toPct(neu,total), toPct(neg,total)] : [pos,neu,neg];

  const ctx = document.getElementById('newsChart').getContext('2d');
  if (newsChart) newsChart.destroy();
  newsChart = new Chart(ctx, {
    type:'bar',
    data:{
      labels:[''],
      datasets:[
        {label:'Positive %', data:[data[0]], backgroundColor:'#82c616'},
        {label:'Neutral %',  data:[data[1]], backgroundColor:'#ffc32e'},
        {label:'Negative %', data:[data[2]], backgroundColor:'#ff8261'}
      ]
    },
    options:{
      responsive:true, maintainAspectRatio:false, animation:false, resizeDelay:200,
      scales:{
        x:{ stacked:true, grid:{ display:false }, ticks:{ color:varMuted() } },
        y:{ stacked:true, min:0, max:100, ticks:{ color:varMuted(), callback:v=>v+'%' }, grid:{ color:'#1b2a3f' } }
      },
      plugins:{
        legend:{ labels:{ color: '#e8f1f7' } },
        tooltip:{ callbacks:{ label:(ctx)=>`${ctx.dataset.label}: ${ctx.parsed.y.toFixed(1)}%` } }
      }
    }
  });
}

async function drawSerpChart(){
  // If a CEO is selected, plot recent 3 dates for that CEO; else overall averages per date (3 dates)
  // Minimal viable: use current date values only as a flat line (or a single point).
  // For simplicity, plot the last 3 available dates from processed files (if any), else flat N/A.
  const labels = [];
  const negSeries = [];
  const ctrlSeries = [];

  // try last 3 dates from serpDaily (if empty, use [currentDate])
  const pool = serpDaily.length ? serpDaily.map(r=>r.date) : [currentDate];
  const last3 = pool.filter(isISODate).sort().slice(-3);

  for (const d of last3){
    labels.push(d);
    let negPct=null, ctrlPct=null;
    try{
      const url = `${PROCESSED_DIR}/${d}-ceo-serps-processed.csv`;
      const rows = await fetchCsv(url);
      let subset = rows;
      if (selectedCeo){
        subset = rows.filter(r=>String(r.ceo||'').trim()===selectedCeo);
      }
      const total = subset.reduce((a,b)=>a+(Number(b.total||0)||0),0);
      const neg   = subset.reduce((a,b)=>a+(Number(b.negative_serp||0)||0),0);
      const ctrl  = subset.reduce((a,b)=>a+(Number(b.controlled||0)||0),0);

      negPct  = total ? (neg/total)*100 : null;
      ctrlPct = total ? (ctrl/total)*100 : null;
    }catch(e){
      negPct=null; ctrlPct=null;
    }
    negSeries.push(negPct);
    ctrlSeries.push(ctrlPct);
  }

  const ctx = document.getElementById('serpChart').getContext('2d');
  if (serpChart) serpChart.destroy();
  serpChart = new Chart(ctx, {
    type:'line',
    data:{
      labels,
      datasets:[
        { label:'Negative SERP %', data:negSeries, borderWidth:2, tension:.3, pointRadius:3, borderColor:'#ff8261' },
        { label:'Control %',       data:ctrlSeries, borderWidth:2, tension:.3, pointRadius:3, borderColor:'#58dbed' }
      ]
    },
    options:{
      responsive:true, maintainAspectRatio:false, animation:false, resizeDelay:200,
      scales:{
        x:{ ticks:{ color:varMuted() }, grid:{ color:'#17223a' } },
        y:{ min:0, max:100, ticks:{ color:varMuted(), callback:v=>v+'%' }, grid:{ color:'#1b2a3f' } }
      },
      plugins:{
        legend:{ labels:{ color:'#e8f1f7' } },
        tooltip:{ callbacks:{ label:(ctx)=> `${ctx.dataset.label}: ${ctx.parsed.y==null?'N/A':ctx.parsed.y.toFixed(1)+'%'}` } }
      }
    }
  });
}

/* ==============================
   Headlines / SERP / Boards modals
   (SERP behavior preserved; headlines/boards simple)
============================== */
function closeModal(){ $('#serpModal').classList.remove('show'); $('#serpModal').setAttribute('aria-hidden','true'); }
document.querySelectorAll('[data-close]').forEach(el=>el.addEventListener('click', closeModal));
$('#serpModal')?.addEventListener('click', (e)=>{ if (e.target.dataset.close!==undefined || e.target.classList.contains('backdrop')) closeModal(); });

async function openSerp(ceo){
  const d = currentDate;
  $('#serpTitle').textContent = `SERP — ${ceo}`;
  $('#serpList').innerHTML = 'Loading…';
  $('#serpStats').innerHTML = '';

  // Load row list from data_ceos/serp_rows/yyyy-mm-dd-ceo-serps-rows.csv
  let rows = [];
  try{
    const url = `${DAILY_DIR}/serp_rows/${d}-ceo-serps-rows.csv`;
    const all = await fetchCsv(url);
    rows = all.filter(r => String(r.ceo||'').trim()===ceo);
  }catch(e){ rows = []; }

  // Top stats: Negative %, Control %, Risk
  let negPct=null, ctrlPct=null;
  try{
    const urlp = `${PROCESSED_DIR}/${d}-ceo-serps-processed.csv`;
    const p = await fetchCsv(urlp);
    const row = p.find(r=>String(r.ceo||'').trim()===ceo);
    if (row){
      const tot = Number(row.total||0)||0;
      const neg = Number(row.negative_serp||0)||0;
      const ctrl= Number(row.controlled||0)||0;
      negPct  = tot? (neg/tot)*100 : null;
      ctrlPct = tot? (ctrl/tot)*100 : null;
    }
  }catch(e){}

  const risk = computeRisk(negPct??0, ctrlPct??0);
  const statHtml = `
    <span>Negative SERP: <strong>${fmtPct(negPct)}</strong></span>
    <span>|</span>
    <span>Control: <strong>${fmtPct(ctrlPct)}</strong></span>
    <span>|</span>
    <span>Risk: <span class="pill ${risk==='High'?'neg':(risk==='Medium'?'neu':'pos')}">${risk}</span></span>
  `;
  $('#serpStats').innerHTML = statHtml;

  if (!rows.length){
    $('#serpList').innerHTML = `<div style="color:var(--muted)">No SERPs for ${ceo} on ${d}.</div>`;
  }else{
    $('#serpList').innerHTML = rows.map((r,i)=>{
      const title = (r.title||'').trim() || '(no title)';
      const url   = (r.url||'').trim() || '#';
      const dom   = (()=>{ try{return (new URL(url)).hostname.replace(/^www\./,'')}catch{return ''} })();
      const snip  = (r.snippet||'').trim();
      const sent  = String(r.sentiment||'').toLowerCase();
      const ctrl  = String(r.controlled||'').toLowerCase()==='true' ? 'controlled' : 'uncontrolled';
      const pillS = sent==='negative'?'neg':(sent==='positive'?'pos':'neu');
      const pillC = ctrl==='controlled'?'ctrl':'un';
      return `
        <div class="serp-item">
          <div class="serp-domain">${dom}</div>
          <a class="serp-title" href="${url}" target="_blank" rel="noopener">${title}</a>
          <div class="serp-snippet">${snip}</div>
          <div class="row-top" style="margin-top:8px">
            <span class="pill ${pillS}">${sent || 'neutral'}</span>
            <span class="pill ${pillC}">${ctrl}</span>
          </div>
        </div>
      `;
    }).join('');
  }

  $('#serpModal').classList.add('show');
  $('#serpModal').setAttribute('aria-hidden','false');
}

function openHeadlines(ceo){
  alert(`Headlines viewer will appear here for ${ceo} (date ${currentDate}).`);
}
function openBoards(ceo){
  const arr = boardsByCeo.get(ceo)||[];
  if (!arr.length){ alert(`No boards found for ${ceo}.`); return; }
  const lines = arr.map(b=>`${b.domain} — ${b.url}`).join('\n');
  alert(lines);
}

/* ==============================
   Overall render
============================== */
async function renderAll(){
  let rows = computeTableRowsForDate(currentDate);
  await hydrateSerpPercentsIntoRows(rows, currentDate);
  rows = applySort(rows);
  filteredRows = rows;
  renderTable(filteredRows);
  renderCharts();
}

/* Utils */
function varMuted(){ return getComputedStyle(document.documentElement).getPropertyValue('--muted') || '#9bb3c4'; }

/* Kickoff */
initDatesAndRender();
</script>
</body>
</html>
