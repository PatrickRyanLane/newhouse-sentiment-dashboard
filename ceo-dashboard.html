<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CEO News Sentiment Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-7xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-3xl font-bold">CEO News Sentiment Dashboard</h1>
      <p class="text-sm text-slate-600">Shows the top 25 Fortune 500 CEOs by negative article count for a selected day. Data source: <code>data_ceos/daily_counts.csv</code>.</p>
    </header>

    <!-- Controls -->
    <section class="mb-4 grid gap-3 md:grid-cols-3">
      <div>
        <label class="block text-sm font-medium mb-1">Pick date</label>
        <select id="dateSelect" class="w-full border rounded-lg p-2 bg-white"></select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Filter CEOs</label>
        <input id="brandFilter" type="text" placeholder="Type to filter…" class="w-full border rounded-lg p-2" />
      </div>
      <div class="flex items-end gap-2 w-full">
        <button id="refreshBtn" class="px-3 py-2 rounded-lg bg-slate-900 text-white">Refresh</button>
      </div>
    </section>

    <!-- Save / Display -->
    <section class="mb-6 p-4 border rounded-xl bg-white">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <h2 class="text-lg font-semibold">Save highlighted CEOs</h2>
        <div class="flex items-center gap-3">
          <span class="text-sm text-slate-600">Display</span>
          <div class="flex gap-1" role="group" aria-label="Display mode">
            <button id="modeCountsBtn" class="px-2 py-1 rounded-lg border bg-white" title="Show raw counts">Counts</button>
            <button id="modePercentBtn" class="px-2 py-1 rounded-lg border bg-white" title="Show percentages">%</button>
          </div>
        </div>
      </div>
      <div class="mt-3 flex items-center gap-3 flex-wrap">
        <button id="saveLocalBtn" class="px-3 py-2 rounded-lg bg-black hover:bg-black/90 text-white">Save selection (local)</button>
        <button id="exportCsvBtn" class="px-3 py-2 rounded-lg bg-black hover:bg-black/90 text-white">Download all data (CSV)</button>
      </div>
    </section>

    <!-- Trend charts -->
    <section class="mb-6 p-4 border rounded-xl bg-white">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-lg font-semibold">Sentiment trend</h2>
        <div class="flex items-center gap-2">
          <span id="trendInfo" class="text-xs text-slate-500"></span>
          <span id="trendRange" class="text-xs text-slate-500"></span>
          <button id="trendPrev" class="px-2 py-1 border rounded disabled:opacity-40" title="Older 30 days">←</button>
          <button id="trendNext" class="px-2 py-1 border rounded disabled:opacity-40" title="Newer 30 days">→</button>
        </div>
      </div>
      <p id="trendHint" class="text-sm text-slate-500 mb-2 hidden">Select exactly <span class="font-semibold">1</span> CEO to display a trend. When none is selected, the top negative CEO is shown by default.</p>

      <!-- Stacked bar -->
      <div class="h-64">
        <canvas id="trendChart"></canvas>
      </div>
      <!-- NSI -->
      <div class="mt-6 h-40">
        <canvas id="nsiChart"></canvas>
      </div>
      <!-- Δ Negative% -->
      <div class="mt-6 h-40">
        <canvas id="deltaNegChart"></canvas>
      </div>
    </section>

    <!-- Table -->
    <section class="overflow-x-auto">
      <table class="min-w-full text-sm bg-white rounded-xl overflow-hidden border">
        <thead class="bg-slate-100">
          <tr>
            <th class="p-3 text-left"><input type="checkbox" id="selectAll"></th>
            <th class="p-3 text-left">Rank</th>
            <th class="p-3 text-left">CEO</th>
            <th class="p-3 text-left">Company</th>
            <th id="thNeg" class="p-3 text-left">Negative (%)</th>
            <th id="thNeu" class="p-3 text-left">Neutral (%)</th>
            <th id="thPos" class="p-3 text-left">Positive (%)</th>
            <th class="p-3 text-left">Theme</th>
            <th class="p-3 text-left">Headlines</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
      <p id="status" class="text-xs text-slate-500 mt-2"></p>
    </section>

    <!-- Saved (local) -->
    <section class="mt-8">
      <h2 class="text-lg font-semibold mb-2">Saved (local) watchlist</h2>
      <div id="savedContainer" class="border rounded-xl bg-white p-4 text-sm">
        <p class="text-slate-600">No saved items yet.</p>
      </div>
    </section>
  </div>

  <!-- Drill-down Modal -->
  <div id="modalBackdrop" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-3xl bg-white rounded-2xl shadow-xl overflow-hidden">
        <div class="flex items-center justify-between p-4 border-b">
          <div>
            <h3 id="modalTitle" class="text-xl font-bold">Headlines</h3>
            <p id="modalSubtitle" class="text-sm text-slate-600"></p>
          </div>
          <button id="modalClose" class="px-3 py-1.5 rounded-lg border">Close</button>
        </div>
        <div id="modalBody" class="max-h-[70vh] overflow-y-auto p-4">
          <p class="text-sm text-slate-500">Loading…</p>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  // paths
  const CSV_COUNTS = 'data_ceos/daily_counts.csv';
  const GH_USER = 'jonas-sickler';
  const GH_REPO = 'news-sentiment-dashboard';
  const GH_PAGES_BASE = `https://${GH_USER}.github.io/${GH_REPO}/`;
  const CSV_ARTICLES = (date) => `data_ceos/articles/${date}.csv`;
  const ROWS_TO_SHOW = 25;

  // elements
  const tableBody=document.getElementById('tableBody');
  const modeCountsBtn=document.getElementById('modeCountsBtn');
  const modePercentBtn=document.getElementById('modePercentBtn');
  const dateSelect=document.getElementById('dateSelect');
  const brandFilter=document.getElementById('brandFilter');
  const statusEl=document.getElementById('status');
  const selectAll=document.getElementById('selectAll');
  const saveLocalBtn=document.getElementById('saveLocalBtn');
  const exportCsvBtn=document.getElementById('exportCsvBtn');

  const trendCanvas=document.getElementById('trendChart');
  const trendInfo=document.getElementById('trendInfo');
  const trendRange=document.getElementById('trendRange');
  const trendHint=document.getElementById('trendHint');
  const trendPrev=document.getElementById('trendPrev');
  const trendNext=document.getElementById('trendNext');
  const TREND_WINDOW=30;
  let trendChart=null, nsiChart=null, deltaNegChart=null;
  let trendBrand=null, trendPage=0;

  const modalBackdrop=document.getElementById('modalBackdrop');
  const modalTitle=document.getElementById('modalTitle');
  const modalSubtitle=document.getElementById('modalSubtitle');
  const modalBody=document.getElementById('modalBody');
  const modalClose=document.getElementById('modalClose');

  let allRows=[], currentRows=[], currentDate=null;
  let selected=new Set();
  let viewMode=localStorage.getItem('view_mode') || 'percent';
  const articlesCache={};

  // utils
  const formatInt=(x)=>Number(x||0);
  function fmtPct(part,total,dec=0){ const t=Number(total||0), p=Number(part||0); if(!t) return '0%'; const v=(p/t)*100; const s=v.toFixed(dec); return s.replace(/\.0+$/,'')+'%'; }
  function normalizeRowKeys(row){ const out={}; for(const k in row){ out[String(k||'').replace(/^\ufeff/,'').trim().toLowerCase()] = row[k]; } return out; }
  function getThemeFor(row){ return (row.theme && String(row.theme).trim().length) ? row.theme : 'None'; }
  function headerLabel(b){ return viewMode==='percent'? `${b} (%)` : b; }
  function updateHeaderLabels(){ thNeg.textContent=headerLabel('Negative'); thNeu.textContent=headerLabel('Neutral'); thPos.textContent=headerLabel('Positive'); }
  const thNeg=document.getElementById('thNeg'), thNeu=document.getElementById('thNeu'), thPos=document.getElementById('thPos');
  function updateModeButtons(){ const base='px-2 py-1 rounded-lg border'; modeCountsBtn.className=base+(viewMode==='counts'?' bg-slate-900 text-white':' bg-white'); modePercentBtn.className=base+(viewMode==='percent'?' bg-slate-900 text-white':' bg-white'); }
  function cellVal(part,total){ if(viewMode==='percent') return {val:fmtPct(part,total), title:`${part} of ${total}`}; const pct=fmtPct(part,total); return {val:String(part), title:`${pct} of ${total}`}; }
  function sentimentBadge(s){ const base='inline-block px-2 py-0.5 rounded-full text-xs'; if(s==='negative') return `<span class="${base} bg-rose-100 text-rose-700">negative</span>`; if(s==='positive') return `<span class="${base} bg-emerald-100 text-emerald-700">positive</span>`; return `<span class="${base} bg-slate-100 text-slate-700">neutral</span>`; }
  function rollingAvg(arr,w=7){ const out=[]; for(let i=0;i<arr.length;i++){ const s=Math.max(0,i-w+1), a=arr.slice(s,i+1); out.push(+(a.reduce((m,v)=>m+v,0)/a.length).toFixed(1)); } return out; }
  function diffSeries(arr){ const out=[0]; for(let i=1;i<arr.length;i++) out.push(+(arr[i]-arr[i-1]).toFixed(1)); return out; }

  // dates/select/filter
  function renderDateOptions(){
    const dates=Array.from(new Set(allRows.map(r=>r.date))).sort();
    dateSelect.innerHTML=dates.map(d=>`<option value="${d}">${d}</option>`).join('\n');
    currentDate=dates[dates.length-1]||null; if(currentDate) dateSelect.value=currentDate;
    updateHeaderLabels(); updateModeButtons();
  }
  function computeRows(){
    const f=(brandFilter.value||'').toLowerCase();
    const rows=allRows.filter(r=> r.date===currentDate && r.brand);
    rows.sort((a,b)=> formatInt(b.negative)-formatInt(a.negative));
    const top=rows.filter(r=> r.brand.toLowerCase().includes(f)).slice(0,ROWS_TO_SHOW);
    selected=new Set(Array.from(selected).filter(b=> top.find(r=> r.brand===b)));
    currentRows=top;
  }

  // table render
  function renderTable(){
    tableBody.innerHTML = currentRows.map((r,idx)=>{
      const isSel=selected.has(r.brand);
      const n=cellVal(r.negative,r.total), u=cellVal(r.neutral,r.total), p=cellVal(r.positive,r.total);
      return `<tr class="border-t hover:bg-slate-50">
        <td class="p-3"><input type="checkbox" data-brand="${r.brand.replace(/\"/g,'&quot;')}" ${isSel?'checked':''}></td>
        <td class="p-3">${idx+1}</td>
        <td class="p-3 font-medium"><button class="underline" data-view-brand="${r.brand.replace(/\"/g,'&quot;')}">${r.brand}</button></td>
        <td class="p-3">${r.company || ''}</td>
        <td class="p-3" title="${n.title}">${n.val}</td>
        <td class="p-3" title="${u.title}">${u.val}</td>
        <td class="p-3" title="${p.title}">${p.val}</td>
        <td class="p-3 text-slate-700">${getThemeFor(r)}</td>
        <td class="p-3"><button class="px-2 py-1 border rounded-lg" data-view-brand="${r.brand.replace(/\"/g,'&quot;')}">View</button></td>
      </tr>`;
    }).join('\n');
    statusEl.textContent = `${currentRows.length} CEOs shown for ${currentDate}. ${selected.size} selected.`;
    attachTableHandlers(); updateTrend();
  }
  function attachTableHandlers(){
    tableBody.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
      cb.addEventListener('change', ()=>{ const b=cb.getAttribute('data-brand'); if(cb.checked) selected.add(b); else selected.delete(b); statusEl.textContent=`${currentRows.length} CEOs shown for ${currentDate}. ${selected.size} selected.`; updateTrend(); });
    });
    tableBody.querySelectorAll('[data-view-brand]').forEach(btn=> btn.addEventListener('click', ()=> showDrilldown(btn.getAttribute('data-view-brand'))));
  }

  // saved
  function renderSaved(){
    const saved=JSON.parse(localStorage.getItem('saved_ceos')||'[]');
    const hNeg=headerLabel('Negative'), hNeu=headerLabel('Neutral'), hPos=headerLabel('Positive');
    if(!saved.length){ document.getElementById('savedContainer').innerHTML='<p class="text-slate-600">No saved items yet.</p>'; return; }
    document.getElementById('savedContainer').innerHTML = `
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-100">
            <tr>
              <th class="p-2 text-left">Date</th>
              <th class="p-2 text-left">CEO</th>
              <th class="p-2 text-left">Company</th>
              <th class="p-2 text-left">${hNeg}</th>
              <th class="p-2 text-left">${hNeu}</th>
              <th class="p-2 text-left">${hPos}</th>
              <th class="p-2 text-left">Theme</th>
              <th class="p-2 text-left">Actions</th>
            </tr>
          </thead>
          <tbody>
            ${saved.map((s,i)=>{
              const n=cellVal(s.negative,s.total), u=cellVal(s.neutral,s.total), p=cellVal(s.positive,s.total);
              return `<tr class="border-t">
                <td class="p-2">${s.date}</td>
                <td class="p-2 font-medium">${s.brand}</td>
                <td class="p-2">${s.company||''}</td>
                <td class="p-2" title="${n.title}">${n.val}</td>
                <td class="p-2" title="${u.title}">${u.val}</td>
                <td class="p-2" title="${p.title}">${p.val}</td>
                <td class="p-2">${s.theme||'None'}</td>
                <td class="p-2"><button data-i="${i}" class="text-rose-600 underline">Remove</button></td>
              </tr>`;
            }).join('\n')}
          </tbody>
        </table>
      </div>`;
    document.querySelectorAll('#savedContainer button[data-i]').forEach(btn=>{
      btn.addEventListener('click', ()=>{ const i=+btn.getAttribute('data-i'); const arr=JSON.parse(localStorage.getItem('saved_ceos')||'[]'); arr.splice(i,1); localStorage.setItem('saved_ceos', JSON.stringify(arr)); renderSaved(); });
    });
  }
  function saveSelectionLocal(){
    const current=currentRows.filter(r=> selected.has(r.brand));
    if(!current.length){ alert('No rows selected.'); return; }
    const saved=JSON.parse(localStorage.getItem('saved_ceos')||'[]');
    const key=(x)=>`${x.date}__${x.brand}`;
    const exist=new Set(saved.map(key));
    for(const r of current){ if(!exist.has(key(r))) saved.push(r); }
    localStorage.setItem('saved_ceos', JSON.stringify(saved));
    renderSaved(); alert('Saved locally.');
  }
  function exportSelectionCsv(){
    const rows=allRows.filter(r=> r.date===currentDate);
    if(!rows.length){ alert('No data for this date.'); return; }
    rows.sort((a,b)=>{ const d=formatInt(b.negative)-formatInt(a.negative); return d!==0?d:String(a.brand).localeCompare(String(b.brand)); });
    const header=['date','ceo','company','total','positive','neutral','negative','theme'];
    const body=rows.map(r=>[ r.date, r.brand, r.company||'', r.total, r.positive, r.neutral, r.negative, '"' + String(getThemeFor(r)||'').replace(/"/g,'""') + '"' ].join(','));
    const csv='\ufeff' + [header.join(','), ...body].join('\r\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=`ceo_alldata_${currentDate}.csv`; a.rel='noopener'; a.target='_blank';
    document.body.appendChild(a); a.click(); setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); },800);
  }

  // drilldown
  function openModal(){ modalBackdrop.classList.remove('hidden'); }
  function closeModal(){ modalBackdrop.classList.add('hidden'); }
  modalClose.addEventListener('click', closeModal);
  modalBackdrop.addEventListener('click', (e)=>{ if(e.target===modalBackdrop) closeModal(); });
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });

  async function loadArticlesForDate(date){
    if(articlesCache[date]) return articlesCache[date];
    const rel=CSV_ARTICLES(date)+'?_='+Date.now();
    const abs=GH_PAGES_BASE+CSV_ARTICLES(date)+(CSV_ARTICLES(date).includes('?')?'&':'?')+'_='+Date.now();
    const candidates=[rel]; if(!rel.startsWith(GH_PAGES_BASE)) candidates.push(abs);
    for(const url of candidates){
      try{
        const resp=await fetch(url,{cache:'no-store'}); if(!resp.ok) continue;
        const text=await resp.text(); const parsed=Papa.parse(text,{header:true});
        const norm=(Array.isArray(parsed.data)?parsed.data:[]).map(normalizeRowKeys);
        const rows=norm.filter(r=>r && (r.brand||r.company) && (r.title||r.headline)).map(r=>{
          const brand=String(r.brand||'').trim(); const alias=String(r.alias_matched||r.alias||'').trim(); const company=String(r.company||'').trim();
          const rawUrl=String(r.url||r.link||''); let domain=String(r.domain||''); if(!domain&&rawUrl){ try{ domain=new URL(rawUrl).hostname; }catch{} }
          return { brand, company, alias, title:String(r.title||r.headline||'').trim(), url:rawUrl, domain, sentiment:String(r.sentiment||'neutral'), published:String(r.published||r.date||'') };
        });
        articlesCache[date]=rows; return rows;
      }catch(e){}
    }
    articlesCache[date]=[]; return [];
  }
  function parseDateMaybe(s){ const t=Date.parse(s); return isNaN(t)?0:t; }
  async function showDrilldown(brand){
    modalTitle.textContent = brand + ' — Headlines';
    modalSubtitle.textContent = `Date: ${currentDate}`;
    modalBody.innerHTML = '<p class="text-sm text-slate-500">Loading…</p>'; openModal();
    const all=await loadArticlesForDate(currentDate);
    const key=brand.trim().toLowerCase();
    const rows=all.filter(r=> (r.brand||'').trim().toLowerCase()===key || (r.alias||'').trim().toLowerCase()===key);
    rows.sort((a,b)=>{ const ord=x=>x.sentiment==='negative'?2:(x.sentiment==='neutral'?1:0); const d=ord(b)-ord(a); return d!==0?d:parseDateMaybe(b.published)-parseDateMaybe(a.published); });
    if(!rows.length){ modalBody.innerHTML='<p class="text-sm text-slate-600">No articles found for this CEO on this date.</p>'; return; }
    modalBody.innerHTML = `<div class="space-y-3">
      ${rows.map(r=>`
        <div class="p-3 border rounded-xl hover:bg-slate-50">
          <div class="flex items-center justify-between gap-3">
            <div class="text-xs text-slate-500">${r.domain||''}</div>
            <div>${sentimentBadge(r.sentiment)}</div>
          </div>
          <a href="${r.url}" target="_blank" rel="noopener" class="block mt-1 font-medium underline">${String(r.title).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')}</a>
          ${r.published?`<div class="text-xs text-slate-500 mt-1">${r.published}</div>`:''}
        </div>`).join('\n')}
    </div>`;
  }

  // trend/change
  function allDatesSorted(){ return Array.from(new Set(allRows.map(r=>r.date))).sort(); }
  function seriesForBrand(brand){
    const dates=allDatesSorted(); const byDate=new Map(); for(const r of allRows) if(r.brand===brand) byDate.set(r.date,r);
    const posC=[],neuC=[],negC=[],tot=[]; const posP=[],neuP=[],negP=[];
    for(const d of dates){
      const r=byDate.get(d)||{total:0,positive:0,neutral:0,negative:0}; const T=r.total||0; const pct=(x)=>T?+(100*x/T).toFixed(1):0;
      posC.push(r.positive||0); neuC.push(r.neutral||0); negC.push(r.negative||0); tot.push(T);
      posP.push(pct(r.positive||0)); neuP.push(pct(r.neutral||0)); negP.push(pct(r.negative||0));
    }
    return { dates, posC, neuC, negC, tot, posP, neuP, negP };
  }
  function updateTrend(){
    const selCount=selected.size; let brand=null;
    if(selCount===1) brand=Array.from(selected)[0];
    else if(selCount===0 && currentRows.length) brand=currentRows[0].brand;
    else{ trendHint.classList.remove('hidden'); trendInfo.textContent=''; trendRange.textContent=''; if(trendChart){trendChart.destroy();} if(nsiChart){nsiChart.destroy();} if(deltaNegChart){deltaNegChart.destroy();} return; }
    if(brand!==trendBrand) trendPage=0; trendHint.classList.add('hidden');

    const full=seriesForBrand(brand);
    const total=full.dates.length, W=TREND_WINDOW, maxPage=Math.max(0,Math.ceil(total/W)-1);
    if(trendPage>maxPage) trendPage=maxPage;
    const end=Math.max(0,total-W*trendPage), start=Math.max(0,end-W);

    const labels=full.dates.slice(start,end);
    const pos=(viewMode==='percent'?full.posP:full.posC).slice(start,end);
    const neu=(viewMode==='percent'?full.neuP:full.neuC).slice(start,end);
    const neg=(viewMode==='percent'?full.negP:full.negC).slice(start,end);
    const posPctWin=full.posP.slice(start,end), negPctWin=full.negP.slice(start,end);

    trendBrand=brand;
    trendInfo.textContent=`CEO: ${brand}`;
    trendRange.textContent = labels.length ? `  |  DATE: ${labels[0]} → ${labels[labels.length-1]}` : '';
    const showLabels=labels.length<=7;

    if(trendChart) trendChart.destroy();
    trendChart = new Chart(trendCanvas.getContext('2d'), {
      type:'bar',
      data:{ labels,
        datasets:[
          { label:'Positive', data:pos, backgroundColor:'#98c15b', stack:'sent' },
          { label:'Neutral',  data:neu, backgroundColor:'#dae5e6', stack:'sent' },
          { label:'Negative', data:neg, backgroundColor:'#ffb199', stack:'sent' },
        ]},
      options:{
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{position:'top'}, tooltip:{ callbacks:{ label:(c)=> viewMode==='percent' ? `${c.dataset.label}: ${c.parsed.y}%` : `${c.dataset.label}: ${c.parsed.y}` } } },
        scales:{ x:{ stacked:true, ticks:{ display:showLabels } }, y:{ stacked:true, beginAtZero:true, ticks:{ callback:(v)=> viewMode==='percent'? v+'%':v } } }
      }
    });

    const nsi = posPctWin.map((v,i)=> +(v - negPctWin[i]).toFixed(1));
    const nsiAvg=rollingAvg(nsi,7);
    if(nsiChart) nsiChart.destroy();
    nsiChart = new Chart(document.getElementById('nsiChart').getContext('2d'), {
      type:'line',
      data:{ labels, datasets:[
        { label:'NSI (Positive% − Negative%)', data:nsi, borderColor:'#2563eb', tension:0.25, pointRadius:0, fill:false },
        { label:'7-day avg', data:nsiAvg, borderColor:'#64748b', borderDash:[4,4], tension:0.25, pointRadius:0, fill:false },
      ]},
      options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'top'}},
        scales:{ x:{ ticks:{ display:showLabels } }, y:{ beginAtZero:true, suggestedMin:-100, suggestedMax:100, ticks:{ callback:(v)=> v+'%' } } }
      }
    });

    const deltaNeg=diffSeries(negPctWin);
    if(deltaNegChart) deltaNegChart.destroy();
    const colors=deltaNeg.map(v=> v>0 ? '#ffb199' : (v<0 ? '#b8e276' : '#cedcdd'));
    deltaNegChart = new Chart(document.getElementById('deltaNegChart').getContext('2d'), {
      type:'bar',
      data:{ labels, datasets:[{ label:'Δ Negative% vs prior day', data:deltaNeg, backgroundColor:colors }] },
      options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:true}},
        scales:{ x:{ ticks:{ display:showLabels } }, y:{ beginAtZero:true, suggestedMin:-50, suggestedMax:50, ticks:{ callback:(v)=> v+'%' } } }
      }
    });
  }

  // data load
  function loadCountsCsv(){
    const rel=new URL(CSV_COUNTS, location.href).href + (CSV_COUNTS.includes('?')?'&':'?') + '_=' + Date.now();
    const abs=GH_PAGES_BASE + CSV_COUNTS + (CSV_COUNTS.includes('?')?'&':'?') + '_=' + Date.now();
    const candidates=[rel]; if(!rel.startsWith(GH_PAGES_BASE)) candidates.push(abs);
    (async ()=>{
      let okText=null;
      for(const url of candidates){
        try{ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) continue; const t=await r.text(); if(t && t.length){ okText=t; break; } }catch(e){}
      }
      if(!okText){ statusEl.textContent='Error loading data.'; return; }
      const parsed=Papa.parse(okText,{header:true,dynamicTyping:true});
      const raw=(Array.isArray(parsed.data)?parsed.data:[]).map(normalizeRowKeys);
      const good=raw.filter(r=>r && r.date && r.brand);
      allRows = good.map(r=>({ date:String(r.date), brand:String(r.brand), company: String(r.company||''),
        total:formatInt(r.total), positive:formatInt(r.positive), neutral:formatInt(r.neutral), negative:formatInt(r.negative),
        theme: r.theme ? String(r.theme) : 'none' }));
      if(!allRows.length){ statusEl.textContent='No rows parsed.'; return; }
      renderDateOptions(); computeRows(); renderTable(); renderSaved();
      statusEl.textContent = `${currentRows.length} CEOs shown for ${currentDate}. ${selected.size} selected.`;
    })();
  }

  // events
  dateSelect.addEventListener('change', ()=>{ currentDate=dateSelect.value; computeRows(); renderTable(); });
  brandFilter.addEventListener('input', ()=>{ computeRows(); renderTable(); });
  document.getElementById('refreshBtn').addEventListener('click', loadCountsCsv);
  selectAll.addEventListener('change', ()=>{ if(selectAll.checked) currentRows.forEach(r=>selected.add(r.brand)); else selected.clear(); renderTable(); });
  saveLocalBtn.addEventListener('click', saveSelectionLocal);
  exportCsvBtn.addEventListener('click', exportSelectionCsv);
  modeCountsBtn.addEventListener('click', ()=>{ viewMode='counts'; localStorage.setItem('view_mode','counts'); updateHeaderLabels(); updateModeButtons(); renderTable(); renderSaved(); });
  modePercentBtn.addEventListener('click', ()=>{ viewMode='percent'; localStorage.setItem('view_mode','percent'); updateHeaderLabels(); updateModeButtons(); renderTable(); renderSaved(); });
  trendPrev.addEventListener('click', ()=>{ trendPage += 1; updateTrend(); });
  trendNext.addEventListener('click', ()=>{ trendPage = Math.max(0, trendPage - 1); updateTrend(); });

  loadCountsCsv();
})();
</script>
</body>
</html>
