<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CEO News Sentiment Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --neg: #ffb199;  /* negative */
      --pos: #b8e276;  /* positive */
      --neu: #cedcdd;  /* neutral */
      --ink: #0f172a;  /* slate-900 */
      --muted: #475569;/* slate-600 */
      --border: #e2e8f0;/* slate-200 */
      --bg: #f8fafc;   /* slate-50 */
      --card: #ffffff;
      --btn: #111827;  /* black */
      --btnText: #ffffff;
      --pill: #0f172a;
      --pillText: #fff;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--ink); background: var(--bg);
    }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 24px 16px 80px; }
    h1 { font-size: 28px; margin: 0 0 6px; }
    .muted { color: var(--muted); font-size: 14px; }
    .row { display: grid; grid-template-columns: 1fr 1fr auto; gap: 12px; align-items: center; margin-top: 16px; }
    .control { display:flex; flex-direction: column; gap:6px; }
    select, input {
      width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 10px; background: #fff; font-size: 14px;
    }
    button.primary {
      background: var(--btn); color: var(--btnText); border: 1px solid var(--btn); border-radius: 10px; padding: 10px 14px; font-weight: 600; cursor: pointer;
    }
    button.secondary {
      background: #fff; color: var(--ink); border: 1px solid var(--border); border-radius: 10px; padding: 10px 14px; font-weight: 600; cursor: pointer;
    }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 14px; }
    .toolbar { display:flex; gap:12px; align-items:center; flex-wrap: wrap; }
    .pill { display:inline-flex; gap:8px; align-items:center; background: #fff; border: 1px solid var(--border); padding: 6px; border-radius: 999px; }
    .pill button { border:0; padding:6px 10px; border-radius: 999px; cursor:pointer; font-weight:600; background:transparent; color:var(--ink); }
    .pill button.active { background: var(--pill); color: var(--pillText); }
    table { width:100%; border-collapse: collapse; }
    th, td { padding: 10px 12px; border-top:1px solid var(--border); vertical-align: middle; }
    thead th { border-top:0; font-size: 12px; text-transform: uppercase; letter-spacing: .04em; color: var(--muted); }
    tbody tr:hover { background: #fafafa; }
    .link { color:#1d4ed8; text-decoration:none; font-weight:600; }
    .rank { width: 56px; text-align: center; color: var(--muted);}
    .right { text-align:right; }
    .legend { display:flex; gap:16px; align-items:center; justify-content:flex-start; flex-wrap: wrap; font-size:13px; color:var(--muted); margin: 8px 0 6px; }
    .dot { width:12px; height:12px; border-radius:2px; display:inline-block; margin-right:6px; }
    .nav { display:flex; gap:8px; align-items:center;}
    .nav button { border:1px solid var(--border); background:#fff; border-radius:8px; padding:6px 10px; cursor:pointer; }
    .topline { display:flex; justify-content:space-between; align-items:center; margin-bottom: 8px; color: var(--muted); font-size: 13px;}
    .watchlist { margin-top: 18px; }
    .modal-backdrop { position: fixed; inset: 0; background: rgba(15,23,42,.55); display:none; align-items:center; justify-content:center; padding: 16px; }
    .modal { background:#fff; border-radius:14px; max-width: 800px; width:100%; border:1px solid var(--border); }
    .modal header { padding:14px 16px; border-bottom:1px solid var(--border); font-weight:700; display:flex; justify-content:space-between; align-items:center; }
    .modal .body { padding: 16px; max-height: 70vh; overflow:auto; }
    .badge { background:#eef2ff; color:#3730a3; padding:4px 8px; border-radius:999px; font-size:12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>CEO News Sentiment Dashboard</h1>
    <div class="muted">Shows the top 25 Fortune 500 CEOs by <strong>negative</strong> article count for a selected day. Data source: <code>data_ceos/daily_counts.csv</code>. Click a CEO (or the View button) to see that day's headlines.</div>

    <div class="row">
      <div class="control">
        <label class="muted">Pick date</label>
        <select id="dateSel"></select>
      </div>
      <div class="control">
        <label class="muted">Filter CEOs</label>
        <input id="filterInput" type="search" placeholder="Type to filter…" />
      </div>
      <div class="control" style="align-items:flex-start;gap:8px;">
        <label class="muted" style="visibility:hidden;">&nbsp;</label>
        <div class="toolbar">
          <button id="refreshBtn" class="secondary">Refresh</button>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <div class="toolbar" style="justify-content:space-between;">
        <div style="display:flex; gap:12px; align-items:center;">
          <button id="saveLocalBtn" class="primary">Save selection (local)</button>
          <button id="exportCsvBtn" class="primary">Download all data (CSV)</button>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <span class="muted">Display</span>
          <div class="pill">
            <button id="countsBtn" class="">Counts</button>
            <button id="pctBtn" class="active">%</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <div class="topline">
        <div id="rangeLabel">BRAND: —  |  DATE: —</div>
        <div class="nav">
          <button id="prevWin">←</button>
          <button id="nextWin">→</button>
        </div>
      </div>
      <div class="legend">
        <span><span class="dot" style="background:var(--pos)"></span>Positive</span>
        <span><span class="dot" style="background:var(--neu)"></span>Neutral</span>
        <span><span class="dot" style="background:var(--neg)"></span>Negative</span>
        <span class="badge">Tip: select 1 CEO to display trend</span>
      </div>
      <canvas id="trend" height="140"></canvas>
    </div>

    <div class="card" style="margin-top:16px;">
      <table id="grid">
        <thead>
          <tr>
            <th class="rank">#</th>
            <th class="px-3 py-2 text-left">CEO</th>
            <th class="px-3 py-2 text-left">Company</th>
            <th class="right">Negative</th>
            <th class="right">Neutral</th>
            <th class="right">Positive</th>
            <!-- no Total -->
            <th class="px-3 py-2 text-left">Theme</th>
            <th class="px-3 py-2 text-left">Headlines</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="watchlist">
        <h3 style="margin:18px 0 6px;">Saved (local) watchlist</h3>
        <div id="watchlistEmpty" class="muted">No saved items yet.</div>
        <ul id="watchlist"></ul>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal-backdrop">
    <div class="modal">
      <header>
        <div id="modalTitle">Headlines</div>
        <button id="closeModal" class="secondary">Close</button>
      </header>
      <div class="body" id="modalBody"></div>
    </div>
  </div>

<script>
/** ======== Config ======== **/
const COUNTS_CSV = 'data_ceos/daily_counts.csv';
const ARTICLES_DIR = 'data_ceos/articles'; // /YYYY-MM-DD.csv
const COLORS = { neg: getCSS('--neg'), pos: getCSS('--pos'), neu: getCSS('--neu') };
const MAX_BARS = 30;

/** ======== Small utils ======== **/
function getCSS(varName){ return getComputedStyle(document.documentElement).getPropertyValue(varName).trim(); }
function fmt(n){ return Number(n).toLocaleString(); }
function pct(num, den){ return den ? Math.round((num/den)*100) : 0; }
function $(id){ return document.getElementById(id); }
function csvParse(text){
  // simple CSV parser that handles quotes and commas
  const rows = [];
  let i = 0, cur = '', inQ = false, row = [];
  while (i < text.length){
    const ch = text[i];
    if (inQ){
      if (ch === '"'){
        if (text[i+1] === '"'){ cur += '"'; i++; }
        else { inQ = false; }
      } else cur += ch;
    } else {
      if (ch === '"') inQ = true;
      else if (ch === ','){ row.push(cur); cur=''; }
      else if (ch === '\n'){ row.push(cur); rows.push(row); row=[]; cur=''; }
      else if (ch === '\r'){ /* skip */ }
      else cur += ch;
    }
    i++;
  }
  if (cur.length>0 || row.length) { row.push(cur); rows.push(row); }
  return rows;
}
function rowsToObjects(rows){
  const [h, ...body] = rows;
  const keys = h.map(s => s.trim());
  return body.filter(r => r.length===keys.length).map(r => {
    const o = {}; keys.forEach((k,idx)=>o[k]=r[idx]); return o;
  });
}
function unique(arr){ return [...new Set(arr)]; }

/** ======== State ======== **/
let ALL = [];        // all rows from counts csv
let DATES = [];      // available dates
let DISPLAY = 'pct'; // 'pct' or 'counts'
let chart;           // Chart.js instance
let trendWindow = { start: 0, end: 0 }; // indices into date series
let selectedBrand = null;

/** ======== Load ======== **/
async function loadCounts(){
  const res = await fetch(COUNTS_CSV, { cache: 'no-store' });
  if (!res.ok) throw new Error('Failed to fetch counts CSV');
  const txt = await res.text();
  ALL = rowsToObjects(csvParse(txt));
  // normalize numbers
  ALL.forEach(r => {
    r.total = +r.total || 0;
    r.positive = +r.positive || 0;
    r.neutral = +r.neutral || 0;
    r.negative = +r.negative || 0;
  });
  DATES = unique(ALL.map(r => r.date)).sort();
}

function populateDates(){
  const sel = $('dateSel');
  sel.innerHTML = '';
  DATES.forEach(d => {
    const opt = document.createElement('option');
    opt.value = d; opt.textContent = d;
    sel.appendChild(opt);
  });
  sel.value = DATES[DATES.length-1] || '';
}

function filterRowsForDate(date, searchText){
  let rows = ALL.filter(r => r.date === date);
  if (searchText){
    const s = searchText.toLowerCase();
    rows = rows.filter(r => (r.brand||'').toLowerCase().includes(s) || (r.company||'').toLowerCase().includes(s));
  }
  // order by negative desc, then total desc
  rows.sort((a,b)=> (b.negative - a.negative) || (b.total - a.total));
  // top 25
  return rows.slice(0, 25);
}

function renderTable(date){
  const body = $('grid').querySelector('tbody');
  body.innerHTML = '';
  const filter = $('filterInput').value.trim();
  const rows = filterRowsForDate(date, filter);

  rows.forEach((r, idx) => {
    const tr = document.createElement('tr');
    const neg = DISPLAY==='pct' ? `${pct(r.negative, r.total)}%` : fmt(r.negative);
    const neu = DISPLAY==='pct' ? `${pct(r.neutral, r.total)}%` : fmt(r.neutral);
    const pos = DISPLAY==='pct' ? `${pct(r.positive, r.total)}%` : fmt(r.positive);

    tr.innerHTML = `
      <td class="rank">${idx+1}</td>
      <td class="px-3 py-2"><a href="#" class="link brand-link" data-brand="${r.brand}">${r.brand}</a></td>
      <td class="px-3 py-2">${r.company || ''}</td>
      <td class="right">${neg}</td>
      <td class="right">${neu}</td>
      <td class="right">${pos}</td>
      <td>${r.theme || 'None'}</td>
      <td><button class="secondary view-btn" data-brand="${r.brand}" data-date="${r.date}">View</button></td>
    `;
    body.appendChild(tr);
  });

  body.querySelectorAll('.brand-link').forEach(a=>{
    a.addEventListener('click', (e)=>{
      e.preventDefault();
      selectedBrand = a.dataset.brand;
      updateTrend();
    });
  });
  body.querySelectorAll('.view-btn').forEach(btn=>{
    btn.addEventListener('click', ()=> openHeadlines(btn.dataset.date, btn.dataset.brand));
  });
}

function defaultBrandFor(date){
  const rows = filterRowsForDate(date, $('filterInput').value.trim());
  return rows.length ? rows[0].brand : null;
}

function setCountsMode(mode){
  DISPLAY = mode; // 'pct' or 'counts'
  $('countsBtn').classList.toggle('active', mode==='counts');
  $('pctBtn').classList.toggle('active', mode==='pct');
  renderTable($('dateSel').value);
  updateTrend();
}

/** ======== Trend chart ======== **/
function currentWindowDates(){
  // build series for selected brand across all dates
  const brand = selectedBrand || defaultBrandFor($('dateSel').value);
  if (!brand) return { brand:null, dates:[], rows:[] };
  const rows = ALL.filter(r => r.brand === brand).sort((a,b)=> a.date.localeCompare(b.date));
  const dates = rows.map(r=>r.date);
  // set window (last MAX_BARS)
  let start = Math.max(0, dates.length - MAX_BARS);
  let end = dates.length - 1;
  if (trendWindow.start || trendWindow.end){
    // keep a valid window if user paged
    start = Math.max(0, Math.min(trendWindow.start, dates.length-1));
    end = Math.max(start, Math.min(trendWindow.end, dates.length-1));
  }
  trendWindow = { start, end };
  return { brand, dates, rows };
}

function updateRangeLabel(brand, dates, start, end){
  const left = dates[start] || '—';
  const right = dates[end] || '—';
  $('rangeLabel').textContent = `BRAND: ${brand || '—'}  |  DATE: ${left} → ${right}`;
}

function updateTrend(){
  const { brand, dates, rows } = currentWindowDates();
  const ctx = $('trend').getContext('2d');
  if (!brand || !dates.length){
    updateRangeLabel(brand, [], 0, 0);
    if (chart) { chart.destroy(); chart = null; }
    return;
  }
  const start = trendWindow.start, end = trendWindow.end;
  const winDates = dates.slice(start, end+1);
  const winRows = rows.slice(start, end+1);

  const neg = winRows.map(r => DISPLAY==='pct' ? pct(r.negative, r.total) : r.negative);
  const neu = winRows.map(r => DISPLAY==='pct' ? pct(r.neutral, r.total) : r.neutral);
  const pos = winRows.map(r => DISPLAY==='pct' ? pct(r.positive, r.total) : r.positive);

  const labels = winDates;
  updateRangeLabel(brand, dates, start, end);

  const stacked = {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: 'Positive', data: pos, backgroundColor: COLORS.pos, stack: 's' },
        { label: 'Neutral',  data: neu, backgroundColor: COLORS.neu, stack: 's' },
        { label: 'Negative', data: neg, backgroundColor: COLORS.neg, stack: 's' }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          stacked: true,
          ticks: { display: labels.length <= 7 }
        },
        y: {
          stacked: true,
          beginAtZero: true,
          max: DISPLAY==='pct' ? 100 : undefined,
          ticks: { callback: v => DISPLAY==='pct' ? `${v}%` : v }
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => {
              const val = ctx.parsed.y;
              return `${ctx.dataset.label}: ${DISPLAY==='pct' ? val + '%' : fmt(val)}`;
            }
          }
        }
      }
    }
  };

  if (chart) chart.destroy();
  chart = new Chart(ctx, stacked);
}

$('prevWin').addEventListener('click', ()=>{
  const { dates } = currentWindowDates();
  if (!dates.length) return;
  const span = Math.min(MAX_BARS, dates.length);
  trendWindow.start = Math.max(0, trendWindow.start - span);
  trendWindow.end = Math.max(trendWindow.start, trendWindow.start + span - 1);
  updateTrend();
});
$('nextWin').addEventListener('click', ()=>{
  const { dates } = currentWindowDates();
  if (!dates.length) return;
  const span = Math.min(MAX_BARS, dates.length);
  trendWindow.start = Math.min(Math.max(0, dates.length - span), trendWindow.start + span);
  trendWindow.end = Math.min(dates.length - 1, trendWindow.start + span - 1);
  updateTrend();
});

/** ======== Headlines modal ======== **/
async function openHeadlines(date, brand){
  const url = `${ARTICLES_DIR}/${date}.csv`;
  const res = await fetch(url, { cache: 'no-store' });
  const body = $('modalBody');
  body.innerHTML = '';
  if (!res.ok){
    body.textContent = 'No articles found for this brand on this date.';
  } else {
    const txt = await res.text();
    const rows = rowsToObjects(csvParse(txt));
    const items = rows.filter(r => r.brand === brand);
    if (!items.length){
      body.textContent = 'No articles found for this brand on this date.';
    } else {
      const ul = document.createElement('ul');
      ul.style.listStyle = 'disc';
      ul.style.paddingLeft = '18px';
      items.forEach(it=>{
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = it.link; a.textContent = it.title; a.target = '_blank'; a.rel = 'noopener';
        li.appendChild(a);
        if (it.source){ const small = document.createElement('small'); small.style.marginLeft='8px'; small.textContent = `(${it.source})`; li.appendChild(small); }
        ul.appendChild(li);
      });
      body.appendChild(ul);
    }
  }
  $('modalTitle').textContent = `${brand} — Headlines (Date: ${date})`;
  $('modal').style.display = 'flex';
}
$('closeModal').addEventListener('click', ()=> $('modal').style.display='none');
$('modal').addEventListener('click', (e)=>{ if (e.target.id==='modal') $('modal').style.display='none'; });

/** ======== Export CSV (full day) ======== **/
function downloadCSVFor(date){
  const rows = ALL.filter(r => r.date === date)
                  .sort((a,b)=> b.negative - a.negative || b.total - a.total);
  if (!rows.length){
    alert('No data for this date.'); return;
  }
  const header = ['date','brand','company','positive','neutral','negative','total','theme'];
  const body = rows.map(r => [r.date,r.brand,r.company||'',r.positive,r.neutral,r.negative,r.total,r.theme||'']);
  const csv = '﻿' + [header.join(','), ...body.map(r => r.map(v => {
    v = (v ?? '').toString();
    return (v.includes(',') || v.includes('"') || v.includes('\n')) ? `"${v.replace(/"/g,'""')}"` : v;
  }).join(','))].join('\n');

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `ceo_counts_${date}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

/** ======== Watchlist (local) ======== **/
function getWatch(){ try { return JSON.parse(localStorage.getItem('ceo_watch')||'[]'); } catch { return []; } }
function setWatch(lst){ localStorage.setItem('ceo_watch', JSON.stringify(lst)); renderWatch(); }
function renderWatch(){
  const ul = $('watchlist'); ul.innerHTML=''; const lst = getWatch();
  $('watchlistEmpty').style.display = lst.length ? 'none' : 'block';
  lst.forEach(x=>{
    const li = document.createElement('li'); li.style.margin='4px 0';
    li.textContent = x; ul.appendChild(li);
  });
}
$('saveLocalBtn').addEventListener('click', ()=>{
  const date = $('dateSel').value;
  const rows = filterRowsForDate(date, $('filterInput').value.trim());
  const checked = rows.map(r=>r.brand); // save the ones shown
  setWatch(unique([...getWatch(), ...checked]));
});
$('exportCsvBtn').addEventListener('click', ()=> downloadCSVFor($('dateSel').value));

/** ======== Events ======== **/
$('countsBtn').addEventListener('click', ()=> setCountsMode('counts'));
$('pctBtn').addEventListener('click', ()=> setCountsMode('pct'));
$('refreshBtn').addEventListener('click', async ()=>{
  await loadCounts(); populateDates(); renderTable($('dateSel').value); selectedBrand=null; trendWindow={start:0,end:0}; updateTrend();
});
$('dateSel').addEventListener('change', ()=>{
  renderTable($('dateSel').value);
  selectedBrand=null; trendWindow={start:0,end:0};
  updateTrend();
});
$('filterInput').addEventListener('input', ()=> renderTable($('dateSel').value));

/** ======== Init ======== **/
(async function(){
  try {
    await loadCounts();
    populateDates();
    renderTable($('dateSel').value);
    renderWatch();
    updateTrend();
  } catch (err){
    console.error(err);
    alert('Error loading data. See console.');
  }
})();
</script>
</body>
</html>
