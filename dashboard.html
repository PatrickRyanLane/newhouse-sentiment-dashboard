<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily News Sentiment Dashboard</title>
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Papa Parse (CSV parser) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-7xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-3xl font-bold">Daily News Sentiment Dashboard</h1>
      <p class="text-sm text-slate-600">Shows the top 25 brands by <span class="font-semibold">negative</span> article count for a selected day. Data source: <code>data/daily_counts.csv</code>. Click a brand (or the View button) to see that day's headlines.</p>
    </header>

    <!-- Controls -->
    <section class="mb-4 grid gap-3 md:grid-cols-3">
      <div>
        <label class="block text-sm font-medium mb-1">Pick date</label>
        <select id="dateSelect" class="w-full border rounded-lg p-2 bg-white"></select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Filter brands</label>
        <input id="brandFilter" type="text" placeholder="Type to filter…" class="w-full border rounded-lg p-2" />
      </div>
      <div class="flex items-end gap-2">
        <button id="refreshBtn" class="px-3 py-2 rounded-lg bg-slate-900 text-white">Refresh</button>
        <button id="exportCsvBtn" class="px-3 py-2 rounded-lg border">Export selection (CSV)</button>
      </div>
    </section>

    <!-- Save options -->
    <section class="mb-6 p-4 border rounded-xl bg-white">
      <h2 class="text-lg font-semibold mb-2">Save highlighted brands</h2>
      <p class="text-sm text-slate-600 mb-3">Selections are stored locally in your browser, and optionally sent to a Google Sheet (via a webhook you control).</p>
      <div class="flex flex-col gap-3 md:flex-row md:items-end">
        <button id="saveLocalBtn" class="px-3 py-2 rounded-lg bg-emerald-600 text-white">Save selection (local)</button>
        <div class="flex-1">
          <label class="block text-sm font-medium mb-1">Google Apps Script Webhook URL (optional)</label>
          <input id="webhookUrl" type="url" placeholder="https://script.google.com/macros/s/XXXXX/exec" class="w-full border rounded-lg p-2" />
          <p class="text-xs text-slate-500 mt-1">Paste the URL of your deployed Apps Script web app (POST). We include date, brand, total, positive, neutral, negative, theme.</p>
        </div>
        <button id="sendWebhookBtn" class="px-3 py-2 rounded-lg bg-blue-600 text-white">Export selection → Google Sheet</button>
      </div>
    </section>

    <!-- Table -->
    <section class="overflow-x-auto">
      <table class="min-w-full text-sm bg-white rounded-xl overflow-hidden border">
        <thead class="bg-slate-100">
          <tr>
            <th class="p-3 text-left"><input type="checkbox" id="selectAll"></th>
            <th class="p-3 text-left">Rank</th>
            <th class="p-3 text-left">Brand</th>
            <th class="p-3 text-left">Negative</th>
            <th class="p-3 text-left">Neutral</th>
            <th class="p-3 text-left">Positive</th>
            <th class="p-3 text-left">Total</th>
            <th class="p-3 text-left">Theme</th>
            <th class="p-3 text-left">Headlines</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
      <p id="status" class="text-xs text-slate-500 mt-2"></p>
    </section>

    <!-- Saved (local) -->
    <section class="mt-8">
      <h2 class="text-lg font-semibold mb-2">Saved (local) watchlist</h2>
      <div id="savedContainer" class="border rounded-xl bg-white p-4 text-sm">
        <p class="text-slate-600">No saved items yet.</p>
      </div>
    </section>
  </div>

  <!-- Drill-down Modal -->
  <div id="modalBackdrop" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-3xl bg-white rounded-2xl shadow-xl overflow-hidden">
        <div class="flex items-center justify-between p-4 border-b">
          <div>
            <h3 id="modalTitle" class="text-xl font-bold">Headlines</h3>
            <p id="modalSubtitle" class="text-sm text-slate-600"></p>
          </div>
          <button id="modalClose" class="px-3 py-1.5 rounded-lg border">Close</button>
        </div>
        <div id="modalBody" class="max-h-[70vh] overflow-y-auto p-4">
          <p class="text-sm text-slate-500">Loading…</p>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const CSV_COUNTS = 'data/daily_counts.csv'; // counts table
  const CSV_ARTICLES = (date) => `data/articles/${date}.csv`; // per-day detail
  const ROWS_TO_SHOW = 25; // top by negative
  const tableBody = document.getElementById('tableBody');
  const dateSelect = document.getElementById('dateSelect');
  const brandFilter = document.getElementById('brandFilter');
  const statusEl = document.getElementById('status');
  const selectAll = document.getElementById('selectAll');
  const saveLocalBtn = document.getElementById('saveLocalBtn');
  const exportCsvBtn = document.getElementById('exportCsvBtn');
  const webhookUrl = document.getElementById('webhookUrl');
  const sendWebhookBtn = document.getElementById('sendWebhookBtn');
  const savedContainer = document.getElementById('savedContainer');

  // Modal
  const modalBackdrop = document.getElementById('modalBackdrop');
  const modalTitle = document.getElementById('modalTitle');
  const modalSubtitle = document.getElementById('modalSubtitle');
  const modalBody = document.getElementById('modalBody');
  const modalClose = document.getElementById('modalClose');

  let allRows = []; // daily_counts.csv rows
  let currentDate = null;
  let currentRows = []; // filtered to date, then sorted by negative desc
  let selected = new Set(); // brand names selected (for current date)
  const articlesCache = {}; // date -> [article rows]

  function formatInt(x){ return Number(x || 0); }

  function renderDateOptions(){
    const dates = Array.from(new Set(allRows.map(r => r.date))).sort();
    dateSelect.innerHTML = dates.map(d => `<option value="${d}">${d}</option>`).join('\n');
    currentDate = dates[dates.length - 1] || null;
    if(currentDate) dateSelect.value = currentDate;
  }

  function computeRows(){
    const filter = (brandFilter.value || '').toLowerCase();
    const rows = allRows.filter(r => r.date === currentDate && r.brand);
    rows.sort((a,b)=> formatInt(b.negative) - formatInt(a.negative));
    const top = rows.filter(r => r.brand.toLowerCase().includes(filter)).slice(0, ROWS_TO_SHOW);
    selected = new Set(Array.from(selected).filter(b => top.find(r => r.brand === b)));
    currentRows = top;
  }

  function sentimentBadge(s){
    const base = 'inline-block px-2 py-0.5 rounded-full text-xs';
    if(s === 'negative') return `<span class="${base} bg-rose-100 text-rose-700">negative</span>`;
    if(s === 'positive') return `<span class="${base} bg-emerald-100 text-emerald-700">positive</span>`;
    return `<span class="${base} bg-slate-100 text-slate-700">neutral</span>`;
  }

  function renderTable(){
    tableBody.innerHTML = currentRows.map((r, idx)=>{
      const isSel = selected.has(r.brand);
      return `<tr class="border-t hover:bg-slate-50">
        <td class="p-3"><input type="checkbox" data-brand="${r.brand.replace(/"/g,'&quot;')}" ${isSel?'checked':''}></td>
        <td class="p-3">${idx+1}</td>
        <td class="p-3 font-medium"><button class="underline" data-view-brand="${r.brand.replace(/"/g,'&quot;')}">${r.brand}</button></td>
        <td class="p-3">${r.negative}</td>
        <td class="p-3">${r.neutral}</td>
        <td class="p-3">${r.positive}</td>
        <td class="p-3">${r.total}</td>
        <td class="p-3 text-slate-700">${r.theme || 'none'}</td>
        <td class="p-3"><button class="px-2 py-1 border rounded-lg" data-view-brand="${r.brand.replace(/"/g,'&quot;')}">View</button></td>
      </tr>`
    }).join('\n');
    statusEl.textContent = `${currentRows.length} brands shown for ${currentDate}. ${selected.size} selected.`;
  }

  function renderSaved(){
    const saved = JSON.parse(localStorage.getItem('saved_brands') || '[]');
    if(!saved.length){
      savedContainer.innerHTML = '<p class="text-slate-600">No saved items yet.</p>';
      return;
    }
    savedContainer.innerHTML = `
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-100">
            <tr>
              <th class="p-2 text-left">Date</th>
              <th class="p-2 text-left">Brand</th>
              <th class="p-2 text-left">Negative</th>
              <th class="p-2 text-left">Neutral</th>
              <th class="p-2 text-left">Positive</th>
              <th class="p-2 text-left">Total</th>
              <th class="p-2 text-left">Theme</th>
              <th class="p-2 text-left">Actions</th>
            </tr>
          </thead>
          <tbody>
            ${saved.map((s,i)=>`
              <tr class="border-t">
                <td class="p-2">${s.date}</td>
                <td class="p-2 font-medium">${s.brand}</td>
                <td class="p-2">${s.negative}</td>
                <td class="p-2">${s.neutral}</td>
                <td class="p-2">${s.positive}</td>
                <td class="p-2">${s.total}</td>
                <td class="p-2">${s.theme || 'none'}</td>
                <td class="p-2"><button data-i="${i}" class="text-rose-600 underline">Remove</button></td>
              </tr>`).join('\n')}
          </tbody>
        </table>
      </div>`;
    savedContainer.querySelectorAll('button[data-i]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const idx = parseInt(btn.getAttribute('data-i'),10);
        const arr = JSON.parse(localStorage.getItem('saved_brands') || '[]');
        arr.splice(idx,1);
        localStorage.setItem('saved_brands', JSON.stringify(arr));
        renderSaved();
      });
    });
  }

  function saveSelectionLocal(){
    const current = currentRows.filter(r => selected.has(r.brand));
    if(!current.length){ alert('No rows selected.'); return; }
    const saved = JSON.parse(localStorage.getItem('saved_brands') || '[]');
    const key = (x)=> `${x.date}__${x.brand}`;
    const existingKeys = new Set(saved.map(key));
    for(const row of current){ if(!existingKeys.has(key(row))) saved.push(row); }
    localStorage.setItem('saved_brands', JSON.stringify(saved));
    renderSaved();
    alert('Saved locally.');
  }

  function exportSelectionCsv(){
    const rows = currentRows.filter(r => selected.has(r.brand));
    if(!rows.length){ alert('No rows selected.'); return; }
    const header = ['date','brand','total','positive','neutral','negative','theme'];
    const csv = [header.join(',')].concat(rows.map(r=>[
      r.date, r.brand, r.total, r.positive, r.neutral, r.negative, `"${(r.theme||'').replaceAll('"','""')}"`
    ].join(','))).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `selection_${currentDate}.csv`; a.click();
    URL.revokeObjectURL(url);
  }

  async function sendSelectionToWebhook(){
    const url = (webhookUrl.value || '').trim();
    if(!url){ alert('Please paste your Google Apps Script Webhook URL.'); return; }
    const rows = currentRows.filter(r => selected.has(r.brand));
    if(!rows.length){ alert('No rows selected.'); return; }
    try{
      const resp = await fetch(url, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ rows }) });
      if(!resp.ok){ throw new Error('HTTP '+resp.status); }
      await resp.json().catch(()=>({status:'ok'}));
      alert('Sent to Google Sheet.');
    }catch(err){ console.error(err); alert('Failed to send to webhook. See console for details.'); }
  }

  function attachTableHandlers(){
    tableBody.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
      cb.addEventListener('change', ()=>{
        const brand = cb.getAttribute('data-brand');
        if(cb.checked) selected.add(brand); else selected.delete(brand);
        statusEl.textContent = `${currentRows.length} brands shown for ${currentDate}. ${selected.size} selected.`;
      });
    });
    tableBody.querySelectorAll('[data-view-brand]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const brand = btn.getAttribute('data-view-brand');
        showDrilldown(brand);
      });
    });
  }

  // Modal helpers
  function openModal(){ modalBackdrop.classList.remove('hidden'); }
  function closeModal(){ modalBackdrop.classList.add('hidden'); }
  modalClose.addEventListener('click', closeModal);
  modalBackdrop.addEventListener('click', (e)=>{ if(e.target === modalBackdrop) closeModal(); });
  window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeModal(); });

  // Load and cache articles for a date
  async function loadArticlesForDate(date){
    if(articlesCache[date]) return articlesCache[date];
    const path = CSV_ARTICLES(date) + '?_=' + Date.now();
    try{
      const resp = await fetch(path);
      if(!resp.ok){ articlesCache[date] = []; return []; }
      const text = await resp.text();
      const parsed = Papa.parse(text, { header: true });
      const rows = parsed.data.filter(r=> r && r.brand && r.title && r.url).map(r=>({
        brand: String(r.brand),
        title: String(r.title),
        url: String(r.url),
        domain: String(r.domain || ''),
        sentiment: String(r.sentiment || 'neutral'),
        published: String(r.published || '')
      }));
      articlesCache[date] = rows;
      return rows;
    }catch(err){ console.error(err); articlesCache[date] = []; return []; }
  }

  function parseDateMaybe(s){ const t = Date.parse(s); return isNaN(t) ? 0 : t; }

  async function showDrilldown(brand){
    modalTitle.textContent = brand + ' — Headlines';
    modalSubtitle.textContent = `Date: ${currentDate}`;
    modalBody.innerHTML = '<p class="text-sm text-slate-500">Loading…</p>';
    openModal();

    const all = await loadArticlesForDate(currentDate);
    const rows = all.filter(r => r.brand === brand);
    // Prefer negative first, then published desc
    rows.sort((a,b)=>{
      const order = (x)=> x.sentiment === 'negative' ? 2 : (x.sentiment === 'neutral' ? 1 : 0);
      const d = order(b) - order(a);
      if(d !== 0) return d;
      return parseDateMaybe(b.published) - parseDateMaybe(a.published);
    });

    if(!rows.length){
      modalBody.innerHTML = '<p class="text-sm text-slate-600">No articles found for this brand on this date.</p>';
      return;
    }

    modalBody.innerHTML = `
      <div class="space-y-3">
        ${rows.map(r=>`
          <div class="p-3 border rounded-xl hover:bg-slate-50">
            <div class="flex items-center justify-between gap-3">
              <div class="text-xs text-slate-500">${r.domain || ''}</div>
              <div>${sentimentBadge(r.sentiment)}</div>
            </div>
            <a href="${r.url}" target="_blank" rel="noopener" class="block mt-1 font-medium underline">${escapeHtml(r.title)}</a>
            ${r.published ? `<div class="text-xs text-slate-500 mt-1">${r.published}</div>` : ''}
          </div>`).join('\n')}
      </div>`;
  }

  function escapeHtml(s){
    return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;');
  }

  // Event bindings
  dateSelect.addEventListener('change', ()=>{ currentDate = dateSelect.value; computeRows(); renderTable(); attachTableHandlers(); });
  brandFilter.addEventListener('input', ()=>{ computeRows(); renderTable(); attachTableHandlers(); });
  document.getElementById('refreshBtn').addEventListener('click', ()=>{ loadCountsCsv(); });
  saveLocalBtn.addEventListener('click', saveSelectionLocal);
  exportCsvBtn.addEventListener('click', exportSelectionCsv);
  sendWebhookBtn.addEventListener('click', sendSelectionToWebhook);
  selectAll.addEventListener('change', ()=>{
    if(selectAll.checked){ currentRows.forEach(r=>selected.add(r.brand)); }
    else { selected.clear(); }
    renderTable(); attachTableHandlers();
  });

  // Load CSVs
  function loadCountsCsv(){
    statusEl.textContent = 'Loading…';
    fetch(CSV_COUNTS + '?_=' + Date.now())
      .then(r=>{ if(!r.ok) throw new Error('Failed to fetch '+CSV_COUNTS+' ('+r.status+')'); return r.text(); })
      .then(text=>{
        const parsed = Papa.parse(text, { header: true, dynamicTyping: true });
        const raw = parsed.data.map(normalizeRowKeys);
        const good = raw.filter(r => r && r.date && r.brand);
        allRows = good.map(r => ({
          date: String(r.date),
          brand: String(r.brand),
          total: formatInt(r.total),
          positive: formatInt(r.positive),
          neutral: formatInt(r.neutral),
          negative: formatInt(r.negative),
          theme: r.theme ? String(r.theme) : 'none'
        }));
        if(!allRows.length){
          statusEl.textContent = 'No rows parsed from data/daily_counts.csv. Open /data/daily_counts.csv to confirm the file is deployed.';
          dateSelect.innerHTML = '';
          tableBody.innerHTML = '';
          return;
        }
        renderDateOptions();
        computeRows();
        renderTable(); attachTableHandlers();
        renderSaved();
        statusEl.textContent = `${currentRows.length} brands shown for ${currentDate}. ${selected.size} selected.`;
      })
      .catch(err=>{ console.error(err); statusEl.textContent = 'Error loading data. Check console.'; });
  })
      .then(text=>{
        const parsed = Papa.parse(text, { header: true, dynamicTyping: true });
        allRows = parsed.data
          .filter(r => r && r.date && r.brand)
          .map(r => ({
            date: String(r.date),
            brand: String(r.brand),
            total: formatInt(r.total),
            positive: formatInt(r.positive),
            neutral: formatInt(r.neutral),
            negative: formatInt(r.negative),
            theme: r.theme ? String(r.theme) : 'none'
          }));
        renderDateOptions();
        computeRows();
        renderTable(); attachTableHandlers();
        renderSaved();
        statusEl.textContent = `${currentRows.length} brands shown for ${currentDate}. ${selected.size} selected.`;
      })
      .catch(err=>{ console.error(err); statusEl.textContent = 'Error loading data. Check console.'; });
  }

  loadCountsCsv();
})();
</script>
</body>
</html>
