<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BRAND News Sentiment Dashboard</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Papa Parse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    /* Keep brand name left-aligned even when it wraps */
    td[data-col="brand-name"]{
      text-align:left !important; vertical-align:top;
    }
    td[data-col="brand-name"] > *{
      text-align:left !important; white-space:normal; word-break:break-word;
      line-height:1.15; display:inline-block;
    }
    /* Sort header affordance */
    .th-sort{ cursor:pointer; user-select:none; }
    .th-sort .arrow{ opacity:.35; margin-left:.25rem }
    .th-sort.active .arrow{ opacity:1 }
    /* Trend canvas sizing */
    #trendWrap{ height:20rem; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-7xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-3xl font-bold">BRAND News Sentiment Dashboard</h1>
      <p class="text-sm text-slate-600">
        Shows the top 25 Fortune 500 brands by <em>negative</em> article count for a selected day.
        Data sources: <code>data/daily_counts.csv</code>, <code>data/serps/brand_serps.csv</code>.
      </p>
    </header>

    <!-- Controls -->
    <section class="mb-4 grid gap-3 md:grid-cols-3">
      <div>
        <label class="block text-sm font-medium mb-1">Pick date</label>
        <select id="dateSelect" class="w-full border rounded-lg p-2 bg-white"></select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Filter brands</label>
        <input id="brandFilter" type="text" placeholder="Type to filter…" class="w-full border rounded-lg p-2"/>
      </div>
      <div class="flex items-end gap-2">
        <button id="refreshBtn" class="px-3 py-2 rounded-lg bg-slate-900 text-white">Refresh</button>
      </div>
    </section>

    <!-- Trend -->
    <section class="mb-6 p-4 border rounded-xl bg-white">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-lg font-semibold">Sentiment trend</h2>
        <div class="flex items-center gap-2">
          <span id="trendInfo" class="text-xs text-slate-500"></span>
          <span id="trendRange" class="text-xs text-slate-500"></span>
          <button id="trendPrev" class="px-2 py-1 border rounded disabled:opacity-40" title="Older 30 days">←</button>
          <button id="trendNext" class="px-2 py-1 border rounded disabled:opacity-40" title="Newer 30 days">→</button>
        </div>
      </div>
      <p id="trendHint" class="text-sm text-slate-500 mb-2 hidden">
        Tip: select exactly <span class="font-semibold">1</span> brand to display a trend. When none is selected, top negative brand is shown by default.
      </p>
      <div id="trendWrap"><canvas id="trendChart"></canvas></div>
    </section>

    <!-- Table -->
    <section class="overflow-x-auto">
      <table class="min-w-full text-sm bg-white rounded-xl overflow-hidden border">
        <thead class="bg-slate-100">
          <tr>
            <th class="p-3 text-left"><input type="checkbox" id="selectAll"></th>
            <th class="p-3 text-left">Brand</th>
            <th class="p-3 text-left">Theme</th>
            <th class="p-3 text-left th-sort" data-sort="negnews">Negative News (%) <span class="arrow">▲▼</span></th>
            <th class="p-3 text-left th-sort" data-sort="negserp">Negative SERP (%) <span class="arrow">▲▼</span></th>
            <th class="p-3 text-left th-sort" data-sort="control">SERP Control (%) <span class="arrow">▲▼</span></th>
            <th class="p-3 text-left th-sort" data-sort="risk">Risk <span class="arrow">▲▼</span></th>
            <th class="p-3 text-left">Headlines</th>
            <th class="p-3 text-left">SERP</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>

      <!-- Pagination -->
      <div class="flex items-center justify-between mt-3">
        <div class="text-xs text-slate-500" id="status"></div>
        <div class="flex gap-2">
          <button id="prevPage" class="px-3 py-1.5 border rounded-lg">Prev</button>
          <button id="nextPage" class="px-3 py-1.5 border rounded-lg">Next</button>
        </div>
      </div>
    </section>
  </div>

  <!-- Modal -->
  <div id="modalBackdrop" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-3xl bg-white rounded-2xl shadow-xl overflow-hidden">
        <div class="flex items-center justify-between p-4 border-b">
          <div>
            <h3 id="modalTitle" class="text-xl font-bold">Details</h3>
            <p id="modalSubtitle" class="text-sm text-slate-600"></p>
          </div>
          <button id="modalClose" class="px-3 py-1.5 rounded-lg border">Close</button>
        </div>
        <div id="modalBody" class="max-h-[70vh] overflow-y-auto p-4">
          <p class="text-sm text-slate-500">Loading…</p>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  // ---- Config / paths ----
  const GH_USER = 'jonas-sickler';
  const GH_REPO = 'news-sentiment-dashboard';
  const GH_BASE = `https://${GH_USER}.github.io/${GH_REPO}/`;

  const CSV_COUNTS = 'data/daily_counts.csv';                 // brand news
  const CSV_SERPS  = 'data/serps/brand_serps.csv';            // SERPs

  const ROWS_PER_PAGE = 25;
  const TREND_WINDOW = 30; // days per page in chart

  // ---- DOM ----
  const tableBody = document.getElementById('tableBody');
  const dateSelect = document.getElementById('dateSelect');
  const brandFilter = document.getElementById('brandFilter');
  const refreshBtn = document.getElementById('refreshBtn');
  const selectAll = document.getElementById('selectAll');
  const statusEl = document.getElementById('status');
  const prevPageBtn = document.getElementById('prevPage');
  const nextPageBtn = document.getElementById('nextPage');

  // Trend
  const trendCanvas = document.getElementById('trendChart');
  const trendWrap = document.getElementById('trendWrap');
  const trendInfo = document.getElementById('trendInfo');
  const trendRange = document.getElementById('trendRange');
  const trendPrev = document.getElementById('trendPrev');
  const trendNext = document.getElementById('trendNext');
  const trendHint = document.getElementById('trendHint');

  // Modal
  const modalBackdrop = document.getElementById('modalBackdrop');
  const modalTitle = document.getElementById('modalTitle');
  const modalSubtitle = document.getElementById('modalSubtitle');
  const modalBody = document.getElementById('modalBody');
  const modalClose = document.getElementById('modalClose');

  // ---- State ----
  let allRows = [];      // news counts
  let serps = [];        // SERPs
  let currentDate = null;
  let selected = new Set();  // selected brand names
  let trendChart = null;
  let page = 0;          // pagination index
  let sortKey = 'negnews';
  let sortDir = 'desc';  // 'asc'|'desc'
  let filteredRows = []; // rows after date+filter, before pagination

  // ---- Helpers ----
  function fmtPct(v, d=0){
    const x = Number(v||0);
    return (Math.round(x * Math.pow(10,d)) / Math.pow(10,d)).toFixed(d).replace(/\.0+$/,'') + '%';
  }
  function asInt(x){ const n = Number(x||0); return Number.isFinite(n)?n:0; }

  function openModal(){ modalBackdrop.classList.remove('hidden'); }
  function closeModal(){ modalBackdrop.classList.add('hidden'); }
  modalClose.addEventListener('click', closeModal);
  modalBackdrop.addEventListener('click', e => { if(e.target === modalBackdrop) closeModal(); });

  function sentimentBadge(s){
    const base = 'inline-block px-2 py-0.5 rounded-full text-xs';
    if((s||'').toLowerCase()==='negative') return `<span class="${base} bg-rose-100 text-rose-700">negative</span>`;
    if((s||'').toLowerCase()==='positive') return `<span class="${base} bg-emerald-100 text-emerald-700">positive</span>`;
    return `<span class="${base} bg-slate-100 text-slate-700">neutral</span>`;
  }

  function riskLabel(negSerp, control){
    const ns = Number(negSerp||0), ctrl = Number(control||0);
    if(ns > 0) return 'high';
    if(ns === 0 && ctrl < 70) return 'medium';
    return 'low';
  }

  // ---- Fetchers ----
  async function fetchTextCandidates(path){
    const rel = new URL(path, location.href).href + (path.includes('?')?'&':'?') + '_=' + Date.now();
    const abs = GH_BASE + path + (path.includes('?')?'&':'?') + '_=' + Date.now();
    const candidates = [rel];
    if(!rel.startsWith(GH_BASE)) candidates.push(abs);
    for(const url of candidates){
      try{
        const r = await fetch(url, {cache:'no-store', mode:'cors'});
        if(r.ok){ const t = await r.text(); if(t) return t; }
      }catch(_){}
    }
    return '';
  }

  async function loadCounts(){
    const t = await fetchTextCandidates(CSV_COUNTS);
    if(!t) return [];
    const parsed = Papa.parse(t, {header:true, dynamicTyping:true});
    return (parsed.data||[]).map(row=>{
      const r = {};
      for(const k in row){
        const nk = String(k||'').replace(/^\ufeff/,'').trim().toLowerCase();
        r[nk]=row[k];
      }
      return {
        date: String(r.date||''),
        brand: String(r.brand||''),
        total: asInt(r.total),
        positive: asInt(r.positive),
        neutral: asInt(r.neutral),
        negative: asInt(r.negative),
        theme: String(r.theme||'None')
      };
    }).filter(r=> r.date && r.brand);
  }

  async function loadSerps(){
    const t = await fetchTextCandidates(CSV_SERPS);
    if(!t) return [];
    const parsed = Papa.parse(t, {header:true});
    return (parsed.data||[]).map(row=>{
      const norm = {};
      for(const k in row){
        const nk = String(k||'').replace(/^\ufeff/,'').trim().toLowerCase();
        norm[nk]=row[k];
      }
      return {
        brand: String(norm.brand||'').trim(),
        title: String(norm.title||'').trim(),
        link: String(norm.link||'').trim(),
        domain: String(norm['root domain']||norm.domain||'').trim(),
        snippet: String(norm.snippet||norm['snippet']||'').trim(),
        control: parseControl(norm.control),
        sentiment: (String(norm.sentiment||'').trim().toLowerCase() || 'neutral')
      };
    }).filter(r=> r.brand && r.link);
  }

  function parseControl(val){
    if(typeof val === 'boolean') return val;
    const s = String(val||'').trim().toLowerCase();
    if(['true','t','1','yes','y','controlled'].includes(s)) return true;
    if(['false','f','0','no','n','uncontrolled'].includes(s)) return false;
    return false; // default conservative
  }

  // ---- Transformations ----
  function allDatesSorted(){ return Array.from(new Set(allRows.map(r=>r.date))).sort(); }

  function buildSerpSummaryForBrandMap(){
    // Map<string brand, {neg:%, control:%, total:int}>
    const byBrand = new Map();
    for(const r of serps){
      const key = r.brand;
      const s = byBrand.get(key) || {tot:0, neg:0, ctrl:0};
      s.tot += 1;
      if(r.control) s.ctrl += 1;
      if(r.sentiment === 'negative') s.neg += 1;
      byBrand.set(key, s);
    }
    const out = new Map();
    for(const [b, s] of byBrand){
      const negPct = s.tot ? (s.neg / s.tot)*100 : 0;
      const ctrlPct = s.tot ? (s.ctrl / s.tot)*100 : 0;
      out.set(b, {negPct, ctrlPct, total:s.tot});
    }
    return out;
  }

  function computeFilteredRows(){
    const q = (brandFilter.value||'').trim().toLowerCase();
    const rows = allRows.filter(r => r.date===currentDate && r.brand);
    // attach SERP stats
    const serpMap = buildSerpSummaryForBrandMap();
    for(const r of rows){
      const s = serpMap.get(r.brand) || {negPct:0, ctrlPct:0};
      r._negNewsPct = r.total ? (r.negative/r.total)*100 : 0;
      r._negSerpPct = s.negPct;
      r._ctrlPct = s.ctrlPct;
      r._risk = riskLabel(r._negSerpPct, r._ctrlPct);
    }
    // filter
    const wanted = rows.filter(r => r.brand.toLowerCase().includes(q));
    // sort
    wanted.sort((a,b)=>{
      const k = sortKey;
      const aVal = k==='negnews'?a._negNewsPct:(k==='negserp'?a._negSerpPct:(k==='control'?a._ctrlPct:(a._risk||'').localeCompare(b._risk||'')));
      const bVal = k==='negnews'?b._negNewsPct:(k==='negserp'?b._negSerpPct:(k==='control'?b._ctrlPct:(b._risk||'').localeCompare(a._risk||'')));
      if(k==='risk'){ // simple order high>medium>low
        const ord = v => v==='high'?3:(v==='medium'?2:1);
        const d = (ord(b._risk)-ord(a._risk));
        return sortDir==='desc'?d:-d;
      }
      const d = Number(bVal)-Number(aVal);
      return sortDir==='desc'?d:-d;
    });
    filteredRows = wanted;
  }

  function paginate(arr){
    const start = page * ROWS_PER_PAGE;
    return arr.slice(start, start + ROWS_PER_PAGE);
  }

  function updateStatus(){
    const total = filteredRows.length;
    const start = total? (page*ROWS_PER_PAGE+1):0;
    const end = Math.min(total, (page+1)*ROWS_PER_PAGE);
    statusEl.textContent = `${start}-${end} of ${total} brands · date ${currentDate}`;
    prevPageBtn.disabled = page<=0;
    nextPageBtn.disabled = end>=total;
  }

  function renderTable(){
    const slice = paginate(filteredRows);
    tableBody.innerHTML = slice.map((r, idx)=>{
      const negNews = fmtPct(r._negNewsPct);
      const negSerp = fmtPct(r._negSerpPct);
      const ctrl = fmtPct(r._ctrlPct);
      return `<tr class="border-t hover:bg-slate-50 align-top">
        <td class="p-3"><input type="checkbox" data-brand="${escapeHtml(r.brand)}"></td>
        <td class="p-3" data-col="brand-name"><div class="font-medium leading-snug">${escapeHtml(r.brand)}</div></td>
        <td class="p-3 text-slate-700">${escapeHtml(r.theme||'None')}</td>
        <td class="p-3">${negNews}</td>
        <td class="p-3">${negSerp}</td>
        <td class="p-3">${ctrl}</td>
        <td class="p-3 capitalize">${r._risk}</td>
        <td class="p-3"><button class="px-2 py-1 border rounded-lg" data-headlines="${escapeHtml(r.brand)}">View</button></td>
        <td class="p-3"><button class="px-2 py-1 border rounded-lg" data-serp="${escapeHtml(r.brand)}">View</button></td>
      </tr>`;
    }).join('\n');

    // handlers
    tableBody.querySelectorAll('button[data-headlines]').forEach(btn=>{
      btn.addEventListener('click', () => showHeadlines(btn.getAttribute('data-headlines')));
    });
    tableBody.querySelectorAll('button[data-serp]').forEach(btn=>{
      btn.addEventListener('click', () => showSerp(btn.getAttribute('data-serp')));
    });
  }

  function esc(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#39;'); }

  async function showHeadlines(brand){
    const all = allRows.filter(r => r.date===currentDate && r.brand===brand);
    // We only have counts CSV; detail articles were per-date file in your repo.
    // Fallback: explain where to find per-day articles.
    modalTitle.textContent = `${brand} — Headlines`;
    modalSubtitle.textContent = `Date: ${currentDate}`;
    modalBody.innerHTML = `<p class="text-sm text-slate-600">
      Headlines are in <code>data/articles/${currentDate}.csv</code>. Open the CEO or Brand dashboard drilldown to view them there.</p>`;
    openModal();
  }

  function showSerp(brand){
    const rows = serps.filter(s => (s.brand||'').trim().toLowerCase() === brand.trim().toLowerCase());
    modalTitle.textContent = `${brand} — SERP`;
    modalSubtitle.textContent = `Total results: ${rows.length}`;
    if(!rows.length){
      modalBody.innerHTML = '<p class="text-sm text-slate-600">No SERP rows found.</p>';
      openModal(); return;
    }
    modalBody.innerHTML = `
      <div class="space-y-3">
        ${rows.map(r=>`
          <div class="p-3 border rounded-xl">
            <div class="flex items-center justify-between gap-3 text-xs text-slate-500">
              <div>${esc(r.domain||'')}</div>
              <div class="flex gap-2">
                <span>${r.control?'controlled':'uncontrolled'}</span>
                <span>${sentimentBadge(r.sentiment)}</span>
              </div>
            </div>
            <a href="${esc(r.link)}" target="_blank" rel="noopener" class="block mt-1 font-medium underline">${esc(r.title)}</a>
            ${r.snippet?`<div class="text-xs text-slate-600 mt-1">${esc(r.snippet)}</div>`:''}
          </div>
        `).join('\n')}
      </div>`;
    openModal();
  }

  // ---- Trend (percent only) ----
  function seriesForBrand(brand){
    const dates = allDatesSorted();
    const byDate = new Map();
    for(const r of allRows){ if(r.brand===brand) byDate.set(r.date, r); }
    const pos=[],neu=[],neg=[];
    for(const d of dates){
      const r = byDate.get(d) || {total:0,positive:0,neutral:0,negative:0};
      const t = r.total||0; const f=x=> t? (x/t*100):0;
      pos.push(+f(r.positive).toFixed(1));
      neu.push(+f(r.neutral).toFixed(1));
      neg.push(+f(r.negative).toFixed(1));
    }
    return {dates,pos,neu,neg};
  }

  let trendBrand=null, trendPage=0;
  function updateTrend(){
    const sel = Array.from(tableBody.querySelectorAll('input[type="checkbox"]:checked')).map(cb=>cb.getAttribute('data-brand'));
    let brand = null; let auto=false;
    if(sel.length===1) brand=sel[0];
    else if(filteredRows.length){ brand = filteredRows[0].brand; auto=true; }
    else { trendInfo.textContent=''; trendRange.textContent=''; if(trendChart){trendChart.destroy();} return; }

    trendHint.classList.toggle('hidden', true);
    if(brand !== trendBrand){ trendPage = 0; }
    const full = seriesForBrand(brand);
    const total = full.dates.length;
    const W = TREND_WINDOW;
    const maxPage = Math.max(0, Math.ceil(total/W)-1);
    if(trendPage > maxPage) trendPage = maxPage;
    const end = Math.max(0, total - W*trendPage);
    const start = Math.max(0, end - W);

    const labels = full.dates.slice(start, end);
    const data = {
      labels,
      datasets:[
        {label:'Positive', data: full.pos.slice(start,end), backgroundColor:'#98c15b', stack:'s'},
        {label:'Neutral',  data: full.neu.slice(start,end), backgroundColor:'#dae5e6', stack:'s'},
        {label:'Negative', data: full.neg.slice(start,end), backgroundColor:'#ffb199', stack:'s'},
      ]
    };
    const options={
      responsive:true, maintainAspectRatio:false,
      scales:{ x:{stacked:true}, y:{stacked:true,beginAtZero:true,ticks:{callback:v=>v+'%'}} },
      plugins:{ legend:{position:'top'} }
    };

    trendBrand = brand;
    trendInfo.textContent = `BRAND: ${brand}`;
    trendRange.textContent = labels.length?` | DATE: ${labels[0]} → ${labels[labels.length-1]}`:'';

    if(trendChart) trendChart.destroy();
    trendChart = new Chart(trendCanvas.getContext('2d'), {type:'bar', data, options});
  }

  trendPrev.addEventListener('click', ()=>{ trendPage += 1; updateTrend(); });
  trendNext.addEventListener('click', ()=>{ trendPage = Math.max(0, trendPage-1); updateTrend(); });

  // ---- Sorting ----
  function bindSortHeaders(){
    document.querySelectorAll('.th-sort').forEach(th=>{
      th.addEventListener('click', ()=>{
        const key = th.getAttribute('data-sort'); // negnews|negserp|control|risk
        if(sortKey===key){ sortDir = (sortDir==='desc' ? 'asc' : 'desc'); }
        else { sortKey=key; sortDir='desc'; }
        document.querySelectorAll('.th-sort').forEach(h=>h.classList.remove('active'));
        th.classList.add('active');
        page=0;
        computeFilteredRows(); renderTable(); updateStatus(); updateTrend();
      });
    });
  }

  // ---- Wireups ----
  dateSelect.addEventListener('change', ()=>{ currentDate = dateSelect.value; page=0; computeFilteredRows(); renderTable(); updateStatus(); updateTrend(); });
  brandFilter.addEventListener('input', ()=>{ page=0; computeFilteredRows(); renderTable(); updateStatus(); updateTrend(); });
  refreshBtn.addEventListener('click', ()=>{ init(); });
  prevPageBtn.addEventListener('click', ()=>{ if(page>0){ page-=1; renderTable(); updateStatus(); } });
  nextPageBtn.addEventListener('click', ()=>{ page+=1; renderTable(); updateStatus(); });

  // ---- Init ----
  async function init(){
    allRows = await loadCounts();
    serps = await loadSerps();

    const dates = allDatesSorted();
    dateSelect.innerHTML = dates.map(d=>`<option value="${d}">${d}</option>`).join('');
    currentDate = dates[dates.length-1] || null;

    bindSortHeaders();
    computeFilteredRows(); page=0; renderTable(); updateStatus(); updateTrend();
  }

  init();
})();
</script>
</body>
</html>
