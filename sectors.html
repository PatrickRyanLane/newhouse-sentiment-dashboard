<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Geographic Locations — Sectors Dashboard</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<!-- PapaParse for GitHub CSV roster parsing -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
:root {
  --bg: #044152;
  --card: #092e37;
  --muted: #a2ebf3;
  --text: #ebf2f2;
  --accent: #58dbed;
  --black: #1f2121;
  --pill-neg: #ff8261;
  --pill-neu: #cfdbdd;
  --pill-pos: #82c618;
  --stroke: #0e2230;
  --chip: #12343e;
  --chipBorder: #174550;
}

*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
.wrap{max-width:1200px;margin:0 auto;padding:20px}
h1{font-size:28px;margin:6px 0 18px}
.controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:0 0 16px}
.card{background:var(--card);border:1px solid var(--stroke);border-radius:12px;padding:12px 12px}
select,input[type="text"]{background:#1f2121;border:1px solid #23314d;border-radius:10px;color:var(--text);padding:8px 10px}
button{background:#1f2121;border:1px solid #2a3b5e;color:var(--text);border-radius:10px;padding:8px 12px;cursor:pointer}
button:hover{filter:brightness(1.08)}
.grid{display:grid;grid-template-rows:minmax(360px,42vh) minmax(360px,42vh);gap:18px;margin:16px 0}
.chart-card{background:var(--card);border:1px solid var(--stroke);border-radius:12px;padding:12px 12px 48px;position:relative}
.chart-card canvas{width:100% !important;height:100% !important;display:block}
.chart-actions{position:absolute;top:10px;right:12px;display:flex;align-items:center;gap:10px}
.chart-actions .dates-range{font-size:12px}
.chart-actions .dates-pager{display:flex;gap:6px}
.chart-actions .dates-pager button{background:#1f2121;border:1px solid #2a3b5e;color:var(--text);border-radius:8px;padding:4px 8px;cursor:pointer}
.chart-actions .dates-pager button[disabled]{opacity:.45;cursor:not-allowed}
.table-card{background:var(--card);border:1px solid var(--stroke);border-radius:12px;padding:10px}
.table-hint{margin:0 0 8px;color:var(--muted)}
table{width:100%;border-collapse:separate;border-spacing:0 6px}
thead th{font-size:12px;color:var(--muted);text-align:center;padding:6px 8px}
tbody td{padding:10px 8px;background:#1f2121;border-top:1px solid #0f1831;border-bottom:1px solid #0f1831;text-align:center}
tbody tr td:first-child{border-left:1px solid #0f1831;border-radius:10px 0 0 10px}
tbody tr td:last-child{border-right:1px solid #0f1831;border-radius:0 10px 10px 0}
.right{text-align:right}.center{text-align:center}
.table-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch}
.table-scroll::-webkit-scrollbar{height:8px}
.table-scroll::-webkit-scrollbar-track{background:rgba(255,255,255,.05);border-radius:8px}
.table-scroll::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:8px}
@media (max-width:960px){
  .table-card{padding:8px}
  thead th, tbody td{padding:8px 10px}
  table{min-width:820px}
}
.pagination{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:8px}
.muted{color:var(--muted)}

/* Modal Styles */
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:1000;align-items:center;justify-content:center}
.modal.open{display:flex}
.modal-content{background:var(--card);border:1px solid var(--stroke);border-radius:12px;padding:20px;max-width:600px;max-height:80vh;overflow-y:auto;width:90%;position:relative}
.modal-close{position:absolute;top:10px;right:10px;background:none;border:none;color:var(--text);font-size:24px;cursor:pointer}
.modal-close:hover{color:var(--accent)}
.modal-title{margin-top:0;margin-bottom:16px;font-size:18px}
.modal-body{font-size:13px;line-height:1.6}
.article-item{background:#1f2121;border:1px solid #0f1831;border-radius:8px;padding:12px;margin-bottom:10px}
.article-item h4{margin:0 0 6px;color:var(--accent);font-size:14px}
.article-item p{margin:0;color:var(--muted);font-size:12px}
.loading-spinner{text-align:center;color:var(--muted);padding:20px}
</style>
</head>

<body>
<div class="wrap">
  <h1>Geographic Locations — Sectors Dashboard</h1>
  <div class="controls card">
    <div>
      <div class="muted" style="font-size:12px;margin:0 0 4px">Date</div>
      <select id="dateSelect"></select>
    </div>
    <div style="flex:1 1 420px">
      <div class="muted" style="font-size:12px;margin:0 0 4px">Filter (Sector)</div>
      <input id="filterInput" type="text" placeholder="Type to filter…" />
    </div>
    <button id="refreshBtn">Refresh Data</button>
    <button id="clearBtn">Clear Selection</button>
  </div>
  <div class="grid">
    <div class="chart-card">
      <h3>News sentiment (percent of articles)</h3>
      <div class="chart-actions">
        <span class="dates-range muted" aria-live="polite"></span>
        <div class="dates-pager">
          <button class="dates-prev" title="Older window">←</button>
          <button class="dates-next" title="Newer window">→</button>
        </div>
      </div>
      <canvas id="newsChart"></canvas>
    </div>
    <div class="chart-card">
      <h3>SERP (Negative % • Control %)</h3>
      <div class="chart-actions">
        <span class="dates-range muted" aria-live="polite"></span>
        <div class="dates-pager">
          <button class="dates-prev" title="Older window">←</button>
          <button class="dates-next" title="Newer window">→</button>
        </div>
      </div>
      <canvas id="serpChart"></canvas>
    </div>
  </div>
  <div class="table-card">
    <div class="table-scroll">
      <table>
        <thead>
          <tr>
            <th style="width:56px">Select</th>
            <th data-key="sector">Sector</th>
            <th data-key="neg_news">Negative News % ▲▼</th>
            <th data-key="neg_serp">Negative SERP % ▲▼</th>
            <th data-key="ctrl_pct">SERP Control % ▲▼</th>
            <th style="width:120px">Actions</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="pagination">
      <button id="prevBtn">Prev</button>
      <div>Page <span id="pageNo">1</span> / <span id="pageTotal">1</span></div>
      <button id="nextBtn">Next</button>
    </div>
  </div>
</div>

<!-- Modal for Headlines -->
<div id="headlinesModal" class="modal">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal('headlinesModal')">✕</button>
    <h2 class="modal-title">Articles for <span id="modalSectorName"></span></h2>
    <div id="modalBody" class="modal-body"></div>
  </div>
</div>

<!-- Modal for SERP Data -->
<div id="serpModal" class="modal">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal('serpModal')">✕</button>
    <h2 class="modal-title">SERP Data for <span id="serpModalSectorName"></span></h2>
    <div id="serpModalBody" class="modal-body"></div>
  </div>
</div>

<script>
const PROXY_URL = 'https://newhouse-sentiment-dashboard.vercel.app/api/sheets.js';
const GITHUB_RAW_URL = 'https://raw.githubusercontent.com/PatrickRyanLane/newhouse-sentiment-dashboard/main';
let allCountsRows = [];
let serpsDaily = [];
let sectorFromBrand = new Map();
let brandsBySector = new Map();
let filteredRows = [];
let selectedSector = null;
let currentSort = { key:null, dir:1 };
let currentPage = 1;
const PAGE_SIZE = 25;
let newsChart, serpChart;
const DATE_WINDOW_SIZE = 30;
let dateWindowStart = null;

// Modal Cache: stores fetched modal data to avoid refetching
const modalCache = {
  headlines: {},
  serps: {}
};

const isISODate = s => /^\d{4}-\d{2}-\d{2}$/.test(String(s||'').trim());
const esc = (s) => String(s ?? '').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const fmtPct = v => (v==null) ? 'N/A' : (Math.round(v*100) + '%');
const canonBrand = s => String(s || '').toLowerCase().replace(/\s+/g,' ').trim();

function clampDateStart(total){if(total<=DATE_WINDOW_SIZE)return 0;const maxStart=total-DATE_WINDOW_SIZE;const start=(dateWindowStart??maxStart);return Math.min(Math.max(0,start),maxStart)}
function sliceWindow(arr,start,size){return arr.slice(start,start+size)}
function updateDateRangeUI(allDates){const start=clampDateStart(allDates.length);const end=Math.min(allDates.length,start+DATE_WINDOW_SIZE);const label=allDates.length?`${allDates[start]} — ${allDates[end-1]}`:'';document.querySelectorAll('.dates-range').forEach(el=>el.textContent=label);const atStart=start===0;const atEnd=(start+DATE_WINDOW_SIZE)>=allDates.length;document.querySelectorAll('.dates-prev').forEach(b=>b.disabled=atStart);document.querySelectorAll('.dates-next').forEach(b=>b.disabled=atEnd)}
function hookDatePager(allDates){const goPrev=()=>{const total=allDates.length;if(total<=DATE_WINDOW_SIZE)return;dateWindowStart=clampDateStart(total)-DATE_WINDOW_SIZE;if(dateWindowStart<0)dateWindowStart=0;renderCharts()};const goNext=()=>{const total=allDates.length;if(total<=DATE_WINDOW_SIZE)return;const maxStart=total-DATE_WINDOW_SIZE;dateWindowStart=Math.min(maxStart,clampDateStart(total)+DATE_WINDOW_SIZE);renderCharts()};document.querySelectorAll('.dates-prev').forEach(b=>b.onclick=goPrev);document.querySelectorAll('.dates-next').forEach(b=>b.onclick=goNext)}

async function fetchFromSheets(sheetName,date=null){const fullName=date?`${date}-${sheetName}`:sheetName;try{const response=await fetch(PROXY_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'READ',sheetName:fullName})});if(!response.ok){const errorText=await response.text();console.error(`HTTP ${response.status} for ${fullName}:`,errorText);return[]}const data=await response.json();return data.data||[]}catch(e){console.warn(`Failed to read ${fullName}:`,e);return[]}}

// Fetch CSV from GitHub using PapaParse
async function fetchGitHubCSV(filePath) {
  try {
    const url = `${GITHUB_RAW_URL}/${filePath}`;
    console.log('[DEBUG] Fetching GitHub CSV:', url);
    const response = await fetch(url);
    if (!response.ok) {
      console.error(`HTTP ${response.status} for ${url}`);
      return [];
    }
    const text = await response.text();
    
    // Use PapaParse to handle CSV properly (handles quoted fields with commas, etc.)
    const result = Papa.parse(text, { header: true, skipEmptyLines: true });
    console.log('[DEBUG] Parsed', result.data.length, 'rows from', filePath);
    return result.data;
  } catch (e) {
    console.warn(`Failed to read ${filePath}:`, e);
    return [];
  }
}

// CONSOLIDATED DATA LOADING: Single function that fetches all data simultaneously using Promise.all()
async function loadAllData(){
  // Fetch roster from GitHub CSV, counts from Google Sheets
  const results = await Promise.all([
    fetchGitHubCSV('rosters/main-roster.csv'),
    fetchFromSheets('brand-articles-daily-counts-chart'),
    fetchFromSheets('brand-serps-daily-counts-chart')
  ]);

  console.log('[DEBUG] loadAllData results:', {roster: results[0].length, counts: results[1].length, serps: results[2].length});

  // Process roster data
  const rosterRows = results[0];
  sectorFromBrand.clear();
  brandsBySector.clear();
  rosterRows.forEach(r=>{
    const brandRaw=r.company||r.Company||r.brand||r.Brand||'';
    const sector=r.sector||r.Sector||'';
    const brandKey=canonBrand(brandRaw);
    if(!brandKey||!sector)return;
    sectorFromBrand.set(brandKey,sector);
    if(!brandsBySector.has(sector))brandsBySector.set(sector,new Set());
    brandsBySector.get(sector).add(brandKey)
  });
  console.log(`[INFO] Loaded ${brandsBySector.size} sectors with ${sectorFromBrand.size} brands`, Array.from(brandsBySector.keys()));

  // Process article counts data
  const countsRows = results[1];
  allCountsRows = countsRows.map(r=>({
    date:String(r.date||'').trim(),
    company:String(r.company||r.brand||'').trim(),
    pos:+r.positive_articles||+r.positive||+r.pos||0,
    neu:+r.neutral_articles||+r.neutral||+r.neu||0,
    neg:+r.negative_articles||+r.negative||+r.neg||0
  })).filter(r=>isISODate(r.date)&&r.company);

  // Process SERP data
  const serpRows = results[2];
  serpsDaily = serpRows.map(r=>({
    date:(r.date||'').trim(),
    company:(r.company||r.brand||'').trim(),
    total:+r.total||0,
    neg_serp:+r.neg_pct||+r.negative_serp||+r.neg_serp||0,
    ctrl:+r.controlled||+r.control||0
  })).filter(r=>isISODate(r.date)&&r.company);
}

async function init(){
  // Single consolidated call instead of three separate function calls
  await loadAllData();
  
  const dateSet=new Set([...allCountsRows.map(r=>r.date),...serpsDaily.map(r=>r.date)].filter(isISODate));
  const dates=[...dateSet].sort();
  const sel=document.getElementById('dateSelect');
  sel.innerHTML=dates.map(d=>`<option value="${d}">${d}</option>`).join('');
  sel.value=dates[dates.length-1]||'';
  sel.addEventListener('change',()=>{currentPage=1;selectedSector=null;renderAll()});
  document.getElementById('filterInput').addEventListener('input',()=>{currentPage=1;renderAll()});
  document.getElementById('refreshBtn').onclick=async()=>{await init()};
  document.getElementById('clearBtn').onclick=()=>{selectedSector=null;document.getElementById('filterInput').value='';renderAll()};
  document.getElementById('prevBtn').onclick=()=>{if(currentPage>1){currentPage--;renderTable()}};
  document.getElementById('nextBtn').onclick=()=>{const totalPages=Math.max(1,Math.ceil(filteredRows.length/PAGE_SIZE));if(currentPage<totalPages){currentPage++;renderTable()}};
  document.querySelectorAll('thead th[data-key]').forEach(th=>{
    th.style.cursor='pointer';
    th.addEventListener('click',()=>{
      const k=th.getAttribute('data-key');
      if(currentSort.key===k)currentSort.dir*=-1;
      else{currentSort.key=k;currentSort.dir=1}
      renderTable()
    })
  });
  const ro=new ResizeObserver(()=>{if(newsChart)newsChart.resize();if(serpChart)serpChart.resize()});
  document.querySelectorAll('.chart-card').forEach(el=>ro.observe(el));
  renderAll()
}

async function buildSectorRowsForDate(d){
  console.log('[DEBUG] buildSectorRowsForDate called with date:', d);
  const newsByBrand=new Map();
  for(const r of allCountsRows){
    if(r.date!==d)continue;
    const b=canonBrand(r.company||r.brand||r.ceo||'');
    if(!b)continue;
    const cur=newsByBrand.get(b)||{pos:0,neu:0,neg:0};
    cur.pos+=+r.pos||0;
    cur.neu+=+r.neu||0;
    cur.neg+=+r.neg||0;
    newsByBrand.set(b,cur)
  }
  const serpByBrand=new Map();
  for(const r of serpsDaily){
    if(r.date!==d)continue;
    const b=canonBrand(r.company||r.brand||'');
    if(!b)continue;
    const cur=serpByBrand.get(b)||{total:0,neg:0,ctrl:0};
    cur.total+=+r.total||0;
    cur.neg+=+r.neg_serp||0;
    cur.ctrl+=+r.ctrl||0;
    serpByBrand.set(b,cur)
  }
  console.log('[DEBUG] buildSectorRowsForDate:', {date: d, newsByBrandCount: newsByBrand.size, serpByBrandCount: serpByBrand.size});
  const sectors=[];
  brandsBySector.forEach((brandSet,sectorName)=>{
    let nPos=0,nNeu=0,nNeg=0,sTot=0,sNeg=0,sCtrl=0;
    brandSet.forEach(bKey=>{
      const n=newsByBrand.get(bKey);
      if(n){nPos+=n.pos;nNeu+=n.neu;nNeg+=n.neg}
      const s=serpByBrand.get(bKey);
      if(s){sTot+=s.total;sNeg+=s.neg;sCtrl+=s.ctrl}
    });
    const newsTot=nPos+nNeu+nNeg;
    const neg_news=newsTot?(nNeg/newsTot):null;
    const neg_serp=sTot?(sNeg/sTot):null;
    const ctrl_pct=sTot?(sCtrl/sTot):null;
    if(newsTot||sTot){
      sectors.push({sector:sectorName,neg_news,neg_serp,ctrl_pct})
    }
  });
  sectors.sort((a,b)=>a.sector.localeCompare(b.sector));
  console.log('[DEBUG] buildSectorRowsForDate returning:', {sectorCount: sectors.length, sectors: sectors.map(s => s.sector)});
  return sectors
}

async function renderAll(){
  const d=document.getElementById('dateSelect').value;
  const filter=document.getElementById('filterInput').value.trim().toLowerCase();
  const rows=(await buildSectorRowsForDate(d)).filter(r=>!filter||r.sector.toLowerCase().includes(filter));
  console.log('[DEBUG] renderAll:', {date: d, sectorCount: rows.length, sectors: rows.map(r => r.sector), brandsBySectorSize: brandsBySector.size, allCountsRowsSize: allCountsRows.length, serpsDailySize: serpsDaily.length});
  filteredRows=rows;
  currentPage=1;
  if(rows.length===1){
    selectedSector=rows[0].sector
  }else if(selectedSector&&!rows.some(r=>r.sector===selectedSector)){
    selectedSector=null
  }
  renderTable();
  renderCharts()
}

function renderTable(){
  const tbody=document.getElementById('tbody');
  let rows=[...filteredRows];
  if(currentSort.key){
    rows.sort((a,b)=>{
      const ka=a[currentSort.key],kb=b[currentSort.key];
      if(typeof ka==='string')return currentSort.dir*ka.localeCompare(kb);
      return currentSort.dir*((ka??-1)-(kb??-1))
    })
  }
  const start=(currentPage-1)*PAGE_SIZE;
  const pageRows=rows.slice(start,start+PAGE_SIZE);
  tbody.innerHTML=pageRows.map(r=>{
    const checked=(selectedSector&&selectedSector===r.sector)?'checked':'';
    return `<tr><td class="center"><input type="checkbox" class="sectorCheck" data-sector="${esc(r.sector)}" ${checked} /></td><td>${esc(r.sector)}</td><td>${fmtPct(r.neg_news)}</td><td>${fmtPct(r.neg_serp)}</td><td>${fmtPct(r.ctrl_pct)}</td><td class="center"><button onclick="showHeadlines('${esc(r.sector)}', '${document.getElementById('dateSelect').value}')">Headlines</button><button onclick="showSerps('${esc(r.sector)}', '${document.getElementById('dateSelect').value}')">SERPs</button></td></tr>`
  }).join('');
  tbody.querySelectorAll('.sectorCheck').forEach(cb=>{
    cb.addEventListener('change',e=>{
      const sec=e.target.getAttribute('data-sector');
      if(e.target.checked){
        selectedSector=sec;
        tbody.querySelectorAll('.sectorCheck').forEach(x=>{if(x!==e.target)x.checked=false})
      }else{
        if(selectedSector===sec)selectedSector=null
      }
      renderCharts()
    })
  });
  document.getElementById('pageNo').textContent=String(currentPage);
  document.getElementById('pageTotal').textContent=String(Math.max(1,Math.ceil(filteredRows.length/PAGE_SIZE)))
}

function getDateSeries(){
  let allowed=null;
  if(selectedSector&&brandsBySector.has(selectedSector)){
    allowed=brandsBySector.get(selectedSector)
  }
  const byDate=new Map();
  allCountsRows.forEach(r=>{
    const brandKey=canonBrand(r.company||r.brand||'');
    if(allowed&&!allowed.has(brandKey))return;
    const key=r.date;
    if(!byDate.has(key))byDate.set(key,{pos:0,neu:0,neg:0});
    const bucket=byDate.get(key);
    bucket.pos+=+r.pos||0;
    bucket.neu+=+r.neu||0;
    bucket.neg+=+r.neg||0
  });
  const serpByDate=new Map();
  serpsDaily.forEach(r=>{
    const brandKey=canonBrand(r.company||r.brand||'');
    if(allowed&&!allowed.has(brandKey))return;
    const key=r.date;
    if(!serpByDate.has(key))serpByDate.set(key,{total:0,neg:0,ctrl:0});
    const s=serpByDate.get(key);
    s.total+=+r.total||0;
    s.neg+=+r.neg_serp||0;
    s.ctrl+=+r.ctrl||0
  });
  const dates=[...new Set([...byDate.keys(),...serpByDate.keys()])].filter(isISODate).sort();
  const newsPos=[],newsNeu=[],newsNeg=[],serpNegPct=[],serpCtrlPct=[];
  dates.forEach(d=>{
    const n=byDate.get(d)||{pos:0,neu:0,neg:0};
    const t=n.pos+n.neu+n.neg||0;
    newsPos.push(t?n.pos/t*100:0);
    newsNeu.push(t?n.neu/t*100:0);
    newsNeg.push(t?n.neg/t*100:0);
    const s=serpByDate.get(d)||{total:0,neg:0,ctrl:0};
    serpNegPct.push(s.total?s.neg/s.total*100:0);
    serpCtrlPct.push(s.total?s.ctrl/s.total*100:0)
  });
  return{dates,newsPos,newsNeu,newsNeg,serpNegPct,serpCtrlPct}
}

function renderCharts(){
  const{dates,newsPos,newsNeu,newsNeg,serpNegPct,serpCtrlPct}=getDateSeries();
  if(dateWindowStart===null){
    dateWindowStart=Math.max(0,dates.length-DATE_WINDOW_SIZE)
  }
  const start=clampDateStart(dates.length);
  const d=sliceWindow(dates,start,DATE_WINDOW_SIZE);
  const nP=sliceWindow(newsPos,start,DATE_WINDOW_SIZE);
  const nN=sliceWindow(newsNeu,start,DATE_WINDOW_SIZE);
  const nG=sliceWindow(newsNeg,start,DATE_WINDOW_SIZE);
  const sN=sliceWindow(serpNegPct,start,DATE_WINDOW_SIZE);
  const sC=sliceWindow(serpCtrlPct,start,DATE_WINDOW_SIZE);
  updateDateRangeUI(dates);
  hookDatePager(dates);
  const who=selectedSector?selectedSector:"Index Average";
  const fmtPctInt=v=>`${Math.round(v)}%`;
  const commonOpts={responsive:true,maintainAspectRatio:false,layout:{padding:{bottom:24}},scales:{x:{ticks:{color:'#ebf2f2'},grid:{color:'rgba(255,255,255,.05)'}},y:{ticks:{color:'#ebf2f2',stepSize:20,callback:v=>fmtPctInt(v)},grid:{color:'rgba(255,255,255,.06)'},suggestedMin:0,suggestedMax:100}},plugins:{legend:{labels:{color:'#ebf2f2'}},title:{display:true,text:who,color:'#ebf2f2',font:{weight:'bold',size:14},padding:{top:10,bottom:6}},tooltip:{callbacks:{label:ctx=>{const label=ctx.dataset?.label?`${ctx.dataset.label}: `:'';const val=(ctx.parsed&&typeof ctx.parsed.y==='number')?ctx.parsed.y:(typeof ctx.parsed==='number'?ctx.parsed:0);return `${label}${fmtPctInt(val)}`}}}}};
  const nh=document.getElementById('newsChart').getContext('2d');
  if(newsChart)newsChart.destroy();
  newsChart=new Chart(nh,{type:'bar',data:{labels:d,datasets:[{label:'Positive %',data:nP,backgroundColor:'#82c618',stack:'s'},{label:'Neutral %',data:nN,backgroundColor:'#cfdbdd',stack:'s'},{label:'Negative %',data:nG,backgroundColor:'#ff8261',stack:'s'}]},options:{...commonOpts}});
  const sh=document.getElementById('serpChart').getContext('2d');
  if(serpChart)serpChart.destroy();
  serpChart=new Chart(sh,{type:'line',data:{labels:d,datasets:[{label:'Negative SERP %',data:sN,tension:.25,borderColor:'#ff8261',backgroundColor:'rgba(255,130,97,.2)',fill:false},{label:'Control %',data:sC,tension:.25,borderColor:'#58dbed',backgroundColor:'rgba(88,219,237,.15)',fill:false}]},options:{...commonOpts}})
}

// LAZY LOADING: Modal functions - data only fetches when user clicks button
async function showHeadlines(sector, date) {
  const cacheKey = `${sector}-${date}`;
  
  // Check cache first - if data exists, use it instantly (no network request)
  if (modalCache.headlines[cacheKey]) {
    displayHeadlinesModal(sector, modalCache.headlines[cacheKey]);
    return;
  }

  // Show loading state while fetching
  const modalBody = document.getElementById('modalBody');
  modalBody.innerHTML = '<div class="loading-spinner">Loading articles...</div>';
  document.getElementById('modalSectorName').textContent = sector;
  document.getElementById('headlinesModal').classList.add('open');

  try {
    // Lazy load: only fetch when user clicks (not on page load)
    const sheetName = `${date}-brand-articles-daily`;
    const articles = await fetchFromSheets(sheetName);
    
    // Filter articles for this sector's brands
    const sectorBrands = brandsBySector.get(sector) || new Set();
    const filtered = articles.filter(a => {
      const brandKey = canonBrand(a.company || a.brand || '');
      return sectorBrands.has(brandKey);
    });

    // Cache the result
    modalCache.headlines[cacheKey] = filtered;
    
    // Display cached data
    displayHeadlinesModal(sector, filtered);
  } catch (e) {
    console.error('Error loading headlines:', e);
    modalBody.innerHTML = '<div class="loading-spinner">Error loading articles</div>';
  }
}

function displayHeadlinesModal(sector, articles) {
  const modalBody = document.getElementById('modalBody');
  
  if (articles.length === 0) {
    modalBody.innerHTML = '<p class="muted">No articles found for this sector on this date.</p>';
    return;
  }

  modalBody.innerHTML = articles.map(a => `
    <div class="article-item">
      <h4>${esc(a.title || 'Untitled')}</h4>
      <p><strong>Brand:</strong> ${esc(a.company || a.brand || 'Unknown')}</p>
      <p><strong>Sentiment:</strong> ${esc(a.sentiment || 'Unknown')}</p>
      <p>${esc(a.snippet || a.description || 'No description available')}</p>
      ${a.url ? `<p><a href="${esc(a.url)}" target="_blank" style="color: var(--accent);">Read more →</a></p>` : ''}
    </div>
  `).join('');
}

// LAZY LOADING: Similar implementation for SERP data
async function showSerps(sector, date) {
  const cacheKey = `${sector}-${date}`;
  
  // Check cache first
  if (modalCache.serps[cacheKey]) {
    displaySerpsModal(sector, modalCache.serps[cacheKey]);
    return;
  }

  // Show loading state
  const serpModalBody = document.getElementById('serpModalBody');
  serpModalBody.innerHTML = '<div class="loading-spinner">Loading SERP data...</div>';
  document.getElementById('serpModalSectorName').textContent = sector;
  document.getElementById('serpModal').classList.add('open');

  try {
    // Lazy load: only fetch when clicked
    const sheetName = `${date}-brand-serps-daily`;
    const serpData = await fetchFromSheets(sheetName);
    
    // Filter for this sector's brands
    const sectorBrands = brandsBySector.get(sector) || new Set();
    const filtered = serpData.filter(s => {
      const brandKey = canonBrand(s.company || s.brand || '');
      return sectorBrands.has(brandKey);
    });

    // Cache the result
    modalCache.serps[cacheKey] = filtered;
    
    // Display cached data
    displaySerpsModal(sector, filtered);
  } catch (e) {
    console.error('Error loading SERP data:', e);
    serpModalBody.innerHTML = '<div class="loading-spinner">Error loading SERP data</div>';
  }
}

function displaySerpsModal(sector, serpData) {
  const serpModalBody = document.getElementById('serpModalBody');
  
  if (serpData.length === 0) {
    serpModalBody.innerHTML = '<p class="muted">No SERP data found for this sector on this date.</p>';
    return;
  }

  serpModalBody.innerHTML = serpData.map(s => `
    <div class="article-item">
      <h4>${esc(s.company || s.brand || 'Unknown')}</h4>
      <p><strong>Total Results:</strong> ${s.total || 0}</p>
      <p><strong>Negative %:</strong> ${fmtPct(s.neg_pct || s.neg_serp || 0)}</p>
      <p><strong>Control %:</strong> ${fmtPct(s.controlled || s.control || 0)}</p>
      ${s.domain ? `<p><strong>Domain:</strong> ${esc(s.domain)}</p>` : ''}
    </div>
  `).join('');
}

function closeModal(modalId) {
  document.getElementById(modalId).classList.remove('open');
}

// Close modals when clicking outside
document.addEventListener('click', (e) => {
  const headlinesModal = document.getElementById('headlinesModal');
  const serpModal = document.getElementById('serpModal');
  
  if (e.target === headlinesModal) headlinesModal.classList.remove('open');
  if (e.target === serpModal) serpModal.classList.remove('open');
});

init();
</script>
</body>
</html>