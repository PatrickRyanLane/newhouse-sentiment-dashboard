<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Sectors News Sentiment Dashboard</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Papa Parse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    .th-sort { cursor:pointer; user-select:none }
    .th-sort .arrow { opacity:.35; margin-left:.25rem }
    .th-sort.active .arrow { opacity:1 }
    #trendWrap { height: 22rem; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-7xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-3xl font-bold">Sectors News Sentiment Dashboard</h1>
      <p class="text-sm text-slate-600">
        Sources <code>data/roster.csv</code>, <code>data/daily_counts.csv</code>, <code>data/serps/brand_serps.csv</code>.
      </p>
    </header>

    <!-- Controls -->
    <section class="mb-4 grid gap-3 md:grid-cols-3">
      <div>
        <label class="block text-sm font-medium mb-1">Pick date</label>
        <select id="dateSelect" class="w-full border rounded-lg p-2 bg-white"></select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Filter sectors</label>
        <input id="filterInput" type="text" placeholder="Type to filter…" class="w-full border rounded-lg p-2"/>
      </div>
      <div class="flex items-end gap-2">
        <button id="refreshBtn" class="px-3 py-2 rounded-lg bg-slate-900 text-white">Refresh</button>
      </div>
    </section>

    <!-- Trend -->
    <section class="mb-6 p-4 border rounded-xl bg-white">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-lg font-semibold">Sentiment trend</h2>
        <div class="flex items-center gap-2 text-xs text-slate-500" id="trendInfo"></div>
      </div>
      <div id="trendWrap">
        <canvas id="trendChart"></canvas>
      </div>
    </section>

    <!-- Table -->
    <section class="overflow-x-auto">
      <table class="min-w-full text-sm bg-white rounded-xl overflow-hidden border">
        <thead class="bg-slate-100">
          <tr>
            <th class="p-3 text-left"><input type="checkbox" id="selectAll"></th>
            <th class="p-3 text-left">Sector</th>
            <th class="p-3 text-left th-sort" data-sort="negNewsPct">
              Negative News (%) <span class="arrow">▾</span>
            </th>
            <th class="p-3 text-left th-sort" data-sort="negSerpPct">
              Negative SERP (%) <span class="arrow">▾</span>
            </th>
            <th class="p-3 text-left th-sort" data-sort="controlPct">
              SERP Control (%) <span class="arrow">▾</span>
            </th>
            <th class="p-3 text-left th-sort" data-sort="riskRank">
              Risk <span class="arrow">▾</span>
            </th>
            <th class="p-3 text-left">SERP</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>

      <!-- Pagination -->
      <div class="mt-3 flex items-center gap-2">
        <button id="prevBtn" class="px-3 py-1.5 border rounded disabled:opacity-40">Prev</button>
        <button id="nextBtn" class="px-3 py-1.5 border rounded disabled:opacity-40">Next</button>
        <span id="pageInfo" class="text-xs text-slate-600 ml-2"></span>
      </div>

      <p id="status" class="text-xs text-slate-500 mt-2"></p>
    </section>
  </div>

  <!-- Modal -->
  <div id="modalBackdrop" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-3xl bg-white rounded-2xl shadow-xl overflow-hidden">
        <div class="flex items-center justify-between p-4 border-b">
          <div>
            <h3 id="modalTitle" class="text-xl font-bold">SERP</h3>
            <p id="modalSubtitle" class="text-sm text-slate-600"></p>
          </div>
          <button id="modalClose" class="px-3 py-1.5 rounded-lg border">Close</button>
        </div>
        <div id="modalBody" class="max-h-[70vh] overflow-y-auto p-4">
          <p class="text-sm text-slate-500">Loading…</p>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ----------- Config / constants -----------
  const GH_USER = 'jonas-sickler';
  const GH_REPO = 'news-sentiment-dashboard';
  const GH_PAGES_BASE = `https://${GH_USER}.github.io/${GH_REPO}/`;

  const CSV_ROSTER   = 'data/roster.csv';
  const CSV_COUNTS   = 'data/daily_counts.csv';
  const CSV_SERPS    = 'data/serps/brand_serps.csv';

  const PAGE_SIZE = 25;

  // ----------- Elements -----------
  const dateSelect   = document.getElementById('dateSelect');
  const filterInput  = document.getElementById('filterInput');
  const refreshBtn   = document.getElementById('refreshBtn');
  const selectAll    = document.getElementById('selectAll');
  const tableBody    = document.getElementById('tableBody');
  const statusEl     = document.getElementById('status');

  const prevBtn      = document.getElementById('prevBtn');
  const nextBtn      = document.getElementById('nextBtn');
  const pageInfo     = document.getElementById('pageInfo');

  const trendCanvas  = document.getElementById('trendChart');
  const trendInfo    = document.getElementById('trendInfo');

  // Modal
  const modalBackdrop = document.getElementById('modalBackdrop');
  const modalTitle    = document.getElementById('modalTitle');
  const modalSubtitle = document.getElementById('modalSubtitle');
  const modalBody     = document.getElementById('modalBody');
  const modalClose    = document.getElementById('modalClose');

  // ----------- State -----------
  let roster = [];          // rows from roster.csv
  let counts = [];          // rows from daily_counts.csv
  let serps  = [];          // rows from brand_serps.csv

  let companyToSector = new Map(); // normalized company -> sector

  let allDates = [];        // sorted list of dates from counts
  let currentDate = null;

  let sectorsRows = [];     // computed per-sector rows for currentDate
  let filteredRows = [];    // after filter text
  let selected = new Set(); // selected sector names
  let page = 0;

  let sortKey = 'negNewsPct';
  let sortDir = 'desc'; // 'asc' | 'desc'

  let chart = null;

  // ----------- Utilities -----------
  function normalizeKey(k){ return String(k||'').replace(/^\ufeff/, '').trim().toLowerCase(); }
  function normHeaders(row){
    const out = {};
    for(const k in row){ out[normalizeKey(k)] = row[k]; }
    return out;
  }

  function fetchCSV(path){
    // Try relative first, then GH Pages absolute
    const rel = new URL(path, location.href).href + (path.includes('?')?'&':'?') + '_=' + Date.now();
    const abs = GH_PAGES_BASE + path + (path.includes('?')?'&':'?') + '_=' + Date.now();
    const candidates = [rel];
    if(!rel.startsWith(GH_PAGES_BASE)) candidates.push(abs);

    return (async () => {
      for(const url of candidates){
        try{
          const r = await fetch(url, {cache:'no-store', mode:'cors'});
          if(!r.ok) continue;
          const text = await r.text();
          const parsed = Papa.parse(text, {header:true, dynamicTyping:true});
          const rows = (parsed.data||[]).map(normHeaders);
          return rows;
        }catch(_e){}
      }
      return [];
    })();
  }

  // name normalization to join brand/company
  function normName(s){
    return String(s||'')
      .toLowerCase()
      .replace(/&/g,'and')
      .replace(/\b(the|inc|inc\.|corp|co|co\.|company|ltd|ltd\.|plc|holdings?|group|corporation|services|stores|systems|international|intl|us|usa)\b/g,'')
      .replace(/[^a-z0-9]+/g,'')
      .trim();
  }

  function pct(n, d, dp=0){
    if(!d) return 0;
    const v = (n/d)*100;
    return +v.toFixed(dp);
  }

  function riskLabel(negSerpPct, controlPct){
    if(negSerpPct > 0) return {label:'High', rank:3};
    if(negSerpPct === 0 && controlPct < 70) return {label:'Medium', rank:2};
    return {label:'Low', rank:1};
  }

  function badge(txt, color){
    const cls = {
      green:  'bg-emerald-100 text-emerald-700',
      gray:   'bg-slate-100 text-slate-700',
      red:    'bg-rose-100 text-rose-700',
      blue:   'bg-sky-100 text-sky-700',
      amber:  'bg-amber-100 text-amber-800'
    }[color] || 'bg-slate-100 text-slate-700';
    return `<span class="inline-block px-2 py-0.5 rounded-full text-[11px] ${cls}">${txt}</span>`;
  }

  function fmtPct(v){ return `${Math.round(v)}%`; }

  // ----------- Load & prepare -----------
  async function loadAll(){
    statusEl.textContent = 'Loading CSVs…';
    [roster, counts, serps] = await Promise.all([
      fetchCSV(CSV_ROSTER),
      fetchCSV(CSV_COUNTS),
      fetchCSV(CSV_SERPS)
    ]);

    // Build company -> sector map (normalized)
    companyToSector = new Map();
    for(const r of roster){
      const comp = r.company || r.brand || r.name || r['company name'];
      const sect = r.sector || r.industry || 'Unknown';
      if(comp){
        companyToSector.set(normName(comp), String(sect).trim());
      }
    }

    // Dates
    const dates = Array.from(new Set(counts.map(r=> String(r.date||'').trim()).filter(Boolean))).sort();
    allDates = dates;
    currentDate = dates[dates.length-1] || null;

    renderDateOptions();
    computeSectors();
    renderTable();
    renderTrend();
    statusEl.textContent = `Loaded ${roster.length} roster rows, ${counts.length} news rows, ${serps.length} SERP rows.`;
  }

  function renderDateOptions(){
    dateSelect.innerHTML = allDates.map(d=> `<option value="${d}">${d}</option>`).join('');
    if(currentDate) dateSelect.value = currentDate;
  }

  // ----------- Compute sector rows for current date -----------
  function companySectorForBrand(brand){
    // Try direct brand->company match by normalization
    const key = normName(brand);
    if(companyToSector.has(key)) return companyToSector.get(key);

    // Heuristic: some brands may include words not in roster, try relaxed:
    // (We already normalized away common suffixes; this is best-effort)
    return 'Unknown';
  }

  function computeSectors(){
    // Aggregate NEWS by sector for selected date: sum pos/neu/neg
    const newsBySector = new Map(); // sector -> {pos,neu,neg}
    for(const r of counts){
      if(String(r.date) !== String(currentDate)) continue;
      const brand = r.brand || r.name || '';
      if(!brand) continue;
      const sec = companySectorForBrand(brand);
      const acc = newsBySector.get(sec) || {pos:0,neu:0,neg:0};
      acc.pos += +r.positive || 0;
      acc.neu += +r.neutral || 0;
      acc.neg += +r.negative || 0;
      newsBySector.set(sec, acc);
    }

    // Aggregate SERPs by sector for same date
    const serpBySector = new Map(); // sector -> {tot, neg, ctrl}
    for(const s of serps){
      const d = s.date || s['Date'] || '';
      if(String(d) !== String(currentDate)) continue;

      const b = s.brand || s['Brand'] || '';
      if(!b) continue;
      const sec = companySectorForBrand(b);

      const tot  = 1;
      const isNeg = String(s.sentiment || s['Sentiment'] || '').toLowerCase() === 'negative' ? 1 : 0;
      const ctrl = /^(true|yes|1)$/i.test(String(s.control || s['Control'] || 'false')) ? 1 : 0;

      const acc = serpBySector.get(sec) || {tot:0,neg:0,ctrl:0};
      acc.tot  += tot;
      acc.neg  += isNeg;
      acc.ctrl += ctrl;
      serpBySector.set(sec, acc);
    }

    // Build sector rows
    const sectors = new Set([...newsBySector.keys(), ...serpBySector.keys()]);
    const rows = [];
    for(const sec of sectors){
      const n = newsBySector.get(sec) || {pos:0,neu:0,neg:0};
      const tNews = n.pos + n.neu + n.neg;
      const negNewsPct = pct(n.neg, tNews);

      const s = serpBySector.get(sec) || {tot:0,neg:0,ctrl:0};
      const negSerpPct = pct(s.neg, s.tot);
      const controlPct = pct(s.ctrl, s.tot);

      const risk = riskLabel(negSerpPct, controlPct);

      rows.push({
        sector: sec,
        pos: n.pos, neu: n.neu, neg: n.neg, tNews,
        serpTot: s.tot, serpNeg: s.neg, serpCtrl: s.ctrl,
        negNewsPct, negSerpPct, controlPct,
        risk: risk.label, riskRank: risk.rank
      });
    }

    // Keep for table & trend (filtering/sorting applied later)
    sectorsRows = rows;
    applyFilterAndSort();
  }

  // ----------- Filtering / sorting / pagination -----------
  function applyFilterAndSort(){
    const q = (filterInput.value || '').trim().toLowerCase();
    filteredRows = sectorsRows.filter(r => !q || r.sector.toLowerCase().includes(q));

    sortRows();
    page = 0;
    updatePagination();
  }

  function sortRows(){
    const k = sortKey;
    const dir = sortDir === 'asc' ? 1 : -1;
    filteredRows.sort((a,b)=>{
      let va = a[k], vb = b[k];
      if(typeof va === 'string') va = va.toLowerCase();
      if(typeof vb === 'string') vb = vb.toLowerCase();
      if(va < vb) return -1*dir;
      if(va > vb) return 1*dir;
      return 0;
    });
  }

  function updatePagination(){
    const total = filteredRows.length;
    const maxPage = Math.max(0, Math.ceil(total / PAGE_SIZE) - 1);
    page = Math.min(page, maxPage);

    prevBtn.disabled = (page <= 0);
    nextBtn.disabled = (page >= maxPage);
    pageInfo.textContent = total ? `Page ${page+1} of ${maxPage+1} • ${total} sectors` : '';

    renderTable();
    renderTrend(); // trend reflects current selection / filter
  }

  // ----------- Render table -----------
  function renderTable(){
    const start = page * PAGE_SIZE;
    const rows = filteredRows.slice(start, start + PAGE_SIZE);

    const html = rows.map(r=>{
      const isSel = selected.has(r.sector);
      return `<tr class="border-t hover:bg-slate-50">
        <td class="p-3"><input type="checkbox" data-sector="${r.sector.replace(/"/g,'&quot;')}" ${isSel?'checked':''}></td>
        <td class="p-3 font-medium">${r.sector}</td>
        <td class="p-3">${fmtPct(r.negNewsPct)}</td>
        <td class="p-3">${fmtPct(r.negSerpPct)}</td>
        <td class="p-3">${fmtPct(r.controlPct)}</td>
        <td class="p-3">${r.risk === 'High' ? badge('High','red') : (r.risk==='Medium'?badge('Medium','amber'):badge('Low','green'))}</td>
        <td class="p-3"><button class="px-2 py-1 border rounded-lg" data-serp="${r.sector.replace(/"/g,'&quot;')}">View</button></td>
      </tr>`;
    }).join('\n');

    tableBody.innerHTML = html;

    // Checkbox handlers
    tableBody.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
      cb.addEventListener('change', ()=>{
        const sec = cb.getAttribute('data-sector');
        if(cb.checked) selected.add(sec); else selected.delete(sec);
        renderTrend();
      });
    });

    // SERP modal handlers
    tableBody.querySelectorAll('button[data-serp]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const sec = btn.getAttribute('data-serp');
        showSectorSerps(sec);
      });
    });

    // Update select-all state (checks only visible page)
    const visibleAllChecked = rows.length && rows.every(r=> selected.has(r.sector));
    selectAll.checked = visibleAllChecked;
  }

  // ----------- Trend -----------
  function seriesFor(sectorsSet){
    // Build per-day totals across selected sectors (or all when empty)
    const useSectors = sectorsSet && sectorsSet.size ? sectorsSet : null;

    // dates already sorted
    const labels = allDates.slice(-30); // last 30 days window
    const pos=[], neu=[], neg=[];

    for(const d of labels){
      let ap={pos:0,neu:0,neg:0};
      for(const r of counts){
        if(String(r.date)!==d) continue;
        const brand = r.brand || '';
        const sec = companySectorForBrand(brand);
        if(useSectors && !useSectors.has(sec)) continue;
        ap.pos += +r.positive||0;
        ap.neu += +r.neutral||0;
        ap.neg += +r.negative||0;
      }
      const total = ap.pos+ap.neu+ap.neg;
      pos.push(pct(ap.pos,total,1));
      neu.push(pct(ap.neu,total,1));
      neg.push(pct(ap.neg,total,1));
    }
    return {labels,pos,neu,neg};
  }

  function renderTrend(){
    // Decide which sectors to chart
    const sel = new Set(selected); // names
    const oneName = sel.size===1 ? Array.from(sel)[0] : null;

    const s = seriesFor(sel);
    trendInfo.textContent = (oneName ? `SECTOR: ${oneName}` : 'INDEX average (all/selected) over last 30 days');

    const data = {
      labels: s.labels,
      datasets: [
        { label: 'Positive', data: s.pos, backgroundColor: '#98c15b', stack: 'sent' },
        { label: 'Neutral',  data: s.neu, backgroundColor: '#dae5e6', stack: 'sent' },
        { label: 'Negative', data: s.neg, backgroundColor: '#ffb199', stack: 'sent' }
      ]
    };
    const options = {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { stacked:true, ticks:{ maxRotation:0, autoSkip:true, maxTicksLimit: 8 } },
        y: { stacked:true, beginAtZero:true, ticks:{ callback:(v)=> v+'%' } }
      },
      plugins: {
        legend: { position:'top' },
        tooltip: {
          callbacks:{
            label: (ctx)=> `${ctx.dataset.label}: ${ctx.parsed.y}%`
          }
        }
      }
    };

    if(chart) chart.destroy();
    chart = new Chart(trendCanvas.getContext('2d'), {type:'bar', data, options});
  }

  // ----------- SERP modal -----------
  function openModal(){ modalBackdrop.classList.remove('hidden'); }
  function closeModal(){ modalBackdrop.classList.add('hidden'); }
  modalClose.addEventListener('click', closeModal);
  modalBackdrop.addEventListener('click', (e)=>{ if(e.target===modalBackdrop) closeModal(); });
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });

  function esc(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }

  function showSectorSerps(sector){
    modalTitle.textContent = `${sector} — SERPs`;
    modalSubtitle.textContent = `Date: ${currentDate}`;
    openModal();

    // Gather SERPs for this sector on current date
    const rows = serps.filter(s=>{
      const d = String(s.date||s['Date']||'');
      const b = String(s.brand||s['Brand']||'');
      if(d !== String(currentDate)) return false;
      return companySectorForBrand(b) === sector;
    });

    if(!rows.length){
      modalBody.innerHTML = '<p class="text-sm text-slate-600">No SERP rows found for this sector on this date.</p>';
      return;
    }

    // Group by brand for readability
    const byBrand = new Map();
    for(const r of rows){
      const b = String(r.brand||r['Brand']||'Unknown');
      if(!byBrand.has(b)) byBrand.set(b, []);
      byBrand.get(b).push(r);
    }

    const html = [];
    for(const [brand, list] of byBrand.entries()){
      html.push(`<div class="mb-4 pb-3 border-b">
        <div class="font-semibold">${esc(brand)}</div>
        <div class="mt-2 space-y-2">
          ${list.map(item=>{
            const root = item['Root Domain'] || item.rootdomain || '';
            const title = item.title || item['Title'] || '';
            const link  = item.link || item['Link'] || '#';
            const snip  = item.snippet || item['Snippet'] || '';
            const ctrl  = /^(true|yes|1)$/i.test(String(item.control||item['Control']||'false'));
            const sent  = String(item.sentiment||item['Sentiment']||'').toLowerCase();
            const bCtrl = ctrl ? badge('controlled','blue') : badge('uncontrolled','gray');
            const bSent = sent==='negative' ? badge('negative','red') : (sent==='positive'?badge('positive','green'):badge('neutral','gray'));
            return `<div class="p-3 border rounded-xl">
              <div class="flex items-center justify-between gap-3">
                <div class="text-xs text-slate-500">${esc(root||'')}</div>
                <div class="flex items-center gap-2">${bCtrl}${bSent}</div>
              </div>
              <a href="${esc(link)}" target="_blank" rel="noopener" class="block mt-1 font-medium underline">${esc(title)}</a>
              ${snip? `<div class="text-xs text-slate-600 mt-1">${esc(snip)}</div>`:''}
            </div>`;
          }).join('')}
        </div>
      </div>`);
    }

    modalBody.innerHTML = html.join('\n');
  }

  // ----------- Event wiring -----------
  refreshBtn.addEventListener('click', async ()=>{
    await loadAll();
  });

  dateSelect.addEventListener('change', ()=>{
    currentDate = dateSelect.value;
    computeSectors();
    renderTable();
    renderTrend();
  });

  filterInput.addEventListener('input', ()=>{
    applyFilterAndSort();
  });

  // Sorting headers
  document.querySelectorAll('.th-sort').forEach(th=>{
    th.addEventListener('click', ()=>{
      const key = th.getAttribute('data-sort');
      if(sortKey === key){
        sortDir = (sortDir==='asc') ? 'desc' : 'asc';
      }else{
        sortKey = key;
        sortDir = 'desc';
        document.querySelectorAll('.th-sort').forEach(x=> x.classList.remove('active'));
        th.classList.add('active');
      }
      sortRows();
      page = 0;
      updatePagination();
    });
  });

  // Select all (visible page)
  selectAll.addEventListener('change', ()=>{
    const start = page * PAGE_SIZE;
    const rows = filteredRows.slice(start, start + PAGE_SIZE);
    if(selectAll.checked){
      rows.forEach(r=> selected.add(r.sector));
    }else{
      rows.forEach(r=> selected.delete(r.sector));
    }
    renderTable();
    renderTrend();
  });

  prevBtn.addEventListener('click', ()=>{ if(page>0){ page--; updatePagination(); } });
  nextBtn.addEventListener('click', ()=>{ page++; updatePagination(); });

  // ----------- Init -----------
  loadAll();
})();
</script>
</body>
</html>
